"use strict";(self.webpackChunkopenkruise_io=self.webpackChunkopenkruise_io||[]).push([[7977],{28453:(e,s,t)=>{t.d(s,{R:()=>d,x:()=>l});var n=t(96540);const i={},r=n.createContext(i);function d(e){const s=n.useContext(r);return n.useMemo((function(){return"function"==typeof e?e(s):{...s,...e}}),[s,e])}function l(e){let s;return s=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:d(e.components),n.createElement(r.Provider,{value:s},e.children)}},66137:(e,s,t)=>{t.r(s),t.d(s,{assets:()=>o,contentTitle:()=>l,default:()=>h,frontMatter:()=>d,metadata:()=>n,toc:()=>c});const n=JSON.parse('{"id":"user-manuals/deletionprotection","title":"Deletion Protection","description":"FEATURE STATE: Kruise v0.9.0","source":"@site/docs/user-manuals/deletionprotection.md","sourceDirName":"user-manuals","slug":"/user-manuals/deletionprotection","permalink":"/docs/next/user-manuals/deletionprotection","draft":false,"unlisted":false,"editUrl":"https://github.com/openkruise/openkruise.io/edit/master/docs/user-manuals/deletionprotection.md","tags":[],"version":"current","lastUpdatedBy":"Zhen Zhang","lastUpdatedAt":1752137622000,"frontMatter":{"title":"Deletion Protection"},"sidebar":"docs","previous":{"title":"PodProbeMarker","permalink":"/docs/next/user-manuals/podprobemarker"},"next":{"title":"PodUnavailableBudget","permalink":"/docs/next/user-manuals/podunavailablebudget"}}');var i=t(74848),r=t(28453);const d={title:"Deletion Protection"},l=void 0,o={},c=[{value:"Usage",id:"usage",level:2},{value:"Deletion Protection of service and ingress",id:"deletion-protection-of-service-and-ingress",level:2},{value:"Risk",id:"risk",level:2}];function a(e){const s={a:"a",code:"code",h2:"h2",li:"li",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,r.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsxs)(s.p,{children:[(0,i.jsx)(s.strong,{children:"FEATURE STATE:"})," Kruise v0.9.0"]}),"\n",(0,i.jsx)(s.p,{children:"This feature provides a safety policy which could help users protect Kubernetes resources and\napplications' availability from the cascading deletion mechanism."}),"\n",(0,i.jsx)(s.h2,{id:"usage",children:"Usage"}),"\n",(0,i.jsxs)(s.p,{children:["Firstly, users have to enable the ",(0,i.jsx)(s.code,{children:"ResourcesDeletionProtection"})," feature-gate during ",(0,i.jsx)(s.a,{href:"../installation#optional-feature-gate",children:"Kruise installation or upgrade"}),"."]}),"\n",(0,i.jsxs)(s.p,{children:["Then, users can add the label named ",(0,i.jsx)(s.code,{children:"policy.kruise.io/delete-protection"})," to some specific resources. The values can be:"]}),"\n",(0,i.jsxs)(s.ul,{children:["\n",(0,i.jsxs)(s.li,{children:[(0,i.jsx)(s.code,{children:"Always"}),": this object will always be forbidden to be deleted, unless the label is removed"]}),"\n",(0,i.jsxs)(s.li,{children:[(0,i.jsx)(s.code,{children:"Cascading"}),": this object will be forbidden to be deleted, if it has active resources owned"]}),"\n"]}),"\n",(0,i.jsx)(s.p,{children:"The resources supported and the cascading judgement relationship:"}),"\n",(0,i.jsxs)(s.table,{children:[(0,i.jsx)(s.thead,{children:(0,i.jsxs)(s.tr,{children:[(0,i.jsx)(s.th,{children:"Kind"}),(0,i.jsx)(s.th,{children:"Group"}),(0,i.jsx)(s.th,{children:"Version"}),(0,i.jsxs)(s.th,{children:[(0,i.jsx)(s.strong,{children:"Cascading"})," judgement"]})]})}),(0,i.jsxs)(s.tbody,{children:[(0,i.jsxs)(s.tr,{children:[(0,i.jsx)(s.td,{children:(0,i.jsx)(s.code,{children:"Namespace"})}),(0,i.jsx)(s.td,{children:"core"}),(0,i.jsx)(s.td,{children:"v1"}),(0,i.jsx)(s.td,{children:"whether there is active Pods in this namespace"})]}),(0,i.jsxs)(s.tr,{children:[(0,i.jsx)(s.td,{children:(0,i.jsx)(s.code,{children:"CustomResourceDefinition"})}),(0,i.jsx)(s.td,{children:"apiextensions.k8s.io"}),(0,i.jsx)(s.td,{children:"v1beta1, v1"}),(0,i.jsx)(s.td,{children:"whether there is existing CRs of this CRD"})]}),(0,i.jsxs)(s.tr,{children:[(0,i.jsx)(s.td,{children:(0,i.jsx)(s.code,{children:"Deployment"})}),(0,i.jsx)(s.td,{children:"apps"}),(0,i.jsx)(s.td,{children:"v1"}),(0,i.jsx)(s.td,{children:"whether the replicas is 0"})]}),(0,i.jsxs)(s.tr,{children:[(0,i.jsx)(s.td,{children:(0,i.jsx)(s.code,{children:"StatefulSet"})}),(0,i.jsx)(s.td,{children:"apps"}),(0,i.jsx)(s.td,{children:"v1"}),(0,i.jsx)(s.td,{children:"whether the replicas is 0"})]}),(0,i.jsxs)(s.tr,{children:[(0,i.jsx)(s.td,{children:(0,i.jsx)(s.code,{children:"ReplicaSet"})}),(0,i.jsx)(s.td,{children:"apps"}),(0,i.jsx)(s.td,{children:"v1"}),(0,i.jsx)(s.td,{children:"whether the replicas is 0"})]}),(0,i.jsxs)(s.tr,{children:[(0,i.jsx)(s.td,{children:(0,i.jsx)(s.code,{children:"CloneSet"})}),(0,i.jsx)(s.td,{children:"apps.kruise.io"}),(0,i.jsx)(s.td,{children:"v1alpha1"}),(0,i.jsx)(s.td,{children:"whether the replicas is 0"})]}),(0,i.jsxs)(s.tr,{children:[(0,i.jsx)(s.td,{children:(0,i.jsx)(s.code,{children:"StatefulSet"})}),(0,i.jsx)(s.td,{children:"apps.kruise.io"}),(0,i.jsx)(s.td,{children:"v1alpha1, v1beta1"}),(0,i.jsx)(s.td,{children:"whether the replicas is 0"})]}),(0,i.jsxs)(s.tr,{children:[(0,i.jsx)(s.td,{children:(0,i.jsx)(s.code,{children:"UnitedDeployment"})}),(0,i.jsx)(s.td,{children:"apps.kruise.io"}),(0,i.jsx)(s.td,{children:"v1alpha1"}),(0,i.jsx)(s.td,{children:"whether the replicas is 0"})]})]})]}),"\n",(0,i.jsx)(s.h2,{id:"deletion-protection-of-service-and-ingress",children:"Deletion Protection of service and ingress"}),"\n",(0,i.jsxs)(s.p,{children:[(0,i.jsx)(s.strong,{children:"FEATURE STATE:"})," Kruise v1.6.0"]}),"\n",(0,i.jsxs)(s.p,{children:["Kruise support the deletion protection of service and ingress resources, the strategy only supports ",(0,i.jsx)(s.code,{children:"Always"}),", for example:"]}),"\n",(0,i.jsx)(s.pre,{children:(0,i.jsx)(s.code,{className:"language-yaml",children:"apiVersion: v1\nkind: Service\nmetadata:\n  labels:\n    policy.kruise.io/delete-protection: Always\n  name: test-web\n"})}),"\n",(0,i.jsx)(s.h2,{id:"risk",children:"Risk"}),"\n",(0,i.jsxs)(s.p,{children:["Using ",(0,i.jsx)(s.code,{children:"objectSelector"})," in ",(0,i.jsx)(s.a,{href:"https://kubernetes.io/docs/reference/access-authn-authz/extensible-admission-controllers/#webhook-configuration",children:"webhook configuration"}),",\nKruise webhook will only handle those ",(0,i.jsx)(s.code,{children:"Namespace/CustomResourceDefinition/Deployment/StatefulSet/ReplicaSet"})," resources with ",(0,i.jsx)(s.code,{children:"policy.kruise.io/delete-protection"})," label."]}),"\n",(0,i.jsxs)(s.p,{children:["So, if all kruise-manager Pods are crashed or in other abnormal states, kube-apiserver fails to call the deletion webhook,\nonly the resources with ",(0,i.jsx)(s.code,{children:"policy.kruise.io/delete-protection"})," label can not be deleted temporarily."]})]})}function h(e={}){const{wrapper:s}={...(0,r.R)(),...e.components};return s?(0,i.jsx)(s,{...e,children:(0,i.jsx)(a,{...e})}):a(e)}}}]);