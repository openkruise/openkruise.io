"use strict";(globalThis.webpackChunkopenkruise_io=globalThis.webpackChunkopenkruise_io||[]).push([[3211],{11470:(e,a,n)=>{n.d(a,{A:()=>k});var t=n(96540),r=n(34164),i=n(17559),l=n(23104),s=n(56347),o=n(205),u=n(57485),c=n(31682),d=n(70679);function p(e){return t.Children.toArray(e).filter((e=>"\n"!==e)).map((e=>{if(!e||(0,t.isValidElement)(e)&&function(e){const{props:a}=e;return!!a&&"object"==typeof a&&"value"in a}(e))return e;throw new Error(`Docusaurus error: Bad <Tabs> child <${"string"==typeof e.type?e.type:e.type.name}>: all children of the <Tabs> component should be <TabItem>, and every <TabItem> should have a unique "value" prop.`)}))?.filter(Boolean)??[]}function h(e){const{values:a,children:n}=e;return(0,t.useMemo)((()=>{const e=a??function(e){return p(e).map((({props:{value:e,label:a,attributes:n,default:t}})=>({value:e,label:a,attributes:n,default:t})))}(n);return function(e){const a=(0,c.XI)(e,((e,a)=>e.value===a.value));if(a.length>0)throw new Error(`Docusaurus error: Duplicate values "${a.map((e=>e.value)).join(", ")}" found in <Tabs>. Every value needs to be unique.`)}(e),e}),[a,n])}function m({value:e,tabValues:a}){return a.some((a=>a.value===e))}function b({queryString:e=!1,groupId:a}){const n=(0,s.W6)(),r=function({queryString:e=!1,groupId:a}){if("string"==typeof e)return e;if(!1===e)return null;if(!0===e&&!a)throw new Error('Docusaurus error: The <Tabs> component groupId prop is required if queryString=true, because this value is used as the search param name. You can also provide an explicit value such as queryString="my-search-param".');return a??null}({queryString:e,groupId:a});return[(0,u.aZ)(r),(0,t.useCallback)((e=>{if(!r)return;const a=new URLSearchParams(n.location.search);a.set(r,e),n.replace({...n.location,search:a.toString()})}),[r,n])]}function v(e){const{defaultValue:a,queryString:n=!1,groupId:r}=e,i=h(e),[l,s]=(0,t.useState)((()=>function({defaultValue:e,tabValues:a}){if(0===a.length)throw new Error("Docusaurus error: the <Tabs> component requires at least one <TabItem> children component");if(e){if(!m({value:e,tabValues:a}))throw new Error(`Docusaurus error: The <Tabs> has a defaultValue "${e}" but none of its children has the corresponding value. Available values are: ${a.map((e=>e.value)).join(", ")}. If you intend to show no default tab, use defaultValue={null} instead.`);return e}const n=a.find((e=>e.default))??a[0];if(!n)throw new Error("Unexpected error: 0 tabValues");return n.value}({defaultValue:a,tabValues:i}))),[u,c]=b({queryString:n,groupId:r}),[p,v]=function({groupId:e}){const a=function(e){return e?`docusaurus.tab.${e}`:null}(e),[n,r]=(0,d.Dv)(a);return[n,(0,t.useCallback)((e=>{a&&r.set(e)}),[a,r])]}({groupId:r}),f=(()=>{const e=u??p;return m({value:e,tabValues:i})?e:null})();(0,o.A)((()=>{f&&s(f)}),[f]);return{selectedValue:l,selectValue:(0,t.useCallback)((e=>{if(!m({value:e,tabValues:i}))throw new Error(`Can't select invalid tab value=${e}`);s(e),c(e),v(e)}),[c,v,i]),tabValues:i}}var f=n(92303);const g={tabList:"tabList__CuJ",tabItem:"tabItem_LNqP"};var x=n(74848);function y({className:e,block:a,selectedValue:n,selectValue:t,tabValues:i}){const s=[],{blockElementScrollPositionUntilNextRender:o}=(0,l.a_)(),u=e=>{const a=e.currentTarget,r=s.indexOf(a),l=i[r].value;l!==n&&(o(a),t(l))},c=e=>{let a=null;switch(e.key){case"Enter":u(e);break;case"ArrowRight":{const n=s.indexOf(e.currentTarget)+1;a=s[n]??s[0];break}case"ArrowLeft":{const n=s.indexOf(e.currentTarget)-1;a=s[n]??s[s.length-1];break}}a?.focus()};return(0,x.jsx)("ul",{role:"tablist","aria-orientation":"horizontal",className:(0,r.A)("tabs",{"tabs--block":a},e),children:i.map((({value:e,label:a,attributes:t})=>(0,x.jsx)("li",{role:"tab",tabIndex:n===e?0:-1,"aria-selected":n===e,ref:e=>{s.push(e)},onKeyDown:c,onClick:u,...t,className:(0,r.A)("tabs__item",g.tabItem,t?.className,{"tabs__item--active":n===e}),children:a??e},e)))})}function j({lazy:e,children:a,selectedValue:n}){const i=(Array.isArray(a)?a:[a]).filter(Boolean);if(e){const e=i.find((e=>e.props.value===n));return e?(0,t.cloneElement)(e,{className:(0,r.A)("margin-top--md",e.props.className)}):null}return(0,x.jsx)("div",{className:"margin-top--md",children:i.map(((e,a)=>(0,t.cloneElement)(e,{key:a,hidden:e.props.value!==n})))})}function w(e){const a=v(e);return(0,x.jsxs)("div",{className:(0,r.A)(i.G.tabs.container,"tabs-container",g.tabList),children:[(0,x.jsx)(y,{...a,...e}),(0,x.jsx)(j,{...a,...e})]})}function k(e){const a=(0,f.A)();return(0,x.jsx)(w,{...e,children:p(e.children)},String(a))}},19365:(e,a,n)=>{n.d(a,{A:()=>l});n(96540);var t=n(34164);const r={tabItem:"tabItem_Ymn6"};var i=n(74848);function l({children:e,hidden:a,className:n}){return(0,i.jsx)("div",{role:"tabpanel",className:(0,t.A)(r.tabItem,n),hidden:a,children:e})}},28453:(e,a,n)=>{n.d(a,{R:()=>l,x:()=>s});var t=n(96540);const r={},i=t.createContext(r);function l(e){const a=t.useContext(i);return t.useMemo((function(){return"function"==typeof e?e(a):{...a,...e}}),[a,e])}function s(e){let a;return a=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:l(e.components),t.createElement(i.Provider,{value:a},e.children)}},54261:(e,a,n)=>{n.r(a),n.d(a,{assets:()=>c,contentTitle:()=>u,default:()=>h,frontMatter:()=>o,metadata:()=>t,toc:()=>d});const t=JSON.parse('{"id":"user-manuals/podunavailablebudget","title":"PodUnavailableBudget","description":"FEATURE STATE: Kruise v0.10.0","source":"@site/docs/user-manuals/podunavailablebudget.md","sourceDirName":"user-manuals","slug":"/user-manuals/podunavailablebudget","permalink":"/docs/next/user-manuals/podunavailablebudget","draft":false,"unlisted":false,"editUrl":"https://github.com/openkruise/openkruise.io/edit/master/docs/user-manuals/podunavailablebudget.md","tags":[],"version":"current","lastUpdatedBy":"Divyanshu Choudhury","lastUpdatedAt":1772265009000,"frontMatter":{"title":"PodUnavailableBudget"},"sidebar":"docs","previous":{"title":"Deletion Protection","permalink":"/docs/next/user-manuals/deletionprotection"},"next":{"title":"HPA configuration","permalink":"/docs/next/best-practices/hpa-configuration"}}');var r=n(74848),i=n(28453),l=n(11470),s=n(19365);const o={title:"PodUnavailableBudget"},u=void 0,c={},d=[{value:"API Definition",id:"api-definition",level:2},{value:"Support Custom Workload",id:"support-custom-workload",level:3},{value:"Support for Custom Workloads Without Scale Sub-Resource",id:"support-for-custom-workloads-without-scale-sub-resource",level:3},{value:"Control Protected Operations",id:"control-protected-operations",level:3},{value:"Implementation",id:"implementation",level:2},{value:"Comparison with Kubernetes native PDB",id:"comparison-with-kubernetes-native-pdb",level:2},{value:"feature-gates",id:"feature-gates",level:2},{value:"PodUnavailableBudget Status",id:"podunavailablebudget-status",level:2}];function p(e){const a={a:"a",code:"code",em:"em",h2:"h2",h3:"h3",img:"img",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,i.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsxs)(a.p,{children:[(0,r.jsx)(a.strong,{children:"FEATURE STATE:"})," Kruise v0.10.0"]}),"\n",(0,r.jsx)(a.p,{children:(0,r.jsx)(a.strong,{children:"Note: v1beta1 is available from Kruise v2.0.0."})}),"\n",(0,r.jsxs)(a.p,{children:["Kubernetes offers ",(0,r.jsx)(a.a,{href:"https://kubernetes.io/docs/tasks/run-application/configure-pdb/",children:"Pod Disruption Budget"})," to help you\nrun highly available applications even when you introduce\nfrequent ",(0,r.jsx)(a.a,{href:"https://kubernetes.io/docs/concepts/workloads/pods/disruptions/",children:"voluntary disruptions"}),".\nPDB limits the number of Pods of a replicated application that are down simultaneously from voluntary disruptions.\nHowever, it can only constrain the voluntary disruption triggered by\nthe ",(0,r.jsx)(a.a,{href:"https://kubernetes.io/docs/tasks/administer-cluster/safely-drain-node/#eviction-api",children:"Eviction API"}),".\nFor example, when you run kubectl drain, the tool tries to evict all of the Pods on the Node you're taking out of\nservice."]}),"\n",(0,r.jsx)(a.p,{children:"In the following voluntary disruption scenarios, there are still business disruption or SLA degradation situations:"}),"\n",(0,r.jsxs)(a.ol,{children:["\n",(0,r.jsxs)(a.li,{children:["The application owner update deployment's pod template for general upgrading, while cluster administrator drain nodes\nto scale the cluster down(learn about ",(0,r.jsx)(a.a,{href:"https://github.com/kubernetes/autoscaler/#readme",children:"Cluster Autoscaling"}),")."]}),"\n",(0,r.jsxs)(a.li,{children:["The middleware team is using ",(0,r.jsx)(a.a,{href:"./sidecarset",children:"SidecarSet"})," to rolling upgrade the sidecar containers of the cluster,\ne.g. ServiceMesh envoy, while HPA triggers the scale-down of business applications."]}),"\n",(0,r.jsx)(a.li,{children:"The application owner and middleware team release the same Pods at the same time based on OpenKruise cloneSet,\nsidecarSet in-place upgrades"}),"\n"]}),"\n",(0,r.jsx)(a.p,{children:"In voluntary disruption scenarios, PodUnavailableBudget can achieve the effect of preventing application disruption or\nSLA degradation, which greatly improves the high availability of application services."}),"\n",(0,r.jsx)(a.h2,{id:"api-definition",children:"API Definition"}),"\n",(0,r.jsxs)(l.A,{children:[(0,r.jsx)(s.A,{value:"v1beta1",label:"v1beta1",default:!0,children:(0,r.jsx)(a.pre,{children:(0,r.jsx)(a.code,{className:"language-yaml",children:"apiVersion: policy.kruise.io/v1beta1\nkind: PodUnavailableBudget\nmetadata:\n  name: web-server-pub\n  namespace: web\nspec:\n  targetRef:\n    apiVersion: apps.kruise.io/v1beta1\n    # cloneset, deployment, statefulset etc.\n    kind: CloneSet\n    name: web-server\n  # selector label query over pods managed by the budget\n  # selector and TargetReference are mutually exclusive, targetRef is priority to take effect.\n  # selector is commonly used in scenarios where applications are deployed using multiple workloads,\n  # and targetRef is used for protection against a single workload.\n# selector:\n#   matchLabels:\n#     app: web-server\n  # maximum number of Pods unavailable for the current cloneset, the example is cloneset.replicas(5) * 60% = 3\n  # maxUnavailable and minAvailable are mutually exclusive, maxUnavailable is priority to take effect\n  maxUnavailable: 60%\n  # Minimum number of Pods available for the current cloneset, the example is cloneset.replicas(5) * 40% = 2\n# minAvailable: 40%\n-----------------------\n\napiVersion: apps.kruise.io/v1beta1\nkind: CloneSet\nmetadata:\n  labels:\n    app: web-server\n  name: web-server\n  namespace: web\nspec:\n  replicas: 5\n  selector:\n    matchLabels:\n      app: web-server\n  template:\n    metadata:\n      labels:\n        app: web-server\n    spec:\n      containers:\n      - name: nginx\n        image: nginx:alpine\n"})})}),(0,r.jsx)(s.A,{value:"v1alpha1",label:"v1alpha1",children:(0,r.jsx)(a.pre,{children:(0,r.jsx)(a.code,{className:"language-yaml",children:"apiVersion: policy.kruise.io/v1alpha1\nkind: PodUnavailableBudget\nmetadata:\n  name: web-server-pub\n  namespace: web\nspec:\n  targetRef:\n    apiVersion: apps.kruise.io/v1alpha1\n    # cloneset, deployment, statefulset etc.\n    kind: CloneSet\n    name: web-server\n  # selector label query over pods managed by the budget\n  # selector and TargetReference are mutually exclusive, targetRef is priority to take effect.\n  # selector is commonly used in scenarios where applications are deployed using multiple workloads,\n  # and targetRef is used for protection against a single workload.\n# selector:\n#   matchLabels:\n#     app: web-server\n  # maximum number of Pods unavailable for the current cloneset, the example is cloneset.replicas(5) * 60% = 3\n  # maxUnavailable and minAvailable are mutually exclusive, maxUnavailable is priority to take effect\n  maxUnavailable: 60%\n  # Minimum number of Pods available for the current cloneset, the example is cloneset.replicas(5) * 40% = 2\n# minAvailable: 40%\n-----------------------\n\napiVersion: apps.kruise.io/v1alpha1\nkind: CloneSet\nmetadata:\n  labels:\n    app: web-server\n  name: web-server\n  namespace: web\nspec:\n  replicas: 5\n  selector:\n    matchLabels:\n      app: web-server\n  template:\n    metadata:\n      labels:\n        app: web-server\n    spec:\n      containers:\n      - name: nginx\n        image: nginx:alpine\n"})})})]}),"\n",(0,r.jsx)(a.h3,{id:"support-custom-workload",children:"Support Custom Workload"}),"\n",(0,r.jsxs)(a.p,{children:[(0,r.jsx)(a.strong,{children:"FEATURE STATE:"})," Kruise v1.2.0"]}),"\n",(0,r.jsx)(a.p,{children:"Many companies to meet the needs of more complex application deployment, often through the implementation of custom\nWorkload to manage business Pod.\nFrom kruise v1.2.0, PodUnavailableBudget(PUB) support protect any custom workload with scale sub-resource, e.g.\nArgo-Rollout:"}),"\n",(0,r.jsxs)(l.A,{children:[(0,r.jsx)(s.A,{value:"v1beta1",label:"v1beta1",default:!0,children:(0,r.jsx)(a.pre,{children:(0,r.jsx)(a.code,{className:"language-yaml",children:"apiVersion: policy.kruise.io/v1beta1\nkind: PodUnavailableBudget\nmetadata:\n  name: rollouts-demo\nspec:\n  targetRef:\n    apiVersion: argoproj.io/v1alpha1\n    kind: Rollout\n    name: rollouts-demo\n  minAvailable: 80%\n"})})}),(0,r.jsx)(s.A,{value:"v1alpha1",label:"v1alpha1",children:(0,r.jsx)(a.pre,{children:(0,r.jsx)(a.code,{className:"language-yaml",children:"apiVersion: policy.kruise.io/v1alpha1\nkind: PodUnavailableBudget\nmetadata:\n  name: rollouts-demo\nspec:\n  targetRef:\n    apiVersion: argoproj.io/v1alpha1\n    kind: Rollout\n    name: rollouts-demo\n  minAvailable: 80%\n"})})})]}),"\n",(0,r.jsx)(a.h3,{id:"support-for-custom-workloads-without-scale-sub-resource",children:"Support for Custom Workloads Without Scale Sub-Resource"}),"\n",(0,r.jsxs)(a.p,{children:[(0,r.jsx)(a.strong,{children:"FEATURE STATE:"})," Kruise v1.8.0"]}),"\n",(0,r.jsx)(a.p,{children:"In certain special scenarios, there may be custom workloads that do not implement the Scale sub-resource but still\nrequire protection. In such cases, users can directly specify the total number of replicas to be protected. The configuration methods differ between versions:"}),"\n",(0,r.jsxs)(a.ul,{children:["\n",(0,r.jsxs)(a.li,{children:[(0,r.jsx)(a.strong,{children:"v1alpha1"}),": Use the annotation ",(0,r.jsx)(a.code,{children:"pub.kruise.io/protect-total-replicas"})," to specify the total number of replicas to be protected (value is string type)"]}),"\n",(0,r.jsxs)(a.li,{children:[(0,r.jsx)(a.strong,{children:"v1beta1"}),": Use the ",(0,r.jsx)(a.code,{children:"spec.protectTotalReplicas"})," field to specify the total number of replicas to be protected (value is integer type)"]}),"\n"]}),"\n",(0,r.jsxs)(l.A,{children:[(0,r.jsx)(s.A,{value:"v1beta1",label:"v1beta1",default:!0,children:(0,r.jsx)(a.pre,{children:(0,r.jsx)(a.code,{className:"language-yaml",children:"apiVersion: policy.kruise.io/v1beta1\nkind: PodUnavailableBudget\nmetadata:\n  name: crd-demo\nspec:\n  # Specify the total number of replicas to be protected via spec field\n  protectTotalReplicas: 5\n  ...\n"})})}),(0,r.jsx)(s.A,{value:"v1alpha1",label:"v1alpha1",children:(0,r.jsx)(a.pre,{children:(0,r.jsx)(a.code,{className:"language-yaml",children:'apiVersion: policy.kruise.io/v1alpha1\nkind: PodUnavailableBudget\nmetadata:\n  name: crd-demo\n  annotations:\n    # Specify the target workload replicas\n    pub.kruise.io/protect-total-replicas: "5"\nspec:\n  ...\n'})})})]}),"\n",(0,r.jsx)(a.h3,{id:"control-protected-operations",children:"Control Protected Operations"}),"\n",(0,r.jsxs)(a.p,{children:[(0,r.jsx)(a.strong,{children:"FEATURE STATE:"})," Kruise v1.9.0"]}),"\n",(0,r.jsx)(a.pre,{children:(0,r.jsx)(a.code,{className:"language-yaml",children:'apiVersion: policy.kruise.io/v1alpha1\nkind: PodUnavailableBudget\nmetadata:\n  name: crd-demo\n  annotations:\n    # By default,  DELETE,EVICT,UPDATE are protected\n    # supported operations:\n    # DELETE: pod deletion\n    # EVICT: pod eviction\n    # UPDATE: pod inplace-update\n    # RESIZE: pod inplace-resizing\n    kruise.io/pub-protect-operations: "EVICT, UPDATE"\nspec:\n  ...\n'})}),"\n",(0,r.jsx)(a.p,{children:"Note: if featureGate InPlacePodVerticalScaling is disabled, inplace-resizing operation will be treated as inplace-update"}),"\n",(0,r.jsx)(a.h2,{id:"implementation",children:"Implementation"}),"\n",(0,r.jsx)(a.p,{children:"This program customizes the PodUnavailableBudget (later referred to as PUB) CRD resource to describe the desired state\nof the application, and the working mechanism is shown below:"}),"\n",(0,r.jsx)(a.p,{children:(0,r.jsx)(a.img,{alt:"PodUnavailableBudget",src:n(64201).A+"",width:"833",height:"680"})}),"\n",(0,r.jsx)(a.h2,{id:"comparison-with-kubernetes-native-pdb",children:"Comparison with Kubernetes native PDB"}),"\n",(0,r.jsx)(a.p,{children:"Kubernetes PodDisruptionBudget implements protection against Pod Eviction based on the EvictionREST interface,\nwhile PodUnavailableBudget intercepts all pod modification requests through the admission webhook validating mechanism (\nMany voluntary disruption scenarios can be summarized as modifications to Pod resources),\nand reject the request if the modification does not satisfy the desired state of the PUB."}),"\n",(0,r.jsx)(a.p,{children:(0,r.jsx)(a.strong,{children:"Pub contains all the protection capabilities of kubernetes PDB, you can use both, or use pub independently to\nimplement your application protection (Recommend)."})}),"\n",(0,r.jsx)(a.h2,{id:"feature-gates",children:"feature-gates"}),"\n",(0,r.jsxs)(a.p,{children:["PodUnavailableBudget protection against Pods is turned off by default, if you want to turn it on set feature-gates\n",(0,r.jsx)(a.em,{children:"PodUnavailableBudgetDeleteGate"})," and ",(0,r.jsx)(a.em,{children:"PodUnavailableBudgetUpdateGate"}),"."]}),"\n",(0,r.jsx)(a.pre,{children:(0,r.jsx)(a.code,{className:"language-bash",children:'$ helm install kruise https://... --set featureGates="PodUnavailableBudgetDeleteGate=true\\,PodUnavailableBudgetUpdateGate=true"\n'})}),"\n",(0,r.jsx)(a.h2,{id:"podunavailablebudget-status",children:"PodUnavailableBudget Status"}),"\n",(0,r.jsx)(a.pre,{children:(0,r.jsx)(a.code,{className:"language-yaml",children:"# kubectl describe podunavailablebudgets web-server-pub\nName: web-server-pub\nKind: PodUnavailableBudget\nStatus:\n  unavailableAllowed: 3   # unavailableAllowed number of pod unavailable that are currently allowed\n  currentAvailable: 5   # currentAvailable current number of available pods\n  desiredAvailable: 2   # desiredAvailable minimum desired number of available pods\n  totalReplicas: 5   # totalReplicas total number of pods counted by this PUB\n"})})]})}function h(e={}){const{wrapper:a}={...(0,i.R)(),...e.components};return a?(0,r.jsx)(a,{...e,children:(0,r.jsx)(p,{...e})}):p(e)}},64201:(e,a,n)=>{n.d(a,{A:()=>t});const t=n.p+"assets/images/podunavailablebudget-7ed5c9fff913cf97221663cdd8d7dc62.png"}}]);