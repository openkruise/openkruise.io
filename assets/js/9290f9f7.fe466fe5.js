"use strict";(self.webpackChunkopenkruise_io=self.webpackChunkopenkruise_io||[]).push([[6745],{3905:function(e,t,n){n.d(t,{Zo:function(){return u},kt:function(){return m}});var a=n(7294);function r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function i(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function s(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?i(Object(n),!0).forEach((function(t){r(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):i(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function l(e,t){if(null==e)return{};var n,a,r=function(e,t){if(null==e)return{};var n,a,r={},i=Object.keys(e);for(a=0;a<i.length;a++)n=i[a],t.indexOf(n)>=0||(r[n]=e[n]);return r}(e,t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(a=0;a<i.length;a++)n=i[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(r[n]=e[n])}return r}var o=a.createContext({}),c=function(e){var t=a.useContext(o),n=t;return e&&(n="function"==typeof e?e(t):s(s({},t),e)),n},u=function(e){var t=c(e.components);return a.createElement(o.Provider,{value:t},e.children)},p={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},f=a.forwardRef((function(e,t){var n=e.components,r=e.mdxType,i=e.originalType,o=e.parentName,u=l(e,["components","mdxType","originalType","parentName"]),f=c(n),m=r,h=f["".concat(o,".").concat(m)]||f[m]||p[m]||i;return n?a.createElement(h,s(s({ref:t},u),{},{components:n})):a.createElement(h,s({ref:t},u))}));function m(e,t){var n=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var i=n.length,s=new Array(i);s[0]=f;var l={};for(var o in t)hasOwnProperty.call(t,o)&&(l[o]=t[o]);l.originalType=e,l.mdxType="string"==typeof e?e:r,s[1]=l;for(var c=2;c<i;c++)s[c]=n[c];return a.createElement.apply(null,s)}return a.createElement.apply(null,n)}f.displayName="MDXCreateElement"},2067:function(e,t,n){n.r(t),n.d(t,{assets:function(){return u},contentTitle:function(){return o},default:function(){return m},frontMatter:function(){return l},metadata:function(){return c},toc:function(){return p}});var a=n(7462),r=n(3366),i=(n(7294),n(3905)),s=["components"],l={},o="Custom Lifecycle Management",c={unversionedId:"user-manuals/lifecycle",id:"user-manuals/lifecycle",title:"Custom Lifecycle Management",description:"Game servers, due to their strong stateful characteristics, have a high demand for graceful shutdown operations.",source:"@site/kruisegame/user-manuals/lifecycle.md",sourceDirName:"user-manuals",slug:"/user-manuals/lifecycle",permalink:"/kruisegame/user-manuals/lifecycle",draft:!1,tags:[],version:"current",lastUpdatedBy:"ChrisLiu",lastUpdatedAt:1724372089,formattedLastUpdatedAt:"8/23/2024",frontMatter:{},sidebar:"kruisegame",previous:{title:"Network",permalink:"/kruisegame/user-manuals/network"},next:{title:"GameServer Monitor",permalink:"/kruisegame/user-manuals/gameserver-monitor"}},u={},p=[{value:"Usage Example",id:"usage-example",level:2}],f={toc:p};function m(e){var t=e.components,l=(0,r.Z)(e,s);return(0,i.kt)("wrapper",(0,a.Z)({},f,l,{components:t,mdxType:"MDXLayout"}),(0,i.kt)("h1",{id:"custom-lifecycle-management"},"Custom Lifecycle Management"),(0,i.kt)("p",null,"Game servers, due to their strong stateful characteristics, have a high demand for graceful shutdown operations.\nA game server typically needs to wait until data is fully persisted to disk and ensured to be safe before it can be thoroughly removed.\nAlthough Kubernetes natively provides the preStop hook, which allows containers to execute specific actions before they are about to shut down, there is a limitation: once the preset time limit is exceeded, the container will have to be forcibly terminated, regardless of whether the data processing is complete or not.\nIn some cases, this approach lacks real gracefulness. We need a more flexible mechanism to ensure that game servers can exit smoothly while protecting all critical states."),(0,i.kt)("p",null,"OpenKruise has introduced the Lifecycle Hook feature, which provides precise control and waiting mechanisms for game servers at critical lifecycle moments.\nThis allows servers to execute the actual deletion or update operations only after meeting specific conditions.\nBy providing a configurable Lifecycle field, combined with the ability to customize service quality, OKG ensures that the game server's shutdown process is both graceful and reliable.\nWith this advanced feature, maintainers can ensure that all necessary data persistence and internal state synchronization are safely and correctly completed before the server is smoothly removed or updated."),(0,i.kt)("h2",{id:"usage-example"},"Usage Example"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-yaml"},'apiVersion: game.kruise.io/v1alpha1\nkind: GameServerSet\nmetadata:\n  name: minecraft\n  namespace: default\nspec:\n  replicas: 3\n  lifecycle:\n    preDelete:\n      labelsHandler:\n        gs-sync/delete-block: "true"\n  gameServerTemplate:\n    metadata:\n      labels:\n        gs-sync/delete-block: "true"\n    spec:\n      containers:\n        - image: registry.cn-beijing.aliyuncs.com/chrisliu95/minecraft-demo:probe-v0\n          name: minecraft\n          volumeMounts:\n            - name: gsState\n              mountPath: /etc/gsinfo\n      volumes:\n        - name: gsinfo\n          downwardAPI:\n            items:\n              - path: "state"\n                fieldRef:\n                  fieldPath: metadata.labels[\'game.kruise.io/gs-state\']\n  serviceQualities:\n    - name: healthy\n      containerName: minecraft\n      permanent: false\n      exec:\n        command: ["bash", "./probe.sh"]\n      serviceQualityAction:\n        - state: true\n          result: done\n          labels:\n            gs-sync/delete-block: "false"\n        - state: true\n          result: WaitToBeDeleted\n          opsState: WaitToBeDeleted\n        - state: false\n          opsState: None\n')),(0,i.kt)("p",null,"The corresponding script is as follows. The script performs the following actions:"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},'Acquires the current state of gs from /etc/gsinfo/state and determines whether it is "PreDelete"',(0,i.kt)("ul",{parentName:"li"},(0,i.kt)("li",{parentName:"ul"},"If it is PreDelete, it indicates that the current gs should be in the offline phase. It checks whether the data flushing has been completed (in this example, the presence of a file indicates data flushing completion)",(0,i.kt)("ul",{parentName:"li"},(0,i.kt)("li",{parentName:"ul"},"If the data flushing is not completed, it executes the data flushing action (in this example, it creates a file)"),(0,i.kt)("li",{parentName:"ul"},'If the data flushing is completed, it outputs "done" and exits with 1.'))),(0,i.kt)("li",{parentName:"ul"},"If it is not PreDelete, it indicates that the gs has not entered the offline stage. It uses the number of people in the game server to determine whether it should now go offline.",(0,i.kt)("ul",{parentName:"li"},(0,i.kt)("li",{parentName:"ul"},'If the number of people on the game server equals 0, it outputs "WaitToBeDeleted" and exits with 1.'),(0,i.kt)("li",{parentName:"ul"},"If the number of people on the game server is not 0, it exits with 0.")))))),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},'#!/bin/bash\n\nfile_path="/etc/gsinfo/state"\ndata_flushed_file="/etc/gsinfo/data_flushed"\n\nif [[ ! -f "$file_path" ]]; then\n    exit 0\nfi\n\nstate_content=$(cat "$file_path")\n\nif [[ "$state_content" == "PreDelete" ]]; then\n    if [[ -f "$data_flushed_file" ]]; then\n        echo "done"\n        exit 1\n    else\n        touch "$data_flushed_file"\n        echo "WaitToBeDeleted"\n        exit 1\n    fi\nelse\n    people_count_file="/etc/gsinfo/people_count"\n\n    people_count=$(cat "$people_count_file")\n    \n    if [[ "$people_count" -eq 0 ]]; then\n        echo "WaitToBeDeleted"\n        exit 1\n    else\n        exit 0\n    fi\nfi\n')),(0,i.kt)("p",null,(0,i.kt)("img",{alt:"grace-deletion.png",src:n(4854).Z,width:"2000",height:"465"})),(0,i.kt)("p",null,"The process of elegant delete as follow:"),(0,i.kt)("ol",null,(0,i.kt)("li",{parentName:"ol"},"The game server is running normally, and the number of players is not 0."),(0,i.kt)("li",{parentName:"ol"},"When the number of players drops to 0, set the opsState to WaitToBeDeleted using custom service quality settings."),(0,i.kt)("li",{parentName:"ol"},"Through the automatic scaling policy, OKG deletes the GameServer with WaitToBeDeleted opsState. Since the lifecycle hook is configured and the delete-block label wil be set to true, the gs is not truly deleted but enters the PreDelete state, and the data flushing process is triggered by custom service quality."),(0,i.kt)("li",{parentName:"ol"},"Once data flushing is complete, set the delete-block label to false using custom service quality to release the checkpoint."),(0,i.kt)("li",{parentName:"ol"},"After the checkpoint is released, the PreDelete phase moves into the Delete phase. The gs is then truly deleted.")))}m.isMDXComponent=!0},4854:function(e,t,n){t.Z=n.p+"assets/images/gs-lifecycle-delete-de81e2e95059bd06761bd6bbe55bc3a0.png"}}]);