"use strict";(self.webpackChunkopenkruise_io=self.webpackChunkopenkruise_io||[]).push([[887],{18669:(e,n,s)=>{s.r(n),s.d(n,{assets:()=>d,contentTitle:()=>a,default:()=>p,frontMatter:()=>i,metadata:()=>t,toc:()=>l});const t=JSON.parse('{"id":"user-manuals/podprobemarker","title":"PodProbeMarker","description":"FEATURE STATE: Kruise v1.3.0","source":"@site/versioned_docs/version-v1.7/user-manuals/podprobemarker.md","sourceDirName":"user-manuals","slug":"/user-manuals/podprobemarker","permalink":"/docs/v1.7/user-manuals/podprobemarker","draft":false,"unlisted":false,"editUrl":"https://github.com/openkruise/openkruise.io/edit/master/docs/user-manuals/podprobemarker.md","tags":[],"version":"v1.7","lastUpdatedBy":"Parship Chowdhury","lastUpdatedAt":1753062712000,"frontMatter":{"title":"PodProbeMarker"},"sidebar":"docs","previous":{"title":"PersistentPodState","permalink":"/docs/v1.7/user-manuals/persistentpodstate"},"next":{"title":"Deletion Protection","permalink":"/docs/v1.7/user-manuals/deletionprotection"}}');var o=s(74848),r=s(28453);const i={title:"PodProbeMarker"},a=void 0,d={},l=[{value:"Feature-gate",id:"feature-gate",level:2},{value:"Usage",id:"usage",level:2},{value:"Support TcpSocket Probe",id:"support-tcpsocket-probe",level:3},{value:"How to view Probe results?",id:"how-to-view-probe-results",level:2},{value:"Pod Status Conditions",id:"pod-status-conditions",level:3},{value:"Pod Metadata",id:"pod-metadata",level:3},{value:"Pod Event",id:"pod-event",level:3}];function c(e){const n={a:"a",code:"code",em:"em",h2:"h2",h3:"h3",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,r.R)(),...e.components};return(0,o.jsxs)(o.Fragment,{children:[(0,o.jsxs)(n.p,{children:[(0,o.jsx)(n.strong,{children:"FEATURE STATE:"})," Kruise v1.3.0"]}),"\n",(0,o.jsx)(n.p,{children:"Kubernetes provides three Pod lifecycle management:"}),"\n",(0,o.jsxs)(n.ul,{children:["\n",(0,o.jsxs)(n.li,{children:[(0,o.jsx)(n.strong,{children:"Readiness Probe"})," Used to determine whether the business container is ready to respond to user requests. If the probe fails, the Pod will be removed from Service Endpoints."]}),"\n",(0,o.jsxs)(n.li,{children:[(0,o.jsx)(n.strong,{children:"Liveness Probe"})," Used to determine the health status of the container. If the probe fails, the kubelet will restart the container."]}),"\n",(0,o.jsxs)(n.li,{children:[(0,o.jsx)(n.strong,{children:"Startup Probe"})," Used to know when a container application has started. If such a probe is configured, it disables liveness and readiness checks until it succeeds."]}),"\n"]}),"\n",(0,o.jsxs)(n.p,{children:["So the Probe capabilities provided in Kubernetes have defined specific semantics and related behaviors.\n",(0,o.jsx)(n.strong,{children:"In addition, there is actually a need to customize Probe semantics and related behaviors"}),", such as:"]}),"\n",(0,o.jsxs)(n.ul,{children:["\n",(0,o.jsxs)(n.li,{children:[(0,o.jsx)(n.strong,{children:"GameServer defines Idle Probe to determine whether the Pod currently has a game match"}),", if not, from the perspective of cost optimization, the Pod can be scaled down."]}),"\n",(0,o.jsxs)(n.li,{children:[(0,o.jsx)(n.strong,{children:"K8S Operator defines the main-secondary probe to determine the role of the current Pod (main or secondary)"}),". When upgrading, the secondary can be upgraded first,\nso as to achieve the behavior of selecting the main only once during the upgrade process, reducing the service interruption time during the upgrade process."]}),"\n"]}),"\n",(0,o.jsx)(n.p,{children:"OpenKruise provides the ability to customize the Probe and return the result to the Pod Status, and the user can decide the follow-up behavior based on the probe result."}),"\n",(0,o.jsx)(n.h2,{id:"feature-gate",children:"Feature-gate"}),"\n",(0,o.jsxs)(n.p,{children:["PodProbeMarker feature is turned on by default, if you want to turn it off set feature-gate ",(0,o.jsx)(n.em,{children:"PodProbeMarkerGate"}),"."]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-bash",children:'$ helm install kruise https://... --set featureGates="PodProbeMarkerGate=false"\n'})}),"\n",(0,o.jsx)(n.h2,{id:"usage",children:"Usage"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-yaml",children:"apiVersion: apps.kruise.io/v1alpha1\nkind: PodProbeMarker\nmetadata:\n  name: game-server-probe\n  namespace: ns\nspec:\n  selector:\n    matchLabels:\n      app: game-server\n  probes:\n  - name: Idle\n    containerName: game-server\n    probe:\n      exec:\n        command:\n        - /home/game/idle.sh\n      initialDelaySeconds: 10\n      timeoutSeconds: 3\n      periodSeconds: 10\n      successThreshold: 1\n      failureThreshold: 3\n    markerPolicy:\n    - state: Succeeded\n      labels:\n        gameserver-idle: 'true'\n      annotations:\n        controller.kubernetes.io/pod-deletion-cost: '-10'\n    - state: Failed\n      labels:\n        gameserver-idle: 'false'\n      annotations:\n        controller.kubernetes.io/pod-deletion-cost: '10'\n    podConditionType: game.io/idle\n"})}),"\n",(0,o.jsxs)(n.ul,{children:["\n",(0,o.jsxs)(n.li,{children:[(0,o.jsx)(n.strong,{children:"spec.selector"}),": Select matching Pods based on Labels, both MatchLabels and MatchExpressions are supported. For details, please refer to: ",(0,o.jsx)(n.a,{href:"https://kubernetes.io/docs/concepts/overview/working-with-objects/labels",children:"https://kubernetes.io/docs/concepts/overview/working-with-objects/labels"}),".\nOnce specified, selector cannot be changed for a PodProbeMarker."]}),"\n",(0,o.jsxs)(n.li,{children:["spec.probes","\n",(0,o.jsxs)(n.ul,{children:["\n",(0,o.jsxs)(n.li,{children:[(0,o.jsx)(n.strong,{children:"name"}),": The probe name needs to be unique within the Pod and between different containers"]}),"\n",(0,o.jsxs)(n.li,{children:[(0,o.jsx)(n.strong,{children:"containerName"}),": The container that executes the probe"]}),"\n",(0,o.jsxs)(n.li,{children:[(0,o.jsx)(n.strong,{children:"probe"}),": The API definition related to probe is consistent with the native K8S probe (currently only Exec and tcpSocket is supported). For details, please refer to: ",(0,o.jsx)(n.a,{href:"https://kubernetes.io/docs/tasks/configure-pod-container/configure-liveness-readiness-startup-probes/#configure-probes",children:"https://kubernetes.io/docs/tasks/configure-pod-container/configure-liveness-readiness-startup-probes/#configure-probes"})]}),"\n",(0,o.jsxs)(n.li,{children:[(0,o.jsx)(n.strong,{children:"markerPolicy"}),": According to the Probe execution result (Succeeded or Failed), patch specific Labels and Annotations to the Pod.","\n",(0,o.jsxs)(n.ul,{children:["\n",(0,o.jsx)(n.li,{children:"state: probe result, Succeeded or Failed"}),"\n",(0,o.jsx)(n.li,{children:"labels: If the result is satisfied, patch labels to the Pod"}),"\n",(0,o.jsx)(n.li,{children:"annotations: If the result is satisfied, patch annotations to the Pod"}),"\n"]}),"\n"]}),"\n",(0,o.jsxs)(n.li,{children:[(0,o.jsx)(n.strong,{children:"podConditionType"}),": Save the Probe execution result (Succeeded or Failed) to the pod condition. When probe is Succeeded, pod.status.condition.status=True.\nOtherwise, when the probe fails to execute, pod.status.condition.status=False. When podConditionType is empty, probe execution result will not be saved to pod condition."]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,o.jsxs)(n.p,{children:[(0,o.jsx)(n.strong,{children:"Note:"})," If only one Marker Policy is defined, for example: only define State=Succeeded, Patch Labels[healthy]='true'. When the probe execution success, kruise will patch labels[healthy]='true' to pod.\nAnd when the probe execution fails, Label[healthy] will be deleted."]}),"\n",(0,o.jsx)(n.h3,{id:"support-tcpsocket-probe",children:"Support TcpSocket Probe"}),"\n",(0,o.jsxs)(n.p,{children:[(0,o.jsx)(n.strong,{children:"FEATURE STATE:"})," Kruise v1.6.0"]}),"\n",(0,o.jsxs)(n.p,{children:["With this configuration, the kruise-daemon will attempt to open a socket to your container on the specified port. If it can establish a connection,\nthe probe is considered ",(0,o.jsx)(n.code,{children:"Succeeded"}),", if it can't it is considered ",(0,o.jsx)(n.code,{children:"Failed"}),". For example:"]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-yaml",children:"apiVersion: apps.kruise.io/v1alpha1\nkind: PodProbeMarker\nmetadata:\n  name: game-server-probe\n  namespace: ns\nspec:\n  selector:\n    matchLabels:\n      app: game-server\n  probes:\n  - name: Idle\n    containerName: game-server\n    probe:\n      tcpSocket:\n        port: 8080\n      initialDelaySeconds: 15\n      periodSeconds: 10\n"})}),"\n",(0,o.jsx)(n.h2,{id:"how-to-view-probe-results",children:"How to view Probe results?"}),"\n",(0,o.jsx)(n.h3,{id:"pod-status-conditions",children:"Pod Status Conditions"}),"\n",(0,o.jsxs)(n.p,{children:["If podConditionType is defined, the probe result will be saved to the pod condition, where ",(0,o.jsx)(n.strong,{children:"condition.type=podConditionType"}),", as follows:"]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-yaml",children:"apiVersion: v1\nkind: Pod\nmetadata:\n  labels:\n    app: game-server\n  name: game-server-58cb9f5688-7sbd8\n  namespace: ns\n...\nstatus:\n  conditions:\n    # podConditionType\n  - type: game.io/idle\n    # Probe State 'Succeeded' indicates 'True', and 'Failed' indicates 'False'\n    status: \"True\"\n    lastProbeTime: \"2022-09-09T07:13:04Z\"\n    lastTransitionTime: \"2022-09-09T07:13:04Z\"\n    # If the probe fails to execute, the message is stderr\n    message: \"\"\n"})}),"\n",(0,o.jsxs)(n.p,{children:["This method can be used in combination with Kubernetes ",(0,o.jsx)(n.a,{href:"https://kubernetes.io/docs/concepts/workloads/pods/pod-lifecycle/#pod-readiness-gate",children:"Readiness Gate"})," to flexibly control whether the Pod is Ready."]}),"\n",(0,o.jsx)(n.h3,{id:"pod-metadata",children:"Pod Metadata"}),"\n",(0,o.jsx)(n.p,{children:"If the user defines the MarkerPolicy, OpenKruise will patch the specific Metadata to the Pod, as follows:"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-yaml",children:"apiVersion: v1\nkind: Pod\nmetadata:\n  labels:\n    app: game-server\n    gameserver-idle: 'true'\n  annotations:\n    controller.kubernetes.io/pod-deletion-cost: '-10'\n  name: game-server-58cb9f5688-7sbd8\n  namespace: ns\n"})}),"\n",(0,o.jsxs)(n.p,{children:["OpenKruise ",(0,o.jsx)(n.a,{href:"https://openkruise.io/docs/user-manuals/cloneset#update-sequence",children:"CloneSet"})," and ",(0,o.jsx)(n.a,{href:"https://openkruise.io/docs/user-manuals/advancedstatefulset#update-sequence",children:"Advanced StatefulSet"}),"\nsupport the ability to control upgrade priorities based on Pod Labels. At the same time, community-native Deployment and Kruise CloneSet also support scaling down priority and upgrade order based on ",(0,o.jsx)(n.a,{href:"https://kubernetes.io/docs/concepts/workloads/controllers/replicaset/#pod-deletion-cost",children:"Deletion Cost"}),".\nTherefore, the Custom Probe MarkerPolicy can be combined with the above capabilities to achieve the effect of scaling down or upgrading the priority."]}),"\n",(0,o.jsx)(n.h3,{id:"pod-event",children:"Pod Event"}),"\n",(0,o.jsx)(n.p,{children:"Through the pod event, you can view the historical probe execution results, as follows:"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{children:"$ kubectl describe pods -n ns game-server-58cb9f5688-7sbd8\nEvents:\n  Type    Reason                Age                From                         Message\n  ----    ------                ----               ----                         -------\n  Normal  KruiseProbeFailed     37s (x2 over 47s)  kruise-daemon-podprobe\n  Normal  KruiseProbeSucceeded  36s (x2 over 37s)  kruise-daemon-podprobe\n"})})]})}function p(e={}){const{wrapper:n}={...(0,r.R)(),...e.components};return n?(0,o.jsx)(n,{...e,children:(0,o.jsx)(c,{...e})}):c(e)}},28453:(e,n,s)=>{s.d(n,{R:()=>i,x:()=>a});var t=s(96540);const o={},r=t.createContext(o);function i(e){const n=t.useContext(r);return t.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function a(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(o):e.components||o:i(e.components),t.createElement(r.Provider,{value:n},e.children)}}}]);