# 安装

## 安装OpenKruiseGame（OKG）

### 安装说明

安装OpenKruiseGame需安装Kruise与Kruise-Game，且要求 Kubernetes版本 >= 1.18。

### 安装Kruise

建议采用 helm v3.5+ 来安装 Kruise。

```shell
# Firstly add openkruise charts repository if you haven't do this.
$ helm repo add openkruise https://openkruise.github.io/charts/
# [Optional]
$ helm repo update
# Install the latest version.
$ helm install kruise openkruise/kruise --version 1.8.0
```

### 安装Kruise-Game

```shell
$ helm install kruise-game openkruise/kruise-game --version 1.0.0
```

### 升级 Kruise-Game

```shell
$ helm upgrade kruise-game openkruise/kruise-game --version 1.0.0 [--force]
```

### 可选项

#### 可选：使用自定义配置安装/升级

下表列出了 kruise-game 的可配置参数及其默认值。

| Parameter                                  | Description                                             | Default                          |
|--------------------------------------------|---------------------------------------------------------|----------------------------------|
| `installation.namespace`                   | kruise-game 安装到的 namespace，一般不建议修改                      | `kruise-game-system`             |
| `installation.createNamespace`             | 是否需要创建上述 namespace，一般不建议修改，除非指定安装到已有的 ns 中              | `true`                           |
| `kruiseGame.fullname`                      | kruise-game 部署和其他配置的名称                                  | `kruise-game-controller-manager` |
| `kruiseGame.healthBindPort`                | 用于检查 kruise-game 容器健康检查的端口                              | `8082`                           |
| `kruiseGame.webhook.port`                  | kruise-game 容器服务的 webhook 端口                            | `443`                            |
| `kruiseGame.webhook.targetPort`            | 用于 MutatingWebhookConfigurations 中工作负载的 ObjectSelector  | `9876`                           |
| `kruiseGame.apiServerQps`                  | kruise-game-controller-manager 每秒发送到 API server的最大持续查询数 | `5`                              |
| `kruiseGame.apiServerQpsBurst`             | kruise-game-controller-manager 每秒发送到 API server的最大突发查询数 | `10`                             |
| `kruiseGame.leaderElection`               | 是否开启 leader-election 功能以支持高可用部署                        | `false`                          |
| `replicaCount`                             | kruise-game 的期望副本数                                      | `1`                              |
| `image.repository`                         | kruise-game 的镜像仓库                                       | `openkruise/kruise-game-manager` |
| `image.tag`                                | kruise-game 的镜像版本                                       | `v0.10.0`                        |
| `image.pullPolicy`                         | kruise-game 的镜像拉取策略                                     | `Always`                         |
| `serviceAccount.annotations`               | kruise-game的serviceAccount注解                            | ` `                              |
| `resources.limits.cpu`                     | kruise-game容器的CPU资源限制                                   | `500m`                           |
| `resources.limits.memory`                  | kruise-game容器的内存资源限制                                    | `1Gi`                            |
| `resources.requests.cpu`                   | kruise-game容器的CPU资源请求                                   | `10m`                            |
| `resources.requests.memory`                | kruise-game容器的内存资源请求                                    | `64Mi`                           |
| `prometheus.enabled`                       | 是否创建指标监控服务                                              | `false`                          |
| `prometheus.monitorService.port`           | monitorService的监听端口                                     | `8080`                           |
| `scale.service.port`                       | 伸缩服务监听端口                                                | `6000`                           |
| `scale.service.targetPort`                 | 伸缩服务目标端口                                                | `6000`                           |
| `network.totalWaitTime`                    | 等待网络Ready的最长时间，单位是秒                                     | `60`                             |
| `network.probeIntervalTime`                | 探测网络状态的时间间隔，单位是秒                                        | `5`                              |
| `cloudProvider.installCRD`                 | 是否安装 CloudProvider 相关CRD资源                              | `true`                           |
| `indexOffsetScheduler.enabled`             | 是否安装游戏服序号感知调度器                                          | `false`                          |
| `certificates.autoGenerated`               | 是否自动生成 webhook 证书                                       | `true`                           |
| `certificates.secretName`                  | 包含 webhook 证书的 secret 名称                                | `kruise-game-certs`              |
| `certificates.mountPath`                   | 在容器中挂载 webhook 证书的路径                                    | `/tmp/webhook-certs/`            |
| `certificates.certManager.enabled`         | 是否使用 cert-manager 进行证书管理                                | `false`                          |
| `certificates.certManager.duration`        | 证书有效期                                                   | `8760h0m0s`                      |
| `certificates.certManager.renewBefore`     | 证书到期前续订时间                                               | `5840h0m0s`                      |
| `certificates.certManager.generateCA`      | 是否生成证书颁发机构                                              | `true`                           |
| `certificates.certManager.caSecretName`    | 包含 CA 证书的机密名称                                           | `kruise-game-ca`                 |
| `certificates.certManager.issuer.generate` | 是否自动生成issuer                                            | `true`                           |
| `certificates.certManager.issuer.name`     | issuer 的名称                                              | `kruise-ca`                      |
| `certificates.certManager.issuer.kind`     | issuer 类型                                               | `ClusterIssuer`                  |
| `certificates.certManager.issuer.group`    | issuer的API group                                        | `cert-manager.io`                |

使用 `--set key=value[,key=value]` 参数指定每个参数到 `helm install`,例如,

#### 可选：中国地区的镜像

如果你在中国并且无法从官方 DockerHub 拉取镜像，你可以使用托管在阿里云上的镜像:

```bash
$ helm install kruise-game https://... --set image.repository=registry-cn-hangzhou.ack.aliyuncs.com/acs/kruise-game-manager
```

#### 可选：使用高可用部署

如果你想要使用高可用部署，需要配置使用certManager托管证书，并开启leader-election和设置 `replicaCount` 大于等于3，例如:

```bash
$ helm install kruise-game openkruise/kruise-game \
    --set replicaCount=3 \
    --set certificates.autoGenerated=false \
    --set certificates.certManager.enabled=true \
    --set kruiseGame.leaderElection=true
```

如果需要升级已有的部署，可以参考使用如下命令:

```bash
# 使用helm纳管webhook, helm <= v3.16>
$ kubectl label mutatingwebhookconfiguration kruise-game-mutating-webhook app.kubernetes.io/managed-by=Helm
$ kubectl annotate mutatingwebhookconfiguration kruise-game-mutating-webhook meta.helm.sh/release-name=kruise-game
$ kubectl annotate mutatingwebhookconfiguration kruise-game-mutating-webhook meta.helm.sh/release-namespace=default
$ kubectl label validatingwebhookconfiguration kruise-game-validating-webhook app.kubernetes.io/managed-by=Helm
$ kubectl annotate validatingwebhookconfiguration kruise-game-validating-webhook meta.helm.sh/release-name=kruise-game
$ kubectl annotate validatingwebhookconfiguration kruise-game-validating-webhook meta.helm.sh/release-namespace=default

$ helm upgrade kruise-game openkruise/kruise-game \
    --set replicaCount=3 \
    --set certificates.autoGenerated=false \
    --set certificates.certManager.enabled=true \
    --set kruiseGame.leaderElection=true

# helm > v3.17, 可直接使用 --take-ownership 参数
$ helm upgrade kruise-game openkruise/kruise-game --take-ownership \
    --set replicaCount=3 \
    --set certificates.autoGenerated=false \
    --set certificates.certManager.enabled=true \
    --set kruiseGame.leaderElection=true
```

## 卸载OpenKruiseGame（OKG）

请注意，这将导致删除 kruise-game 创建的所有资源，包括 webhook 配置、服务、命名空间、CRD 和 CR 实例 kruise-game 控制器！
请仅在您完全了解后果后才这样做。
如果安装了 helm charts，则卸载 kruise-game:

```bash
$ helm uninstall kruise-game
release "kruise-game" uninstalled
```

## 常见问题

Q: 出现错误 `no matches for kind "ServiceMonitor" in version "monitoring.coreos.com/v1"`
A: 这是因为集群并没有安装prometheus operator。启用游戏服监控功能需要安装prometheus operator于Kubernetes集群。若您不使用该功能，可以在安装时将 prometheus.enabled 设置为false（默认为true）

Q: 出现错误 `CustomResourceDefinition "poddnats.alibabacloud.com" in namespace "" exists and cannot be imported into the cureent release`
A: 这是因为在集群中已经安装了该CRD，您可以在安装时将cloudProvider.installCRD设置为false（默认为true）

## What's Next
接下来，我们推荐你:
- 了解 kruise-game 的 [部署游戏服](user-manuals/deploy-gameservers.md).
