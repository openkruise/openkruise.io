"use strict";(globalThis.webpackChunkopenkruise_io=globalThis.webpackChunkopenkruise_io||[]).push([[1977],{32295:e=>{e.exports=JSON.parse('{"archive":{"blogPosts":[{"id":"elastic","metadata":{"permalink":"/zh/blog/elastic","editUrl":"https://github.com/openkruise/openkruise.io/edit/master/blog/2025-02-19-elastic-components.md","source":"@site/i18n/zh/docusaurus-plugin-content-blog/2025-02-19-elastic-components.md","title":"\u9762\u5411Workload\u7ea7\u522b\u7684\u7075\u6d3b\u53ef\u914d\u7f6eServerless\u5f39\u6027\u89e3\u51b3\u65b9\u6848","description":"Serverless\u662f\u4e91\u8ba1\u7b97\u7684\u8fdb\u4e00\u6b65\u5ef6\u4f38\uff0c\u56e0\u6b64\u5176\u7ee7\u627f\u4e86\u4e91\u8ba1\u7b97\u7684\u6700\u5927\u7279\u70b9\uff0c\u5373\u6309\u9700\u5f39\u6027\u4f38\u7f29\u3002\u8fd9\u6837\u7684\u6a21\u578b\u8bbe\u8ba1\u8ba9\u5f00\u53d1\u8005\u65e0\u9700\u5173\u6ce8\u5177\u4f53\u7684\u90e8\u7f72\u8d44\u6e90\uff0c\u5145\u5206\u5229\u7528\u8d44\u6e90\u89c4\u6a21\u6548\u5e94\uff0c\u63d0\u4f9b\u66f4\u597d\u7684\u5f39\u6027\u80fd\u529b\uff0c\u4e5f\u80fd\u8ba9\u4f01\u4e1a\u5207\u5b9e\u4eab\u53d7\u5230\u771f\u6b63\u7684\u6309\u9700\u4f7f\u7528\u7279\u5f81\u3002\u6b63\u56e0\u5982\u6b64\uff0c\u66f4\u591a\u7684\u4e91\u5382\u5546\u4eec\u4e0d\u7ea6\u800c\u540c\u5730\u8f6c\u5411Serverless\u8fd9\u4e00\u65b0\u7684\u67b6\u6784\u8bbe\u8ba1\u7406\u5ff5\u3002","date":"2025-02-19T00:00:00.000Z","tags":[{"inline":true,"label":"workload","permalink":"/zh/blog/tags/workload"},{"inline":true,"label":"uniteddeployment","permalink":"/zh/blog/tags/uniteddeployment"},{"inline":true,"label":"workloadspread","permalink":"/zh/blog/tags/workloadspread"},{"inline":true,"label":"best-practice","permalink":"/zh/blog/tags/best-practice"}],"readingTime":20.3,"hasTruncateMarker":false,"authors":[{"name":"Tianyun Zhong","title":"Member of OpenKruise","url":"https://github.com/AiRanthem","imageURL":"https://github.com/AiRanthem.png","key":"AiRanthem","page":null}],"frontMatter":{"slug":"elastic","title":"\u9762\u5411Workload\u7ea7\u522b\u7684\u7075\u6d3b\u53ef\u914d\u7f6eServerless\u5f39\u6027\u89e3\u51b3\u65b9\u6848","authors":["AiRanthem"],"tags":["workload","uniteddeployment","workloadspread","best-practice"]},"unlisted":false,"nextItem":{"title":"OpenKruise V1.4 \u7248\u672c\u89e3\u8bfb\uff1a\u65b0\u589eJob Sidecar Terminator\u80fd\u529b","permalink":"/zh/blog/openkruise-1.4"}},"content":"Serverless\u662f\u4e91\u8ba1\u7b97\u7684\u8fdb\u4e00\u6b65\u5ef6\u4f38\uff0c\u56e0\u6b64\u5176\u7ee7\u627f\u4e86\u4e91\u8ba1\u7b97\u7684\u6700\u5927\u7279\u70b9\uff0c\u5373\u6309\u9700\u5f39\u6027\u4f38\u7f29\u3002\u8fd9\u6837\u7684\u6a21\u578b\u8bbe\u8ba1\u8ba9\u5f00\u53d1\u8005\u65e0\u9700\u5173\u6ce8\u5177\u4f53\u7684\u90e8\u7f72\u8d44\u6e90\uff0c\u5145\u5206\u5229\u7528\u8d44\u6e90\u89c4\u6a21\u6548\u5e94\uff0c\u63d0\u4f9b\u66f4\u597d\u7684\u5f39\u6027\u80fd\u529b\uff0c\u4e5f\u80fd\u8ba9\u4f01\u4e1a\u5207\u5b9e\u4eab\u53d7\u5230\u771f\u6b63\u7684\u6309\u9700\u4f7f\u7528\u7279\u5f81\u3002\u6b63\u56e0\u5982\u6b64\uff0c\u66f4\u591a\u7684\u4e91\u5382\u5546\u4eec\u4e0d\u7ea6\u800c\u540c\u5730\u8f6c\u5411Serverless\u8fd9\u4e00\u65b0\u7684\u67b6\u6784\u8bbe\u8ba1\u7406\u5ff5\u3002\\n\\n\u201c\u7075\u6d3b\u53ef\u914d\u7f6e\u201d\u4f5c\u4e3aServerless\u6280\u672f\u7684\u5f39\u6027\u6838\u5fc3\u80fd\u529b\u4e4b\u4e00\uff0c\u6240\u5173\u6ce8\u7684\u662f\u201c\u901a\u8fc7\u7b80\u5355\u3001\u5c11\u4fb5\u5165\u3001\u7075\u6d3b\u53ef\u914d\u7f6e\u7684\u65b9\u6cd5\u8ba9\u5177\u4f53\u7528\u4e91\u573a\u666f\u80fd\u5145\u5206\u4f7f\u7528\u5f39\u6027\u8d44\u6e90\u201d\u3002\u5176\u672c\u8d28\u662f\u89e3\u51b3\u4e86\u5bb9\u91cf\u89c4\u5212\u4e0e\u5b9e\u9645\u96c6\u7fa4\u8d1f\u8f7d\u914d\u7f6e\u95f4\u7684\u77db\u76fe\u3002\u672c\u6587\u5c06\u4f9d\u6b21\u4ecb\u7ecd\\nWorkloadSpread \u4e0e UnitedDeployment \u4e24\u79cd\u8d44\u6e90\u53ef\u914d\u7f6e\u63d2\u4ef6\uff0c\u8be6\u7ec6\u63a2\u8ba8\u5b83\u4eec\u7684\u6838\u5fc3\u80fd\u529b\u3001\u6280\u672f\u539f\u7406\u4e0e\u4f18\u52a3\u52bf\uff0c\u4ee5\u53ca\u5728\u771f\u5b9e\u573a\u666f\u4e2d\u7684\u5e94\u7528\u3002\u901a\u8fc7\u8fd9\u4e9b\u5185\u5bb9\u5206\u4eab\\nOpenKruise \u793e\u533a\u5728\u5e94\u5bf9 Serverless \u8d1f\u8f7d\u5f39\u6027\u95ee\u9898\u65f6\u7684\u6280\u672f\u6f14\u8fdb\u548c\u601d\u8003\u3002\\n\\n# \u5f39\u6027\u573a\u666f\u6982\u8ff0\\n\\n\u968f\u7740 Serverless \u6280\u672f\u7684\u6210\u719f\uff0c\u8d8a\u6765\u8d8a\u591a\u4f01\u4e1a\u503e\u5411\u4e8e\u4f7f\u7528\u5f39\u6027\u8d44\u6e90\uff08\u5982\u963f\u91cc\u4e91 ACS \u7b49 Serverless \u5bb9\u5668\u5b9e\u4f8b\uff09\u800c\u975e\u9759\u6001\u8d44\u6e90\uff08\u5982\u7531\u4e91\u670d\u52a1\u5668\\n\u7ec4\u6210\u7684\u6258\u7ba1\u8d44\u6e90\u6c60\u3001\u81ea\u5efa\u7684 IDC \u673a\u623f\u7b49\uff09\u6765\u627f\u8f7d\u5177\u6709\u4e34\u65f6\u6027\u3001\u6f6e\u6c50\u6027\u3001\u7a81\u53d1\u6027\u7b49\u7279\u5f81\u7684\u5e94\u7528\uff0c\u4ee5\u6309\u9700\u4f7f\u7528\u7684\u5f62\u5f0f\u63d0\u9ad8\u8d44\u6e90\u5229\u7528\u6548\u7387\uff0c\u964d\u4f4e\u6574\u4f53\u6210\u672c\u3002\u4e0b\u9762\u5217\u51fa\u4e00\u4e9b\u5178\u578b\u7684\u5f39\u6027\u573a\u666f\uff1a\\n\\n1. \u4f18\u5148\u4f7f\u7528\u7ebf\u4e0bIDC\u673a\u623f\u7684\u81ea\u5efa\u8d44\u6e90\uff0c\u5f53\u8d44\u6e90\u4e0d\u8db3\u65f6\uff0c\u5c06\u5e94\u7528\u526f\u672c\u6269\u5c55\u5230\u4e91\u4e0a\u627f\u8f7d\u3002\\n\\n2. \u4f18\u5148\u4f7f\u7528\u5305\u5e74\u5305\u6708\u8d2d\u4e70\u7684\u6258\u7ba1\u8282\u70b9\u8d44\u6e90\u6c60\uff0c\u8d44\u6e90\u4e0d\u8db3\u65f6\u4f7f\u7528\u6309\u91cf\u4ed8\u8d39\u7684 Serverless \u5b9e\u4f8b\u627f\u8f7d\u526f\u672c\u3002\\n\\n3. \u4f18\u5148\u4f7f\u7528\u6301\u6709\u7684\u9ad8\u8d28\u91cf\u7a33\u5b9a\u7b97\u529b\uff08\u5982\u72ec\u4eab\u578b\u7684\u4e91\u670d\u52a1\u5668\u5b9e\u4f8b\uff09\uff0c\u7528\u5b8c\u540e\u518d\u4f7f\u7528\u8f83\u4f4e\u8d28\u91cf\u7684\u7b97\u529b\uff08\u5982 Spot \u5b9e\u4f8b\uff09\u3002\\n\\n4. \u4e3a\u90e8\u7f72\u5230\u4e0d\u540c\u7b97\u529b\u5f62\u5f0f\uff08\u5982 X86 \u67b6\u6784\u3001ARM \u67b6\u6784\u3001Serverless \u5b9e\u4f8b\u7b49\uff09\u4e0a\u7684\u5bb9\u5668\u526f\u672c\u914d\u7f6e\u4e0d\u540c\u7684\u8d44\u6e90\u91cf\uff0c\u4ee5\u83b7\u5f97\u76f8\u4f3c\u7684\u6027\u80fd\u8868\u73b0\u3002\\n\\n5. \u4e3a\u90e8\u7f72\u5230\u8282\u70b9\u4e0a\u4e0e Serverless \u73af\u5883\u7684\u526f\u672c\u6ce8\u5165\u4e0d\u540c\u7684\u4e2d\u95f4\u4ef6\u914d\u7f6e\uff08\u5982\u8282\u70b9\u4e0a\u526f\u672c\u4f7f\u7528\u5171\u4eab Daemon\uff0cServerless \u526f\u672c\u6ce8\u5165 Sidecar\uff09\\n\\n\u672c\u6587\u4ecb\u7ecd\u7684\u4e24\u79cd\u7ec4\u4ef6\uff0c\u5728\u89e3\u51b3\u4e0a\u8ff0\u95ee\u9898\uff0c\u5177\u6709\u5404\u81ea\u7684\u4f18\u52bf\u573a\u666f\u3002\u7528\u6237\u53ef\u4ee5\u6839\u636e\u81ea\u8eab\u5b9e\u9645\u573a\u666f\u9009\u62e9\u5408\u9002\u7684\u80fd\u529b\u6765\u7528\u597d\u5f39\u6027\u7b97\u529b\u3002\\n\\n# \u4e24\u79cd\u7ec4\u4ef6\u7684\u80fd\u529b\u53ca\u5176\u4f18\u52bf\u573a\u666f\u6982\u8ff0\\n\\n* WorkloadSpread\uff1a\u901a\u8fc7 Webhook \u5de5\u4f5c\u673a\u5236\u62e6\u622a\u7b26\u5408\u6761\u4ef6\u7684 Pod \u521b\u5efa\u8bf7\u6c42\uff0c\u5e76\u5bf9\u5176\u6267\u884c Patch \u64cd\u4f5c\u5b8c\u6210\u5dee\u5f02\u5316\u914d\u7f6e\u6ce8\u5165\u3002\u9002\u5408\u9700\u8981\u5c06\u8d44\u6e90\u5212\u5206\u4e3a\u591a\u4e2a\u5f39\u6027\u5206\u533a\uff0c\u5e76\u4e3a\u5404\u5206\u533a\u5185\\n  Pod \u7684 Metadata\u3001Spec \u7b49\u5b57\u6bb5\u8fdb\u884c\u81ea\u5b9a\u4e49\u914d\u7f6e\u7684\u73b0\u5b58\u4e1a\u52a1\u3002\\n\\n* UnitedDeployment\uff1a\u4e00\u79cd\u539f\u751f\u652f\u6301\u5f39\u6027\u5206\u533a\u4e0e Pod \u81ea\u5b9a\u4e49\u914d\u7f6e\u7684\u5de5\u4f5c\u8d1f\u8f7d\uff0c\u5177\u6709\u6bd4 WorkloadSpread\\n  \u66f4\u5f3a\u7684\u5f39\u6027\u4e0e\u5bb9\u91cf\u89c4\u5212\u80fd\u529b\uff0c\u9002\u5408\u9700\u8981\u5212\u5206\u591a\u4e2a\u5f39\u6027\u5206\u533a\u5e76\u4e3a\u5404\u4e2a\u5206\u533a\u5355\u72ec\u8fdb\u884c\u914d\u7f6e\u7684\u65b0\u4e1a\u52a1\u3002\\n\\n# WorkloadSpread\uff1a\u57fa\u4e8e Pod Webhook \u7684\u5f39\u6027\u7b56\u7565\u63d2\u4ef6\\n\\nWorkloadSpread \u662f\u7531 OpenKruise \u793e\u533a\u63d0\u4f9b\u7684\u4e00\u4e2a\u65c1\u8def\u7ec4\u4ef6\uff0c\u80fd\u591f\u6839\u636e\u7279\u5b9a\u89c4\u5219\u5c06\u76ee\u6807\u5de5\u4f5c\u8d1f\u8f7d\u7684 Pod\\n\u5206\u5e03\u5230\u4e0d\u540c\u7c7b\u578b\u7684\u8282\u70b9\u4e0a\uff0c\u4ece\u800c\u8d4b\u4e88\u539f\u59cb\u5de5\u4f5c\u8d1f\u8f7d\u591a\u533a\u57df\u90e8\u7f72\u548c\u5f39\u6027\u90e8\u7f72\u7684\u80fd\u529b\u3002\\nWorkloadSpread \u652f\u6301\u51e0\u4e4e\u6240\u6709\u539f\u751f\u6216\u81ea\u5b9a\u4e49\u7684\u5de5\u4f5c\u8d1f\u8f7d\u7c7b\u578b\u3002\u80fd\u591f\u5728\u907f\u514d\u5bf9\u539f\u59cb\u5de5\u4f5c\u8d1f\u8f7d\u7684\u76f4\u63a5\u4fee\u6539\u7684\u540c\u65f6\uff0c\u589e\u5f3a\u4e86\u5de5\u4f5c\u8d1f\u8f7d\u5728\u591a\u79cd\u73af\u5883\u4e2d\u7684\u9002\u5e94\u6027\u548c\u7075\u6d3b\u6027\uff0c\u4f7f\u5176\u80fd\u591f\u66f4\u597d\u5730\u5e94\u5bf9\u4e0d\u540c\u7684\u90e8\u7f72\u9700\u6c42\u548c\u8fd0\u884c\u6761\u4ef6\u3002\\n\u4e0b\u9762\u662f\u4e00\u4e2a\u5178\u578b WorkloadSpread \u793a\u4f8b\uff1a\\n\\n```yaml\\napiVersion: apps.kruise.io/v1alpha1\\nkind: WorkloadSpread\\nmetadata:\\n  name: workloadspread-demo\\nspec:\\n  targetRef: # WorkloadSpread \u540c\u65f6\u652f\u6301 K8S \u539f\u751f\u4e0e Kruise \u5de5\u4f5c\u8d1f\u8f7d\\n    apiVersion: apps/v1 | apps.kruise.io/v1alpha1\\n    kind: Deployment | CloneSet\\n    name: workload-xxx\\n  subsets:\\n    - name: subset-a\\n      # \u524d\u4e09\u4e2a\u526f\u672c\u8c03\u5ea6\u5230\u8be5 Subset \u4e2d\\n      maxReplicas: 3\\n      # Pod \u7684\u4eb2\u548c\u6027\u914d\u7f6e\\n      requiredNodeSelectorTerm:\\n        matchExpressions:\\n          - key: topology.kubernetes.io/zone\\n            operator: In\\n            values:\\n              - zone-a\\n      patch:\\n        # \u4e3a\u8c03\u5ea6\u5230\u8be5 Subset \u4e2d\u7684 Pod \u989d\u5916\u6ce8\u5165\u4e00\u4e2a\u81ea\u5b9a\u4e49 Label\\n        metadata:\\n          labels:\\n            xxx-specific-label: xxx\\n    - name: subset-b\\n      # \u5f39\u6027 Subset \u90e8\u7f72\u5230 Serverless \u96c6\u7fa4\uff0c\u4e0d\u914d\u7f6e\u5bb9\u91cf\uff0c\u526f\u672c\u6570\u4e0d\u8bbe\u4e0a\u9650\\n      requiredNodeSelectorTerm:\\n        matchExpressions:\\n          - key: topology.kubernetes.io/zone\\n            operator: In\\n            values:\\n              - acs-cn-hangzhou\\n  scheduleStrategy:\\n    # \u8c03\u5ea6\u7b56\u7565\uff0cAdaptive \u6a21\u5f0f\u4f1a\u5c06\u8c03\u5ea6\u5931\u8d25\u7684 Pod \u91cd\u65b0\u8c03\u5ea6\u5230\u5176\u4ed6 Subset\\n    type: Adaptive | Fixed\\n    adaptive:\\n      rescheduleCriticalSeconds: 30\\n```\\n\\n## \u5f3a\u5927\u7684\u5206\u533a\u80fd\u529b\\n\\nWorkloadSpread \u901a\u8fc7 Subsets \u6765\u5212\u5206\u4e0d\u540c\u7684\u5f39\u6027\u5206\u533a\uff0c**\u6309\u7167 Subsets \u987a\u5e8f\u6b63\u5411\u6269\u5bb9\u3001\u9006\u5411\u7f29\u5bb9\u3002**\\n\\n### \u7075\u6d3b\u7684\u8c03\u5ea6\u914d\u7f6e\\n\\n\u5728 Subset \u5c42\u9762\uff0cWorkloadSpread \u4e0d\u4ec5\u652f\u6301\u901a\u8fc7 Label \u9009\u5b9a\u8282\u70b9\uff0c\u8fd8\u652f\u6301\u7ec6\u81f4\u5730\u81ea\u5b9a\u4e49 Subset \u4e2d Pod \u7684\u6c61\u70b9\u4e0e\u5bb9\u5fcd\u5ea6\u914d\u7f6e\u3002\\n\u4f8b\u5982\uff0c\u901a\u8fc7 `requiredNodeSelectorTerm`\u5b57\u6bb5\u53ef\u4ee5\u6307\u5b9a\u5fc5\u987b\u6ee1\u8db3\u7684\u8282\u70b9\u5c5e\u6027\u3001\u901a\u8fc7 `preferredNodeSelectorTerms` \u5b57\u6bb5\u8bbe\u7f6e\u4f18\u9009\u7684\u8282\u70b9\u5c5e\u6027\u3001\u4ee5\u53ca\u901a\u8fc7\\n`tolerations`\u5b57\u6bb5\u914d\u7f6e Pod \u5bf9\u8282\u70b9\u6c61\u70b9\u7684\u5bb9\u5fcd\u5ea6\u3002\\n\u8fd9\u4e9b\u9ad8\u7ea7\u914d\u7f6e\u9009\u9879\u4f7f\u5f97 WorkloadSpread \u80fd\u591f\u66f4\u52a0\u7cbe\u51c6\u5730\u63a7\u5236 Pod \u7684\u8c03\u5ea6\u548c\u5206\u5e03\uff0c\u4ece\u800c\u6ee1\u8db3\u5404\u79cd\u590d\u6742\u7684\u90e8\u7f72\u9700\u6c42\u3002\\n\\n\u5728\u5168\u5c40\u5c42\u9762\uff0cWorkloadSpread \u652f\u6301\u901a\u8fc7`scheduleStrategy`\u5b57\u6bb5\u914d\u7f6e\u4e24\u79cd\u4e0d\u540c\u7684\u8c03\u5ea6\u7b56\u7565\uff1aFixed \u4e0e Adaptive\u3002Fixed \u7b56\u7565\u786e\u4fdd Pod\\n\u4e25\u683c\u6309\u7167\u9884\u5b9a\u4e49\u7684 Subsets \u8fdb\u884c\u5206\u5e03\uff0c\u5373\u4f7f\u56e0\u4e3a\u5404\u79cd\u539f\u56e0\u8c03\u5ea6\u5931\u8d25\u3002\\n\u8fd9\u5bf9\u4e8e\u9700\u8981\u7cbe\u786e\u63a7\u5236\u5de5\u4f5c\u8d1f\u8f7d\u5206\u5e03\u7684\u573a\u666f\u975e\u5e38\u6709\u7528\u3002\u800c Adaptive \u7b56\u7565\u5219\u63d0\u4f9b\u4e86\u66f4\u9ad8\u7684\u7075\u6d3b\u6027\uff0c\u5f53\u67d0\u4e2a Subset \u65e0\u6cd5\u6ee1\u8db3\u8c03\u5ea6\u9700\u6c42\u65f6\uff0cPod\\n\u53ef\u4ee5\u81ea\u52a8\u91cd\u65b0\u8c03\u5ea6\u5230\u5176\u4ed6\u6709\u53ef\u7528\u5bb9\u91cf\u7684 Subset \u4e0a\uff0c\u4ece\u800c\u63d0\u9ad8\u7cfb\u7edf\u7684\u5f39\u6027\u548c\u53ef\u9760\u6027\u3002\\n\\n\u901a\u8fc7\u5f3a\u5927\u4e14\u9ad8\u6548\u7684\u8c03\u5ea6\u7b56\u7565\uff0cWorkloadSpread \u80fd\u591f\u5728\u590d\u6742\u7684\u5f39\u6027\u4e1a\u52a1\u573a\u666f\u4e2d\u786e\u4fdd Pod \u5728\u4e0d\u540c\u7684\u5f39\u6027\u5206\u533a\u4e4b\u95f4\u5b9e\u73b0\u7075\u6d3b\u4e14\u5747\u8861\u7684\u5206\u914d\u3002\\n\\n### \u7ec6\u81f4\u7684 Pod \u5b9a\u5236\u914d\u7f6e\u65b9\u5f0f\\n\\n\u5728 WorkloadSpread \u7684 subset \u914d\u7f6e\u4e2d\uff0c\u53ef\u4ee5\u901a\u8fc7 patch \u5b57\u6bb5\u5bf9\u8c03\u5ea6\u5230\u8be5\u5206\u533a\u7684 Pod \u8fdb\u884c\u7ec6\u81f4\u7684\u81ea\u5b9a\u4e49\u3002\u51e0\u4e4e\u6240\u6709 Pod \u4e2d\u652f\u6301 patch\\n\u64cd\u4f5c\u7684\u5b57\u6bb5\u90fd\u53ef\u4ee5\u8fdb\u884c\u4fee\u6539\u3002\\n\u8fd9\u4e9b\u5b57\u6bb5\u5305\u62ec\u4f46\u4e0d\u9650\u4e8e\u5bb9\u5668\u955c\u50cf\u3001\u8d44\u6e90\u9650\u5236\u3001\u73af\u5883\u53d8\u91cf\u3001\u5377\u6302\u8f7d\u3001\u542f\u52a8\u547d\u4ee4\u3001\u63a2\u9488\u914d\u7f6e\u548c\u6807\u7b7e\u7b49\u3002\u901a\u8fc7 Pod \u5b57\u6bb5\u7684\u7cbe\u7ec6\u5316\u5b9a\u5236\uff0cPod\\n\u7684\u57fa\u672c\u89c4\u683c\uff08\u5728\u76ee\u6807\u5de5\u4f5c\u8d1f\u8f7d\u6a21\u677f\u4e2d\u5b9a\u4e49\uff09\u4e0e\u73af\u5883\u9002\u914d\uff08\u5728 subset \u7684 patch \u5b57\u6bb5\u4e2d\u5b9a\u4e49\uff09\u5b9e\u73b0\u4e86\u6709\u6548\u89e3\u8026\uff0c\u4ece\u800c\u4f7f\u5f97\u5de5\u4f5c\u8d1f\u8f7d\u80fd\u591f\u7075\u6d3b\u5730\u9002\u914d\u5404\u79cd\u4e0d\u540c\u7684\u5206\u533a\u73af\u5883\u3002\u4e0b\u9762\u662f\u4e00\u4e9b\u5e38\u7528\u7684\u81ea\u5b9a\u4e49\u793a\u4f8b\uff1a\\n\\n```yaml\\n...\\n# patch pod with a topology label:\\npatch:\\n  metadata:\\n    labels:\\n      topology.application.deploy/zone: \\"zone-a\\"\\n...\\n```\\n\\n\u4ee5\u4e0a\u7247\u6bb5\u5c55\u793a\u4e86\u5982\u4f55\u5bf9 Subset \u4e2d\u7684\u6240\u6709 Pod \u6dfb\u52a0\u6216\u4fee\u6539\u4e00\u4e2a Label\u3002\\n\\n```yaml\\n...\\n# patch pod container resources:\\npatch:\\n  spec:\\n    containers:\\n      - name: main\\n        resources:\\n          limit:\\n            cpu: \\"2\\"\\n            memory: 800Mi\\n...\\n```\\n\\n\u4ee5\u4e0a\u7247\u6bb5\u5c55\u793a\u4e86\u5982\u4f55\u4fee\u6539\u4e00\u4e2a Subset \u4e2d Pod \u7684\u8d44\u6e90\u3002\\n\\n```yaml\\n...\\n# patch pod container env with a zone name:\\npatch:\\n  spec:\\n    containers:\\n      - name: main\\n        env:\\n          - name: K8S_AZ_NAME\\n            value: zone-a\\n...\\n```\\n\\n\u4ee5\u4e0a\u7247\u6bb5\u5c55\u793a\u4e86\u5982\u4f55\u4fee\u6539\u4e00\u4e2a Subset \u4e2d Pod \u7684\u73af\u5883\u53d8\u91cf\u3002\\n\\n## WorkloadSpread \u7684 Pod Webhook \u5de5\u4f5c\u539f\u7406\\n\\nWorkloadSpread \u901a\u8fc7 Pod Webhook \u76f4\u63a5\u4f5c\u7528\u4e8e\u76ee\u6807\u5de5\u4f5c\u8d1f\u8f7d\u6240\u521b\u5efa\u7684 Pod \u800c\u975e\u5de5\u4f5c\u8d1f\u8f7d\u672c\u8eab\uff0c\u56e0\u6b64\u6269\u7f29\u5bb9\u64cd\u4f5c\u4f9d\u7136\u901a\u8fc7\u64cd\u4f5c\u76ee\u6807\u5de5\u4f5c\u8d1f\u8f7d\u7684\\nreplicas \u8fdb\u884c\u3002\u76f8\u6bd4\u4e4b\u4e0b\uff0cElasticWorkload \u5bf9\u539f\u6709\u4e1a\u52a1\u7684\u4fb5\u5165\u6027\u8f83\u5927\uff0c\u800c WorkloadSpread \u5219\u56e0\u4e3a\u5b8c\u5168\u4e0d\u64cd\u4f5c\u76ee\u6807\u5de5\u4f5c\u8d1f\u8f7d\u3001\u6240\u6709\u529f\u80fd\u90fd\u7531\u5355\u72ec\u7684\u63a7\u5236\u5668\u4e0e\\nWebhook \u76f4\u63a5\u4f5c\u7528\u4e8e Pod\uff0c\u56e0\u800c\u5177\u6709\u66f4\u9ad8\u7684\u5185\u805a\u6027\u3002\\n\\n\u5f53\u7b26\u5408\u6761\u4ef6\u7684 Pod \u521b\u5efa\u65f6\uff0cWorkloadSpread \u7684 Pod Webhook \u4f1a\u5c06\u5176\u62e6\u622a\uff0c\u5e76\u8bfb\u53d6\u76f8\u5e94\u7684 WorkloadSpread \u914d\u7f6e\u3002Webhook\\n\u4f1a\u6309\u7167\u6269\u5bb9\u987a\u5e8f\uff0c\u4ece\u914d\u7f6e\u4e2d\u6839\u636e\u5bb9\u91cf\u60c5\u51b5\u9009\u62e9\u4e00\u4e2a\u5408\u9002\u7684 subset \u5206\u914d\u7ed9\u8be5 Pod\uff0c\u5e76\u4f9d\u636e subset \u4e2d\u5b9a\u4e49\u7684\u8c03\u5ea6\u4fe1\u606f\u548c\u81ea\u5b9a\u4e49\u4fe1\u606f\u4fee\u6539 Pod\\n\u7684\u914d\u7f6e\u3002\u540c\u65f6\uff0c\u63a7\u5236\u5668\u8fd8\u4f1a\u7ef4\u62a4\u6240\u6709\u76f8\u5173 Pod \u7684 controller.kubernetes.io/pod-deletion-cost \u6807\u7b7e\uff0c\u4ece\u800c\u786e\u4fdd\u7f29\u5bb9\u987a\u5e8f\u7684\u6b63\u786e\u6027\u3002\\n\\n## WorkloadSpread \u5b58\u5728\u7684\u4e0d\u8db3\u65b9\u9762\\n\\nWorkloadSpread \u5728\u8bbe\u8ba1\u4e0a\u6d89\u53ca\u5230\u591a\u4e2a\u4e0d\u8026\u5408\u7684\u7ec4\u4ef6\uff0c\u5e76\u4e14\u6267\u884c\u8fc7\u7a0b\u8f83\u4e3a\u677e\u6563\uff0c\u56e0\u6b64\u5176\u5b58\u5728\u4e00\u4e9b\u4e0d\u8db3\u4e4b\u5904\u3002\\n\\n### Webhook \u7684\u6f5c\u5728\u98ce\u9669\\n\\nWorkloadSpread \u4f9d\u8d56 Pod Webhook \u6765\u5b9e\u73b0\u5176\u529f\u80fd\uff0c\u56e0\u6b64\u5b83\u4f1a\u62e6\u622a\u96c6\u7fa4\u4e2d\u6240\u6709 Pod \u7684\u521b\u5efa\u8bf7\u6c42\u3002\u5f53\u8fd0\u884c Webhook \u7684 Pod\uff08\u5373\\nkruise-manager\uff09\u6027\u80fd\u4e0d\u8db3\u6216\u53d1\u751f\u6545\u969c\u65f6\uff0c\u53ef\u80fd\u4f1a\u5bfc\u81f4\u6574\u4e2a\u96c6\u7fa4\u65e0\u6cd5\u521b\u5efa\u65b0\u7684 Pod\u3002\u6b64\u5916\uff0c\u5f53\u96c6\u7fa4\u5728\u77ed\u65f6\u95f4\u5185\u9700\u8981\u8fdb\u884c\u5927\u91cf\u7684\u6269\u7f29\u5bb9\u64cd\u4f5c\u65f6\uff0cWebhook\\n\u4e5f\u53ef\u80fd\u4f1a\u6210\u4e3a\u6027\u80fd\u74f6\u9888\u3002\\n\\n### \u4f5c\u7528\u4e8e Pod \u7684\u5c40\u9650\u6027\\n\\n\u5c3d\u7ba1\u901a\u8fc7 Webhook \u76f4\u63a5\u4f5c\u7528\u4e8e Pod \u53ef\u4ee5\u51cf\u5c11\u5bf9\u7528\u6237\u4e1a\u52a1\u7684\u4fb5\u5165\uff0c\u4f46\u8fd9\u79cd\u65b9\u6cd5\u4e5f\u5f15\u5165\u4e86\u4e00\u4e9b\u5c40\u9650\u6027\u3002\u4f8b\u5982\uff0c\u5bf9\u4e8e CloneSet \u800c\u8a00\uff0c\u5b83\u53ea\u80fd\u901a\u8fc7\\npartition \u5b57\u6bb5\u6765\u63a7\u5236\u6574\u4e2a\u96c6\u7fa4\u5185\u7070\u5ea6\u5347\u7ea7\u7684\u6bd4\u4f8b\uff0c\u800c\u65e0\u6cd5\u7cbe\u7ec6\u5730\u63a7\u5236\u6bcf\u4e2a subset \u4e2d\u7684\u7070\u5ea6\u6bd4\u4f8b\u3002\u540c\u6837\u5730\uff0cWorkloadSpread\\n\u7684\u8bbe\u8ba1\u6ce8\u5b9a\u4e86\u5176\u65e0\u6cd5\u5c06\u5de5\u4f5c\u8d1f\u8f7d\u7ea7\u522b\u7684\u80fd\u529b\u5e94\u7528\u5230\u6bcf\u4e2a subset \u4e2d\u3002\\n\\n## \u5ba2\u6237\u6848\u4f8b1\uff1a\u5927\u89c4\u6a21\u538b\u6d4b\u573a\u666f\u4e0b\u8fdb\u884c\u5e26\u5bbd\u5305\u5206\u914d\\n\\n\u8be5\u6848\u4f8b\u4e2d\uff0c\u5ba2\u6237\u9700\u8981\u5728\u67d0\u8d2d\u7269\u8282\u5927\u4fc3\u524d\u5bf9\u7ebf\u4e0a\u7cfb\u7edf\u8fdb\u884c\u538b\u6d4b\u3002\u4e3a\u6b64\uff0c\u5ba2\u6237\u5f00\u53d1\u4e86\u4e00\u4e2a load-agent \u7a0b\u5e8f\u7528\u4e8e\u4ea7\u751f\u8bf7\u6c42\uff0c\u5e76\u901a\u8fc7\u4e00\u4e2a CloneSet\\n\u7ba1\u7406 agent \u7684\u526f\u672c\u6570\u6765\u63a7\u5236\u538b\u6d4b\u6d41\u91cf\u5927\u5c0f\u3002\u5728\u5bf9\u4e1a\u52a1\u573a\u666f\u8fdb\u884c\u5206\u6790\u540e\uff0c\u5ba2\u6237\u5224\u65ad\u538b\u6d4b\u9700\u8981 3000 \u4e2a agent \u526f\u672c\u3002\u4e3a\u4e86\u8282\u7701\u6210\u672c\uff0c\u5ba2\u6237\u5411\u4e91\u670d\u52a1\u5546\u8d2d\u4e70\u4e86\\n10 \u4e2a 200M \u7684\u5171\u4eab\u5e26\u5bbd\u5305\u5b9e\u4f8b\uff08\u6bcf\u4e2a\u5171\u4eab\u5e26\u5bbd\u5305\u53ef\u4ee5\u4f9b300\u4e2aPod\u4f7f\u7528\uff09\uff0c\u671f\u671b\u5c06\u5176\u52a8\u6001\u5730\u5206\u914d\u7ed9\u5f39\u6027\u4f38\u7f29\u7684 agent \u526f\u672c\u3002\\n\\n\u8003\u8651\u5230\u6a21\u62df\u8bf7\u6c42\u7684 CloneSet \u662f\u901a\u8fc7\u5ba2\u6237\u7684\u538b\u6d4b\u7cfb\u7edf\u53d1\u5e03\u4e0e\u52a8\u6001\u4f38\u7f29\u7684\uff0c\u4e0d\u9002\u5408\u91cd\u5efa\uff0c\u56e0\u800c\u5ba2\u6237\u9009\u62e9\u7ed9 CloneSet \u5916\u6302 WorkloadSpread\\n\u6765\u5b9e\u73b0\u5e26\u5bbd\u5305\u7684\u5206\u914d\u3002\u5177\u4f53\u5730\uff0c\u5ba2\u6237\u5728\u538b\u6d4b\u96c6\u7fa4\u4e2d\u521b\u5efa\u4e86\u4e00\u4e2a\u6307\u5411\u4e0a\u8ff0 CloneSet \u7684 WorkloadSpread\uff0c\u5b83\u5305\u542b 11 \u4e2a Subset\uff1a\u524d 10 \u4e2a\\nSubset \u7684\u5bb9\u91cf\u4e3a 300\uff0c\u5e76\u901a\u8fc7 patch \u4fee\u6539\u4e86 Pod \u7684 Annotations \u7528\u4e8e\u7ed1\u5b9a\u5177\u4f53\u7684\u5e26\u5bbd\u5305\uff1b\u6700\u540e\u4e00\u4e2a Subset \u6ca1\u6709\u5bb9\u91cf\uff0c\u4e0d\u6307\u5b9a\u5e26\u5bbd\u5305\uff0c\u7528\u4e8e\u963b\u6b62\u4e07\u4e00\u521b\u5efa\u8d85\u8fc7\\n3000 \u4e2a\u526f\u672c\u540e\u989d\u5916\u7684\u5e26\u5bbd\u5206\u914d\u3002\\n\\n```yaml\\napiVersion: apps.kruise.io/v1alpha1\\nkind: WorkloadSpread\\nmetadata:\\n  name: bandwidth-spread\\n  namespace: loadtest\\nspec:\\n  targetRef:\\n    apiVersion: apps.kruise.io/v1alpha1\\n    kind: CloneSet\\n    name: load-agent-XXXXX\\n  subsets:\\n    - name: bandwidthPackage-1\\n      maxReplicas: 300\\n      patch:\\n        metadata:\\n          annotations:\\n            k8s.aliyun.com/eip-common-bandwidth-package-id: <id1>\\n\\n    - ...\\n\\n    - name: bandwidthPackage-10\\n      maxReplicas: 300\\n      patch:\\n        metadata:\\n          annotations:\\n            k8s.aliyun.com/eip-common-bandwidth-package-id: <id10>\\n    - name: no-eip\\n```\\n\\n## \u5ba2\u6237\u6848\u4f8b2\uff1a\u4e3a\u6258\u7ba1 K8S \u96c6\u7fa4\u4e2d\u7684\u670d\u52a1\u5f39\u6027\u6269\u5bb9\u5230 Serverless \u5b9e\u4f8b\u63d0\u4f9b\u517c\u5bb9\u6027\\n\\n\u8be5\u6848\u4f8b\u4e2d\uff0c\u5ba2\u6237\u6709\u4e00\u4e2a\u8fd0\u884c\u4e8e\u79c1\u6709\u4e91\u7684\u670d\u52a1\u3002\u7531\u4e8e\u4e1a\u52a1\u53d1\u5c55\u9700\u8981\u6269\u5bb9\u66f4\u591a\u7684\u7b97\u529b\uff0c\u4f46\u662f\u6682\u65f6\u65e0\u6cd5\u6269\u5efa\u7ebf\u4e0b\u673a\u623f\uff0c\u56e0\u6b64\u9009\u62e9\u4f7f\u7528\u865a\u62df\u8282\u70b9\u80fd\u529b\u63a5\u5165\u4e91\u4e0a\u7684\\nServerless \u5f39\u6027\u7b97\u529b\u7ec4\u6210\u6df7\u5408\u4e91\u3002\u5ba2\u6237\u7684\u5e94\u7528\u4f7f\u7528\u4e86\u4e00\u4e9b\u52a0\u901f\u670d\u52a1\uff08\u5982 [Fluid](https://github.com/fluid-cloudnative/fluid)\\n\uff09\uff0c\u8fd9\u4e9b\u670d\u52a1\u7ec4\u4ef6\u5728\u79c1\u6709\u4e91\u4e2d\u901a\u8fc7 DaemonSet\\n\u7b49\u65b9\u5f0f\u9884\u5148\u90e8\u7f72\u5728\u4e86\u8282\u70b9\u4e0a\u63d0\u4f9b\u670d\u52a1\uff1b\u4f46\u662f\u5728\u4e91\u4e0a\u6ca1\u6709\u90e8\u7f72\u57fa\u7840\u670d\u52a1\uff0c\u56e0\u800c\u9700\u8981\u4e3a Pod \u989d\u5916\u6ce8\u5165\u4e00\u4e2a sidecar \u6765\u63d0\u4f9b\u52a0\u901f\u80fd\u529b\u3002\\n\\n\u5ba2\u6237\u8bc9\u6c42\u5728\u73b0\u6709\u4e1a\u52a1\u6269\u5bb9\u4e0a\u4e91\u7684\u8fc7\u7a0b\u4e2d\uff0c\u4e0d\u80fd\u53d8\u52a8\u539f\u6709\u5de5\u4f5c\u8d1f\u8f7d\uff08Deployment\uff09\u7684 8 \u4e2a\u526f\u672c\uff0c\u4ec5\u5bf9\u4e91\u4e0a Pod \u7684\u914d\u7f6e\u505a\u4fee\u8ba2\u3002\u5ba2\u6237\u901a\u8fc7\\nWorkloadSpread \u7ed9\u6269\u5bb9\u5230\u4e0d\u540c Subset \u7684 Pod \u5206\u522b\\n\u6253\u4e0a\u4e86\u7528\u4e8e\u63a7\u5236\u662f\u5426\u6ce8\u5165 Fluid Sidecar \u7684\u6807\u7b7e `serverless.fluid.io/inject`\uff0c\u4ee5\u5728 Serverless \u5b9e\u4f8b\u4e2d\u6ce8\u5165 Sidecar\u3002\u76f8\u5173\u793a\u4f8b\u5982\u4e0b\uff1a\\n\\n```yaml\\napiVersion: apps.kruise.io/v1alpha1\\nkind: WorkloadSpread\\nmetadata:\\n  name: data-processor-spread\\nspec:\\n  targetRef:\\n    apiVersion: apps/v1\\n    kind: Deployment\\n    name: data-processor\\n  subsets:\\n    - name: local\\n      maxReplicas: 8\\n      patch:\\n        metadata:\\n          labels:\\n            serverless.fluid.io/inject: \\"false\\"\\n    - name: aliyun-acs\\n      patch:\\n        metadata:\\n          labels:\\n            serverless.fluid.io/inject: \\"true\\"\\n```\\n\\n# UnitedDeployment\uff1a\u539f\u751f\u5177\u5907 Serverless \u5f39\u6027\u80fd\u529b\u7684\u5de5\u4f5c\u8d1f\u8f7d\\n\\nUnitedDeployment \u662f OpenKruise \u793e\u533a\u63d0\u4f9b\u7684\u4e00\u79cd\u539f\u751f\u652f\u6301\u5206\u533a\u7ba1\u7406\u7684\u8f7b\u91cf\u5316\u9ad8\u7ea7\u5de5\u4f5c\u8d1f\u8f7d\u3002\u4e0e ElasticWorkload \u548c WorkloadSpread\\n\u5bf9\u57fa\u7840\u5de5\u4f5c\u8d1f\u8f7d\u8fdb\u884c\u589e\u5f3a\u7684\u8bbe\u8ba1\u7406\u5ff5\u4e0d\u540c\uff0cUnitedDeployment \u63d0\u4f9b\u4e86\u4e00\u79cd\u5168\u65b0\u7684\u6a21\u5f0f\u6765\u7ba1\u7406\u5206\u533a\u5f39\u6027\u5e94\u7528\u3002UnitedDeployment\\n\u8d44\u6e90\u901a\u8fc7\u4e00\u4e2a\u6a21\u677f\u6765\u5b9a\u4e49\u5e94\u7528\uff0c\u63a7\u5236\u5668\u5219\u901a\u8fc7\u521b\u5efa\u5e76\u7ba1\u7406\u591a\u4e2a\u6b21\u7ea7\u5de5\u4f5c\u8d1f\u8f7d\u6765\u5339\u914d\u4e0d\u540c\u7684\u5206\u533a\u3002UnitedDeployment\\n\u6700\u663e\u8457\u7684\u7279\u5f81\u5728\u4e8e\uff0c\u5b83\u4f5c\u4e3a\u4e00\u4e2a\u4e00\u4f53\u5316\u7684\u5f39\u6027\u8d1f\u8f7d\uff0c\u5728\u5355\u4e2a\u8d44\u6e90\u4e2d\u540c\u65f6\u5b8c\u6210\u5e94\u7528\u5b9a\u4e49\u3001\u5206\u533a\u5b9a\u4e49\u3001\u5bb9\u91cf\u7ba1\u7406\u3001\u6269\u7f29\u5bb9\u548c\u5e94\u7528\u5347\u7ea7\u7b49\u5e94\u7528\u5168\u751f\u547d\u5468\u671f\u7ba1\u7406\u3002\u4ee5\u4e0b\u662f\u4e00\u4e2a\u5178\u578b\u7684\\nUnitedDeployment \u8d44\u6e90\u793a\u4f8b\uff1a\\n\\n```yaml\\napiVersion: apps.kruise.io/v1alpha1\\nkind: UnitedDeployment\\nmetadata:\\n  name: sample-ud\\nspec:\\n  replicas: 6\\n  selector:\\n    matchLabels:\\n      app: sample\\n  template:\\n    # UnitedDeployment \u4f1a\u901a\u8fc7\u6b64\u6a21\u677f\u4e3a\u6bcf\u4e2a\u5206\u533a\u521b\u5efa\u4e00\u4e2a CloneSet    \\n    cloneSetTemplate:\\n      metadata:\\n        labels:\\n          app: sample\\n      spec:\\n        # CloneSet Spec\\n        ...\\n  topology:\\n    subsets:\\n      - name: ecs\\n        # \u8be5\u5206\u533a\u7684\u526f\u672c\u8c03\u5ea6\u5230\u5177\u6709\u6807\u7b7e ecs \u7684\u6258\u7ba1\u8282\u70b9\u6c60\u4e0a\\n        nodeSelectorTerm:\\n          matchExpressions:\\n            - key: node\\n              operator: In\\n              values:\\n                - ecs\\n        # \u8be5\u5206\u533a\u6700\u591a\u6709\u4e24\u4e2a\u526f\u672c\\n        maxReplicas: 2\\n      - name: acs-serverless\\n        # acs \u5f39\u6027\u5206\u533a\u526f\u672c\u6570\u65e0\u9650\\n        nodeSelectorTerm:\\n          matchExpressions:\\n            - key: node\\n              operator: In\\n              values:\\n                - acs-virtual-kubelet\\n```\\n\\n## UnitedDeployment \u7684\u4f18\u52bf\\n\\n### \u4e00\u7ad9\u5f0f\u5f39\u6027\u5e94\u7528\u7ba1\u7406\\n\\nUnitedDeployment \u7684\u4e00\u7ad9\u5f0f\u5e94\u7528\u7ba1\u7406\u4f53\u73b0\u5728\u53ea\u9700\u8981\u4f7f\u7528\u4e00\u4e2a\u8d44\u6e90\u5c31\u53ef\u4ee5\u5b8c\u6210\u5e94\u7528\u7684\u5b9a\u4e49\u3001\u5206\u533a\u3001\u6269\u7f29\u5bb9\u3001\u5347\u7ea7\u7b49\u64cd\u4f5c\u3002\\n\\nUnitedDeployment \u63a7\u5236\u5668\u4f1a\u6839\u636e\u5de5\u4f5c\u8d1f\u8f7d\u6a21\u677f\uff0c\u4e3a\u6bcf\u4e2a\u5206\u533a\u7ba1\u7406\u4e00\u4e2a\u5bf9\u5e94\u7c7b\u578b\u7684\u6b21\u7ea7\u5de5\u4f5c\u8d1f\u8f7d\uff0c\u8fd9\u4e9b\u6b21\u7ea7\u5de5\u4f5c\u8d1f\u8f7d\u65e0\u9700\u7528\u6237\u989d\u5916\u5173\u6ce8\u3002\u5728\u4e0a\u56fe\u4e2d\uff0c\u7528\u6237\u53ea\u9700\u8981\u7ba1\u7406\u84dd\u8272\u7684\u5e94\u7528\u4e0e\u5206\u533a\uff0cUnitedDeployment\\n\u63a7\u5236\u5668\u5219\u4f1a\u6839\u636e\u5168\u5c40\u914d\u7f6e\u5b8c\u6210\u540e\u7eed\u5bf9\u5404\u4e2a\u6b21\u7ea7\u5de5\u4f5c\u8d1f\u8f7d\u7684\u7ba1\u7406\u5de5\u4f5c\uff0c\u5305\u62ec\u521b\u5efa\u3001\u4fee\u6539\u3001\u5220\u9664\u7b49\u3002\u9664\u4e86\u76f4\u63a5\u5bf9\u6b21\u7ea7\u5de5\u4f5c\u8d1f\u8f7d\u7684\u7ba1\u7406\uff0c\u5728\u5fc5\u8981\u65f6\uff0c\u63a7\u5236\u5668\u8fd8\u4f1a\u76d1\u63a7\u8fd9\u4e9b\u5de5\u4f5c\u8d1f\u8f7d\u521b\u5efa\u7684\\nPod \u72b6\u6001\u4ee5\u8fdb\u884c\u76f8\u5e94\u7684\u8c03\u6574\u3002\u7531\u4e8e\u6240\u6709\u76f8\u5173\u7684\u8d44\u6e90\u5168\u90fd\u7531\u63a7\u5236\u5668\u76f4\u63a5\u7ba1\u7406\uff0c\u8d44\u6e90\u7684\u64cd\u4f5c\u7684\u53d1\u751f\u65f6\u673a\u662f\u53ef\u63a7\u7684\u3002\u56e0\u6b64\uff0c**UnitedDeployment\\n\u63a7\u5236\u5668\u603b\u80fd\u83b7\u53d6\u76f8\u5173\u8d44\u6e90\u7684\u6b63\u786e\u4fe1\u606f\uff0c\u5e76\u5728\u6b63\u786e\u7684\u65f6\u673a\u5bf9\u5176\u8fdb\u884c\u64cd\u4f5c\uff0c\u800c\u4e0d\u4f1a\u53d1\u751f\u4e00\u81f4\u6027\u95ee\u9898\u3002**\\n\\n\u7528\u6237\u5728 UnitedDeployment \u8d44\u6e90\u4e2d\u914d\u7f6e\u7684\u526f\u672c\u6570\u5c06\u4f1a\u88ab\u63a7\u5236\u5668\u9002\u5f53\u5730\u5206\u914d\u5230\u5404\u4e2a\u6b21\u7ea7\u5de5\u4f5c\u8d1f\u8f7d\u4e0a\uff0c\u7531\u5de5\u4f5c\u8d1f\u8f7d\u63a7\u5236\u5668\u5b9e\u65bd\u5177\u4f53\u7684\u6269\u7f29\u5bb9\u64cd\u4f5c\u3002\u56e0\u6b64\uff0c\\n**\u4f7f\u7528 UnitedDeployment \u7684\u6269\u7f29\u5bb9\u4e0e\u76f4\u63a5\u4f7f\u7528\u5bf9\u5e94\u7684\u5de5\u4f5c\u8d1f\u8f7d\u6269\u7f29\u5bb9\u4ea7\u751f\u5b8c\u5168\u76f8\u540c\u7684\u6548\u679c\uff0c\u7528\u6237\u4e0d\u9700\u8981\u989d\u5916\u5b66\u4e60\u3002**\\n\\n\u5f97\u76ca\u4e8e\u5bf9\u6b21\u7ea7\u5de5\u4f5c\u8d1f\u8f7d\u7684\u76f4\u63a5\u7ba1\u7406\uff0cUnitedDeployment\\n\u5177\u5907\u4e86\u5bf9\u5e94\u7528\u8fdb\u884c\u66f4\u65b0\u548c\u5347\u7ea7\u7684\u80fd\u529b\u3002\u5f53\u5de5\u4f5c\u8d1f\u8f7d\u6a21\u677f\u4e2d\u7684\u914d\u7f6e\u53d1\u751f\u4efb\u4f55\u53d8\u66f4\u65f6\uff0c\u8fd9\u4e9b\u53d8\u66f4\u5c06\u88ab\u540c\u6b65\u5230\u76f8\u5e94\u7684\u6b21\u7ea7\u5de5\u4f5c\u8d1f\u8f7d\u4e2d\uff0c\u5e76\u7531\u5de5\u4f5c\u8d1f\u8f7d\u63a7\u5236\u5668\u6267\u884c\u5177\u4f53\u7684\u5347\u7ea7\u903b\u8f91\u3002\u8fd9\u610f\u5473\u7740\uff0c\u4f8b\u5982\\nCloneSet \u7684\u539f\u5730\u5347\u7ea7\u7b49\u7279\u6027\u53ef\u4ee5\u5728\u5404\u4e2a\u5206\u533a\u5185\u6b63\u5e38\u751f\u6548\u3002\u6b64\u5916\uff0c\u5982\u679c\u5206\u533a\u5185\u7684\u6b21\u7ea7\u5de5\u4f5c\u8d1f\u8f7d\u652f\u6301\u7070\u5ea6\u5347\u7ea7\u7279\u6027\uff0cUnitedDeployment\\n\u8fd8\u80fd\u591f\u7edf\u4e00\u5b83\u4eec\u7684 partition \u5b57\u6bb5\u503c\uff0c\u4ece\u800c\u5b9e\u73b0\u5404\u5206\u533a\u4e4b\u95f4\u66f4\u7ec6\u81f4\u7684\u7070\u5ea6\u63a7\u5236\u3002\\n\\n### \u7ec6\u81f4\u7684\u5206\u533a\u914d\u7f6e\\n\\nUnitedDeployment \u5185\u7f6e\u4e86\u4e24\u79cd\u5bb9\u91cf\u5206\u914d\u7b97\u6cd5\uff0c\u8ba9\u7528\u6237\u53ef\u4ee5\u901a\u8fc7\u7ec6\u81f4\u7684\u5206\u533a\u5bb9\u91cf\u914d\u7f6e\u6765\u5e94\u5bf9\u5f39\u6027\u5e94\u7528\u7684\u5404\u79cd\u573a\u666f\u3002\\n\\n\u5f39\u6027\u5206\u914d\u7b97\u6cd5\u5b9e\u73b0\u4e86\u4e0e ElasticWorkload\u3001WorkloadSpread \u7c7b\u4f3c\u7684\u7ecf\u5178\u5f39\u6027\u5bb9\u91cf\u5206\u914d\u65b9\u5f0f\uff1a\u901a\u8fc7\u4e3a\u6bcf\u4e2a\u5206\u533a\u8bbe\u5b9a\u5bb9\u91cf\u7684\u4e0a\u4e0b\u9650\uff0c\u8ba9 Pod\\n\u6309\u7167\u5206\u533a\u7684\u5b9a\u4e49\u987a\u5e8f\u6b63\u5e8f\u6269\u5bb9\u3001\u9006\u5e8f\u7f29\u5bb9\u3002\u8fd9\u79cd\u65b9\u6cd5\u4e0a\u6587\u5df2\u7ecf\u8fdb\u884c\u4e86\u5145\u5206\u4ecb\u7ecd\uff0c\u6b64\u5904\u4e0d\u518d\u8d58\u8ff0\u3002\\n\\n\u6307\u5b9a\u5206\u914d\u7b97\u6cd5\u5219\u662f\u4e00\u79cd\u65b0\u7684\u5bb9\u91cf\u5206\u914d\u65b9\u5f0f\u3002\u8fd9\u79cd\u65b9\u5f0f\u901a\u8fc7\u56fa\u5b9a\u6570\u503c\u6216\u767e\u5206\u6bd4\u76f4\u63a5\u4e3a\u90e8\u5206\u5206\u533a\u6307\u5b9a\u5bb9\u91cf\uff0c\u5e76\u9884\u7559\u81f3\u5c11\u4e00\u4e2a\u5f39\u6027\u5206\u533a\u7528\u4e8e\u5e73\u644a\u5269\u4f59\u7684\u526f\u672c\u3002\u6307\u5b9a\u5206\u914d\u7b97\u6cd5\u53ef\u4ee5\u9002\u914d\u4e00\u4e9b\u4f20\u7edf\u5f39\u6027\u5206\u914d\u7b97\u6cd5\u65e0\u6cd5\u5e94\u5bf9\u7684\u573a\u666f\u3002\u6bd4\u5982\uff1a\u56fa\u5b9a\u5bb9\u91cf\u9002\u5408\u7ba1\u63a7\u8282\u70b9\u3001\u5165\u53e3\u7f51\u5173\u7b49\u7ec4\u4ef6\uff1b\u767e\u5206\u6bd4\u5bb9\u91cf\u5219\u9002\u5408\u5c06\u6838\u5fc3\u526f\u672c\u5206\u6563\u5230\u4e0d\u540c\u5730\u57df\u8282\u70b9\uff0c\u5e76\u9884\u7559\u4e00\u4e9b\u7a81\u53d1\u5f39\u6027\u8d44\u6e90\u3002\\n\\n\u9664\u4e86\u5bb9\u91cf\u5206\u914d\uff0cUnitedDeployment \u8fd8\u5141\u8bb8\u4e3a\u6bcf\u4e2a\u5206\u533a\u5206\u522b\u914d\u7f6e Pod \u7684\u4efb\u4f55 Spec \u5b57\u6bb5\uff08\u5305\u62ec\u5bb9\u5668\u955c\u50cf\uff0c Image\uff09\uff0c\u8fd9\u4e3a UnitedDeployment\\n\u7684\u5206\u533a\u914d\u7f6e\u8d4b\u4e88\u4e86\u66f4\u4e3a\u5f3a\u5927\u7684\u7075\u6d3b\u6027\uff1a\u7406\u8bba\u4e0a\u751a\u81f3\u53ef\u4ee5\u4f7f\u7528\u4e00\u4e2a UnitedDeployment \u7ba1\u7406\u90e8\u7f72\u4e00\u6574\u5957\u5fae\u670d\u52a1\u5e94\u7528\u6216\u662f\u5927\u6a21\u578b\u63a8\u7406\u7ba1\u7ebf\uff08\u4e0d\u63a8\u8350\u8fd9\u4e48\u505a\uff09\u3002\\n\\n### \u81ea\u9002\u5e94\u5f39\u6027\u80fd\u529b\\n\\nUnitedDeployment \u5177\u5907\u5f3a\u5927\u7684\u81ea\u9002\u5e94\u5f39\u6027\u80fd\u529b\uff0c\u80fd\u591f\u81ea\u52a8\u5730\u5b8c\u6210\u6269\u7f29\u5bb9\u548c\u91cd\u8c03\u5ea6\u7b49\u64cd\u4f5c\uff0c\u800c\u65e0\u9700\u7528\u6237\u8fc7\u591a\u5173\u6ce8\uff0c\u964d\u4f4e\u8fd0\u7ef4\u6210\u672c\u3002\\n\\nUnitedDeployment \u652f\u6301 Kubernetes \u7684\u6c34\u5e73\u81ea\u52a8\u6269\u5c55\uff08HPA\uff09\uff0c\u80fd\u591f\u6839\u636e\u9884\u5148\u914d\u7f6e\u7684\u6761\u4ef6\u81ea\u52a8\u5730\u8fdb\u884c\u6269\u7f29\u5bb9\u64cd\u4f5c\u2014\u2014\u8fd9\u4e9b\u64cd\u4f5c\u4f9d\u7136\u4e25\u683c\u9075\u5faa\u5206\u533a\u914d\u7f6e\u3002\u901a\u8fc7\\nHPA\uff0c\u5e94\u7528\u5728\u67d0\u4e2a\u5206\u533a\u8d44\u6e90\u5373\u5c06\u8017\u5c3d\u65f6\uff0c\u80fd\u591f\u81ea\u52a8\u5411\u5176\u4ed6\u5206\u533a\u6269\u5bb9\uff0c\u5b9e\u73b0\u81ea\u52a8\u4f38\u7f29\uff0c\u4ece\u800c\u63d0\u9ad8\u8d44\u6e90\u5229\u7528\u7387\u3002\\n\\nUnitedDeployment \u8fd8\u5177\u6709\u81ea\u9002\u5e94 Pod \u91cd\u8c03\u5ea6\u80fd\u529b\u3002\u5f53\u63a7\u5236\u5668\u53d1\u73b0\u67d0\u4e2a\u5206\u533a\u4e2d\u5b58\u5728\u4e00\u4e9b\u7531\u4e8e\u5404\u79cd\u539f\u56e0\u8c03\u5ea6\u5931\u8d25\u800c\u957f\u65f6\u95f4\u5904\u4e8e Pending \u72b6\u6001\u7684\\nPod \u65f6\uff0c\u4f1a\u5c06\u5176\u91cd\u65b0\u8c03\u5ea6\u5230\u5176\u4ed6\u5206\u533a\uff0c\u4ee5\u786e\u4fdd\u53ef\u7528 Pod \u526f\u672c\u7684\u6570\u91cf\uff0c\u5e76\u4e14\u4f9d\u65e7\u9075\u5faa\u5206\u533a\u914d\u7f6e\u7684\u5bb9\u91cf\u5206\u914d\u7b56\u7565\u3002\u5728\u6269\u5bb9\u8fc7\u7a0b\u4e2d\uff0c\u63a7\u5236\u5668\u4f1a\u907f\u514d\u5c06\\nPod \u5206\u914d\u5230\u4e0d\u53ef\u8c03\u5ea6\u7684\u5206\u533a\u4e2d\uff0c\u5373\u4f7f\u8be5\u5206\u533a\u8fd8\u6709\u5269\u4f59\u5bb9\u91cf\u3002**\u7528\u6237\u80fd\u591f\u914d\u7f6e\u8c03\u5ea6\u5931\u8d25\u7684\u8d85\u65f6\u65f6\u95f4\u4ee5\u53ca\u5206\u533a\u4ece\u4e0d\u53ef\u7528\u72b6\u6001\u4e2d\u6062\u590d\u7684\u65f6\u95f4\uff0c\u4ece\u800c\u66f4\u597d\u5730\u5bf9\u81ea\u9002\u5e94\u8c03\u5ea6\u80fd\u529b\u8fdb\u884c\u63a7\u5236\u3002\\n**\\n\\n\u5f97\u76ca\u4e8e UnitedDeployment \u5f3a\u5927\u7684\u81ea\u9002\u5e94\u80fd\u529b\uff0c\u7528\u6237\u5728\u4f7f\u7528\u8be5\u7ec4\u4ef6\u65f6\u53ef\u4ee5\u4ec5\u8fdb\u884c\u5206\u533a\u5212\u5206\uff0c\u800c\u4e0d\u5fc5\u8be6\u7ec6\u89c4\u5212\u6bcf\u4e2a\u5206\u533a\u7684\u5bb9\u91cf\u3002\u63a7\u5236\u5668\u5c06\u81ea\u52a8\u5728\u4e0d\u540c\u7684\u5206\u533a\u95f4\u5206\u914d\u526f\u672c\u6570\u91cf\uff0c\u65e0\u9700\u7528\u6237\u5e72\u9884\u3002\\n\\n## UnitedDeployment \u7684\u4e09\u7ea7\u8d1f\u8f7d\u6a21\u5f0f\\n\\nUnitedDeployment \u5305\u542b\u4e86\u4e09\u4e2a\u7ea7\u522b\u7684\u5de5\u4f5c\u8d1f\u8f7d\u3002UnitedDeployment \u81ea\u8eab\u4f5c\u4e3a\u4e00\u7ea7\u8d1f\u8f7d\uff0c\u5305\u542b\u8d1f\u8f7d\u6a21\u677f\u3001\u5206\u533a\u914d\u7f6e\u4ee5\u53ca\u526f\u672c\u6570\u91cf\u3002\u63a7\u5236\u5668\u4f1a\u4e3a\u6bcf\u4e2a\u5206\u533a\uff08Subset\uff09\u521b\u5efa\u5e76\u7ba1\u7406\u4e00\u4e2a\u6b21\u7ea7\u5de5\u4f5c\u8d1f\u8f7d\u3002\\n\\n\u8fd9\u4e9b\u6b21\u7ea7\u5de5\u4f5c\u8d1f\u8f7d\u662f UnitedDeployment \u4e2d\u8d1f\u8f7d\u6a21\u677f\u5e94\u7528\u4e8e\u5bf9\u5e94\u5206\u533a\u914d\u7f6e\uff08\u5982\u8c03\u5ea6\u7b56\u7565\u3001\u8ba1\u7b97\u540e\u7684\u526f\u672c\u6570\u3001Pod\\n\u81ea\u5b9a\u4e49\u7b49\uff09\u540e\u751f\u6210\u7684\u5177\u4f53\u5b9e\u4f8b\u3002\u8fd9\u4e9b\u6b21\u7ea7\u5de5\u4f5c\u8d1f\u8f7d\u5b9e\u4f8b\u7684\u63a7\u5236\u5668\uff08\u5982 Deployment\u3001CloneSet\u3001StatefulSet \u7b49\uff09\u5c06\u4f1a\u7ba1\u7406\u4f5c\u4e3a\u4e09\u7ea7\u8d1f\u8f7d\u7684 Pod\u3002\\n\\n\u4e09\u7ea7\u5de5\u4f5c\u8d1f\u8f7d\u7684\u6a21\u5f0f\u4f7f\u5f97 UnitedDeployment \u4e0d\u76f4\u63a5\u7ba1\u7406 Pod\uff0c\u800c\u662f\u80fd\u591f\u590d\u7528\u6b21\u7ea7\u5de5\u4f5c\u8d1f\u8f7d\u7684\u5404\u79cd\u80fd\u529b\u3002\u672a\u6765\uff0c\u968f\u7740 UnitedDeployment\\n\u652f\u6301\u66f4\u591a\u6b21\u7ea7\u8d1f\u8f7d\u7c7b\u578b\uff0c\u5176\u529f\u80fd\u4e5f\u5c06\u5f97\u5230\u8fdb\u4e00\u6b65\u6269\u5c55\uff0c\u4ece\u800c\u652f\u6301\u66f4\u591a\u3001\u66f4\u590d\u6742\u7684\u5f39\u6027\u573a\u666f\u3002\\n\\n## UnitedDeployment \u5b58\u5728\u7684\u4e0d\u8db3\u4e4b\u5904\\n\\nUnitedDeployment \u7684\u8bb8\u591a\u4f18\u52bf\u5747\u6e90\u81ea\u5176\u4f5c\u4e3a\u4e00\u4e2a\u72ec\u7acb\u5de5\u4f5c\u8d1f\u8f7d\u6240\u5177\u5907\u7684\u4e00\u7ad9\u5f0f\u7ba1\u7406\u80fd\u529b\uff0c\u4f46\u8fd9\u4e5f\u5bfc\u81f4\u4e86\u5176\u5177\u6709\u4e1a\u52a1\u6539\u9020\u4fb5\u5165\u6027\u8f83\u9ad8\u7684\u4e0d\u8db3\u3002\u5bf9\u4e8e\u7528\u6237\u7684\u73b0\u6709\u4e1a\u52a1\uff0c\u9700\u8981\u5bf9\u4e0a\u5c42\u5e73\u53f0\uff08\u8fd0\u7ef4\u7cfb\u7edf\u3001\u53d1\u5e03\u7cfb\u7edf\u7b49\uff09\u8fdb\u884c\u6539\u9020\uff0c\u4ee5\u4fbf\u4ece\u73b0\u6709\u7684\\nDeployment\u3001CloneSet \u7b49\u5de5\u4f5c\u8d1f\u8f7d\u5207\u6362\u5230 UnitedDeployment\u3002\\n\\n## \u5ba2\u6237\u6848\u4f8b1\uff1aK8S \u96c6\u7fa4\u4e2d\uff0c Pod \u5f39\u6027\u6269\u5c55\u5230 ACS \u5b9e\u4f8b\uff0c\u5e76\u9488\u5bf9 Serverless \u5bb9\u5668\u505a\u9002\u914d\\n\\n\u73b0\u5728\u7684\u4e91\u670d\u52a1\u5546\u63d0\u4f9b\u7684 K8S \u670d\u52a1\u5927\u81f4\u4e0a\u53ef\u4ee5\u5206\u4e3a\u4ee5\u4e0b\u4e09\u79cd\uff1a\\n\\n1. \u7528\u6237\u8d2d\u4e70\u4e91\u670d\u52a1\u5668\u4f5c\u4e3a\u56fa\u5b9a\u8282\u70b9\u7684\u6258\u7ba1\u96c6\u7fa4\\n2. \u901a\u8fc7\u865a\u62df\u8282\u70b9\u6280\u672f\u76f4\u63a5\u4ea4\u4ed8\u5bb9\u5668\u7b97\u529b\u7684 Serverless \u96c6\u7fa4\\n3. \u540c\u65f6\u5305\u542b\u6258\u7ba1\u8282\u70b9\u4e0e\u865a\u62df\u8282\u70b9\u7684\u6df7\u5408\u96c6\u7fa4\\n\\n\u8be5\u6848\u4f8b\u4e2d\uff0c\u5ba2\u6237\u51c6\u5907\u4e0a\u7ebf\u4e00\u4e2a\u65b0\u7684\u4e1a\u52a1\uff0c\u8be5\u4e1a\u52a1\u9884\u8ba1\u5177\u6709\u5f88\u660e\u663e\u7684\u5cf0\u8c37\uff1a\u5728\u9ad8\u5cf0\u671f\u4e0e\u4f4e\u8c37\u671f\u6d41\u91cf\u6709\u6570\u5341\u500d\u7684\u5dee\u8ddd\u3002\u4e3a\u4e86\u5e94\u5bf9\u8fd9\u79cd\u4e1a\u52a1\u7279\u6027\uff0c\u5ba2\u6237\u9009\u62e9\u91c7\u8d2d\u4e86\u4e00\u6279\\nECS \u7ec4\u6210 \u6258\u7ba1\u96c6\u7fa4\u7528\u4e8e\u627f\u8f7d\u57fa\u7840\u6d41\u91cf\uff0c\u5e76\u5728\u4e1a\u52a1\u9ad8\u5cf0\u671f\u5230\u6765\u65f6\u5feb\u901f\u5730\u5c06\u65b0\u7684\u526f\u672c\u5f39\u6027\u6269\u5bb9\u5230 ACS \u4e2d\u3002\u540c\u65f6\uff0c\u5ba2\u6237\u7684\u5e94\u7528\u7a0b\u5e8f\u5177\u6709\u4e00\u5b9a\u7684\u7279\u6b8a\u6027\uff0c\u5728\\nServerless \u73af\u5883\u9700\u8981\u505a\u4e00\u4e9b\u989d\u5916\u7684\u914d\u7f6e\u624d\u80fd\u8fd0\u884c\u3002\\n\\n\u5ba2\u6237\u5bf9\u8fd9\u4e2a\u65b0\u4e1a\u52a1\u7684\u5de5\u4f5c\u8d1f\u8f7d\u7684\u8bc9\u6c42\u662f\uff0c\u4fdd\u8bc1\u4f18\u5148\u7528\u5b8c ECS \u8d44\u6e90\u7684\u524d\u63d0\u4e0b\uff0c\u901a\u8fc7 HPA\\n\u81ea\u52a8\u5730\u5f39\u6027\u4f38\u7f29\uff0c\u540c\u65f6\u9488\u5bf9\u4e0d\u540c\u7684\u73af\u5883\u6ce8\u5165\u4e0d\u540c\u7684\u73af\u5883\u53d8\u91cf\u3002\u5bf9\u4e8e\u8fd9\u79cd\u6bd4\u8f83\u590d\u6742\u7684\u5f39\u6027\u5e94\u7528\u573a\u666f\uff0cUnitedDeployment \u6bd4\u8f83\u7b26\u5408\u9700\u6c42\u3002\u5176\u4e2d\u4e00\u4e2a\u914d\u7f6e\u7684\u5b9e\u4f8b\u5982\u4e0b\uff1a\\n\\n```yaml\\napiVersion: apps.kruise.io/v1alpha1\\nkind: UnitedDeployment\\nmetadata:\\n  name: elastic-app\\nspec:\\n  # \u7701\u7565\u4e1a\u52a1\u7684\u5de5\u4f5c\u8d1f\u8f7d\u6a21\u677f\\n  ...\\n  topology:\\n    # \u542f\u52a8 Adaptive \u8c03\u5ea6\uff0c\u81ea\u9002\u5e94\u5730\u5c06 Pod \u526f\u672c\u8c03\u5ea6\u5230 ECS \u8282\u70b9\u6c60\u4e0e ACS \u5b9e\u4f8b\\n    scheduleStrategy:\\n      type: Adaptive\\n      adaptive:\\n        # ECS \u8282\u70b9\u8c03\u5ea6\u5931\u8d25 10 \u79d2\u540e\u5f00\u59cb\u8c03\u5ea6\u5230 ACS Serverless \u5b9e\u4f8b\\n        rescheduleCriticalSeconds: 10\\n    subsets:\\n      # \u4f18\u5148\u8c03\u5ea6 ECS \u5e76\u4e0d\u8bbe\u4e0a\u9650\uff0c\u76f4\u5230\u8c03\u5ea6\u5931\u8d25\u624d\u5c06 Pod \u8c03\u5ea6\u5230 ACS\\n      # \u7f29\u5bb9\u65f6\uff0c\u5148\u5220\u9664 ACS \u5b9e\u4f8b\uff0c\u4e4b\u540e\u518d\u5220\u9664 ECS \u8282\u70b9\u6c60\u4e2d\u7684 Pod\\n      - name: ecs\\n        nodeSelectorTerm:\\n          matchExpressions:\\n            - key: type\\n              operator: NotIn\\n              values:\\n                - acs-virtual-kubelet\\n      - name: acs-serverless\\n        nodeSelectorTerm:\\n          matchExpressions:\\n            - key: type\\n              operator: In\\n              values:\\n                - acs-virtual-kubelet\\n          # \u901a\u8fc7 patch \u4fee\u6539\u8c03\u5ea6\u5230\u5f39\u6027\u7b97\u529b\u7684 Pod \u73af\u5883\u53d8\u91cf\uff0c\u542f\u7528\u5e94\u7528\u7684 Serverless \u6a21\u5f0f\\n        patch:\\n          spec:\\n            containers:\\n              - name: main\\n                env:\\n                  - name: APP_RUNTIME_MODE\\n                    value: SERVERLESS\\n---\\n# \u7ed3\u5408 HPA \u81ea\u52a8\u6269\u7f29\u5bb9\\napiVersion: autoscaling/v2beta1\\nkind: HorizontalPodAutoscaler\\nmetadata:\\n  name: elastic-app-hpa\\nspec:\\n  minReplicas: 1\\n  maxReplicas: 100\\n  metrics:\\n    - resource:\\n        name: cpu\\n        targetAverageUtilization: 2\\n      type: Resource\\n  scaleTargetRef:\\n    apiVersion: apps.kruise.io/v1alpha1\\n    kind: UnitedDeployment\\n    name: elastic-app\\n```\\n\\n## \u5ba2\u6237\u6848\u4f8b2\uff1a\u4e3a\u8c03\u5ea6\u5230\u4e0d\u540c\u67b6\u6784 ECS \u4e0a\u7684 Pod \u5206\u914d\u4e0d\u540c\u7684\u8d44\u6e90\\n\\n\u8be5\u6848\u4f8b\u4e2d\uff0c\u5ba2\u6237\u5206\u522b\u91c7\u8d2d\u4e86 Intel \u3001AMD \u4e0e ARM \u5e73\u53f0 CPU \u7684\u82e5\u5e72 ECS \u5b9e\u4f8b\uff0c\u51c6\u5907\u4e0a\u7ebf\u4e00\u4e2a\u65b0\u7684\u670d\u52a1\u3002\u7528\u6237\u5e0c\u671b\u8c03\u5ea6\u5230\u4e0d\u540c\u5e73\u53f0\u7684 Pod\\n\u5b9e\u4f8b\u80fd\u8868\u73b0\u51fa\u76f8\u8fd1\u7684\u6027\u80fd\uff0c\u627f\u8f7d\u76f8\u540c\u7684 QPS\u3002\u7ecf\u8fc7\u538b\u6d4b\uff0c\u53d1\u73b0\u4ee5 Intel CPU \u4e3a\u57fa\u51c6\uff0c\u8981\u627f\u8f7d\u540c\u6837\u7684\u538b\u529b\uff0cAMD \u5e73\u53f0\u9700\u8981\u66f4\u591a\u7684 CPU \u6838\u6570\uff0c\u800c\\nARM \u5e73\u53f0\u9700\u8981\u66f4\u591a\u7684\u5185\u5b58\u3002\u540c\u65f6\uff0c\u5ba2\u6237\u91c7\u8d2d\u7684\u4e09\u79cd\u670d\u52a1\u5668\u4e2d\uff0c\u6309\u7167\u7b97\u529b\u5355\u4f4d\uff0cIntel \u5e73\u53f0\u5360\u7ea6\u4e00\u534a\uff0cAMD \u4e0e ARM \u5404\u5360\u7ea6\u56db\u5206\u4e4b\u4e00\u3002\\n\\n\u5ba2\u6237\u8bc9\u6c42\u8fd9\u4e2a\u65b0\u670d\u52a1\u4f7f\u7528\u7684 Workload \u80fd\u591f\u5c06 Pod \u6309\u7167\u6bd4\u4f8b\u5747\u644a\u5230\u4e0d\u540c\u7684\u7b97\u529b\u4e0a\uff0c\u5e76\u4e14\u9488\u5bf9\u4e0d\u540c\u7684\u7b97\u529b\u5e73\u53f0\u914d\u7f6e\u4e0d\u540c\u7684\u8d44\u6e90\u91cf\uff0c\u4ee5\u5411\u4e0b\u6e38\u8c03\u7528\u65b9\u63d0\u4f9b\u8f83\u4e3a\u7a33\u5b9a\u7684\u6027\u80fd\u3002\u4f7f\u7528\\nUnitedDeployment \u7684 Pod \u81ea\u5b9a\u4e49\u80fd\u529b\u914d\u5408\u6307\u5b9a\u5bb9\u91cf\u5206\u914d\u7b97\u6cd5\uff0c\u53ef\u4ee5\u57fa\u672c\u6ee1\u8db3\u9700\u6c42\u3002\u5176\u4e2d\u4e00\u4e2a\u914d\u7f6e\u7684\u5b9e\u4f8b\u5982\u4e0b\uff1a\\n\\n```yaml\\napiVersion: apps.kruise.io/v1alpha1\\nkind: UnitedDeployment\\nmetadata:\\n  name: my-app\\nspec:\\n  replicas: 4\\n  selector:\\n    matchLabels:\\n      app: my-app\\n  template:\\n    deploymentTemplate:\\n      ... # \u7701\u7565\u4e1a\u52a1\u5de5\u4f5c\u8d1f\u8f7d\u6a21\u677f\\n  topology:\\n    # intel\u3001amd\u3001\u501a\u5929710ARM\u673a\u578b\u5206\u522b\u627f\u8f7d50%\u300125%\u300125%\u7684\u526f\u672c\\n    subsets:\\n      - name: intel\\n        replicas: 50%\\n        nodeSelectorTerm:\\n          ... # \u901a\u8fc7 label \u9009\u4e2d Intel \u8282\u70b9\u6c60\\n        patch:\\n          spec:\\n            containers:\\n              - name: main\\n                resources:\\n                  limits:\\n                    cpu: 2000m\\n                    memory: 4000Mi\\n      - name: amd64\\n        replicas: 25%\\n        nodeSelectorTerm:\\n          ... # \u901a\u8fc7 label \u9009\u4e2d AMD \u8282\u70b9\u6c60\\n        # AMD \u5e73\u53f0\u5206\u914d\u66f4\u591a CPU\\n        patch:\\n          spec:\\n            containers:\\n              - name: main\\n                resources:\\n                  limits:\\n                    cpu: 3000m\\n                    memory: 4000Mi\\n      - name: yitian-arm\\n        replicas: 25%\\n        nodeSelectorTerm:\\n          ... # \u901a\u8fc7 label \u9009\u4e2d ARM \u8282\u70b9\u6c60\\n        # ARM \u5e73\u53f0\u5206\u914d\u66f4\u591a\u5185\u5b58\\n        patch:\\n          spec:\\n            containers:\\n              - name: main\\n                resources:\\n                  limits:\\n                    cpu: 2000m\\n                    memory: 6000Mi\\n\\n```\\n\\n# \u603b\u7ed3\\n\\n\u5f39\u6027\u7b97\u529b\u80fd\u591f\u6781\u5927\u5730\u964d\u4f4e\u4e1a\u52a1\u7684\u6210\u672c\uff0c\u5e76\u4e14\u6709\u6548\u5730\u63d0\u9ad8\u670d\u52a1\u7684\u6027\u80fd\u4e0a\u9650\u3002\u8981\u7528\u597d\u5f39\u6027\u7b97\u529b\uff0c\u9700\u8981\u6839\u636e\u5177\u4f53\u4e1a\u52a1\u7279\u70b9\uff0c\u9009\u62e9\u5408\u9002\u7684\u5f39\u6027\u6280\u672f\u3002\u4e0b\u8868\u662f\u672c\u6587\u4ecb\u7ecd\u7684\u56db\u79cd\u7ec4\u4ef6\u7684\u80fd\u529b\u5bf9\u6bd4\u603b\u7ed3\uff0c\u5e0c\u671b\u80fd\u591f\u7ed9\u60a8\u63d0\u4f9b\u4e00\u5b9a\u7684\u53c2\u8003\u3002\\n\\n| \u7ec4\u4ef6               | \u5206\u533a\u539f\u7406              | \u6613\u6539\u9020 \u7a0b\u5ea6 (\u975e\u4fb5\u5165\u6027) | \u5206\u533a \u7ec6\u81f4\u5ea6 | \u5f39\u6027\u80fd\u529b |\\n|------------------|-------------------|---------------|--------|------|\\n| WorkloadSpread   | \u901a\u8fc7 Webhook \u4fee\u6539 Pod | \u9ad8             | \u4e2d      | \u4e2d    |\\n| UnitedDeployment | \u901a\u8fc7\u6a21\u677f\u521b\u5efa\u591a\u4e2a\u5de5\u4f5c\u8d1f\u8f7d      | \u4f4e             | \u9ad8      | \u9ad8    |"},{"id":"openkruise-1.4","metadata":{"permalink":"/zh/blog/openkruise-1.4","editUrl":"https://github.com/openkruise/openkruise.io/edit/master/blog/2023-04-18-release-1.4.md","source":"@site/i18n/zh/docusaurus-plugin-content-blog/2023-04-18-release-1.4.md","title":"OpenKruise V1.4 \u7248\u672c\u89e3\u8bfb\uff1a\u65b0\u589eJob Sidecar Terminator\u80fd\u529b","description":"OpenKruise\uff08 https://github.com/openkruise/kruise \uff09\u662f\u963f\u91cc\u4e91\u5f00\u6e90\u7684\u4e91\u539f\u751f\u5e94\u7528\u81ea\u52a8\u5316\u7ba1\u7406\u5957\u4ef6\uff0c\u4e5f\u662f\u5f53\u524d\u6258\u7ba1\u5728 Cloud Native Computing Foundation (CNCF) \u4e0b\u7684\u5b75\u5316\u9879\u76ee\u3002\u5b83\u6765\u81ea\u963f\u91cc\u5df4\u5df4\u591a\u5e74\u6765\u5bb9\u5668\u5316\u3001\u4e91\u539f\u751f\u7684\u6280\u672f\u6c89\u6dc0\uff0c\u662f\u963f\u91cc\u5185\u90e8\u751f\u4ea7\u73af\u5883\u5927\u89c4\u6a21\u5e94\u7528\u7684\u57fa\u4e8e Kubernetes \u4e4b\u4e0a\u7684\u6807\u51c6\u6269\u5c55\u7ec4\u4ef6\uff0c\u4e5f\u662f\u7d27\u8d34\u4e0a\u6e38\u793e\u533a\u6807\u51c6\u3001\u9002\u5e94\u4e92\u8054\u7f51\u89c4\u6a21\u5316\u573a\u666f\u7684\u6280\u672f\u7406\u5ff5\u4e0e\u6700\u4f73\u5b9e\u8df5\u3002","date":"2023-04-18T00:00:00.000Z","tags":[{"inline":true,"label":"release","permalink":"/zh/blog/tags/release"}],"readingTime":6.87,"hasTruncateMarker":false,"authors":[{"name":"Mingshan Zhao","title":"Member of OpenKruise","url":"https://github.com/zmberg","imageURL":"https://github.com/zmberg.png","key":"zmberg","page":null}],"frontMatter":{"slug":"openkruise-1.4","title":"OpenKruise V1.4 \u7248\u672c\u89e3\u8bfb\uff1a\u65b0\u589eJob Sidecar Terminator\u80fd\u529b","authors":["zmberg"],"tags":["release"]},"unlisted":false,"prevItem":{"title":"\u9762\u5411Workload\u7ea7\u522b\u7684\u7075\u6d3b\u53ef\u914d\u7f6eServerless\u5f39\u6027\u89e3\u51b3\u65b9\u6848","permalink":"/zh/blog/elastic"},"nextItem":{"title":"OpenKruise v1.3\uff1a\u65b0\u589e\u81ea\u5b9a\u4e49 Pod Probe \u63a2\u9488\u80fd\u529b\u4e0e\u5927\u89c4\u6a21\u96c6\u7fa4\u6027\u80fd\u663e\u8457\u63d0\u5347","permalink":"/zh/blog/openkruise-1.3"}},"content":"OpenKruise\uff08 https://github.com/openkruise/kruise \uff09\u662f\u963f\u91cc\u4e91\u5f00\u6e90\u7684\u4e91\u539f\u751f\u5e94\u7528\u81ea\u52a8\u5316\u7ba1\u7406\u5957\u4ef6\uff0c\u4e5f\u662f\u5f53\u524d\u6258\u7ba1\u5728 Cloud Native Computing Foundation (CNCF) \u4e0b\u7684\u5b75\u5316\u9879\u76ee\u3002\u5b83\u6765\u81ea\u963f\u91cc\u5df4\u5df4\u591a\u5e74\u6765\u5bb9\u5668\u5316\u3001\u4e91\u539f\u751f\u7684\u6280\u672f\u6c89\u6dc0\uff0c\u662f\u963f\u91cc\u5185\u90e8\u751f\u4ea7\u73af\u5883\u5927\u89c4\u6a21\u5e94\u7528\u7684\u57fa\u4e8e Kubernetes \u4e4b\u4e0a\u7684\u6807\u51c6\u6269\u5c55\u7ec4\u4ef6\uff0c\u4e5f\u662f\u7d27\u8d34\u4e0a\u6e38\u793e\u533a\u6807\u51c6\u3001\u9002\u5e94\u4e92\u8054\u7f51\u89c4\u6a21\u5316\u573a\u666f\u7684\u6280\u672f\u7406\u5ff5\u4e0e\u6700\u4f73\u5b9e\u8df5\u3002\\n\\nOpenKruise \u5728 2023.3.31 \u53d1\u5e03\u4e86\u6700\u65b0\u7684 v1.4 \u7248\u672c\uff08[ChangeLog](https://github.com/openkruise/kruise/blob/master/CHANGELOG.md)\uff09\uff0c\u65b0\u589e Job Sidecar Terminator \u91cd\u78c5\u529f\u80fd\uff0c\u672c\u6587\u4ee5\u4e0b\u5bf9\u65b0\u7248\u672c\u505a\u6574\u4f53\u7684\u6982\u89c8\u4ecb\u7ecd\u3002\\n\\n## 1. \u91cd\u8981\u66f4\u65b0\\n- \u4e3a\u4e86\u65b9\u4fbf\u5927\u5bb6\u4f7f\u7528 Kruise \u589e\u5f3a\u80fd\u529b\uff0c\u9ed8\u8ba4\u6253\u5f00\u4e86\u4e00\u4e9b\u7a33\u5b9a\u7684\u80fd\u529b\uff0c\u5982\u4e0b\uff1aResourcesDeletionProtection, WorkloadSpread, PodUnavailableBudgetDeleteGate, InPlaceUpdateEnvFromMetadata, StatefulSetAutoDeletePVC, PodProbeMarkerGate\u3002\u4e0a\u8ff0\u80fd\u529b\u5927\u90e8\u5206\u662f\u9700\u8981\u7279\u522b\u914d\u7f6e\u624d\u4f1a\u751f\u6548\u7684\uff0c\u6240\u4ee5\u9ed8\u8ba4\u6253\u5f00\u4e00\u822c\u4e0d\u4f1a\u5bf9\u5b58\u91cf\u96c6\u7fa4\u9020\u6210\u5f71\u54cd\uff0c\u5982\u679c\u6709\u4e00\u4e9b\u7279\u6027\u4e0d\u60f3\u4f7f\u7528\uff0c\u53ef\u4ee5\u5728\u5347\u7ea7\u65f6\u5173\u95ed\u3002\\n- Kruise-Manager leader \u9009\u4e3e\u65b9\u5f0f\u4ece configmaps \u8fc1\u79fb\u4e3a configmapsleases\uff0c\u4e3a\u540e\u9762\u8fc1\u79fb\u5230 leases \u65b9\u5f0f\u505a\u51c6\u5907\uff0c\u53e6\u5916\uff0c\u8fd9\u662f\u5b98\u65b9\u63d0\u4f9b\u7684\u5e73\u6ed1\u5347\u7ea7\u7684\u65b9\u5f0f\uff0c\u4e0d\u4f1a\u5bf9\u5b58\u91cf\u7684\u96c6\u7fa4\u9020\u6210\u5f71\u54cd\u3002\\n\\n## 2. Sidecar\u5bb9\u5668\u7ba1\u7406\u80fd\u529b\uff1aJob Sidecar Terminator\\n\u5728 Kubernetes \u4e2d\u5bf9\u4e8e Job \u7c7b\u578b Workload\uff0c\u4eba\u4eec\u901a\u5e38\u5e0c\u671b\u5f53\u4e3b\u5bb9\u5668\u5b8c\u6210\u4efb\u52a1\u5e76\u9000\u51fa\u540e\uff0cPod \u8fdb\u5165\u5df2\u5b8c\u6210\u72b6\u6001\u3002\u7136\u800c\uff0c\u5f53\u8fd9\u4e9b Pod \u62e5\u6709 Long-Running Sidecar \u5bb9\u5668\u65f6\uff0c\u7531\u4e8e Sidecar \u5bb9\u5668\u5728\u4e3b\u5bb9\u5668\u9000\u51fa\u540e\u65e0\u6cd5\u81ea\u884c\u9000\u51fa\uff0c\u5bfc\u81f4 Pod \u4e00\u76f4\u65e0\u6cd5\u8fdb\u5165\u5df2\u5b8c\u6210\u72b6\u6001\u3002\u9762\u5bf9\u8fd9\u4e2a\u95ee\u9898\uff0c\u793e\u533a\u7684\u5e38\u89c1\u89e3\u51b3\u65b9\u6848\u4e00\u822c\u90fd\u9700\u8981\u5bf9 Main \u548c Sidecar \u8fdb\u884c\u6539\u9020\uff0c\u4e24\u8005\u901a\u8fc7 Volume \u5171\u4eab\u6765\u5b9e\u73b0 Main \u5bb9\u5668\u9000\u51fa\u4e4b\u540e\uff0cSidecar \u5bb9\u5668\u5b8c\u6210\u9000\u51fa\u7684\u6548\u679c\u3002\\n\\n\u793e\u533a\u7684\u89e3\u51b3\u65b9\u6848\u53ef\u4ee5\u89e3\u51b3\u8fd9\u4e2a\u95ee\u9898\uff0c\u4f46\u662f\u9700\u8981\u5bf9\u5bb9\u5668\u8fdb\u884c\u6539\u9020\uff0c\u5c24\u5176\u5bf9\u4e8e\u793e\u533a\u901a\u7528\u7684 Sidecar \u5bb9\u5668\uff0c\u6539\u9020\u548c\u7ef4\u62a4\u7684\u6210\u672c\u592a\u9ad8\u4e86\u3002\\n\\n\u4e3a\u6b64\uff0c\u6211\u4eec\u5728 Kruise \u4e2d\u52a0\u5165\u4e86\u4e00\u4e2a\u540d\u4e3a SidecarTerminator \u7684\u63a7\u5236\u5668\uff0c\u4e13\u95e8\u7528\u4e8e\u5728\u6b64\u7c7b\u573a\u666f\u4e0b\uff0c\u76d1\u542c\u4e3b\u5bb9\u5668\u7684\u5b8c\u6210\u72b6\u6001\uff0c\u5e76\u9009\u62e9\u5408\u9002\u7684\u65f6\u673a\u7ec8\u6b62\u6389 Pod \u4e2d\u7684 sidecar \u5bb9\u5668\uff0c\u5e76\u4e14\u65e0\u9700\u5bf9 Main \u548c Sidecar \u5bb9\u5668\u8fdb\u884c\u4fb5\u5165\u5f0f\u6539\u9020\u3002\\n\\n### \u8fd0\u884c\u5728\u666e\u901a\u8282\u70b9\u7684 Pod\\n\u5bf9\u4e8e\u8fd0\u884c\u4e8e\u666e\u901a\u8282\u70b9\u7684 Pod\uff08\u5e38\u89c4Kubelet\uff09\uff0c\u4f7f\u7528\u8be5\u7279\u6027\u975e\u5e38\u7b80\u5355\uff0c\u7528\u6237\u53ea\u9700\u8981\u5728\u8981\u5728\u76ee\u6807 sidecar \u5bb9\u5668\u4e2d\u6dfb\u52a0\u4e00\u4e2a\u7279\u6b8a\u7684 env \u5bf9\u5176\u8fdb\u884c\u6807\u8bc6\uff0c\u63a7\u5236\u5668\u4f1a\u5728\u6070\u5f53\u7684\u65f6\u673a\u5229\u7528 Kruise Daemon \u63d0\u4f9b\u7684 CRR \u7684\u80fd\u529b\uff0c\u5c06\u8fd9\u4e9b sidecar \u5bb9\u5668\u7ec8\u6b62\uff1a\\n\\n```yaml\\nkind: Job\\nspec:\\n  template:\\n    spec:\\n      containers:\\n      - name: sidecar\\n        env:\\n        - name: KRUISE_TERMINATE_SIDECAR_WHEN_JOB_EXIT\\n          value: \\"true\\"\\n      - name: main\\n      ...\\n```\\n\\n### \u8fd0\u884c\u5728\u865a\u62df\u8282\u70b9\u7684 Pod\\n\\n\u5bf9\u4e8e\u4e00\u4e9b\u63d0\u4f9b Serverless \u5bb9\u5668\u7684\u5e73\u53f0\uff0c\u4f8b\u5982 ECI \u6216\u8005 Fargate, \u5176 Pods \u53ea\u80fd\u8fd0\u884c\u4e8e Virtual-Kubelet \u4e4b\u7c7b\u7684\u865a\u62df\u8282\u70b9\u3002 \u7136\u800c\uff0cKruise Daemon \u65e0\u6cd5\u90e8\u7f72\u548c\u5de5\u4f5c\u5728\u8fd9\u4e9b\u865a\u62df\u8282\u70b9\u4e4b\u4e0a\uff0c\u5bfc\u81f4\u65e0\u6cd5\u4f7f\u7528 CRR \u80fd\u529b\u5c06\u5bb9\u5668\u7ec8\u6b62\u3002 \u4f46\u5e78\u8fd0\u5730\u662f\uff0c\u6211\u4eec\u53ef\u4ee5\u501f\u52a9\u539f\u751f Kubernetes \u63d0\u4f9b\u7684 Pod \u539f\u5730\u5347\u7ea7\u673a\u5236\u6765\u8fbe\u5230\u540c\u6837\u7684\u76ee\u7684\uff1a\u53ea\u9700\u8981\u6784\u9020\u4e00\u4e2a\u7279\u6b8a\u955c\u50cf\uff0c\u8fd9\u4e2a\u955c\u50cf\u7684\u552f\u4e00\u4f5c\u7528\u5c31\u662f\u5f53\u88ab\u62c9\u8d77\u540e\uff0c\u4f1a\u5feb\u901f\u5730\u4e3b\u52a8\u9000\u51fa\uff0c\u8fd9\u6837\u4e00\u6765\uff0c\u53ea\u9700\u8981\u5728\u9000\u51fa sidecar \u65f6\uff0c\u5c06\u539f\u672c\u7684 sidecar \u955c\u50cf\u66ff\u6362\u4e3a\u5feb\u901f\u9000\u51fa\u955c\u50cf\uff0c\u5373\u53ef\u8fbe\u5230\u9000\u51fa sidecar \u7684\u76ee\u7684\u3002\\n\\n#### \u6b65\u9aa4\u4e00: \u51c6\u5907\u4e00\u4e2a\u5feb\u901f\u9000\u51fa\u955c\u50cf\\n- \u8be5\u955c\u50cf\u53ea\u9700\u8981\u5177\u5907\u975e\u5e38\u7b80\u5355\u7684\u903b\u8f91\uff1a\u5f53\u5176\u88ab\u62c9\u8d77\u540e\uff0c\u76f4\u63a5\u9000\u51fa\uff0c\u4e14\u9000\u51fa\u7801\u4e3a 0\u3002\\n- \u8be5\u955c\u50cf\u9700\u8981\u517c\u5bb9\u539f sidecar \u955c\u50cf\u7684 commands \u548c args\uff0c\u4ee5\u9632\u5bb9\u5668\u88ab\u62c9\u8d77\u65f6\u62a5\u9519\u3002\\n\\n#### \u6b65\u9aa4\u4e8c: \u914d\u7f6e\u4f60\u7684 sidecar \u5bb9\u5668\\n\\n```yaml\\nkind: Job\\nspec:\\n  template:\\n    spec:\\n      containers:\\n      - name: sidecar\\n        env:\\n        - name: KRUISE_TERMINATE_SIDECAR_WHEN_JOB_EXIT_WITH_IMAGE\\n          value: \\"example/quick-exit:v1.0.0\\"\\n      - name: main\\n      ...\\n```\\n\\n\u4f7f\u7528\u4f60\u81ea\u5df1\u51c6\u5907\u7684\u5feb\u901f\u9000\u51fa\u955c\u50cf\u6765\u66ff\u6362\u4e0a\u8ff0 \\"example/quick-exit:v1.0.0\\".\\n\\n### \u6ce8\u610f\u4e8b\u9879\\n- sidecar \u5bb9\u5668\u5fc5\u987b\u80fd\u591f\u54cd\u5e94 SIGTERM \u4fe1\u53f7\uff0c\u5e76\u4e14\u5f53\u6536\u5230\u6b64\u4fe1\u53f7\u65f6\uff0centrypoint \u8fdb\u7a0b\u9700\u8981\u9000\u51fa(\u5373 sidecar \u5bb9\u5668\u9700\u8981\u9000\u51fa)\uff0c\u5e76\u4e14\u9000\u51fa\u7801\u5e94\u5f53\u4e3a 0\u3002\\n- \u8be5\u7279\u6027\u9002\u7528\u4e8e\u4efb\u610f Job \u7c7b\u578b Workload \u6240\u7ba1\u7406\u7684 Pod\uff0c\u53ea\u8981\u4ed6\u4eec\u7684 RestartPolicy \u4e3a Never/OnFailure \u5373\u53ef\u3002\\n- \u5177\u6709\u73af\u5883\u53d8\u91cf KRUISE_TERMINATE_SIDECAR_WHEN_JOB_EXIT \u7684\u5bb9\u5668\u5c06\u88ab\u89c6\u4e3a sidecar \u5bb9\u5668\uff0c\u5176\u4ed6\u5bb9\u5668\u5c06\u88ab\u89c6\u4e3a\u4e3b\u5bb9\u5668\uff0c\u5f53\u6240\u6709\u4e3b\u5bb9\u5668\u5b8c\u6210\u540e\uff0csidecar \u5bb9\u5668\u624d\u4f1a\u88ab\u7ec8\u6b62\uff1a\\n  - \u5728 Never \u91cd\u542f\u7b56\u7565\u4e0b\uff0c\u4e3b\u5bb9\u5668\u4e00\u65e6\u9000\u51fa\uff0c\u5c06\u88ab\u89c6\u4e3a\\"\u5df2\u5b8c\u6210\\"\u3002\\n  - \u5728 OnFailure \u91cd\u542f\u7b56\u7565\u4e0b\uff0c\u4e3b\u5bb9\u5668\u9000\u51fa\u4ee3\u7801\u5fc5\u987b\u4e3a0\uff0c\u624d\u4f1a\u88ab\u89c6\u4e3a\\"\u5df2\u5b8c\u6210\\"\u3002\\n- \u4e14\u8fd0\u884c\u5728\u666e\u901a\u8282\u70b9\u65b9\u5f0f\u4e0b\uff0c`KRUISE_TERMINATE_SIDECAR_WHEN_JOB_EXIT` \u7684\u4f18\u5148\u7ea7\u9ad8\u4e8e`KRUISE_TERMINATE_SIDECAR_WHEN_JOB_EXIT_WITH_IMAGE`\\n\\n## 3. \u589e\u5f3a\u7248\u672c\u7684\u5de5\u4f5c\u8d1f\u8f7d\\n### CloneSet \u4f18\u5316\u6027\u80fd \uff1a\u65b0\u589e FeatureGate CloneSetEventHandlerOptimization\\n\u5f53\u524d\uff0c\u65e0\u8bba\u662f Pod \u7684\u72b6\u6001\u53d8\u5316\u8fd8\u662f Metadata \u53d8\u5316\uff0cPod Update \u4e8b\u4ef6\u90fd\u4f1a\u89e6\u53d1 CloneSet reconcile \u903b\u8f91\u3002CloneSet Reconcile \u9ed8\u8ba4\u914d\u7f6e\u4e86\u4e09\u4e2a worker\uff0c\u5bf9\u4e8e\u96c6\u7fa4\u89c4\u6a21\u8f83\u5c0f\u7684\u573a\u666f\uff0c\u8fd9\u79cd\u60c5\u51b5\u5e76\u4e0d\u4f1a\u9020\u6210\u95ee\u9898\u3002\\n\\n\u4f46\u5bf9\u4e8e\u96c6\u7fa4\u89c4\u6a21\u8f83\u5927\u6216 Pod Update \u4e8b\u4ef6\u8f83\u591a\u7684\u60c5\u51b5\uff0c\u8fd9\u4e9b\u65e0\u6548\u7684 reconcile \u5c06\u4f1a\u963b\u585e\u771f\u6b63\u7684 CloneSet reconcile\uff0c\u8fdb\u800c\u5bfc\u81f4 CloneSet \u7684\u6eda\u52a8\u5347\u7ea7\u7b49\u53d8\u66f4\u5ef6\u8fdf\u3002\u4e3a\u4e86\u89e3\u51b3\u8fd9\u4e2a\u95ee\u9898\uff0c\u53ef\u4ee5\u6253\u5f00 feature-gate CloneSetEventHandlerOptimization \u6765\u51cf\u5c11\u4e00\u4e9b\u4e0d\u5fc5\u8981\u7684 reconcile \u5165\u961f\u3002\\n\\n### CloneSet \u65b0\u589e disablePVCReuse \u5b57\u6bb5\\n\u5982\u679c\u4e00\u4e2a Pod \u88ab\u5916\u90e8\u76f4\u63a5\u8c03\u7528\u5220\u9664\u6216\u9a71\u9010\u65f6\uff0c\u8fd9\u4e2a Pod \u5173\u8054\u7684 PVCs \u8fd8\u90fd\u5b58\u5728\uff1b\u5e76\u4e14 CloneSet controller \u53d1\u73b0\u6570\u91cf\u4e0d\u8db3\u91cd\u65b0\u6269\u5bb9\u65f6\uff0c\u65b0\u6269\u51fa\u6765\u7684 Pod \u4f1a\u590d\u7528\u539f Pod \u7684 instance-id \u5e76\u5173\u8054\u539f\u6765\u7684 PVCs\u3002\\n\\n\u7136\u800c\uff0c\u5982\u679c Pod \u6240\u5728\u7684 Node \u51fa\u73b0\u5f02\u5e38\uff0c\u590d\u7528\u53ef\u80fd\u4f1a\u5bfc\u81f4\u65b0 Pod \u542f\u52a8\u5931\u8d25\uff0c\u8be6\u60c5\u53c2\u8003 issue 1099\u3002\u4e3a\u4e86\u89e3\u51b3\u8fd9\u4e2a\u95ee\u9898\uff0c\u60a8\u53ef\u4ee5\u8bbe\u7f6e\u5b57\u6bb5 **DisablePVCReuse=true**\uff0c\u5f53 Pod \u88ab\u9a71\u9010\u6216\u8005\u5220\u9664\u540e\uff0c\u4e0e Pod \u76f8\u5173\u7684 PVCs \u5c06\u88ab\u81ea\u52a8\u5220\u9664\uff0c\u4e0d\u518d\u88ab\u590d\u7528\u3002\\n\\n```yaml\\napiVersion: apps.kruise.io/v1alpha1\\nkind: CloneSet\\nspec:\\n  ...\\n  replicas: 4\\n  scaleStrategy:\\n    disablePVCReuse: true\\n```\\n\\n### CloneSet \u589e\u52a0 PreNormal \u751f\u547d\u5468\u671f\u94a9\u5b50\\nCloneSet \u5df2\u7ecf\u652f\u6301\u4e86PreparingUpdate\u3001PreparingDelete \u4e24\u79cd\u751f\u547d\u5468\u671f\u94a9\u5b50\uff0c\u7528\u4e8e\u5e94\u7528\u7684\u4f18\u96c5\u4e0b\u7ebf\uff0c\u8be6\u60c5\u53c2\u8003\u793e\u533a\u6587\u6863\u3002\u4e3a\u4e86\u652f\u6301\u4f18\u96c5\u4e0a\u7ebf\u7684\u573a\u666f\uff0c\u672c\u6b21\u65b0\u589e\u52a0\u4e86 PreNormal \u72b6\u6001\uff0c\u5177\u4f53\u5982\u4e0b\uff1a\\n\\n```yaml\\napiVersion: apps.kruise.io/v1alpha1\\nkind: CloneSet\\nspec:\\n  # define with finalizer\\n  lifecycle:\\n    preNormal:\\n      finalizersHandler:\\n      - example.io/unready-blocker\\n\\n  # or define with label\\n  # lifecycle:\\n  #   preNormal:\\n  #     labelsHandler:\\n  #       example.io/block-unready: \\"true\\"\\n```\\n\\n\u5f53 CloneSet \u521b\u5efa\u4e00\u4e2a Pod\uff08\u5305\u62ec\u6b63\u5e38\u6269\u5bb9\u548c\u91cd\u5efa\u5347\u7ea7\uff09\u65f6\uff1a\\n- \u5982\u679c Pod \u6ee1\u8db3\u4e86 `PreNormal` hook \u7684\u5b9a\u4e49\uff0c\u624d\u4f1a\u88ab\u8ba4\u4e3a\u662f `Available`\uff0c\u5e76\u4e14\u624d\u4f1a\u8fdb\u5165 `Normal` \u72b6\u6001\\n\u8fd9\u5bf9\u4e8e\u4e00\u4e9b Pod \u521b\u5efa\u65f6\u7684\u540e\u7f6e\u68c0\u67e5\u5f88\u6709\u7528\uff0c\u6bd4\u5982\u4f60\u53ef\u4ee5\u68c0\u67e5 Pod \u662f\u5426\u5df2\u7ecf\u6302\u8f7d\u5230 SLB \u540e\u7aef\uff0c\u4ece\u800c\u907f\u514d\u6eda\u52a8\u5347\u7ea7\u65f6\uff0c\u65e7\u5b9e\u4f8b\u9500\u6bc1\u540e\uff0c\u65b0\u5b9e\u4f8b\u6302\u8f7d\u5931\u8d25\u5bfc\u81f4\u7684\u6d41\u91cf\u635f\u5931\u3002\\n\\n## 4. \u9ad8\u7ea7\u7684\u5e94\u7528\u8fd0\u7ef4\u80fd\u529b\\n### \u5bb9\u5668\u91cd\u542f\u65b0\u589e forceRecreate \u5b57\u6bb5\\n\u5f53\u521b\u5efa [CRR](https://openkruise.io/docs/user-manuals/containerrecreaterequest) \u8d44\u6e90\u65f6\uff0c\u5982\u679c\u5bb9\u5668\u6b63\u5728\u542f\u52a8\u8fc7\u7a0b\u4e2d\uff0cCRR \u5c06\u4e0d\u4f1a\u518d\u91cd\u542f\u5bb9\u5668\u3002\u5982\u679c\u60a8\u60f3\u8981\u5f3a\u5236\u91cd\u542f\u5bb9\u5668\uff0c\u53ef\u4ee5\u4f7f\u7528\u4ee5\u4e0b\u5b57\u6bb5\u5f00\u542f\uff1a\\n\\n```yaml\\napiVersion: apps.kruise.io/v1alpha1\\nkind: ContainerRecreateRequest\\nspec:\\n  ...\\n  strategy:\\n    forceRecreate: true\\n```\\n\\n### \u955c\u50cf\u9884\u70ed\u652f\u6301 Attach metadata into cri interface\\n\u5f53 Kubelet \u521b\u5efa Pod \u65f6\uff0cKubelet \u5c06\u4f1a attach metadata \u5230 container runtime cri \u63a5\u53e3\u3002\u955c\u50cf\u4ed3\u5e93\u53ef\u4ee5\u6839\u636e\u8fd9\u4e9b metadata \u4fe1\u606f\u6765\u786e\u5b9a\u62c9\u955c\u50cf\u7684\u6765\u6e90\u4e1a\u52a1\uff0c\u5982\u679c\u53d1\u751f\u4e86\u4ed3\u5e93\u8fc7\u8f7d\u3001\u538b\u529b\u8fc7\u5927\u7684\u60c5\u51b5\uff0c\u53ef\u4ee5\u5bf9\u5177\u4f53\u7684\u4e1a\u52a1\u8fdb\u884c\u964d\u7ea7\u5904\u7406\u3002OpenKruise \u955c\u50cf\u9884\u70ed\u540c\u6837\u652f\u6301\u7c7b\u4f3c\u7684\u80fd\u529b\uff0c\u5982\u4e0b\uff1a\\n\\n```yaml\\napiVersion: apps.kruise.io/v1alpha1\\nkind: ImagePullJob\\nspec:\\n  ...\\n  image: nginx:1.9.1\\n  sandboxConfig:\\n    annotations:\\n      io.kubernetes.image.metrics.tags: \\"cluster=cn-shanghai\\"\\n    labels:\\n      io.kubernetes.image.app: \\"foo\\"\\n```\\n\\n## \u793e\u533a\u53c2\u4e0e\\n\\n\u975e\u5e38\u6b22\u8fce\u4f60\u901a\u8fc7 Github/Slack/\u9489\u9489/\u5fae\u4fe1 \u7b49\u65b9\u5f0f\u52a0\u5165\u6211\u4eec\u6765\u53c2\u4e0e OpenKruise \u5f00\u6e90\u793e\u533a\u3002\\n\u4f60\u662f\u5426\u5df2\u7ecf\u6709\u4e00\u4e9b\u5e0c\u671b\u4e0e\u6211\u4eec\u793e\u533a\u4ea4\u6d41\u7684\u5185\u5bb9\u5462\uff1f\\n\u53ef\u4ee5\u5728\u6211\u4eec\u7684[\u793e\u533a\u53cc\u5468\u4f1a](https://shimo.im/docs/gXqmeQOYBehZ4vqo)\u4e0a\u5206\u4eab\u4f60\u7684\u58f0\u97f3\uff0c\u6216\u901a\u8fc7\u4ee5\u4e0b\u6e20\u9053\u53c2\u4e0e\u8ba8\u8bba\uff1a\\n\\n- \u52a0\u5165\u793e\u533a [Slack channel](https://kubernetes.slack.com/channels/openkruise) (English)\\n- \u52a0\u5165\u793e\u533a\u9489\u9489\u7fa4\uff1a\u641c\u7d22\u7fa4\u53f7 `23330762` (Chinese)\\n- \u52a0\u5165\u793e\u533a\u5fae\u4fe1\u7fa4\uff08\u65b0\uff09\uff1a\u6dfb\u52a0\u7528\u6237 `openkruise` \u5e76\u8ba9\u673a\u5668\u4eba\u62c9\u4f60\u5165\u7fa4 (Chinese)"},{"id":"openkruise-1.3","metadata":{"permalink":"/zh/blog/openkruise-1.3","editUrl":"https://github.com/openkruise/openkruise.io/edit/master/blog/2022-10-07-release-1.3.md","source":"@site/i18n/zh/docusaurus-plugin-content-blog/2022-10-07-release-1.3.md","title":"OpenKruise v1.3\uff1a\u65b0\u589e\u81ea\u5b9a\u4e49 Pod Probe \u63a2\u9488\u80fd\u529b\u4e0e\u5927\u89c4\u6a21\u96c6\u7fa4\u6027\u80fd\u663e\u8457\u63d0\u5347","description":"\u4e91\u539f\u751f\u5e94\u7528\u81ea\u52a8\u5316\u7ba1\u7406\u5957\u4ef6\u3001CNCF Sandbox \u9879\u76ee -- OpenKruise\uff0c\u8fd1\u671f\u53d1\u5e03\u4e86 v1.3 \u7248\u672c\u3002","date":"2022-10-07T00:00:00.000Z","tags":[{"inline":true,"label":"release","permalink":"/zh/blog/tags/release"}],"readingTime":9.12,"hasTruncateMarker":false,"authors":[{"name":"Mingshan Zhao","title":"Member of OpenKruise","url":"https://github.com/zmberg","imageURL":"https://github.com/zmberg.png","key":"zmberg","page":null}],"frontMatter":{"slug":"openkruise-1.3","title":"OpenKruise v1.3\uff1a\u65b0\u589e\u81ea\u5b9a\u4e49 Pod Probe \u63a2\u9488\u80fd\u529b\u4e0e\u5927\u89c4\u6a21\u96c6\u7fa4\u6027\u80fd\u663e\u8457\u63d0\u5347","authors":["zmberg"],"tags":["release"]},"unlisted":false,"prevItem":{"title":"OpenKruise V1.4 \u7248\u672c\u89e3\u8bfb\uff1a\u65b0\u589eJob Sidecar Terminator\u80fd\u529b","permalink":"/zh/blog/openkruise-1.4"},"nextItem":{"title":"OpenKruise v1.2\uff1a\u65b0\u589e PersistentPodState \u5b9e\u73b0\u6709\u72b6\u6001 Pod \u62d3\u6251\u56fa\u5b9a\u4e0e IP \u590d\u7528","permalink":"/zh/blog/openkruise-1.2"}},"content":"\u4e91\u539f\u751f\u5e94\u7528\u81ea\u52a8\u5316\u7ba1\u7406\u5957\u4ef6\u3001CNCF Sandbox \u9879\u76ee -- OpenKruise\uff0c\u8fd1\u671f\u53d1\u5e03\u4e86 v1.3 \u7248\u672c\u3002\\n\\n[OpenKruise](https://openkruise.io) \u662f\u9488\u5bf9 Kubernetes \u7684\u589e\u5f3a\u80fd\u529b\u5957\u4ef6\uff0c\u805a\u7126\u4e8e\u4e91\u539f\u751f\u5e94\u7528\u7684\u90e8\u7f72\u3001\u5347\u7ea7\u3001\u8fd0\u7ef4\u3001\u7a33\u5b9a\u6027\u9632\u62a4\u7b49\u9886\u57df\u3002\\n\u6240\u6709\u7684\u529f\u80fd\u90fd\u901a\u8fc7 CRD \u7b49\u6807\u51c6\u65b9\u5f0f\u6269\u5c55\uff0c\u53ef\u4ee5\u9002\u7528\u4e8e 1.16 \u4ee5\u4e0a\u7248\u672c\u7684\u4efb\u610f Kubernetes \u96c6\u7fa4\u3002\u5355\u6761 helm \u547d\u4ee4\u5373\u53ef\u5b8c\u6210 Kruise \u7684\u4e00\u952e\u90e8\u7f72\uff0c\u65e0\u9700\u66f4\u591a\u914d\u7f6e\u3002\\n\\n## \u7248\u672c\u89e3\u6790\\n\\n\u5728\u7248\u672cv1.3\u4e2d\uff0cOpenKruise\u63d0\u4f9b\u4e86\u65b0\u7684CRD\u8d44\u6e90 `PodProbeMarker`\uff0c\u6539\u5584\u4e86\u5927\u89c4\u6a21\u96c6\u7fa4\u7684\u4e00\u4e9b\u6027\u80fd\u95ee\u9898\uff0cAdvanced DaemonSet\u652f\u6301\u955c\u50cf\u9884\u70ed\uff0c\\n\u4ee5\u53ca CloneSet\u3001WorkloadSpread\u3001Advanced CronJob\u3001SidecarSet\u4e00\u4e9b\u65b0\u7684\u7279\u6027\u3002\\n\\n### 1. \u65b0\u589e CRD \u548c Controller\uff1aPodProbeMarker\\n\\nKubernetes\u63d0\u4f9b\u4e86\u4e09\u79cd\u9ed8\u8ba4\u7684Pod\u751f\u547d\u5468\u671f\u7ba1\u7406\uff1a\\n- **Readiness Probe** \u7528\u6765\u5224\u65ad\u4e1a\u52a1\u5bb9\u5668\u662f\u5426\u5df2\u7ecf\u51c6\u5907\u597d\u54cd\u5e94\u7528\u6237\u8bf7\u6c42\uff0c\u5982\u679c\u68c0\u67e5\u5931\u8d25\uff0c\u4f1a\u5c06\u8be5Pod\u4eceService Endpoints\u4e2d\u5254\u9664\u3002\\n- **Liveness Probe** \u7528\u6765\u5224\u65ad\u5bb9\u5668\u7684\u5065\u5eb7\u72b6\u6001\uff0c\u5982\u679c\u68c0\u67e5\u5931\u8d25\uff0ckubelet\u5c06\u4f1a\u91cd\u542f\u8be5\u5bb9\u5668\u3002\\n- **Startup Probe** \u7528\u6765\u5224\u65ad\u5bb9\u5668\u662f\u5426\u542f\u52a8\u5b8c\u6210\uff0c\u5982\u679c\u5b9a\u4e49\u4e86\u8be5Probe\uff0c\u90a3\u4e48Readiness Probe\u4e0eLiveness Probe\u5c06\u4f1a\u5728\u5b83\u6210\u529f\u4e4b\u540e\u518d\u6267\u884c\u3002\\n\\n\u6240\u4ee5Kubernetes\u4e2d\u63d0\u4f9b\u7684Probe\u80fd\u529b\u90fd\u5df2\u7ecf\u9650\u5b9a\u4e86\u7279\u5b9a\u7684\u8bed\u4e49\u4ee5\u53ca\u76f8\u5173\u7684\u884c\u4e3a\u3002**\u9664\u6b64\u4e4b\u5916\uff0c\u5176\u5b9e\u8fd8\u662f\u5b58\u5728\u81ea\u5b9a\u4e49Probe\u8bed\u4e49\u4ee5\u53ca\u76f8\u5173\u884c\u4e3a\u7684\u9700\u6c42**\uff0c\u4f8b\u5982\uff1a\\n- **GameServer\u5b9a\u4e49 Idle Probe \u7528\u6765\u5224\u65ad\u8be5Pod\u5f53\u524d\u662f\u5426\u5b58\u5728\u6e38\u620f\u5bf9\u5c40**\uff0c\u5982\u679c\u6ca1\u6709\uff0c\u4ece\u6210\u672c\u4f18\u5316\u7684\u89d2\u5ea6\uff0c\u53ef\u4ee5\u5c06\u8be5Pod\u7f29\u5bb9\u6389\u3002\\n- **K8S Operator\u5b9a\u4e49 main-secondary Probe \u6765\u5224\u65ad\u5f53\u524dPod\u7684\u89d2\u8272\uff08main or secondary\uff09**\uff0c\u5347\u7ea7\u7684\u65f6\u5019\uff0c\u53ef\u4ee5\u4f18\u5148\u5347\u7ea7 secondary\uff0c\u8fdb\u800c\u8fbe\u5230\u5347\u7ea7\u8fc7\u7a0b\u53ea\u6709\u4e00\u6b21\u9009\u4e3b\u7684\u884c\u4e3a\uff0c\u964d\u4f4e\u5347\u7ea7\u8fc7\u7a0b\u4e2d\u670d\u52a1\u6296\u52a8\u65f6\u95f4\u3002\\n\\nOpenKruise\u63d0\u4f9b\u4e86\u81ea\u5b9a\u4e49Probe\u7684\u80fd\u529b\uff0c\u5e76\u5c06\u7ed3\u679c\u8fd4\u56de\u5230Pod Status\u4e2d\uff0c\u7528\u6237\u53ef\u4ee5\u6839\u636e\u8be5\u7ed3\u679c\u51b3\u5b9a\u540e\u7eed\u7684\u884c\u4e3a\u3002\\n\\nPodProbeMarker\u914d\u7f6e\u5982\u4e0b\uff1a\\n\\n```yaml\\napiVersion: apps.kruise.io/v1alpha1\\nkind: PodProbeMarker\\nmetadata:\\n  name: game-server-probe\\n  namespace: ns\\nspec:\\n  selector:\\n    matchLabels:\\n      app: game-server\\n  probes:\\n  - name: Idle\\n    containerName: game-server\\n    probe:\\n      exec: \\n        command:\\n        - /home/game/idle.sh      \\n      initialDelaySeconds: 10\\n      timeoutSeconds: 3\\n      periodSeconds: 10\\n      successThreshold: 1\\n      failureThreshold: 3\\n    markerPolicy:\\n    - state: Succeeded\\n      labels:\\n        gameserver-idle: \'true\'\\n      annotations:\\n        controller.kubernetes.io/pod-deletion-cost: \'-10\'\\n    - state: Failed\\n      labels:\\n        gameserver-idle: \'false\'\\n      annotations:\\n        controller.kubernetes.io/pod-deletion-cost: \'10\'\\n        podConditionType: game.io/idle\\n```\\n\\nPodProbeMarker\u7ed3\u679c\u53ef\u4ee5\u901a\u8fc7Pod\u5bf9\u8c61\u67e5\u770b\uff1a\\n\\n```yaml\\napiVersion: v1\\nkind: Pod\\nmetadata:\\n  labels:\\n    app: game-server\\n    gameserver-idle: \'true\'\\n  annotations:\\n    controller.kubernetes.io/pod-deletion-cost: \'-10\'\\n  name: game-server-58cb9f5688-7sbd8\\n  namespace: ns\\nspec:\\n  ...\\nstatus:\\n  conditions:\\n    # podConditionType\\n  - type: game.io/idle\\n    # Probe State \'Succeeded\' indicates \'True\', and \'Failed\' indicates \'False\'\\n    status: \\"True\\"\\n    lastProbeTime: \\"2022-09-09T07:13:04Z\\"\\n    lastTransitionTime: \\"2022-09-09T07:13:04Z\\"\\n    # If the probe fails to execute, the message is stderr\\n    message: \\"\\"\\n```\\n\\n### 2. \u6027\u80fd\u4f18\u5316\uff1a\u5927\u89c4\u6a21\u96c6\u7fa4\u6027\u80fd\u663e\u8457\u63d0\u5347\\n\\n- [#1026](https://github.com/openkruise/kruise/pull/1026) \u5f15\u5165\u4e86\u5ef6\u8fdf\u5165\u961f\u673a\u5236\uff0c\u5927\u5e45\u4f18\u5316\u4e86\u5728\u5927\u89c4\u6a21\u5e94\u7528\u96c6\u7fa4\u4e0b kruise-manager \u62c9\u8d77\u65f6\u7684 CloneSet \u63a7\u5236\u5668\u5de5\u4f5c\u961f\u5217\u5806\u79ef\u95ee\u9898\uff0c\u5728\u7406\u60f3\u60c5\u51b5\u4e0b\u521d\u59cb\u5316\u65f6\u95f4\u51cf\u5c11\u4e86 80% \u4ee5\u4e0a\u3002\\n- [#1027](https://github.com/openkruise/kruise/pull/1027) \u4f18\u5316 PodUnavailableBudget \u63a7\u5236\u5668 Event Handler \u903b\u8f91\uff0c\u51cf\u5c11\u65e0\u5173 Pod \u5165\u961f\u6570\u91cf\u3002\\n- [#1011](https://github.com/openkruise/kruise/pull/1011) \u901a\u8fc7\u7f13\u5b58\u673a\u5236\uff0c\u4f18\u5316\u4e86\u5927\u89c4\u6a21\u96c6\u7fa4\u4e0b Advanced DaemonSet \u91cd\u590d\u6a21\u62df Pod \u8c03\u5ea6\u8ba1\u7b97\u7684 CPU\u3001Memory \u6d88\u8017\u3002\\n- [#1015](https://github.com/openkruise/kruise/pull/1015), [#1068](https://github.com/openkruise/kruise/pull/1068) \u5927\u5e45\u964d\u4f4e\u4e86\u5927\u89c4\u6a21\u96c6\u7fa4\u4e0b\u7684\u8fd0\u884c\u65f6\u5185\u5b58\u6d88\u8017\u3002\u5f25\u8865\u4e86 v1.1 \u7248\u672c\u4e2d Disable DeepCopy \u7684\u4e00\u4e9b\u758f\u6f0f\u70b9\uff0c\u51cf\u5c11 expressions \u7c7b\u578b label selector \u7684\u8f6c\u6362\u6d88\u8017\u3002\\n\\n### 3. SidecarSet \u652f\u6301\u6ce8\u5165\u7279\u5b9a\u7684\u5386\u53f2\u7248\u672c\\n\\nSidecarSet \u901a\u8fc7 ControllerRevision \u8bb0\u5f55\u4e86\u5173\u4e8e `containers`\u3001`volumes`\u3001`initContainers`\u3001`imagePullSecrets` \u548c `patchPodMetadata` \u7b49\u5b57\u6bb5\u7684\u5386\u53f2\u7248\u672c\uff0c\u5e76\u5141\u8bb8\u7528\u6237\u5728 Pod \u521b\u5efa\u65f6\u9009\u62e9\u7279\u5b9a\u7684\u5386\u53f2\u7248\u672c\u8fdb\u884c\u6ce8\u5165\u3002\\n\u57fa\u4e8e\u8fd9\u4e00\u7279\u6027\uff0c\u7528\u6237\u53ef\u4ee5\u89c4\u907f\u5728 SidecarSet \u7070\u5ea6\u53d1\u5e03\u65f6\uff0c\u56e0Deployment \u7b49 Workload \u6269\u5bb9\u3001\u5347\u7ea7\u7b49\u64cd\u4f5c\u5e26\u6765\u7684 SidecarSet \u53d1\u5e03\u98ce\u9669\u3002\u5982\u679c\u4e0d\u9009\u62e9\u6ce8\u5165\u7248\u672c\uff0cSidecarSet \u5c06\u5bf9\u91cd\u5efa Pod \u9ed8\u8ba4\u5168\u90fd\u6ce8\u5165\u6700\u65b0\u7248\u672c Sidecar\u3002\\n\\nSidecarSet \u76f8\u5173 ControllerRevision \u8d44\u6e90\u88ab\u653e\u7f6e\u5728\u4e86\u4e0e Kruise-Manager \u76f8\u540c\u7684\u547d\u540d\u7a7a\u95f4\u4e2d\uff0c\u7528\u6237\u53ef\u4ee5\u4f7f\u7528 `kubectl get controllerrevisions -n kruise-system -l kruise.io/sidecarset-name=your-sidecarset-name` \u6765\u67e5\u770b\u3002\\n\u6b64\u5916\uff0c\u7528\u6237\u8fd8\u53ef\u4ee5\u901a\u8fc7 SidecarSet \u7684 `status.latestRevision` \u5b57\u6bb5\u770b\u5230\u5f53\u524d\u7248\u672c\u5bf9\u5e94\u7684 ControllerRevision \u540d\u79f0\uff0c\u4ee5\u65b9\u4fbf\u81ea\u884c\u8bb0\u5f55\u3002\\n\\n#### \u901a\u8fc7 ControllerRevision \u540d\u79f0\u6307\u5b9a\u6ce8\u5165\u7684 Sidecar \u7248\u672c\\n```yaml\\napiVersion: apps.kruise.io/v1alpha1\\nkind: SidecarSet\\nmetadata:\\n  name: sidecarset\\nspec:\\n  ...\\n  injectionStrategy:\\n    revision:\\n      revisionName: specific-controllerRevision-name\\n```\\n\\n#### \u901a\u8fc7\u81ea\u5b9a\u4e49\u7248\u672c\u6807\u8bc6\u6307\u5b9a\u6ce8\u5165\u7684 Sidecar \u7248\u672c\\n\u7528\u6237\u53ef\u4ee5\u901a\u8fc7\u5728\u53d1\u7248\u65f6\uff0c\u540c\u65f6\u7ed9 SidecarSet \u6253\u4e0a `apps.kruise.io/sidecarset-custom-version=your-version-id` \u6765\u6807\u8bb0\u6bcf\u4e00\u4e2a\u5386\u53f2\u7248\u672c\uff0cSidecarSet \u4f1a\u5c06\u8fd9\u4e2a label \u5411\u4e0b\u5e26\u5165\u5230\u5bf9\u5e94\u7684 ControllerRevision \u5bf9\u8c61\uff0c\u4ee5\u4fbf\u7528\u6237\u8fdb\u884c\u7b5b\u9009\uff0c\u5e76\u4e14\u5141\u8bb8\u7528\u6237\u5728\u9009\u62e9\u6ce8\u5165\u5386\u53f2\u7248\u672c\u65f6\uff0c\u4f7f\u7528\u8be5 `your-version-id` \u6765\u8fdb\u884c\u63cf\u8ff0\u3002\\n\\n\u5047\u8bbe\u7528\u6237\u53ea\u60f3\u7070\u5ea6 `10%` \u7684 Pods \u5230 `version-2`\uff0c\u5e76\u4e14\u5bf9\u4e8e\u65b0\u521b\u5efa\u7684 Pod \u5e0c\u671b\u90fd\u6ce8\u5165\u66f4\u52a0\u7a33\u5b9a\u7684 `version-1` \u7248\u672c\u6765\u63a7\u5236\u7070\u5ea6\u98ce\u9669\uff1a\\n```yaml\\napiVersion: apps.kruise.io/v1alpha1\\nkind: SidecarSet\\nmetadata:\\n  name: sidecarset\\n  labels:\\n    apps.kruise.io/sidecarset-custom-version: version-2\\nspec:\\n  ...\\n  updateStrategy:\\n    partition: 90%\\n  injectionStrategy:\\n    revision:\\n      customVersion: version-1\\n```\\n\\n### 4. SidecarSet \u652f\u6301\u6ce8\u5165 Pod Annotations\\n\\nSidecarSet\u652f\u6301\u6ce8\u5165Pod Annotations\uff0c\u914d\u7f6e\u5982\u4e0b\uff1a\\n```yaml\\napiVersion: apps.kruise.io/v1alpha1\\nkind: SidecarSet\\nspec:\\n  containers:\\n  ...\\n  patchPodMetadata:\\n  - annotations:\\n    oom-score: \'{\\"log-agent\\": 1}\'\\n    custom.example.com/sidecar-configuration: \'{\\"command\\": \\"/home/admin/bin/start.sh\\", \\"log-level\\": \\"3\\"}\'\\n  patchPolicy: MergePatchJson\\n  - annotations:\\n    apps.kruise.io/container-launch-priority: Ordered\\n    patchPolicy: Overwrite | Retain\\n```\\npatchPolicy\u4e3a\u6ce8\u5165\u7684\u7b56\u7565\uff0c\u5982\u4e0b\uff1a\\n- **Retain\uff1a** \u9ed8\u8ba4\u7b56\u7565\uff0c\u5982\u679cPod\u4e2d\u5b58\u5728 annotation[key]=value \uff0c\u5219\u4fdd\u7559Pod\u539f\u6709\u7684value\u3002\u53ea\u6709\u5f53 Pod\u4e2d\u4e0d\u5b58\u5728 annotation[key] \u65f6\uff0c\u624d\u6ce8\u5165 annotations[key]=value\u3002\\n- **Overwrite\uff1a** \u4e0e Retain \u5bf9\u5e94\uff0c\u5f53 Pod \u4e2d\u5b58\u5728 annotation[key]=value\uff0c\u5c06\u88ab\u5f3a\u5236\u8986\u76d6\u4e3a value2\u3002\\n- **MergePatchJson\uff1a** \u4e0e Overwrite \u5bf9\u5e94\uff0cannotations value\u4e3a json \u5b57\u7b26\u4e32\u3002\u5982\u679c Pod \u4e0d\u5b58\u5728\u8be5 annotations[key]\uff0c\u5219\u76f4\u63a5\u6ce8\u5165\u3002\u5982\u679c\u5b58\u5728\uff0c\u5219\u8fdb\u884c json value\u5408\u5e76\u3002\\n\u4f8b\u5982\uff1aPod\u4e2d\u5b58\u5728 annotations[oom-score]=\'\\\\{\\"main\\": 2\\\\}\'\uff0c\u6ce8\u5165\u540e\u5c06 value json\u5408\u5e76\u4e3a annotations[oom-score]=\'\\\\{\\"log-agent\\": 1, \\"main\\": 2\\\\}\'\u3002\\n\\n**\u6ce8\u610f\uff1a** patchPolicy\u4e3aOverwrite\u548cMergePatchJson\u65f6\uff0cSidecarSet\u539f\u5730\u5347\u7ea7 Sidecar Container\u65f6\uff0c\u80fd\u591f\u540c\u6b65\u66f4\u65b0\u8be5 annotations\u3002\u4f46\u662f\uff0c\u5982\u679c\u53ea\u4fee\u6539annotations\u5219\u4e0d\u80fd\u751f\u6548\uff0c\u53ea\u80fd\u642d\u914dSidecar\u5bb9\u5668\u955c\u50cf\u4e00\u8d77\u539f\u5730\u5347\u7ea7\u3002\\npatchPolicy\u4e3aRetain\u65f6\uff0cSidecarSet\u539f\u5730\u5347\u7ea7 Sidecar Container\u65f6\uff0c\u5c06\u4e0d\u4f1a\u540c\u6b65\u66f4\u65b0\u8be5 annotations\u3002\\n\\n\u4e0a\u8ff0\u914d\u7f6e\u540e\uff0csidecarSet\u5728\u6ce8\u5165sidecar container\u65f6\uff0c\u4f1a\u6ce8\u5165Pod annotations\uff0c\u5982\u4e0b\uff1a\\n```yaml\\napiVersion: v1\\nkind: Pod\\nmetadata:\\n  annotations:\\n    apps.kruise.io/container-launch-priority: Ordered\\n    oom-score: \'{\\"log-agent\\": 1, \\"main\\": 2}\'\\n    custom.example.com/sidecar-configuration: \'{\\"command\\": \\"/home/admin/bin/start.sh\\", \\"log-level\\": \\"3\\"}\'\\n  name: test-pod\\nspec:\\n  containers:\\n    ...\\n```\\n\\n**\u6ce8\u610f\uff1a** SidecarSet\u4ece\u5b89\u5168\u7684\u8003\u8651\u4e0d\u5e94\u8be5\u6ce8\u5165\u6216\u4fee\u6539\u9664 sidecar container \u4e4b\u5916\u7684 Pod \u5b57\u6bb5\uff0c\u6240\u4ee5\u5982\u679c\u60f3\u8981\u4f7f\u7528\u8be5\u80fd\u529b\uff0c\u9996\u5148\u9700\u8981\u914d\u7f6e SidecarSet_PatchPodMetadata_WhiteList \u767d\u540d\u5355\\n\u6216\u901a\u8fc7 Feature-gate SidecarSetPatchPodMetadataDefaultsAllowed=true \u5173\u95ed\u767d\u540d\u5355\u6821\u9a8c\u3002\\n\\n### 5. Advanced DaemonSet \u652f\u6301\u955c\u50cf\u9884\u70ed\\n\\n\u5982\u679c\u4f60\u5728\u5b89\u88c5\u6216\u5347\u7ea7 Kruise \u7684\u65f6\u5019\u542f\u7528\u4e86 `PreDownloadImageForDaemonSetUpdate` feature-gate\uff0c\\nDaemonSet \u63a7\u5236\u5668\u4f1a\u81ea\u52a8\u5728\u6240\u6709\u65e7\u7248\u672c pod \u6240\u5728 node \u8282\u70b9\u4e0a\u9884\u70ed\u4f60\u6b63\u5728\u7070\u5ea6\u53d1\u5e03\u7684\u65b0\u7248\u672c\u955c\u50cf\u3002 \u8fd9\u5bf9\u4e8e\u5e94\u7528\u53d1\u5e03\u52a0\u901f\u5f88\u6709\u5e2e\u52a9\u3002\\n\\n\u9ed8\u8ba4\u60c5\u51b5\u4e0b DaemonSet \u6bcf\u4e2a\u65b0\u955c\u50cf\u9884\u70ed\u65f6\u7684\u5e76\u53d1\u5ea6\u90fd\u662f `1`\uff0c\u4e5f\u5c31\u662f\u4e00\u4e2a\u4e2a\u8282\u70b9\u62c9\u955c\u50cf\u3002\\n\u5982\u679c\u9700\u8981\u8c03\u6574\uff0c\u4f60\u53ef\u4ee5\u901a\u8fc7 `apps.kruise.io/image-predownload-parallelism` annotation \u6765\u8bbe\u7f6e\u5e76\u53d1\u5ea6\u3002\\n\\n```yaml\\napiVersion: apps.kruise.io/v1alpha1\\nkind: DaemonSet\\nmetadata:\\n  annotations:\\n    apps.kruise.io/image-predownload-parallelism: \\"10\\"\\n```\\n\\n### 6. CloneSet \u6269\u7f29\u5bb9\u4e0e PreparingDelete\\n\\n\u9ed8\u8ba4\u60c5\u51b5\u4e0b\uff0cCloneSet \u5c06\u5904\u4e8e `PreparingDelete` \u72b6\u6001\u7684 Pod \u89c6\u4e3a\u6b63\u5e38\uff0c\u610f\u5473\u7740\u8fd9\u4e9b Pod \u4ecd\u7136\u88ab\u8ba1\u7b97\u5728 `replicas` \u6570\u91cf\u4e2d\u3002\\n\\n\u5728\u8fd9\u79cd\u60c5\u51b5\u4e0b\uff1a\\n\\n- \u5982\u679c\u4f60\u5c06 `replicas` \u4ece `N` \u6539\u4e3a `N-1`\uff0c\u5f53\u4e00\u4e2a\u8981\u5220\u9664\u7684 Pod \u8fd8\u5728 `PreparingDelete` \u72b6\u6001\u4e2d\u65f6\uff0c\u4f60\u91cd\u65b0\u5c06 `replicas` \u6539\u4e3a `N`\uff0cCloneSet \u4f1a\u5c06\u8fd9\u4e2a Pod \u91cd\u65b0\u7f6e\u4e3a `Normal` \u72b6\u6001\u3002\\n- \u5982\u679c\u4f60\u5c06 `replicas` \u4ece `N` \u6539\u4e3a `N-1` \u7684\u540c\u65f6\u5728 `podsToDelete` \u4e2d\u8bbe\u7f6e\u4e86\u4e00\u4e2a Pod\uff0c\u5f53\u8fd9\u4e2a Pod \u8fd8\u5728 `PreparingDelete` \u72b6\u6001\u4e2d\u65f6\uff0c\u4f60\u91cd\u65b0\u5c06 `replicas` \u6539\u4e3a `N`\uff0cCloneSet \u4f1a\u7b49\u5230\u8fd9\u4e2a Pod \u771f\u6b63\u8fdb\u5165 terminating \u4e4b\u540e\u518d\u6269\u5bb9\u4e00\u4e2a Pod \u51fa\u6765\u3002\\n- \u5982\u679c\u4f60\u5728\u4e0d\u6539\u53d8 `replicas` \u7684\u65f6\u5019\u6307\u5b9a\u5220\u9664\u4e00\u4e2a Pod\uff0c\u5f53\u8fd9\u4e2a Pod \u8fd8\u5728 `PreparingDelete` \u72b6\u6001\u4e2d\u65f6\uff0cCloneSet \u4f1a\u7b49\u5230\u8fd9\u4e2a Pod \u771f\u6b63\u8fdb\u5165 terminating \u4e4b\u540e\u518d\u6269\u5bb9\u4e00\u4e2a Pod \u51fa\u6765\u3002\\n\\n\u4ece Kruise v1.3.0 \u7248\u672c\u5f00\u59cb\uff0c\u4f60\u53ef\u4ee5\u5728 CloneSet \u4e2d\u8bbe\u7f6e\u4e00\u4e2a `apps.kruise.io/cloneset-scaling-exclude-preparing-delete: \\"true\\"` \u6807\u7b7e\uff0c\u5b83\u6807\u5fd7\u7740\u8fd9\u4e2a CloneSet \u4e0d\u4f1a\u5c06 `PreparingDelete` \u72b6\u6001\u7684 Pod \u8ba1\u7b97\u5728 `replicas` \u6570\u91cf\u4e2d\u3002\\n\\n\u5728\u8fd9\u79cd\u60c5\u51b5\u4e0b\uff1a\\n\\n- \u5982\u679c\u4f60\u5c06 `replicas` \u4ece `N` \u6539\u4e3a `N-1`\uff0c\u5f53\u4e00\u4e2a\u8981\u5220\u9664\u7684 Pod \u8fd8\u5728 `PreparingDelete` \u72b6\u6001\u4e2d\u65f6\uff0c\u4f60\u91cd\u65b0\u5c06 `replicas` \u6539\u4e3a `N`\uff0cCloneSet \u4f1a\u5c06\u8fd9\u4e2a Pod \u91cd\u65b0\u7f6e\u4e3a `Normal` \u72b6\u6001\u3002\\n- \u5982\u679c\u4f60\u5c06 `replicas` \u4ece `N` \u6539\u4e3a `N-1` \u7684\u540c\u65f6\u5728 `podsToDelete` \u4e2d\u8bbe\u7f6e\u4e86\u4e00\u4e2a Pod\uff0c\u5f53\u8fd9\u4e2a Pod \u8fd8\u5728 `PreparingDelete` \u72b6\u6001\u4e2d\u65f6\uff0c\u4f60\u91cd\u65b0\u5c06 `replicas` \u6539\u4e3a `N`\uff0cCloneSet \u4f1a\u7acb\u5373\u521b\u5efa\u4e00\u4e2a\u65b0 Pod\u3002\\n- \u5982\u679c\u4f60\u5728\u4e0d\u6539\u53d8 `replicas` \u7684\u65f6\u5019\u6307\u5b9a\u5220\u9664\u4e00\u4e2a Pod\uff0c\u5f53\u8fd9\u4e2a Pod \u8fd8\u5728 `PreparingDelete` \u72b6\u6001\u4e2d\u65f6\uff0cCloneSet \u4f1a\u7acb\u5373\u521b\u5efa\u4e00\u4e2a\u65b0 Pod\u3002\\n\\n### 7. Advanced CronJob Time zones\\n\\n\u9ed8\u8ba4\u60c5\u51b5\u4e0b\uff0c\u6240\u6709 AdvancedCronJob schedule \u8c03\u5ea6\u65f6\uff0c\u90fd\u662f\u57fa\u4e8e kruise-controller-manager \u5bb9\u5668\u672c\u5730\u7684\u65f6\u533a\u6240\u8ba1\u7b97\u7684\u3002\\n\\n\u4e0d\u8fc7\uff0c\u5728 v1.3.0 \u7248\u672c\u4e2d\u6211\u4eec\u5f15\u5165\u4e86 `spec.timeZone` \u5b57\u6bb5\uff0c\u4f60\u53ef\u4ee5\u5c06\u5b83\u8bbe\u7f6e\u4e3a\u4efb\u610f\u5408\u6cd5\u65f6\u533a\u7684\u540d\u5b57\u3002\u4f8b\u5982\uff0c\u8bbe\u7f6e `spec.timeZone: \\"Asia/Shanghai\\"` \u5219 Kruise \u4f1a\u6839\u636e\u56fd\u5185\u7684\u65f6\u533a\u8ba1\u7b97 schedule \u4efb\u52a1\u89e6\u53d1\u65f6\u95f4\u3002\\n\\nGo \u6807\u51c6\u5e93\u4e2d\u5185\u7f6e\u4e86\u65f6\u533a\u6570\u636e\u5e93\uff0c\u4f5c\u4e3a\u5728\u5bb9\u5668\u7684\u7cfb\u7edf\u73af\u5883\u4e2d\u6ca1\u6709\u5916\u7f6e\u6570\u636e\u5e93\u65f6\u7684 fallback \u9009\u62e9\u3002\\n\\n### 8. \u5176\u4ed6\u6539\u52a8\\n\\n\u4f60\u53ef\u4ee5\u901a\u8fc7 [Github release](https://github.com/openkruise/kruise/releases) \u9875\u9762\uff0c\u6765\u67e5\u770b\u66f4\u591a\u7684\u6539\u52a8\u4ee5\u53ca\u5b83\u4eec\u7684\u4f5c\u8005\u4e0e\u63d0\u4ea4\u8bb0\u5f55\u3002\\n\\n## \u793e\u533a\u53c2\u4e0e\\n\\n\u975e\u5e38\u6b22\u8fce\u4f60\u901a\u8fc7 Github/Slack/\u9489\u9489/\u5fae\u4fe1 \u7b49\u65b9\u5f0f\u52a0\u5165\u6211\u4eec\u6765\u53c2\u4e0e OpenKruise \u5f00\u6e90\u793e\u533a\u3002\\n\u4f60\u662f\u5426\u5df2\u7ecf\u6709\u4e00\u4e9b\u5e0c\u671b\u4e0e\u6211\u4eec\u793e\u533a\u4ea4\u6d41\u7684\u5185\u5bb9\u5462\uff1f\\n\u53ef\u4ee5\u5728\u6211\u4eec\u7684[\u793e\u533a\u53cc\u5468\u4f1a](https://shimo.im/docs/gXqmeQOYBehZ4vqo)\u4e0a\u5206\u4eab\u4f60\u7684\u58f0\u97f3\uff0c\u6216\u901a\u8fc7\u4ee5\u4e0b\u6e20\u9053\u53c2\u4e0e\u8ba8\u8bba\uff1a\\n\\n- \u52a0\u5165\u793e\u533a [Slack channel](https://kubernetes.slack.com/channels/openkruise) (English)\\n- \u52a0\u5165\u793e\u533a\u9489\u9489\u7fa4\uff1a\u641c\u7d22\u7fa4\u53f7 `23330762` (Chinese)\\n- \u52a0\u5165\u793e\u533a\u5fae\u4fe1\u7fa4\uff08\u65b0\uff09\uff1a\u6dfb\u52a0\u7528\u6237 `openkruise` \u5e76\u8ba9\u673a\u5668\u4eba\u62c9\u4f60\u5165\u7fa4 (Chinese)"},{"id":"openkruise-1.2","metadata":{"permalink":"/zh/blog/openkruise-1.2","editUrl":"https://github.com/openkruise/openkruise.io/edit/master/blog/2022-06-07-release-1.2.md","source":"@site/i18n/zh/docusaurus-plugin-content-blog/2022-06-07-release-1.2.md","title":"OpenKruise v1.2\uff1a\u65b0\u589e PersistentPodState \u5b9e\u73b0\u6709\u72b6\u6001 Pod \u62d3\u6251\u56fa\u5b9a\u4e0e IP \u590d\u7528","description":"\u4e91\u539f\u751f\u5e94\u7528\u81ea\u52a8\u5316\u7ba1\u7406\u5957\u4ef6\u3001CNCF Sandbox \u9879\u76ee -- OpenKruise\uff0c\u8fd1\u671f\u53d1\u5e03\u4e86 v1.2 \u7248\u672c\u3002","date":"2022-06-07T00:00:00.000Z","tags":[{"inline":true,"label":"release","permalink":"/zh/blog/tags/release"}],"readingTime":7.55,"hasTruncateMarker":false,"authors":[{"name":"Siyu Wang","title":"Maintainer of OpenKruise","url":"https://github.com/FillZpp","imageURL":"https://github.com/FillZpp.png","key":"FillZpp","page":null}],"frontMatter":{"slug":"openkruise-1.2","title":"OpenKruise v1.2\uff1a\u65b0\u589e PersistentPodState \u5b9e\u73b0\u6709\u72b6\u6001 Pod \u62d3\u6251\u56fa\u5b9a\u4e0e IP \u590d\u7528","authors":["FillZpp"],"tags":["release"]},"unlisted":false,"prevItem":{"title":"OpenKruise v1.3\uff1a\u65b0\u589e\u81ea\u5b9a\u4e49 Pod Probe \u63a2\u9488\u80fd\u529b\u4e0e\u5927\u89c4\u6a21\u96c6\u7fa4\u6027\u80fd\u663e\u8457\u63d0\u5347","permalink":"/zh/blog/openkruise-1.3"},"nextItem":{"title":"OpenKruise v1.1\uff1a\u529f\u80fd\u589e\u5f3a\u4e0e\u4e0a\u6e38\u5bf9\u9f50\uff0c\u5927\u89c4\u6a21\u573a\u666f\u6027\u80fd\u4f18\u5316","permalink":"/zh/blog/openkruise-1.1"}},"content":"\u4e91\u539f\u751f\u5e94\u7528\u81ea\u52a8\u5316\u7ba1\u7406\u5957\u4ef6\u3001CNCF Sandbox \u9879\u76ee -- OpenKruise\uff0c\u8fd1\u671f\u53d1\u5e03\u4e86 v1.2 \u7248\u672c\u3002\\n\\n[OpenKruise](https://openkruise.io) \u662f\u9488\u5bf9 Kubernetes \u7684\u589e\u5f3a\u80fd\u529b\u5957\u4ef6\uff0c\u805a\u7126\u4e8e\u4e91\u539f\u751f\u5e94\u7528\u7684\u90e8\u7f72\u3001\u5347\u7ea7\u3001\u8fd0\u7ef4\u3001\u7a33\u5b9a\u6027\u9632\u62a4\u7b49\u9886\u57df\u3002\\n\u6240\u6709\u7684\u529f\u80fd\u90fd\u901a\u8fc7 CRD \u7b49\u6807\u51c6\u65b9\u5f0f\u6269\u5c55\uff0c\u53ef\u4ee5\u9002\u7528\u4e8e 1.16 \u4ee5\u4e0a\u7248\u672c\u7684\u4efb\u610f Kubernetes \u96c6\u7fa4\u3002\u5355\u6761 helm \u547d\u4ee4\u5373\u53ef\u5b8c\u6210 Kruise \u7684\u4e00\u952e\u90e8\u7f72\uff0c\u65e0\u9700\u66f4\u591a\u914d\u7f6e\u3002\\n\\n## \u7248\u672c\u89e3\u6790\\n\\n\u5728 v1.2 \u7248\u672c\u4e2d\uff0cOpenKruise \u63d0\u4f9b\u4e86\u4e00\u4e2a\u540d\u4e3a `PersistentPodState` \u7684\u65b0 CRD \u548c\u63a7\u5236\u5668\uff0c\u5728 CloneSet status \u548c lifecycle hook \u4e2d\u65b0\u589e\u5b57\u6bb5\uff0c\\n\u5e76\u5bf9 PodUnavailableBudget \u505a\u4e86\u591a\u91cd\u4f18\u5316\u3002\\n\\n### 1. \u65b0\u589e CRD \u548c Controller\uff1aPersistentPodState\\n\\n\\n\u968f\u7740\u4e91\u539f\u751f\u7684\u53d1\u5c55\uff0c\u8d8a\u6765\u8d8a\u591a\u7684\u516c\u53f8\u5f00\u59cb\u5c06\u6709\u72b6\u6001\u670d\u52a1\uff08\u5982\uff1aEtcd\u3001MQ\uff09\u8fdb\u884c Kubernetes \u90e8\u7f72\u3002K8s StatefulSet \u662f\u7ba1\u7406\u6709\u72b6\u6001\u670d\u52a1\u7684\u5de5\u4f5c\u8d1f\u8f7d\uff0c\u5b83\u5728\u5f88\u591a\u65b9\u9762\u8003\u8651\u4e86\u6709\u72b6\u6001\u670d\u52a1\u7684\u90e8\u7f72\u7279\u5f81\u3002\\n\u7136\u800c\uff0cStatefulSet \u53ea\u80fd\u4fdd\u6301\u6709\u9650\u7684Pod\u72b6\u6001\uff0c\u5982\uff1aPod Name \u6709\u5e8f\u4e14\u4e0d\u53d8\uff0cPVC \u6301\u4e45\u5316\uff0c\u5e76\u4e0d\u80fd\u6ee1\u8db3\u5176\u5b83 Pod \u72b6\u6001\u7684\u4fdd\u6301\u9700\u6c42\uff0c\u4f8b\u5982\uff1a\u56fa\u5b9a IP \u8c03\u5ea6\uff0c\u4f18\u5148\u8c03\u5ea6\u5230\u4e4b\u524d\u90e8\u7f72\u7684 Node \u7b49\u3002\u5178\u578b\u6848\u4f8b\u6709\uff1a\\n\\n- **\u670d\u52a1\u53d1\u73b0\u4e2d\u95f4\u4ef6\u670d\u52a1\u5bf9\u90e8\u7f72\u4e4b\u540e\u7684 Pod IP \u5f02\u5e38\u654f\u611f\uff0c\u8981\u6c42 IP \u4e0d\u80fd\u968f\u610f\u6539\u53d8**\\n\\n- **\u6570\u636e\u5e93\u670d\u52a1\u5c06\u6570\u636e\u6301\u4e45\u5316\u5230\u5bbf\u4e3b\u673a\u78c1\u76d8\uff0c\u6240\u5c5e Node \u6539\u53d8\u5c06\u5bfc\u81f4\u6570\u636e\u4e22\u5931**\\n\\n\u9488\u5bf9\u4e0a\u8ff0\u63cf\u8ff0\uff0cKruise \u901a\u8fc7\u81ea\u5b9a\u4e49 PersistentPodState CRD\uff0c\u80fd\u591f\u4fdd\u6301 Pod \u5176\u5b83\u76f8\u5173\u72b6\u6001\uff0c\u4f8b\u5982\uff1a\u201c\u56fa\u5b9a IP \u8c03\u5ea6\u201d\u3002\\n\\n\u4e00\u4e2a `PersistentPodState` \u8d44\u6e90\u5bf9\u8c61 YAML \u5982\u4e0b\uff1a\\n\\n```yaml\\napiVersion: apps.kruise.io/v1alpha1\\nkind: PersistentPodState\\nmetadata:\\n  name: echoserver\\n  namespace: echoserver\\nspec:\\n  targetRef:\\n    # \u539f\u751fk8s \u6216 kruise StatefulSet\\n    # \u53ea\u652f\u6301 StatefulSet \u7c7b\u578b\\n    apiVersion: apps.kruise.io/v1beta1\\n    kind: StatefulSet\\n    name: echoserver\\n  # required node affinity\uff0c\u5982\u4e0b\uff1aPod\u91cd\u5efa\u540e\u5c06\u5f3a\u5236\u90e8\u7f72\u5230\u540cZone\\n  requiredPersistentTopology:\\n    nodeTopologyKeys:\\n      - failure-domain.beta.kubernetes.io/zone[,other node labels]\\n  # preferred node affinity\uff0c\u5982\u4e0b\uff1aPod\u91cd\u5efa\u540e\u5c06\u5c3d\u91cf\u90e8\u7f72\u5230\u540cNode\\n  preferredPersistentTopology:\\n    - preference:\\n        nodeTopologyKeys:\\n          - kubernetes.io/hostname[,other node labels]\\n      # int, [1 - 100]\\n      weight: 100\\n```\\n\\n\u201c\u56fa\u5b9a IP \u8c03\u5ea6\u201d\u5e94\u8be5\u662f\u6bd4\u8f83\u5e38\u89c1\u7684\u6709\u72b6\u6001\u670d\u52a1\u7684 K8s \u90e8\u7f72\u8981\u6c42\uff0c\u5b83\u7684\u542b\u4e49\u4e0d\u662f\u201c\u6307\u5b9a Pod IP \u90e8\u7f72\u201d\uff0c\u800c\u662f\u8981\u6c42 Pod \u5728\u7b2c\u4e00\u6b21\u90e8\u7f72\u4e4b\u540e\uff0c\u4e1a\u52a1\u53d1\u5e03\u6216\u673a\u5668\u9a71\u9010\u7b49\u5e38\u89c4\u6027\u8fd0\u7ef4\u64cd\u4f5c\u90fd\u4e0d\u4f1a\u5bfc\u81f4 Pod IP \u53d1\u751f\u53d8\u5316\u3002\\n\u8fbe\u5230\u4e0a\u8ff0\u6548\u679c\uff0c\u9996\u5148\u5c31\u9700\u8981 K8s \u7f51\u7edc\u7ec4\u4ef6\u80fd\u591f\u652f\u6301Pod IP\u4fdd\u7559\u4ee5\u53ca\u5c3d\u91cf\u4fdd\u6301IP\u4e0d\u53d8\u7684\u80fd\u529b\uff0c\u672c\u6587\u5c06 flannel \u7f51\u7edc\u7ec4\u4ef6\u4e2d\u7684 Host-local \u63d2\u4ef6\u505a\u4e86\u4e00\u4e9b\u4ee3\u7801\u6539\u9020\uff0c\\n\u4f7f\u4e4b\u80fd\u591f\u8fbe\u5230\u540c Node \u4e0b\u4fdd\u6301 Pod IP \u4e0d\u53d8\u7684\u6548\u679c\uff0c\u76f8\u5173\u539f\u7406\u5c31\u4e0d\u5728\u6b64\u9648\u8ff0\uff0c\u4ee3\u7801\u8bf7\u53c2\u8003\uff1a[host-local](https://github.com/openkruise/samples)\u3002\\n\\n\u201c\u56fa\u5b9a IP \u8c03\u5ea6\u201d\u597d\u50cf\u6709\u7f51\u7edc\u7ec4\u4ef6\u652f\u6301\u5c31\u597d\u4e86\uff0c\u8fd9\u8ddf PersistentPodState \u6709\u4ec0\u4e48\u5173\u7cfb\u5462\uff1f\u56e0\u4e3a\uff0c\u7f51\u7edc\u7ec4\u4ef6\u5b9e\u73b0\\"Pod IP \u4fdd\u6301\u4e0d\u53d8\\"\u90fd\u6709\u4e00\u5b9a\u7684\u9650\u5236\uff0c\\n\u4f8b\u5982\uff1aflannel \u53ea\u80fd\u652f\u6301\u540c Node \u4fdd\u6301 Pod IP \u4e0d\u53d8\u3002\u4f46\u662f\uff0cK8s \u8c03\u5ea6\u7684\u6700\u5927\u7279\u6027\u5c31\u662f\u201c\u4e0d\u786e\u5b9a\u6027\u201d\uff0c\u6240\u4ee5\u201c\u5982\u4f55\u4fdd\u8bc1 Pod \u91cd\u5efa\u540e\u8c03\u5ea6\u5230\u540c Node \u4e0a\u201d\u5c31\u662f PersistentPodState \u89e3\u51b3\u7684\u95ee\u9898\u3002\\n\\n\u53e6\u5916\uff0c\u4f60\u53ef\u4ee5\u901a\u8fc7\u5728 StatefulSet \u6216 Advanced StatefulSet \u4e0a\u9762\u65b0\u589e\u5982\u4e0b\u7684 annotations\uff0c\u6765\u8ba9 Kruise \u81ea\u52a8\u4e3a\u4f60\u7684 StatefulSet \u521b\u5efa `PersistentPodState` \u5bf9\u8c61\uff0c\u4ece\u800c\u907f\u514d\u4e86\u624b\u52a8\u521b\u5efa\u6240\u6709 `PersistentPodState` \u7684\u8d1f\u62c5\u3002\\n\\n```yaml\\napiVersion: apps.kruise.io/v1alpha1\\nkind: StatefulSet\\nmetadata:\\n  annotations:\\n    # \u81ea\u52a8\u751f\u6210PersistentPodState\u5bf9\u8c61\\n    kruise.io/auto-generate-persistent-pod-state: \\"true\\"\\n    # preferred node affinity\uff0c\u5982\u4e0b\uff1aPod\u91cd\u5efa\u540e\u5c06\u5c3d\u91cf\u90e8\u7f72\u5230\u540cNode\\n    kruise.io/preferred-persistent-topology: kubernetes.io/hostname[,other node labels]\\n    # required node affinity\uff0c\u5982\u4e0b\uff1aPod\u91cd\u5efa\u540e\u5c06\u5f3a\u5236\u90e8\u7f72\u5230\u540cZone\\n    kruise.io/required-persistent-topology: failure-domain.beta.kubernetes.io/zone[,other node labels]\\n```\\n\\n### 2. CloneSet \u9488\u5bf9\u767e\u5206\u6bd4\u5f62\u5f0f partition \u8ba1\u7b97\u903b\u8f91\u53d8\u5316\uff0c\u65b0\u589e status \u5b57\u6bb5\\n\\n\u8fc7\u53bb\uff0cCloneSet \u901a\u8fc7 \u201c\u5411\u4e0a\u53d6\u6574\u201d \u7684\u65b9\u5f0f\u6765\u8ba1\u7b97\u5b83\u7684 `partition` \u6570\u503c\uff08\u5f53\u5b83\u662f\u767e\u5206\u6bd4\u5f62\u5f0f\u7684\u6570\u503c\u65f6\uff09\uff0c\u8fd9\u610f\u5473\u7740\u5373\u4f7f\u4f60\u5c06 `partition`\\n\u8bbe\u7f6e\u4e3a\u4e00\u4e2a\u5c0f\u4e8e `100%` \u7684\u767e\u5206\u6bd4\uff0cCloneSet \u4e5f\u6709\u53ef\u80fd\u4e0d\u4f1a\u5347\u7ea7\u4efb\u4f55\u4e00\u4e2a Pod \u5230\u65b0\u7248\u672c\u3002\\n\u6bd4\u5982\uff0c\u5bf9\u4e8e\u4e00\u4e2a `replicas=8` \u548c `partition=90%` \u7684 CloneSet \u5bf9\u8c61\uff0c\u5b83\u6240\u8ba1\u7b97\u51fa\u7684\u5b9e\u9645 partition \u6570\u503c\u662f `8`\uff08\u6765\u81ea `8 * 90%` \u5411\u4e0a\u53d6\u6574\uff09\uff0c\\n\u56e0\u6b64\u5b83\u6682\u65f6\u4e0d\u4f1a\u6267\u884c\u5347\u7ea7\u52a8\u4f5c\u3002\\n\u8fd9\u6709\u65f6\u5019\u4f1a\u4e3a\u7528\u6237\u6765\u5e26\u56f0\u60d1\uff0c\u5c24\u5176\u662f\u5bf9\u4e8e\u4f7f\u7528\u4e86\u4e00\u4e9b rollout \u6eda\u52a8\u5347\u7ea7\u7ec4\u4ef6\u7684\u573a\u666f\uff0c\u6bd4\u5982 Kruise Rollout \u6216 Argo\u3002\\n\\n**\u56e0\u6b64\uff0c\u4ece v1.2 \u7248\u672c\u5f00\u59cb\uff0cCloneSet \u4f1a\u4fdd\u8bc1\u5728 `partition` \u662f\u5c0f\u4e8e `100% ` \u7684\u767e\u5206\u6bd4\u6570\u503c\u65f6\uff0c\u81f3\u5c11\u6709 1 \u4e2a Pod \u4f1a\u88ab\u5347\u7ea7\uff0c\u9664\u975e CloneSet \u5904\u4e8e `replicas <= 1` \u7684\u60c5\u51b5\u3002**\\n\\n\u4e0d\u8fc7\uff0c\u8fd9\u6837\u4f1a\u5bfc\u81f4\u7528\u6237\u96be\u4ee5\u7406\u89e3\u5176\u4e2d\u7684\u8ba1\u7b97\u903b\u8f91\uff0c\u540c\u65f6\u53c8\u9700\u8981\u5728 partition \u5347\u7ea7\u7684\u65f6\u5019\u77e5\u9053\u671f\u671b\u5347\u7ea7\u7684 Pod \u6570\u91cf\uff0c\u6765\u5224\u65ad\u8be5\u6279\u6b21\u5347\u7ea7\u662f\u5426\u5b8c\u6210\u3002\\n\\n\u6240\u4ee5\u6211\u4eec\u53e6\u5916\u53c8\u5728 CloneSet status \u4e2d\u65b0\u589e\u4e86 `expectedUpdatedReplicas` \u5b57\u6bb5\uff0c\u5b83\u53ef\u4ee5\u5f88\u76f4\u63a5\u5730\u5c55\u793a\u57fa\u4e8e\u5f53\u524d\u7684 `partition` \u6570\u503c\uff0c\u671f\u671b\u6709\u591a\u5c11 Pod \u4f1a\u88ab\u5347\u7ea7\u3002\\n\u5bf9\u4e8e\u7528\u6237\u6765\u8bf4\uff0c\u53ea\u9700\u8981\u6bd4\u5bf9 `status.updatedReplicas >= status.expectedUpdatedReplicas` \u4ee5\u53ca\u53e6\u5916\u7684 `updatedReadyReplicas` \u6765\u5224\u65ad\u5f53\u524d\u53d1\u5e03\u9636\u6bb5\u662f\u5426\u8fbe\u5230\u5b8c\u6210\u72b6\u6001\u3002\\n\\n```yaml\\napiVersion: apps.kruise.io/v1alpha1\\nkind: CloneSet\\nspec:\\n  replicas: 8\\n  updateStrategy:\\n    partition: 90%\\nstatus:\\n  replicas: 8\\n  expectedUpdatedReplicas: 1\\n  updatedReplicas: 1\\n  updatedReadyReplicas: 1\\n```\\n\\n### 3. \u5728 lifecycle hook \u9636\u6bb5\u8bbe\u7f6e Pod not-ready\\n\\nKruise \u5728\u65e9\u5148\u7684\u7248\u672c\u4e2d\u63d0\u4f9b\u4e86 lifecycle hook \u529f\u80fd\uff0c\u5176\u4e2d CloneSet \u548c Advanced StatefulSet \u90fd\u652f\u6301\u4e86 PreDelete\u3001InPlaceUpdate \u4e24\u79cd hook\uff0c\\nAdvanced DaemonSet \u76ee\u524d\u53ea\u652f\u6301 PreDelete hook\u3002\\n\\n\u8fc7\u53bb\uff0c\u8fd9\u4e9b hook \u53ea\u4f1a\u5c06\u5f53\u524d\u7684\u64cd\u4f5c\u5361\u4f4f\uff0c\u5e76\u5141\u8bb8\u7528\u6237\u5728 Pod \u5220\u9664\u4e4b\u524d\u6216\u8005\u539f\u5730\u5347\u7ea7\u7684\u524d\u540e\u6765\u505a\u4e00\u4e9b\u81ea\u5b9a\u4e49\u7684\u4e8b\u60c5\uff08\u6bd4\u5982\u5c06 Pod \u4ece\u670d\u52a1\u7aef\u70b9\u4e2d\u6458\u9664\uff09\u3002\\n\u4f46\u662f\uff0cPod \u5728\u8fd9\u4e9b\u9636\u6bb5\u4e2d\u5f88\u53ef\u80fd\u8fd8\u5904\u4e8e Ready \u72b6\u6001\uff0c\u6b64\u65f6\u5c06\u5b83\u4ece\u4e00\u4e9b\u81ea\u5b9a\u4e49\u7684 service \u5b9e\u73b0\u4e2d\u6458\u9664\uff0c\\n\u5176\u5b9e\u4e00\u5b9a\u7a0b\u5ea6\u4e0a\u6709\u70b9\u8fdd\u80cc Kubernetes \u7684\u5e38\u7406\uff0c\u4e00\u822c\u6765\u8bf4\u5b83\u53ea\u4f1a\u5c06\u5904\u4e8e NotReady \u72b6\u6001\u7684 Pod \u4ece\u670d\u52a1\u7aef\u70b9\u4e2d\u6458\u9664\u3002\\n\\n\u56e0\u6b64\uff0c\u8fd9\u4e2a\u7248\u672c\u6211\u4eec\u5728 lifecycle hook \u4e2d\u65b0\u589e\u4e86 `markPodNotReady` \u5b57\u6bb5\uff0c\u5b83\u63a7\u5236\u4e86 Pod \u5728\u5904\u4e8e hook \u9636\u6bb5\u7684\u65f6\u5019\u662f\u5426\u4f1a\u88ab\u5f3a\u5236\u8bbe\u4e3a NotReady \u72b6\u6001\u3002\\n\\n\\n```go\\ntype LifecycleStateType string\\n\\n// Lifecycle contains the hooks for Pod lifecycle.\\ntype Lifecycle struct \\n    // PreDelete is the hook before Pod to be deleted. \\n    PreDelete *LifecycleHook `json:\\"preDelete,omitempty\\"` \\n    // InPlaceUpdate is the hook before Pod to update and after Pod has been updated. \\n    InPlaceUpdate *LifecycleHook `json:\\"inPlaceUpdate,omitempty\\"`\\n}\\n\\ntype LifecycleHook struct {\\n    LabelsHandler     map[string]string `json:\\"labelsHandler,omitempty\\"`\\n    FinalizersHandler []string          `json:\\"finalizersHandler,omitempty\\"`\\n\\t\\n    /**********************  FEATURE STATE: 1.2.0 ************************/\\n    // MarkPodNotReady = true means:\\n    // - Pod will be set to \'NotReady\' at preparingDelete/preparingUpdate state.\\n    // - Pod will be restored to \'Ready\' at Updated state if it was set to \'NotReady\' at preparingUpdate state.\\n    // Default to false.\\n    MarkPodNotReady bool `json:\\"markPodNotReady,omitempty\\"`\\n    /*********************************************************************/\\t\\n}\\n```\\n\\n\u5bf9\u4e8e\u914d\u7f6e\u4e86 `markPodNotReady: true` \u7684 PreDelete hook\uff0c\u5b83\u4f1a\u5728 PreparingDelete \u9636\u6bb5\u7684\u65f6\u5019\u5c06 Pod \u8bbe\u7f6e\u4e3a NotReady\uff0c\\n\u5e76\u4e14\u8fd9\u79cd Pod \u5728\u6211\u4eec\u91cd\u65b0\u8c03\u5927 `replicas` \u6570\u503c\u7684\u65f6\u5019\u65e0\u6cd5\u91cd\u65b0\u56de\u5230 normal \u72b6\u6001\u3002\\n\\n\u5bf9\u4e8e\u914d\u7f6e\u4e86 `markPodNotReady: true` \u7684 InPlaceUpdate hook\uff0c\u5b83\u4f1a\u5728 PreparingUpdate \u9636\u6bb5\u5c06 Pod \u8bbe\u7f6e\u4e3a NotReady\uff0c\\n\u5e76\u5728 Updated \u9636\u6bb5\u5c06\u5f3a\u5236 NotReady \u7684\u72b6\u6001\u53bb\u6389\u3002\\n\\n### 4. PodUnavailableBudget \u652f\u6301\u81ea\u5b9a\u4e49 workload \u4e0e\u6027\u80fd\u4f18\u5316\\n\\nKubernetes \u81ea\u8eab\u63d0\u4f9b\u4e86 PodDisruptionBudget \u6765\u5e2e\u52a9\u7528\u6237\u4fdd\u62a4\u9ad8\u53ef\u7528\u7684\u5e94\u7528\uff0c\u4f46\u5b83\u53ea\u80fd\u9632\u62a4 eviction \u9a71\u9010\u4e00\u79cd\u573a\u666f\u3002\\n\u5bf9\u4e8e\u591a\u79cd\u591a\u6837\u7684\u4e0d\u53ef\u7528\u64cd\u4f5c\uff0cPodUnavailableBudget \u80fd\u591f\u66f4\u52a0\u5168\u9762\u5730\u9632\u62a4\u5e94\u7528\u7684\u9ad8\u53ef\u7528\u548c SLA\uff0c\u5b83\u4e0d\u4ec5\u80fd\u591f\u9632\u62a4 Pod \u9a71\u9010\uff0c\u8fd8\u652f\u6301\u5176\u4ed6\u5982\u5220\u9664\u3001\u539f\u5730\u5347\u7ea7\u7b49\u4f1a\u5bfc\u81f4 Pod \u4e0d\u53ef\u7528\u7684\u64cd\u4f5c\u3002\\n\\n\u8fc7\u53bb\uff0cPodUnavailableBudget \u4ec5\u4ec5\u652f\u6301\u4e00\u4e9b\u7279\u5b9a\u7684 workload\uff0c\u6bd4\u5982 CloneSet\u3001Deployment \u7b49\uff0c\u4f46\u5b83\u4e0d\u80fd\u591f\u8bc6\u522b\u7528\u6237\u81ea\u5df1\u5b9a\u4e49\u7684\u4e00\u4e9b\u672a\u77e5\u5de5\u4f5c\u8d1f\u8f7d\u3002\\n\\n\u4ece v1.2 \u7248\u672c\u5f00\u59cb\uff0cPodUnavailableBudget \u652f\u6301\u4e86\u4fdd\u62a4\u4efb\u610f\u81ea\u5b9a\u4e49\u5de5\u4f5c\u8d1f\u8f7d\u7684 Pod\uff0c\u53ea\u8981\u8fd9\u4e9b\u5de5\u4f5c\u8d1f\u8f7d\u58f0\u660e\u4e86 scale subresource \u5b50\u8d44\u6e90\u3002\\n\\n\u5728 CRD \u4e2d\uff0cscale \u5b50\u8d44\u6e90\u7684\u58f0\u660e\u65b9\u5f0f\u5982\u4e0b\uff1a\\n\\n```yaml\\n    subresources:\\n      scale:\\n        labelSelectorPath: .status.labelSelector\\n        specReplicasPath: .spec.replicas\\n        statusReplicasPath: .status.replicas\\n```\\n\\n\u4e0d\u8fc7\uff0c\u5982\u679c\u4f60\u7684\u9879\u76ee\u662f\u901a\u8fc7 kubebuilder \u6216 operator-sdk \u751f\u6210\u7684\uff0c\u90a3\u4e48\u53ea\u9700\u8981\u5728\u4f60\u7684 workload \u5b9a\u4e49\u7ed3\u6784\u4e0a\u52a0\u4e00\u884c\u6ce8\u89e3\u5e76\u91cd\u65b0 `make manifests` \u5373\u53ef\uff1a\\n\\n```go\\n// +kubebuilder:subresource:scale:specpath=.spec.replicas,statuspath=.status.replicas,selectorpath=.status.labelSelector\\n```\\n\\n\u53e6\u5916\uff0cPodUnavailableBudget \u8fd8\u901a\u8fc7\u5173\u95ed client list \u65f6\u5019\u7684\u9ed8\u8ba4 DeepCopy \u64cd\u4f5c\uff0c\u6765\u63d0\u5347\u4e86\u5728\u5927\u89c4\u6a21\u96c6\u7fa4\u4e2d\u7684\u8fd0\u884c\u65f6\u6027\u80fd\u3002\\n\\n### 5. \u5176\u4ed6\u6539\u52a8\\n\\n\u4f60\u53ef\u4ee5\u901a\u8fc7 [Github release](https://github.com/openkruise/kruise/releases) \u9875\u9762\uff0c\u6765\u67e5\u770b\u66f4\u591a\u7684\u6539\u52a8\u4ee5\u53ca\u5b83\u4eec\u7684\u4f5c\u8005\u4e0e\u63d0\u4ea4\u8bb0\u5f55\u3002\\n\\n## \u793e\u533a\u53c2\u4e0e\\n\\n\u975e\u5e38\u6b22\u8fce\u4f60\u901a\u8fc7 Github/Slack/\u9489\u9489/\u5fae\u4fe1 \u7b49\u65b9\u5f0f\u52a0\u5165\u6211\u4eec\u6765\u53c2\u4e0e OpenKruise \u5f00\u6e90\u793e\u533a\u3002\\n\u4f60\u662f\u5426\u5df2\u7ecf\u6709\u4e00\u4e9b\u5e0c\u671b\u4e0e\u6211\u4eec\u793e\u533a\u4ea4\u6d41\u7684\u5185\u5bb9\u5462\uff1f\\n\u53ef\u4ee5\u5728\u6211\u4eec\u7684[\u793e\u533a\u53cc\u5468\u4f1a](https://shimo.im/docs/gXqmeQOYBehZ4vqo)\u4e0a\u5206\u4eab\u4f60\u7684\u58f0\u97f3\uff0c\u6216\u901a\u8fc7\u4ee5\u4e0b\u6e20\u9053\u53c2\u4e0e\u8ba8\u8bba\uff1a\\n\\n- \u52a0\u5165\u793e\u533a [Slack channel](https://kubernetes.slack.com/channels/openkruise) (English)\\n- \u52a0\u5165\u793e\u533a\u9489\u9489\u7fa4\uff1a\u641c\u7d22\u7fa4\u53f7 `23330762` (Chinese)\\n- \u52a0\u5165\u793e\u533a\u5fae\u4fe1\u7fa4\uff08\u65b0\uff09\uff1a\u6dfb\u52a0\u7528\u6237 `openkruise` \u5e76\u8ba9\u673a\u5668\u4eba\u62c9\u4f60\u5165\u7fa4 (Chinese)"},{"id":"openkruise-1.1","metadata":{"permalink":"/zh/blog/openkruise-1.1","editUrl":"https://github.com/openkruise/openkruise.io/edit/master/blog/2022-03-29-release-1.1.md","source":"@site/i18n/zh/docusaurus-plugin-content-blog/2022-03-29-release-1.1.md","title":"OpenKruise v1.1\uff1a\u529f\u80fd\u589e\u5f3a\u4e0e\u4e0a\u6e38\u5bf9\u9f50\uff0c\u5927\u89c4\u6a21\u573a\u666f\u6027\u80fd\u4f18\u5316","description":"\u4e91\u539f\u751f\u5e94\u7528\u81ea\u52a8\u5316\u7ba1\u7406\u5957\u4ef6\u3001CNCF Sandbox \u9879\u76ee -- OpenKruise\uff0c\u8fd1\u671f\u53d1\u5e03\u4e86 v1.1 \u7248\u672c\u3002","date":"2022-03-29T00:00:00.000Z","tags":[{"inline":true,"label":"release","permalink":"/zh/blog/tags/release"}],"readingTime":9.34,"hasTruncateMarker":false,"authors":[{"name":"Siyu Wang","title":"Maintainer of OpenKruise","url":"https://github.com/FillZpp","imageURL":"https://github.com/FillZpp.png","key":"FillZpp","page":null}],"frontMatter":{"slug":"openkruise-1.1","title":"OpenKruise v1.1\uff1a\u529f\u80fd\u589e\u5f3a\u4e0e\u4e0a\u6e38\u5bf9\u9f50\uff0c\u5927\u89c4\u6a21\u573a\u666f\u6027\u80fd\u4f18\u5316","authors":["FillZpp"],"tags":["release"]},"unlisted":false,"prevItem":{"title":"OpenKruise v1.2\uff1a\u65b0\u589e PersistentPodState \u5b9e\u73b0\u6709\u72b6\u6001 Pod \u62d3\u6251\u56fa\u5b9a\u4e0e IP \u590d\u7528","permalink":"/zh/blog/openkruise-1.2"},"nextItem":{"title":"OpenKruise v1.0\uff1a\u4e91\u539f\u751f\u5e94\u7528\u81ea\u52a8\u5316\u8fbe\u5230\u65b0\u7684\u9ad8\u5cf0","permalink":"/zh/blog/openkruise-1.0"}},"content":"\u4e91\u539f\u751f\u5e94\u7528\u81ea\u52a8\u5316\u7ba1\u7406\u5957\u4ef6\u3001CNCF Sandbox \u9879\u76ee -- OpenKruise\uff0c\u8fd1\u671f\u53d1\u5e03\u4e86 v1.1 \u7248\u672c\u3002\\n\\n[OpenKruise](https://openkruise.io) \u662f\u9488\u5bf9 Kubernetes \u7684\u589e\u5f3a\u80fd\u529b\u5957\u4ef6\uff0c\u805a\u7126\u4e8e\u4e91\u539f\u751f\u5e94\u7528\u7684\u90e8\u7f72\u3001\u5347\u7ea7\u3001\u8fd0\u7ef4\u3001\u7a33\u5b9a\u6027\u9632\u62a4\u7b49\u9886\u57df\u3002\\n\u6240\u6709\u7684\u529f\u80fd\u90fd\u901a\u8fc7 CRD \u7b49\u6807\u51c6\u65b9\u5f0f\u6269\u5c55\uff0c\u53ef\u4ee5\u9002\u7528\u4e8e 1.16 \u4ee5\u4e0a\u7248\u672c\u7684\u4efb\u610f Kubernetes \u96c6\u7fa4\u3002\u5355\u6761 helm \u547d\u4ee4\u5373\u53ef\u5b8c\u6210 Kruise \u7684\u4e00\u952e\u90e8\u7f72\uff0c\u65e0\u9700\u66f4\u591a\u914d\u7f6e\u3002\\n\\n## \u7248\u672c\u89e3\u6790\\n\\n\u5728 v1.1 \u7248\u672c\u4e2d\uff0cOpenKruise \u5bf9\u4e0d\u5c11\u5df2\u6709\u529f\u80fd\u505a\u4e86\u6269\u5c55\u4e0e\u589e\u5f3a\uff0c\u5e76\u4e14\u4f18\u5316\u4e86\u5728\u5927\u89c4\u6a21\u96c6\u7fa4\u4e2d\u7684\u8fd0\u884c\u6027\u80fd\u3002\u4ee5\u4e0b\u5bf9 v1.1 \u7684\u90e8\u5206\u529f\u80fd\u505a\u7b80\u8981\u4ecb\u7ecd\u3002\\n\\n\u503c\u5f97\u6ce8\u610f\u7684\u662f\uff0cOpenKruise v1.1 \u5df2\u7ecf\u5c06 Kubernetes **\u4ee3\u7801\u4f9d\u8d56\u7248\u672c**\u5347\u7ea7\u5230 v1.22\uff0c\u8fd9\u610f\u5473\u7740\u7528\u6237\u53ef\u4ee5\u5728 CloneSet \u7b49\u5de5\u4f5c\u8d1f\u8f7d\u7684 pod template \u6a21\u677f\u4e2d\u4f7f\u7528 up to v1.22 \u7684\u65b0\u5b57\u6bb5\u7b49\uff0c\\n\u4f46\u7528\u6237\u5b89\u88c5\u4f7f\u7528 OpenKruise \u6240\u517c\u5bb9\u7684 Kubernetes \u96c6\u7fa4\u7248\u672c\u4ecd\u7136\u4fdd\u6301\u5728 >= v1.16\u3002\\n\\n### 1. \u539f\u5730\u5347\u7ea7\u652f\u6301\u5bb9\u5668\u987a\u5e8f\u4f18\u5148\u7ea7\\n\\n\u53bb\u5e74\u5e95\u53d1\u5e03\u7684 v1.0 \u7248\u672c\uff0cOpenKruise \u5f15\u5165\u4e86[\u5bb9\u5668\u542f\u52a8\u987a\u5e8f\u63a7\u5236](/docs/user-manuals/containerlaunchpriority/)\u529f\u80fd\uff0c\\n\u5b83\u652f\u6301\u4e3a\u4e00\u4e2a Pod \u4e2d\u7684\u591a\u4e2a\u5bb9\u5668\u5b9a\u4e49\u4e0d\u540c\u7684\u6743\u91cd\u5173\u7cfb\uff0c\u5e76\u5728 Pod \u521b\u5efa\u65f6\u6309\u7167\u6743\u91cd\u6765\u63a7\u5236\u4e0d\u540c\u5bb9\u5668\u7684\u542f\u52a8\u987a\u5e8f\u3002\\n\\n\u5728 v1.0 \u4e2d\uff0c\u8fd9\u4e2a\u529f\u80fd\u4ec5\u4ec5\u80fd\u591f\u4f5c\u7528\u4e8e\u6bcf\u4e2a Pod \u7684\u521b\u5efa\u9636\u6bb5\u3002\u5f53\u521b\u5efa\u5b8c\u6210\u540e\uff0c\u5982\u679c\u5bf9 Pod \u4e2d\u591a\u4e2a\u5bb9\u5668\u505a\u539f\u5730\u5347\u7ea7\uff0c\u5219\u8fd9\u4e9b\u5bb9\u5668\u90fd\u4f1a\u88ab\u540c\u65f6\u6267\u884c\u5347\u7ea7\u64cd\u4f5c\u3002\\n\\n\u6700\u8fd1\u4e00\u6bb5\u65f6\u95f4\uff0c\u793e\u533a\u4e0e LinkedIn \u7b49\u516c\u53f8\u505a\u8fc7\u4e00\u4e9b\u4ea4\u6d41\uff0c\u83b7\u5f97\u4e86\u66f4\u591a\u7528\u6237\u4f7f\u7528\u573a\u666f\u7684\u8f93\u5165\u3002\\n\u5728\u4e00\u4e9b\u573a\u666f\u4e0b\uff0cPod \u4e2d\u591a\u4e2a\u5bb9\u5668\u5b58\u5728\u5173\u8054\u5173\u7cfb\uff0c\u4f8b\u5982\u4e1a\u52a1\u5bb9\u5668\u5347\u7ea7\u7684\u540c\u65f6\uff0cPod \u4e2d\u5176\u4ed6\u4e00\u4e9b\u5bb9\u5668\u4e5f\u9700\u8981\u5347\u7ea7\u914d\u7f6e\u4ece\u800c\u5173\u8054\u5230\u8fd9\u4e2a\u65b0\u7248\u672c\uff1b\\n\u6216\u662f\u591a\u4e2a\u5bb9\u5668\u907f\u514d\u5e76\u884c\u5347\u7ea7\uff0c\u4ece\u800c\u4fdd\u8bc1\u5982\u65e5\u5fd7\u91c7\u96c6\u7c7b\u7684 sidecar \u5bb9\u5668\u4e0d\u4f1a\u4e22\u5931\u4e1a\u52a1\u5bb9\u5668\u4e2d\u7684\u65e5\u5fd7\u7b49\u3002\\n\\n\u56e0\u6b64\uff0c\u5728 v1.1 \u7248\u672c\u4e2d OpenKruise \u652f\u6301\u4e86\u6309\u5bb9\u5668\u4f18\u5148\u7ea7\u987a\u5e8f\u7684\u539f\u5730\u5347\u7ea7\u3002\\n\u5728\u5b9e\u9645\u4f7f\u7528\u8fc7\u7a0b\u4e2d\uff0c\u7528\u6237\u65e0\u9700\u914d\u7f6e\u4efb\u4f55\u989d\u5916\u53c2\u6570\uff0c\u53ea\u8981 Pod \u5728\u521b\u5efa\u65f6\u5df2\u7ecf\u5e26\u6709\u4e86\u5bb9\u5668\u542f\u52a8\u4f18\u5148\u7ea7\uff0c\u5219\u4e0d\u4ec5\u5728 Pod \u521b\u5efa\u9636\u6bb5\uff0c\u4f1a\u4fdd\u8bc1\u9ad8\u4f18\u5148\u7ea7\u5bb9\u5668\u5148\u4e8e\u4f4e\u4f18\u5148\u7ea7\u5bb9\u5668\u542f\u52a8\uff1b\\n\u5e76\u4e14\u5728**\u5355\u6b21\u539f\u5730\u5347\u7ea7**\u4e2d\uff0c\u5982\u679c\u540c\u65f6\u5347\u7ea7\u4e86\u591a\u4e2a\u5bb9\u5668\uff0c\u4f1a\u5148\u5347\u7ea7\u9ad8\u4f18\u5148\u7ea7\u5bb9\u5668\uff0c\u7b49\u5f85\u5b83\u5347\u7ea7\u542f\u52a8\u5b8c\u6210\u540e\uff0c\u518d\u5347\u7ea7\u4f4e\u4f18\u5148\u7ea7\u5bb9\u5668\u3002\\n\\n**\u8fd9\u91cc\u7684\u539f\u5730\u5347\u7ea7\uff0c\u5305\u62ec\u4fee\u6539 image \u955c\u50cf\u5347\u7ea7\u4e0e\u4fee\u6539 env from metadata \u7684\u73af\u5883\u53d8\u91cf\u5347\u7ea7\uff0c\u8be6\u89c1[\u539f\u5730\u5347\u7ea7\u4ecb\u7ecd](/docs/core-concepts/inplace-update)\uff09**\\n\\n\u603b\u7ed3\u6765\u8bf4\\n- \u5bf9\u4e8e\u4e0d\u5b58\u5728\u5bb9\u5668\u542f\u52a8\u987a\u5e8f\u7684 Pod\uff0c\u5728\u591a\u5bb9\u5668\u539f\u5730\u5347\u7ea7\u65f6\u6ca1\u6709\u987a\u5e8f\u4fdd\u8bc1\u3002\\n- \u5bf9\u4e8e\u5b58\u5728\u5bb9\u5668\u542f\u52a8\u987a\u5e8f\u7684 Pod\uff1a\\n  - \u5982\u679c\u672c\u6b21\u539f\u5730\u5347\u7ea7\u7684\u591a\u4e2a\u5bb9\u5668\u5177\u6709\u4e0d\u540c\u7684\u542f\u52a8\u987a\u5e8f\uff0c\u4f1a\u6309\u542f\u52a8\u987a\u5e8f\u6765\u63a7\u5236\u539f\u5730\u5347\u7ea7\u7684\u5148\u540e\u987a\u5e8f\u3002\\n  - \u5982\u679c\u672c\u5730\u539f\u5730\u5347\u7ea7\u7684\u591a\u4e2a\u5bb9\u5668\u7684\u542f\u52a8\u987a\u5e8f\u76f8\u540c\uff0c\u5219\u539f\u5730\u5347\u7ea7\u65f6\u6ca1\u6709\u987a\u5e8f\u4fdd\u8bc1\u3002\\n\\n\u4f8b\u5982\uff0c\u4e00\u4e2a\u5305\u542b\u4e24\u4e2a\u4e0d\u540c\u542f\u52a8\u987a\u5e8f\u5bb9\u5668\u7684 CloneSet \u5982\u4e0b\uff1a\\n\\n```yaml\\napiVersion: apps.kruise.io/v1alpha1\\nkind: CloneSet\\nmetadata:\\n  ...\\nspec:\\n  replicas: 1\\n  template:\\n    metadata:\\n      annotations:\\n        app-config: \\"... config v1 ...\\"\\n    spec:\\n      containers:\\n      - name: sidecar\\n        env:\\n        - name: KRUISE_CONTAINER_PRIORITY\\n          value: \\"10\\"\\n        - name: APP_CONFIG\\n          valueFrom:\\n            fieldRef:\\n              fieldPath: metadata.annotations[\'app-config\']\\n      - name: main\\n        image: main-image:v1\\n  updateStrategy:\\n    type: InPlaceIfPossible\\n```\\n\\n\u5f53\u6211\u4eec\u66f4\u65b0 CloneSet\uff0c\u5c06\u5176\u4e2d app-config annotation \u548c main \u5bb9\u5668\u7684\u955c\u50cf\u4fee\u6539\u540e\uff0c\\n\u610f\u5473\u7740 sidecar \u4e0e main \u5bb9\u5668\u90fd\u9700\u8981\u88ab\u66f4\u65b0\uff0cKruise \u4f1a\u5148\u539f\u5730\u5347\u7ea7 Pod \u6765\u5c06\u5176\u4e2d sidecar \u5bb9\u5668\u91cd\u5efa\u6765\u751f\u6548\u65b0\u7684 env from annotation\u3002\\n\\n\u63a5\u4e0b\u6765\uff0c\u6211\u4eec\u53ef\u4ee5\u5728\u5df2\u5347\u7ea7\u7684 Pod \u4e2d\u770b\u5230 `apps.kruise.io/inplace-update-state` annotation \u548c\u5b83\u7684\u503c\uff1a\\n\\n```json\\n{\\n  \\"revision\\": \\"{CLONESET_NAME}-{HASH}\\",         // \u672c\u6b21\u539f\u5730\u5347\u7ea7\u7684\u76ee\u6807 revision \u540d\u5b57\\n  \\"updateTimestamp\\": \\"2022-03-22T09:06:55Z\\",    // \u6574\u4e2a\u539f\u5730\u5347\u7ea7\u7684\u521d\u6b21\u5f00\u59cb\u65f6\u95f4\\n  \\"nextContainerImages\\": {\\"main\\": \\"main-image:v2\\"},                // \u540e\u7eed\u6279\u6b21\u4e2d\u8fd8\u9700\u8981\u5347\u7ea7\u7684\u5bb9\u5668\u955c\u50cf\\n  // \\"nextContainerRefMetadata\\": {...},                            // \u540e\u7eed\u6279\u6b21\u4e2d\u8fd8\u9700\u8981\u5347\u7ea7\u7684\u5bb9\u5668 env from labels/annotations\\n  \\"preCheckBeforeNext\\": {\\"containersRequiredReady\\": [\\"sidecar\\"]},  // pre-check \u68c0\u67e5\u9879\uff0c\u7b26\u5408\u8981\u6c42\u540e\u624d\u80fd\u539f\u5730\u5347\u7ea7\u540e\u7eed\u6279\u6b21\u7684\u5bb9\u5668\\n  \\"containerBatchesRecord\\":[\\n    {\\"timestamp\\":\\"2022-03-22T09:06:55Z\\",\\"containers\\":[\\"sidecar\\"]}  // \u5df2\u66f4\u65b0\u7684\u9996\u4e2a\u6279\u6b21\u5bb9\u5668\uff08\u5b83\u4ec5\u4ec5\u8868\u660e\u5bb9\u5668\u7684 spec \u5df2\u7ecf\u88ab\u66f4\u65b0\uff0c\u4f8b\u5982 pod.spec.containers \u4e2d\u7684 image \u6216\u662f labels/annotations\uff0c\u4f46\u5e76\u4e0d\u4ee3\u8868 node \u4e0a\u771f\u5b9e\u7684\u5bb9\u5668\u5df2\u7ecf\u5347\u7ea7\u5b8c\u6210\u4e86\uff09\\n  ]\\n}\\n```\\n\\n\u5f53 sidecar \u5bb9\u5668\u5347\u7ea7\u6210\u529f\u4e4b\u540e\uff0cKruise \u4f1a\u63a5\u7740\u518d\u5347\u7ea7 main \u5bb9\u5668\u3002\u6700\u7ec8\u4f60\u4f1a\u5728 Pod \u4e2d\u770b\u5230\u5982\u4e0b\u7684 `apps.kruise.io/inplace-update-state` annotation\uff1a\\n\\n```json\\n{\\n  \\"revision\\": \\"{CLONESET_NAME}-{HASH}\\",\\n  \\"updateTimestamp\\": \\"2022-03-22T09:06:55Z\\",\\n  \\"lastContainerStatuses\\":{\\"main\\":{\\"imageID\\":\\"THE IMAGE ID OF OLD MAIN CONTAINER\\"}},\\n  \\"containerBatchesRecord\\":[\\n    {\\"timestamp\\":\\"2022-03-22T09:06:55Z\\",\\"containers\\":[\\"sidecar\\"]},\\n    {\\"timestamp\\":\\"2022-03-22T09:07:20Z\\",\\"containers\\":[\\"main\\"]}\\n  ]\\n}\\n```\\n\\n\u901a\u5e38\u6765\u8bf4\uff0c\u7528\u6237\u53ea\u9700\u8981\u5173\u6ce8\u5176\u4e2d `containerBatchesRecord` \u6765\u786e\u4fdd\u5bb9\u5668\u662f\u88ab\u5206\u4e3a\u591a\u6279\u5347\u7ea7\u7684\u3002\\n\u5982\u679c\u8fd9\u4e2a Pod \u5728\u539f\u5730\u5347\u7ea7\u7684\u8fc7\u7a0b\u4e2d\u5361\u4f4f\u4e86\uff0c\u4f60\u53ef\u4ee5\u68c0\u67e5 `nextContainerImages/nextContainerRefMetadata` \u5b57\u6bb5\uff0c\u4ee5\u53ca `preCheckBeforeNext` \u4e2d\u524d\u4e00\u6b21\u5347\u7ea7\u7684\u5bb9\u5668\u662f\u5426\u5df2\u7ecf\u5347\u7ea7\u6210\u529f\u5e76 ready \u4e86\u3002\\n\\n### 2. StatefulSetAutoDeletePVC \u529f\u80fd\\n\\n\u4ece Kubernetes v1.23 \u5f00\u59cb\uff0c\u539f\u751f\u7684 StatefulSet \u52a0\u5165\u4e86 StatefulSetAutoDeletePVC \u529f\u80fd\uff0c\u5373**\u6839\u636e\u7ed9\u5b9a\u7b56\u7565\u6765\u9009\u62e9\u4fdd\u7559\u6216\u81ea\u52a8\u5220\u9664 StatefulSet \u521b\u5efa\u7684 PVC \u5bf9\u8c61**\uff0c[\u53c2\u8003\u6587\u6863](https://kubernetes.io/docs/concepts/workloads/controllers/statefulset/#persistentvolumeclaim-retention)\u3002\\n\\n\u56e0\u6b64\uff0cv1.1 \u7248\u672c\u7684 Advanced StatefulSet \u4ece\u4e0a\u6e38\u540c\u6b65\u4e86\u8fd9\u4e2a\u529f\u80fd\uff0c\u5141\u8bb8\u7528\u6237\u901a\u8fc7 `.spec.persistentVolumeClaimRetentionPolicy` \u5b57\u6bb5\u6765\u6307\u5b9a\u8fd9\u4e2a\u81ea\u52a8\u6e05\u7406\u7b56\u7565\u3002\\n\u8fd9\u9700\u8981\u4f60\u5728\u5b89\u88c5\u6216\u5347\u7ea7 Kruise \u7684\u65f6\u5019\uff0c\u542f\u7528 `StatefulSetAutoDeletePVC` feature-gate \u529f\u80fd\u3002\\n\\n```yaml\\napiVersion: apps.kruise.io/v1beta1\\nkind: StatefulSet\\nspec:\\n  ...\\n  persistentVolumeClaimRetentionPolicy:  # optional\\n    whenDeleted: Retain | Delete\\n    whenScaled: Retain | Delete\\n```\\n\\n\u5176\u4e2d\uff0c\u4e24\u4e2a\u7b56\u7565\u5b57\u6bb5\u5305\u62ec\uff1a\\n\\n- `whenDeleted`\uff1a\u5f53 Advanced StatefulSet \u88ab\u5220\u9664\u65f6\uff0c\u5bf9 PVC \u7684\u4fdd\u7559/\u5220\u9664\u7b56\u7565\u3002\\n- `whenScaled`\uff1a\u5f53 Advanced StatefulSet \u53d1\u751f\u7f29\u5bb9\u65f6\uff0c\u5bf9\u7f29\u5bb9 Pod \u5173\u8054 PVC \u7684\u4fdd\u7559/\u5220\u9664\u7b56\u7565\u3002\\n\\n\u6bcf\u4e2a\u7b56\u7565\u90fd\u53ef\u4ee5\u914d\u7f6e\u4ee5\u4e0b\u4e24\u79cd\u503c\uff1a\\n\\n- `Retain`\uff08\u9ed8\u8ba4\u503c\uff09\uff1a\u5b83\u7684\u884c\u4e3a\u4e0e\u8fc7\u53bb StatefulSet \u4e00\u6837\uff0c\u5728 Pod \u5220\u9664\u65f6\u5bf9\u5b83\u5173\u8054\u7684 PVC \u505a\u4fdd\u7559\u3002\\n- `Delete`\uff1a\u5f53 Pod \u5220\u9664\u65f6\uff0c\u81ea\u52a8\u5220\u9664\u5b83\u6240\u5173\u8054\u7684 PVC \u5bf9\u8c61\u3002\\n\\n\u9664\u6b64\u4e4b\u5916\uff0c\u8fd8\u6709\u51e0\u4e2a\u6ce8\u610f\u70b9\uff1a\\n\\n1. StatefulSetAutoDeletePVC \u529f\u80fd\u53ea\u4f1a\u6e05\u7406\u7531 `volumeClaimTemplate` \u4e2d\u5b9a\u4e49\u548c\u521b\u5efa\u7684 PVC\uff0c\u800c\u4e0d\u4f1a\u6e05\u7406\u7528\u6237\u81ea\u5df1\u521b\u5efa\u6216\u5173\u8054\u5230 StatefulSet Pod \u4e2d\u7684 PVC\u3002\\n2. \u4e0a\u8ff0\u6e05\u7406\u53ea\u53d1\u751f\u5728 Advanced StatefulSet \u88ab\u5220\u9664\u6216\u4e3b\u52a8\u7f29\u5bb9\u7684\u60c5\u51b5\u4e0b\u3002\u4f8b\u5982 node \u6545\u969c\u5bfc\u81f4\u7684 Pod \u9a71\u9010\u91cd\u5efa\u7b49\uff0c\u4ecd\u7136\u4f1a\u590d\u7528\u5df2\u6709\u7684 PVC\u3002\\n\\n### 3. Advanced DaemonSet \u91cd\u6784\u5e76\u652f\u6301\u751f\u547d\u5468\u671f\u94a9\u5b50\\n\\n\u65e9\u5148\u7248\u672c\u7684 Advanced DaemonSet \u5b9e\u73b0\u4e0e\u4e0a\u6e38\u63a7\u5236\u5668\u5dee\u5f02\u8f83\u5927\uff0c\u4f8b\u5982\u5bf9\u4e8e not-ready \u548c unschedulable \u7684\u8282\u70b9\u9700\u8981\u989d\u5916\u914d\u7f6e\u5b57\u6bb5\u6765\u9009\u62e9\u662f\u5426\u5904\u7406\uff0c\u8fd9\u5bf9\u4e8e\u6211\u4eec\u7684\u7528\u6237\u6765\u8bf4\u90fd\u589e\u52a0\u4e86\u4f7f\u7528\u6210\u672c\u548c\u8d1f\u62c5\u3002\\n\\n\u5728 v1.1 \u7248\u672c\u4e2d\uff0c\u6211\u4eec\u5bf9 Advanced DaemonSet \u505a\u4e86\u4e00\u6b21\u5c0f\u91cd\u6784\uff0c\u5c06\u5b83\u4e0e\u4e0a\u6e38\u63a7\u5236\u5668\u91cd\u65b0\u505a\u4e86\u5bf9\u9f50\u3002\\n\u56e0\u6b64\uff0cAdvanced DaemonSet \u7684\u6240\u6709\u9ed8\u8ba4\u884c\u4e3a\u4f1a\u4e0e\u539f\u751f DaemonSet \u57fa\u672c\u4e00\u81f4\uff0c\u7528\u6237\u53ef\u4ee5\u50cf\u4f7f\u7528 Advanced StatefulSet \u4e00\u6837\uff0c\u901a\u8fc7\u4fee\u6539 `apiVersion` \u5c31\u80fd\u5f88\u65b9\u4fbf\u5730\u5c06\u4e00\u4e2a\u539f\u751f DaemonSet \u4fee\u6539\u4e3a Advanced DaemonSet \u6765\u4f7f\u7528\u3002\\n\\n\u53e6\u5916\uff0c\u6211\u4eec\u8fd8\u4e3a Advanced DaemonSet \u589e\u52a0\u4e86\u751f\u547d\u5468\u671f\u94a9\u5b50\uff0c\u9996\u5148\u652f\u6301 preDelete hook\uff0c\u6765\u5141\u8bb8\u7528\u6237\u5728 daemon Pod \u88ab\u5220\u9664\u524d\u6267\u884c\u4e00\u4e9b\u81ea\u5b9a\u4e49\u7684\u903b\u8f91\u3002\\n\\n```yaml\\napiVersion: apps.kruise.io/v1alpha1\\nkind: DaemonSet\\nspec:\\n  ...\\n  # define with label\\n  lifecycle:\\n    preDelete:\\n      labelsHandler:\\n        example.io/block-deleting: \\"true\\"\\n```\\n\\n\u5f53 DaemonSet \u5220\u9664\u4e00\u4e2a Pod \u65f6\uff08\u5305\u62ec\u7f29\u5bb9\u548c\u91cd\u5efa\u5347\u7ea7\uff09\uff1a\\n- \u5982\u679c\u6ca1\u6709\u5b9a\u4e49 lifecycle hook \u6216\u8005 Pod \u4e0d\u7b26\u5408 preDelete \u6761\u4ef6\uff0c\u5219\u76f4\u63a5\u5220\u9664\u3002\\n- \u5426\u5219\uff0c\u4f1a\u5148\u5c06 Pod \u66f4\u65b0\u4e3a `PreparingDelete` \u72b6\u6001\uff0c\u5e76\u7b49\u5f85\u7528\u6237\u81ea\u5b9a\u4e49\u7684 controller \u5c06 Pod \u4e2d\u5173\u8054\u7684 label/finalizer \u53bb\u9664\uff0c\u518d\u6267\u884c Pod \u5220\u9664\u3002\\n\\n### 4. Disable DeepCopy \u6027\u80fd\u4f18\u5316\\n\\n\u9ed8\u8ba4\u60c5\u51b5\u4e0b\uff0c\u6211\u4eec\u5728\u4f7f\u7528 controller-runtime \u6765\u7f16\u5199 Operator/Controller \u65f6\uff0c\\n\u4f7f\u7528\u5176\u4e2d `sigs.k8s.io/controller-runtime/pkg/client` Client \u5ba2\u6237\u7aef\u6765 get/list \u67e5\u8be2\u5bf9\u8c61\uff08typed\uff09\uff0c\u90fd\u662f\u4ece\u5185\u5b58 Informer \u4e2d\u83b7\u53d6\u5e76\u8fd4\u56de\uff0c\u8fd9\u662f\u5927\u90e8\u5206\u4eba\u90fd\u77e5\u9053\u7684\u3002\\n\\n\u4f46\u5f88\u591a\u4eba\u4e0d\u77e5\u9053\u7684\u662f\uff0c\u5728\u8fd9\u4e9b get/list \u64cd\u4f5c\u80cc\u540e\uff0ccontroller-runtime \u4f1a\u5c06\u4ece Informer \u4e2d\u67e5\u5230\u7684\u6240\u6709\u5bf9\u8c61\u505a\u4e00\u6b21 deep copy \u6df1\u62f7\u8d1d\u540e\u518d\u8fd4\u56de\u3002\\n\\n\u8fd9\u4e2a\u8bbe\u8ba1\u7684\u521d\u8877\uff0c\u662f\u907f\u514d\u5f00\u53d1\u8005\u9519\u8bef\u5730\u5c06 Informer \u4e2d\u7684\u5bf9\u8c61\u76f4\u63a5\u7be1\u6539\u3002\u5728\u6df1\u62f7\u8d1d\u4e4b\u540e\uff0c\u65e0\u8bba\u5f00\u53d1\u8005\u5bf9 get/list \u8fd4\u56de\u7684\u5bf9\u8c61\u505a\u4e86\u4efb\u4f55\u4fee\u6539\uff0c\u90fd\u4e0d\u4f1a\u5f71\u54cd\u5230 Informer \u4e2d\u7684\u5bf9\u8c61\uff0c\u540e\u8005\u53ea\u4f1a\u4ece kube-apiserver \u7684 ListWatch \u8bf7\u6c42\u4e2d\u540c\u6b65\u3002\\n\\n\u4f46\u662f\u5728\u4e00\u4e9b\u5f88\u5927\u89c4\u6a21\u7684\u96c6\u7fa4\u4e2d\uff0cOpenKruise \u4e2d\u5404\u4e2a\u63a7\u5236\u5668\u540c\u65f6\u5728\u8fd0\u884c\uff0c\u540c\u65f6\u6bcf\u4e2a\u63a7\u5236\u5668\u8fd8\u5b58\u5728\u591a\u4e2a worker \u6267\u884c Reconcile\uff0c\u53ef\u80fd\u4f1a\u5e26\u6765\u5927\u91cf\u7684 deep copy \u64cd\u4f5c\u3002\\n\u4f8b\u5982\u96c6\u7fa4\u4e2d\u6709\u5927\u91cf\u5e94\u7528\u7684 CloneSet\uff0c\u800c\u5176\u4e2d\u4e00\u4e9b CloneSet \u4e0b\u7ba1\u7406\u7684 Pod \u6570\u91cf\u975e\u5e38\u591a\uff0c\u5219\u6bcf\u4e2a worker \u5728 Reconcile \u7684\u65f6\u5019\u90fd\u4f1a list \u67e5\u8be2\u4e00\u4e2a CloneSet \u4e0b\u7684\u6240\u6709 Pod \u5bf9\u8c61\uff0c\u518d\u52a0\u4e0a\u591a\u4e2a worker \u5e76\u884c\u64cd\u4f5c\uff0c\\n\u53ef\u80fd\u9020\u6210 kruise-manager \u77ac\u65f6\u7684 CPU \u548c Memory \u538b\u529b\u9661\u589e\uff0c\u751a\u81f3\u5728\u5185\u5b58\u914d\u989d\u4e0d\u8db3\u7684\u60c5\u51b5\u4e0b\u6709\u53d1\u751f OOM \u7684\u98ce\u9669\u3002\\n\\n\u5728\u4e0a\u6e38\u7684 controller-runtime \u4e2d\uff0c\u6211\u5728\u53bb\u5e74\u5df2\u7ecf\u63d0\u4ea4\u5408\u5e76\u4e86 [DisableDeepCopy \u529f\u80fd](https://github.com/kubernetes-sigs/controller-runtime/pull/1274)\uff0c\u5305\u542b\u5728 controller-runtime v0.10 \u53ca\u4ee5\u4e0a\u7684\u7248\u672c\u3002\\n\u5b83\u5141\u8bb8\u5f00\u53d1\u8005\u6307\u5b9a\u67d0\u4e9b\u7279\u5b9a\u7684\u8d44\u6e90\u7c7b\u578b\uff0c\u5728\u505a get/list \u67e5\u8be2\u65f6\u4e0d\u6267\u884c\u6df1\u62f7\u8d1d\uff0c\u800c\u662f\u76f4\u63a5\u8fd4\u56de Informer \u4e2d\u7684\u5bf9\u8c61\u6307\u9488\u3002\\n\\n\u4f8b\u5982\u4e0b\u8ff0\u4ee3\u7801\uff0c\u5728 main.go \u4e2d\u521d\u59cb\u5316 Manager \u65f6\uff0c\u4e3a cache \u52a0\u5165\u53c2\u6570\u5373\u53ef\u914d\u7f6e Pod \u7b49\u8d44\u6e90\u7c7b\u578b\u4e0d\u505a\u6df1\u62f7\u8d1d\u3002\\n\\n```go\\n    mgr, err := ctrl.NewManager(cfg, ctrl.Options{\\n\\t\\t...\\n\\t\\tNewCache: cache.BuilderWithOptions(cache.Options{\\n\\t\\t\\tUnsafeDisableDeepCopyByObject: map[client.Object]bool{\\n\\t\\t\\t\\t&v1.Pod{}: true,\\n\\t\\t\\t},\\n\\t\\t}),\\n\\t})\\n```\\n\\n\u4f46\u5728 Kruise v1.1 \u7248\u672c\u4e2d\uff0c\u6211\u4eec\u6ca1\u6709\u9009\u62e9\u76f4\u63a5\u4f7f\u7528\u8fd9\u4e2a\u529f\u80fd\uff0c\u800c\u662f\u5c06 [Delegating Client](https://github.com/openkruise/kruise/blob/master/pkg/util/client/delegating_client.go) \u91cd\u65b0\u505a\u4e86\u5c01\u88c5\uff0c\\n\u4ece\u800c\u4f7f\u5f97\u5f00\u53d1\u8005\u53ef\u4ee5\u5728\u4efb\u610f\u505a list \u67e5\u8be2\u7684\u5730\u65b9\u901a\u8fc7 `DisableDeepCopy ListOption` \u6765\u6307\u5b9a\u5355\u6b21\u7684 list \u64cd\u4f5c\u4e0d\u505a\u6df1\u62f7\u8d1d\u3002\\n\\n```go\\n    if err := r.List(context.TODO(), &podList, client.InNamespace(\\"default\\"), utilclient.DisableDeepCopy); err != nil {\\n\\t\\treturn nil, nil, err\\n\\t}\\n```\\n\\n\u8fd9\u6837\u505a\u7684\u597d\u5904\u662f\u4f7f\u7528\u4e0a\u66f4\u52a0\u7075\u6d3b\uff0c\u907f\u514d\u4e3a\u6574\u4e2a\u8d44\u6e90\u7c7b\u578b\u5173\u95ed\u6df1\u62f7\u8d1d\u540e\uff0c\u4f17\u591a\u793e\u533a\u8d21\u732e\u8005\u5728\u53c2\u4e0e\u5f00\u53d1\u7684\u8fc7\u7a0b\u4e2d\u5982\u679c\u6ca1\u6709\u6ce8\u610f\u5230\u5219\u53ef\u80fd\u4f1a\u9519\u8bef\u4fee\u6539 Informer \u4e2d\u7684\u5bf9\u8c61\u3002\\n\\n### 5. \u5176\u4ed6\u6539\u52a8\\n\\n\u4f60\u53ef\u4ee5\u901a\u8fc7 [Github release](https://github.com/openkruise/kruise/releases) \u9875\u9762\uff0c\u6765\u67e5\u770b\u66f4\u591a\u7684\u6539\u52a8\u4ee5\u53ca\u5b83\u4eec\u7684\u4f5c\u8005\u4e0e\u63d0\u4ea4\u8bb0\u5f55\u3002\\n\\n## \u793e\u533a\u53c2\u4e0e\\n\\n\u975e\u5e38\u6b22\u8fce\u4f60\u901a\u8fc7 Github/Slack/\u9489\u9489/\u5fae\u4fe1 \u7b49\u65b9\u5f0f\u52a0\u5165\u6211\u4eec\u6765\u53c2\u4e0e OpenKruise \u5f00\u6e90\u793e\u533a\u3002\\n\u4f60\u662f\u5426\u5df2\u7ecf\u6709\u4e00\u4e9b\u5e0c\u671b\u4e0e\u6211\u4eec\u793e\u533a\u4ea4\u6d41\u7684\u5185\u5bb9\u5462\uff1f\\n\u53ef\u4ee5\u5728\u6211\u4eec\u7684[\u793e\u533a\u53cc\u5468\u4f1a](https://shimo.im/docs/gXqmeQOYBehZ4vqo)\u4e0a\u5206\u4eab\u4f60\u7684\u58f0\u97f3\uff0c\u6216\u901a\u8fc7\u4ee5\u4e0b\u6e20\u9053\u53c2\u4e0e\u8ba8\u8bba\uff1a\\n\\n- \u52a0\u5165\u793e\u533a [Slack channel](https://kubernetes.slack.com/channels/openkruise) (English)\\n- \u52a0\u5165\u793e\u533a\u9489\u9489\u7fa4\uff1a\u641c\u7d22\u7fa4\u53f7 `23330762` (Chinese)\\n- \u52a0\u5165\u793e\u533a\u5fae\u4fe1\u7fa4\uff08\u65b0\uff09\uff1a\u6dfb\u52a0\u7528\u6237 `openkruise` \u5e76\u8ba9\u673a\u5668\u4eba\u62c9\u4f60\u5165\u7fa4 (Chinese)"},{"id":"openkruise-1.0","metadata":{"permalink":"/zh/blog/openkruise-1.0","editUrl":"https://github.com/openkruise/openkruise.io/edit/master/blog/2021-12-13-release-1.0.md","source":"@site/i18n/zh/docusaurus-plugin-content-blog/2021-12-13-release-1.0.md","title":"OpenKruise v1.0\uff1a\u4e91\u539f\u751f\u5e94\u7528\u81ea\u52a8\u5316\u8fbe\u5230\u65b0\u7684\u9ad8\u5cf0","description":"\u4e91\u539f\u751f\u5e94\u7528\u81ea\u52a8\u5316\u7ba1\u7406\u5957\u4ef6\u3001CNCF Sandbox \u9879\u76ee -- OpenKruise\uff0c\u8fd1\u671f\u53d1\u5e03\u4e86 v1.0 \u5927\u7248\u672c\u3002","date":"2021-12-13T00:00:00.000Z","tags":[{"inline":true,"label":"release","permalink":"/zh/blog/tags/release"}],"readingTime":8.16,"hasTruncateMarker":false,"authors":[{"name":"Siyu Wang","title":"Maintainer of OpenKruise","url":"https://github.com/FillZpp","imageURL":"https://github.com/FillZpp.png","key":"FillZpp","page":null}],"frontMatter":{"slug":"openkruise-1.0","title":"OpenKruise v1.0\uff1a\u4e91\u539f\u751f\u5e94\u7528\u81ea\u52a8\u5316\u8fbe\u5230\u65b0\u7684\u9ad8\u5cf0","authors":["FillZpp"],"tags":["release"]},"unlisted":false,"prevItem":{"title":"OpenKruise v1.1\uff1a\u529f\u80fd\u589e\u5f3a\u4e0e\u4e0a\u6e38\u5bf9\u9f50\uff0c\u5927\u89c4\u6a21\u573a\u666f\u6027\u80fd\u4f18\u5316","permalink":"/zh/blog/openkruise-1.1"},"nextItem":{"title":"OpenKruise v0.10.0 \u65b0\u7279\u6027WorkloadSpread\u89e3\u8bfb","permalink":"/zh/blog/workloadspread"}},"content":"\u4e91\u539f\u751f\u5e94\u7528\u81ea\u52a8\u5316\u7ba1\u7406\u5957\u4ef6\u3001CNCF Sandbox \u9879\u76ee -- OpenKruise\uff0c\u8fd1\u671f\u53d1\u5e03\u4e86 v1.0 \u5927\u7248\u672c\u3002\\n\\n[OpenKruise](https://openkruise.io) \u662f\u9488\u5bf9 Kubernetes \u7684\u589e\u5f3a\u80fd\u529b\u5957\u4ef6\uff0c\u805a\u7126\u4e8e\u4e91\u539f\u751f\u5e94\u7528\u7684\u90e8\u7f72\u3001\u5347\u7ea7\u3001\u8fd0\u7ef4\u3001\u7a33\u5b9a\u6027\u9632\u62a4\u7b49\u9886\u57df\u3002\u6240\u6709\u7684\u529f\u80fd\u90fd\u901a\u8fc7 CRD \u7b49\u6807\u51c6\u65b9\u5f0f\u6269\u5c55\uff0c\u53ef\u4ee5\u9002\u7528\u4e8e 1.16 \u4ee5\u4e0a\u7248\u672c\u7684\u4efb\u610f Kubernetes \u96c6\u7fa4\u3002\u5355\u6761 helm \u547d\u4ee4\u5373\u53ef\u5b8c\u6210 Kruise \u7684\u4e00\u952e\u90e8\u7f72\uff0c\u65e0\u9700\u66f4\u591a\u914d\u7f6e\u3002\\n\\n![openkruise-features|center|450x400](/img/blog/2021-12-13-release-1.0/features-zh.png)\\n\\n\u603b\u5f97\u6765\u770b\uff0c\u76ee\u524d OpenKruise \u63d0\u4f9b\u7684\u80fd\u529b\u5206\u4e3a\u51e0\u4e2a\u9886\u57df\uff1a\\n\\n- **\u5e94\u7528\u5de5\u4f5c\u8d1f\u8f7d**\uff1a\u9762\u5411\u65e0\u72b6\u6001\u3001\u6709\u72b6\u6001\u3001daemon \u7b49\u591a\u79cd\u7c7b\u578b\u5e94\u7528\u7684\u9ad8\u7ea7\u90e8\u7f72\u53d1\u5e03\u7b56\u7565\uff0c\u4f8b\u5982\u539f\u5730\u5347\u7ea7\u3001\u7070\u5ea6\u6d41\u5f0f\u53d1\u5e03\u7b49\u3002\\n- **Sidecar \u5bb9\u5668\u7ba1\u7406**\uff1a\u652f\u6301\u72ec\u7acb\u5b9a\u4e49 sidecar \u5bb9\u5668\uff0c\u5b8c\u6210\u52a8\u6001\u6ce8\u5165\u3001\u72ec\u7acb\u539f\u5730\u5347\u7ea7\u3001\u70ed\u5347\u7ea7\u7b49\u529f\u80fd\u3002\\n- **\u589e\u5f3a\u8fd0\u7ef4\u80fd\u529b**\uff1a\u5305\u62ec\u5bb9\u5668\u539f\u5730\u91cd\u542f\u3001\u955c\u50cf\u9884\u62c9\u53d6\u3001\u5bb9\u5668\u542f\u52a8\u987a\u5e8f\u4fdd\u969c\u7b49\u3002\\n- **\u5e94\u7528\u5206\u533a\u7ba1\u7406**\uff1a\u7ba1\u7406\u5e94\u7528\u5728\u591a\u4e2a\u5206\u533a\uff08\u53ef\u7528\u533a\u3001\u4e0d\u540c\u673a\u578b\u7b49\uff09\u4e0a\u7684\u90e8\u7f72\u6bd4\u4f8b\u3001\u987a\u5e8f\u3001\u4f18\u5148\u7ea7\u7b49\u3002\\n- **\u5e94\u7528\u5b89\u5168\u9632\u62a4**\uff1a\u5e2e\u52a9\u5e94\u7528\u5728 Kubernetes \u4e4b\u4e0a\u83b7\u5f97\u66f4\u9ad8\u7684\u5b89\u5168\u6027\u4fdd\u969c\u4e0e\u53ef\u7528\u6027\u9632\u62a4\u3002\\n\\n## \u7248\u672c\u89e3\u6790\\n\\n\u5728 v1.0 \u5927\u7248\u672c\u4e2d\uff0cOpenKruise \u5e26\u6765\u4e86\u591a\u79cd\u65b0\u7684\u7279\u6027\uff0c\u540c\u65f6\u4e5f\u5bf9\u4e0d\u5c11\u5df2\u6709\u529f\u80fd\u505a\u4e86\u589e\u5f3a\u4e0e\u4f18\u5316\u3002\\n\\n\u9996\u5148\u8981\u8bf4\u7684\u662f\uff0c\u4ece v1.0 \u5f00\u59cb OpenKruise \u5c06 CRD/WehhookConfiguration \u7b49\u8d44\u6e90\u914d\u7f6e\u7684\u7248\u672c\u4ece `v1beta1` \u5347\u7ea7\u5230 `v1`\uff0c\u56e0\u6b64\u53ef\u4ee5**\u652f\u6301 Kubernetes v1.22 \u53ca\u4ee5\u4e0a\u7248\u672c\u7684\u96c6\u7fa4\uff0c\u4f46\u540c\u65f6\u4e5f\u8981\u6c42 Kubernetes \u7684\u7248\u672c\u4e0d\u80fd\u4f4e\u4e8e v1.16**\u3002\\n\\n\u4ee5\u4e0b\u5bf9 v1.0 \u7684\u90e8\u5206\u529f\u80fd\u505a\u7b80\u8981\u4ecb\u7ecd\uff0c\u8be6\u7ec6\u7684 ChangeLog \u5217\u8868\u8bf7\u67e5\u770b OpenKruise Github \u4e0a\u7684 release \u8bf4\u660e\u4ee5\u53ca\u5b98\u7f51\u6587\u6863\u3002\\n\\n### 1. \u652f\u6301\u73af\u5883\u53d8\u91cf\u539f\u5730\u5347\u7ea7\\n\\n*Author: [@FillZpp](https://github.com/FillZpp)*\\n\\nOpenKruise \u4ece\u65e9\u671f\u7248\u672c\u5f00\u59cb\u5c31\u652f\u6301\u4e86 \u201c\u539f\u5730\u5347\u7ea7\u201d \u529f\u80fd\uff0c\u4e3b\u8981\u5e94\u7528\u4e8e CloneSet \u4e0e Advanced StatefulSet \u4e24\u79cd\u5de5\u4f5c\u8d1f\u8f7d\u4e0a\u3002\u7b80\u5355\u6765\u8bf4\uff0c\u539f\u5730\u5347\u7ea7\u4f7f\u5f97\u5e94\u7528\u5728\u5347\u7ea7\u7684\u8fc7\u7a0b\u4e2d\uff0c\u4e0d\u9700\u8981\u5220\u9664\u3001\u65b0\u5efa Pod \u5bf9\u8c61\uff0c\u800c\u662f\u901a\u8fc7\u5bf9 Pod \u4e2d\u5bb9\u5668\u914d\u7f6e\u7684\u4fee\u6539\u6765\u8fbe\u5230\u5347\u7ea7\u7684\u76ee\u7684\u3002\\n\\n![inplace-update-comparation|center|450x400](/img/docs/core-concepts/inplace-update-comparation.png)\\n\\n\u5982\u4e0a\u56fe\u6240\u793a\uff0c\u539f\u5730\u5347\u7ea7\u8fc7\u7a0b\u4e2d\u53ea\u4fee\u6539\u4e86 Pod \u4e2d\u7684\u5b57\u6bb5\uff0c\u56e0\u6b64\uff1a\\n\\n1. \u53ef\u4ee5\u907f\u514d\u5982 *\u8c03\u5ea6*\u3001*\u5206\u914d IP*\u3001*\u5206\u914d\u3001\u6302\u8f7d\u76d8* \u7b49\u989d\u5916\u7684\u64cd\u4f5c\u548c\u4ee3\u4ef7\u3002\\n2. \u66f4\u5feb\u7684\u955c\u50cf\u62c9\u53d6\uff0c\u56e0\u4e3a\u53ef\u4ee5\u590d\u7528\u5df2\u6709\u65e7\u955c\u50cf\u7684\u5927\u90e8\u5206 layer \u5c42\uff0c\u53ea\u9700\u8981\u62c9\u53d6\u65b0\u955c\u50cf\u53d8\u5316\u7684\u4e00\u4e9b layer\u3002\\n3. \u5f53\u4e00\u4e2a\u5bb9\u5668\u5728\u539f\u5730\u5347\u7ea7\u65f6\uff0cPod \u7684\u7f51\u7edc\u3001\u6302\u8f7d\u76d8\u3001\u4ee5\u53ca Pod \u4e2d\u7684\u5176\u4ed6\u5bb9\u5668\u4e0d\u4f1a\u53d7\u5230\u5f71\u54cd\uff0c\u4ecd\u7136\u7ef4\u6301\u8fd0\u884c\u3002\\n\\n\u7136\u800c\uff0cOpenKruise \u8fc7\u53bb\u53ea\u80fd\u5bf9 Pod \u4e2d image \u5b57\u6bb5\u7684\u66f4\u65b0\u505a\u539f\u5730\u5347\u7ea7\uff0c\u5bf9\u4e8e\u5176\u4ed6\u5b57\u6bb5\u4ecd\u7136\u53ea\u80fd\u91c7\u7528\u4e0e Deployment \u76f8\u4f3c\u7684\u91cd\u5efa\u5347\u7ea7\u3002\u4e00\u76f4\u4ee5\u6765\uff0c\u6211\u4eec\u6536\u5230\u5f88\u591a\u7528\u6237\u53cd\u9988\uff0c\u5e0c\u671b\u652f\u6301\u5bf9 env \u7b49\u66f4\u591a\u5b57\u6bb5\u7684\u539f\u5730\u5347\u7ea7 -- \u7531\u4e8e\u53d7\u5230 kube-apiserver \u7684\u9650\u5236\uff0c\u8fd9\u662f\u5f88\u96be\u505a\u5230\u7684\u3002\\n\\n\u7ecf\u8fc7\u6211\u4eec\u7684\u4e0d\u61c8\u52aa\u529b\uff0cOpenKruise \u7ec8\u4e8e\u5728 v1.0 \u7248\u672c\u4e2d\uff0c\u652f\u6301\u4e86\u901a\u8fc7 Downward API \u7684\u65b9\u5f0f\u652f\u6301\u4e86 env \u73af\u5883\u53d8\u91cf\u7684\u539f\u5730\u5347\u7ea7\u3002\u4f8b\u5982\u5bf9\u4ee5\u4e0bCloneSet YAML\uff0c\u7528\u6237\u5c06\u914d\u7f6e\u5b9a\u4e49\u5728 annotation \u4e2d\u5e76\u5173\u8054\u5230\u5bf9\u5e94 env \u4e2d\u3002\u540e\u7eed\u5728\u4fee\u6539\u914d\u7f6e\u65f6\uff0c\u53ea\u9700\u8981\u66f4\u65b0 annotation value \u4e2d\u7684\u503c\uff0cKruise \u5c31\u4f1a\u5bf9 Pod \u4e2d\u6240\u6709 env \u91cc\u5f15\u7528\u4e86\u8fd9\u4e2a annotation \u7684\u5bb9\u5668\u89e6\u53d1\u539f\u5730\u91cd\u5efa\uff0c\u4ece\u800c\u751f\u6548\u8fd9\u4e2a\u65b0\u7684 value \u914d\u7f6e\u3002\\n\\n```yaml\\napiVersion: apps.kruise.io/v1alpha1\\nkind: CloneSet\\nmetadata:\\n  ...\\nspec:\\n  replicas: 1\\n  template:\\n    metadata:\\n      annotations:\\n        app-config: \\"... the real env value ...\\"\\n    spec:\\n      containers:\\n      - name: app\\n        env:\\n        - name: APP_CONFIG\\n          valueFrom:\\n            fieldRef:\\n              fieldPath: metadata.annotations[\'app-config\']\\n  updateStrategy:\\n    type: InPlaceIfPossible\\n```\\n\\n*\u4e0e\u6b64\u540c\u65f6\uff0c\u6211\u4eec\u5728\u8fd9\u4e2a\u7248\u672c\u4e2d\u4e5f\u53bb\u9664\u4e86\u8fc7\u53bb\u5bf9\u955c\u50cf\u539f\u5730\u5347\u7ea7\u7684`imageID`\u9650\u5236\uff0c\u5373\u652f\u6301\u76f8\u540cimageID\u7684\u4e24\u4e2a\u955c\u50cf\u66ff\u6362\u5347\u7ea7\u3002*\\n\\n\u5177\u4f53\u4f7f\u7528\u65b9\u5f0f\u8bf7\u53c2\u8003[\u6587\u6863](/docs/core-concepts/inplace-update)\u3002\\n\\n### 2. \u914d\u7f6e\u8de8\u547d\u540d\u7a7a\u95f4\u5206\u53d1\\n\\n*Author: [@veophi](https://github.com/veophi)*\\n\\n\u5728\u5bf9 Secret\u3001ConfigMap \u7b49 namespace-scoped \u8d44\u6e90\u8fdb\u884c\u8de8 namespace \u5206\u53d1\u53ca\u540c\u6b65\u7684\u573a\u666f\u4e2d\uff0c\u539f\u751f kubernetes \u76ee\u524d\u53ea\u652f\u6301\u7528\u6237 one-by-one \u5730\u8fdb\u884c\u624b\u52a8\u5206\u53d1\u4e0e\u540c\u6b65\uff0c\u5341\u5206\u5730\u4e0d\u65b9\u4fbf\u3002\\n\\n\u5178\u578b\u7684\u6848\u4f8b\u6709\uff1a\\n- \u5f53\u7528\u6237\u9700\u8981\u4f7f\u7528 SidecarSet \u7684 imagePullSecrets \u80fd\u529b\u65f6\uff0c\u8981\u5148\u91cd\u590d\u5730\u5728\u76f8\u5173 namespaces \u4e2d\u521b\u5efa\u5bf9\u5e94\u7684 Secret\uff0c\u5e76\u4e14\u9700\u8981\u786e\u4fdd\u8fd9\u4e9b Secret \u914d\u7f6e\u7684\u6b63\u786e\u6027\u548c\u4e00\u81f4\u6027\u3002\\n- \u5f53\u7528\u6237\u60f3\u8981\u91c7\u7528 ConfigMap \u6765\u914d\u7f6e\u4e00\u4e9b**\u901a\u7528**\u7684\u73af\u5883\u53d8\u91cf\u65f6\uff0c\u5f80\u5f80\u9700\u8981\u5728\u591a\u4e2a namespaces \u505a ConfigMap \u7684\u4e0b\u53d1\uff0c\u5e76\u4e14\u540e\u7eed\u7684\u4fee\u6539\u5f80\u5f80\u4e5f\u8981\u6c42\u591a namespaces \u4e4b\u95f4\u4fdd\u6301\u540c\u6b65\u3002\\n\\n\u56e0\u6b64\uff0c\u9762\u5bf9\u8fd9\u4e9b\u9700\u8981\u8de8 namespaces \u8fdb\u884c\u8d44\u6e90\u5206\u53d1\u548c**\u591a\u6b21\u540c\u6b65**\u7684\u573a\u666f\uff0c\u6211\u4eec\u671f\u671b\u4e00\u79cd\u66f4\u4fbf\u6377\u7684\u5206\u53d1\u548c\u540c\u6b65\u5de5\u5177\u6765\u81ea\u52a8\u5316\u5730\u53bb\u505a\u8fd9\u4ef6\u4e8b\uff0c\u4e3a\u6b64\u6211\u4eec\u8bbe\u8ba1\u5e76\u5b9e\u73b0\u4e86\u4e00\u4e2a\u65b0\u7684CRD --- **ResourceDistribution**\u3002\\n\\nResourceDistribution \u76ee\u524d\u652f\u6301 **Secret** \u548c **ConfigMap** \u4e24\u7c7b\u8d44\u6e90\u7684\u5206\u53d1\u548c\u540c\u6b65\u3002\\n\\n```yaml\\napiVersion: apps.kruise.io/v1alpha1\\nkind: ResourceDistribution\\nmetadata:\\n  name: sample\\nspec:\\n  resource:\\n    apiVersion: v1\\n    kind: ConfigMap\\n    metadata:\\n      name: game-demo\\n    data:\\n      ...\\n  targets:\\n  \\tnamespaceLabelSelector:\\n      ...\\n    # or includedNamespaces, excludedNamespaces\\n```\\n\\n\u5982\u4e0a\u8ff0 YAML \u6240\u793a\uff0cResourceDistribution\u662f\u4e00\u7c7b **cluster-scoped** \u7684 CRD\uff0c\u5176\u4e3b\u8981\u7531 **`resource`** \u548c **`targets`** \u4e24\u4e2a\u5b57\u6bb5\u6784\u6210\uff0c\u5176\u4e2d **`resource`** \u5b57\u6bb5\u7528\u4e8e\u63cf\u8ff0\u7528\u6237\u6240\u8981\u5206\u53d1\u7684\u8d44\u6e90\uff0c**`targets`** \u5b57\u6bb5\u7528\u4e8e\u63cf\u8ff0\u7528\u6237\u6240\u8981\u5206\u53d1\u7684\u76ee\u6807\u547d\u540d\u7a7a\u95f4\u3002\\n\\n\u5177\u4f53\u4f7f\u7528\u65b9\u5f0f\u8bf7\u53c2\u8003[\u6587\u6863](/docs/user-manuals/resourcedistribution)\u3002\\n\\n### 3. \u5bb9\u5668\u542f\u52a8\u987a\u5e8f\u63a7\u5236\\n\\n*Author: [@Concurrensee](https://github.com/Concurrensee)*\\n\\n\u5bf9\u4e8e Kubernetes \u7684\u4e00\u4e2a Pod\uff0c\u5176\u4e2d\u7684\u591a\u4e2a\u5bb9\u5668\u53ef\u80fd\u5b58\u5728\u4f9d\u8d56\u5173\u7cfb\uff0c\u6bd4\u5982 \u5bb9\u5668B \u4e2d\u5e94\u7528\u8fdb\u7a0b\u7684\u8fd0\u884c\u4f9d\u8d56\u4e8e \u5bb9\u5668A \u4e2d\u7684\u5e94\u7528\u3002\u56e0\u6b64\uff0c\u591a\u4e2a\u5bb9\u5668\u4e4b\u95f4\u5b58\u5728\u987a\u5e8f\u5173\u7cfb\u7684\u9700\u6c42\uff1a\\n- \u5bb9\u5668A \u5148\u542f\u52a8\uff0c\u542f\u52a8\u6210\u529f\u540e\u624d\u53ef\u4ee5\u542f\u52a8 \u5bb9\u5668B\\n- \u5bb9\u5668B \u5148\u9000\u51fa\uff0c\u9000\u51fa\u5b8c\u6210\u540e\u624d\u53ef\u4ee5\u505c\u6b62 \u5bb9\u5668A\\n\\n\u901a\u5e38\u6765\u8bf4 Pod \u5bb9\u5668\u7684\u542f\u52a8\u548c\u9000\u51fa\u987a\u5e8f\u662f\u7531 Kubelet \u7ba1\u7406\u7684\u3002Kubernetes \u66fe\u7ecf\u6709\u4e00\u4e2a KEP \u8ba1\u5212\u5728 container \u4e2d\u589e\u52a0\u4e00\u4e2a type \u5b57\u6bb5\u6765\u6807\u8bc6\u4e0d\u540c\u7c7b\u578b\u5bb9\u5668\u7684\u542f\u505c\u4f18\u5148\u7ea7\u3002\u4f46\u662f\u7531\u4e8e sig-node \u8003\u8651\u5230\u5bf9\u73b0\u6709\u4ee3\u7801\u67b6\u6784\u7684\u6539\u52a8\u592a\u5927\uff0c\u76ee\u524d\u8fd9\u4e2a KEP \u5df2\u7ecf\u88ab\u62d2\u7edd\u4e86\u3002\\n\\n\u56e0\u6b64\uff0cOpenKruise \u5728 v1.0 \u4e2d\u63d0\u4f9b\u4e86\u540d\u4e3a **Container Launch Priority** \u7684\u529f\u80fd\uff0c\u7528\u4e8e\u63a7\u5236\u4e00\u4e2a Pod \u4e2d\u591a\u4e2a\u5bb9\u5668\u7684\u5f3a\u5236\u542f\u52a8\u987a\u5e8f\uff1a\\n\\n1. \u5bf9\u4e8e\u4efb\u610f\u4e00\u4e2a Pod \u5bf9\u8c61\uff0c\u53ea\u9700\u8981\u5728 annotations \u4e2d\u5b9a\u4e49 `apps.kruise.io/container-launch-priority: Ordered`\uff0c\u5219 Kruise \u4f1a\u6309\u7167 Pod \u4e2d `containers` \u5bb9\u5668\u5217\u8868\u7684\u987a\u5e8f\u6765\u4fdd\u8bc1\u5176\u4e2d\u5bb9\u5668\u7684\u4e32\u884c\u542f\u52a8\u3002\\n2. \u5982\u679c\u8981\u81ea\u5b9a\u4e49 `containers` \u4e2d\u591a\u4e2a\u5bb9\u5668\u7684\u542f\u52a8\u987a\u5e8f\uff0c\u5219\u5728\u5bb9\u5668 env \u4e2d\u6dfb\u52a0 `KRUISE_CONTAINER_PRIORITY` \u73af\u5883\u53d8\u91cf\uff0cvalue \u503c\u662f\u8303\u56f4\u5728 `[-2147483647, 2147483647]` \u7684\u6574\u6570\u3002\u4e00\u4e2a\u5bb9\u5668\u7684 priority \u503c\u8d8a\u5927\uff0c\u4f1a\u4fdd\u8bc1\u8d8a\u5148\u542f\u52a8\u3002\\n\\n\u5177\u4f53\u4f7f\u7528\u65b9\u5f0f\u8bf7\u53c2\u8003[\u6587\u6863](/docs/user-manuals/containerlaunchpriority)\u3002\\n\\n### 4. `kubectl-kruise` \u547d\u4ee4\u884c\u5de5\u5177\\n\\n*Author: [@hantmac](https://github.com/hantmac)*\\n\\n\u8fc7\u53bb OpenKruise \u662f\u901a\u8fc7 kruise-api\u3001client-java \u7b49\u4ed3\u5e93\u63d0\u4f9b\u4e86 Go\u3001Java \u7b49\u8bed\u8a00\u7684 Kruise API \u5b9a\u4e49\u4ee5\u53ca\u5ba2\u6237\u7aef\u5c01\u88c5\uff0c\u53ef\u4f9b\u7528\u6237\u5728\u81ea\u5df1\u7684\u5e94\u7528\u7a0b\u5e8f\u4e2d\u5f15\u5165\u4f7f\u7528\u3002\u4f46\u4ecd\u7136\u6709\u4e0d\u5c11\u7528\u6237\u5728\u6d4b\u8bd5\u73af\u5883\u4e0b\u9700\u8981\u7075\u6d3b\u5730\u7528\u547d\u4ee4\u884c\u64cd\u4f5c workload \u8d44\u6e90\u3002\\n\\n\u7136\u800c\u539f\u751f `kubectl` \u5de5\u5177\u63d0\u4f9b\u7684 `rollout`\u3001`set image` \u7b49\u547d\u4ee4\u53ea\u80fd\u9002\u7528\u4e8e\u539f\u751f\u7684 workload \u7c7b\u578b\uff0c\u5982 Deployment\u3001StatefulSet\uff0c\u5e76\u4e0d\u80fd\u8bc6\u522b OpenKruise \u4e2d\u6269\u5c55\u7684 workload \u7c7b\u578b\u3002\\n\\n\u56e0\u6b64\uff0cOpenKruise \u6700\u65b0\u63d0\u4f9b\u4e86 `kubectl-kruise` \u547d\u4ee4\u884c\u5de5\u5177\uff0c\u5b83\u662f `kubectl` \u7684\u6807\u51c6\u63d2\u4ef6\uff0c\u63d0\u4f9b\u4e86\u8bb8\u591a\u9002\u7528\u4e8e OpenKruise workload \u7684\u529f\u80fd\u3002\\n\\n```bash\\n# rollout undo cloneset\\n$ kubectl kruise rollout undo cloneset/nginx\\n\\n#  rollout status advanced statefulset\\n$ kubectl kruise rollout status statefulsets.apps.kruise.io/sts-demo\\n\\n# set image of a cloneset\\n$ kubectl kruise set image cloneset/nginx busybox=busybox nginx=nginx:1.9.1\\n```\\n\\n\u5177\u4f53\u4f7f\u7528\u65b9\u5f0f\u8bf7\u53c2\u8003[\u6587\u6863](/docs/cli-tool/kubectl-plugin)\u3002\\n\\n### 5. \u5176\u4f59\u90e8\u5206\u529f\u80fd\u6539\u8fdb\u4e0e\u4f18\u5316\\n\\n**CloneSet:**\\n- \u901a\u8fc7 `scaleStrategy.maxUnavailable` \u7b56\u7565\u652f\u6301\u6d41\u5f0f\u6269\u5bb9\\n- Stable revision \u5224\u65ad\u903b\u8f91\u53d8\u5316\uff0c\u5f53\u6240\u6709 Pod \u7248\u672c\u4e0e updateRevision \u4e00\u81f4\u65f6\u5219\u6807\u8bb0\u4e3a currentRevision\\n\\n**WorkloadSpread:**\\n- \u652f\u6301\u63a5\u7ba1\u5b58\u91cf Pod \u5230\u5339\u914d\u7684 subset \u5206\u7ec4\u4e2d\\n- \u4f18\u5316 webhook \u5728 Pod \u6ce8\u5165\u65f6\u7684\u66f4\u65b0\u4e0e\u91cd\u8bd5\u903b\u8f91\\n\\n**Advanced DaemonSet:**\\n- \u652f\u6301\u5bf9 Daemon Pod \u505a\u539f\u5730\u5347\u7ea7\\n- \u5f15\u5165 progressive annotation \u6765\u9009\u62e9\u662f\u5426\u6309 partition \u9650\u5236 Pod \u521b\u5efa\\n\\n**SidecarSet:**\\n- \u89e3\u51b3 SidecarSet \u8fc7\u6ee4\u5c4f\u853d inactive Pod\\n- \u5728 `transferenv` \u4e2d\u65b0\u589e `SourceContainerNameFrom` \u548c `EnvNames` \u5b57\u6bb5\uff0c\u6765\u89e3\u51b3 container name \u4e0d\u4e00\u81f4\u4e0e\u5927\u91cf env \u60c5\u51b5\u4e0b\u7684\u5197\u4f59\u95ee\u9898\\n\\n**PodUnavailableBudget:**\\n- \u65b0\u589e \u201c\u8df3\u8fc7\u4fdd\u62a4\u201d \u6807\u8bc6\\n- PodUnavailableBudget controller \u5173\u6ce8 workload \u5de5\u4f5c\u8d1f\u8f7d\u7684 replicas \u53d8\u5316\\n\\n**NodeImage:**\\n- \u52a0\u5165 `--nodeimage-creation-delay` \u53c2\u6570\uff0c\u5e76\u9ed8\u8ba4\u7b49\u5f85\u65b0\u589e Node ready \u4e00\u6bb5\u65f6\u95f4\u540e\u540c\u6b65\u521b\u5efa NodeImage\\n\\n**UnitedDeployment:**\\n- \u89e3\u51b3 `NodeSelectorTerms` \u4e3a nil \u60c5\u51b5\u4e0b Pod `NodeSelectorTerms` \u957f\u5ea6\u4e3a 0 \u7684\u95ee\u9898\\n\\n**Other optimization:**\\n- kruise-daemon \u91c7\u7528 protobuf \u534f\u8bae\u64cd\u4f5c Pod \u8d44\u6e90\\n- \u66b4\u9732 cache resync \u4e3a\u547d\u4ee4\u884c\u53c2\u6570\uff0c\u5e76\u5728 chart \u4e2d\u8bbe\u7f6e\u9ed8\u8ba4\u503c\u4e3a 0\\n- \u89e3\u51b3 certs \u66f4\u65b0\u65f6\u7684 http checker \u5237\u65b0\u95ee\u9898\\n- \u53bb\u9664\u5bf9 forked controller-tools \u7684\u4f9d\u8d56\uff0c\u6539\u4e3a\u4f7f\u7528\u539f\u751f controller-tools \u914d\u5408 markers \u6ce8\u89e3\\n\\n## \u793e\u533a\u53c2\u4e0e\\n\\n\u975e\u5e38\u6b22\u8fce\u4f60\u901a\u8fc7 Github/Slack/\u9489\u9489/\u5fae\u4fe1 \u7b49\u65b9\u5f0f\u52a0\u5165\u6211\u4eec\u6765\u53c2\u4e0e OpenKruise \u5f00\u6e90\u793e\u533a\u3002\\n\u4f60\u662f\u5426\u5df2\u7ecf\u6709\u4e00\u4e9b\u5e0c\u671b\u4e0e\u6211\u4eec\u793e\u533a\u4ea4\u6d41\u7684\u5185\u5bb9\u5462\uff1f\\n\u53ef\u4ee5\u5728\u6211\u4eec\u7684[\u793e\u533a\u53cc\u5468\u4f1a](https://shimo.im/docs/gXqmeQOYBehZ4vqo)\u4e0a\u5206\u4eab\u4f60\u7684\u58f0\u97f3\uff0c\u6216\u901a\u8fc7\u4ee5\u4e0b\u6e20\u9053\u53c2\u4e0e\u8ba8\u8bba\uff1a\\n\\n- \u52a0\u5165\u793e\u533a [Slack channel](https://kubernetes.slack.com/channels/openkruise) (English)\\n- \u52a0\u5165\u793e\u533a\u9489\u9489\u7fa4\uff1a\u641c\u7d22\u7fa4\u53f7 `23330762` (Chinese)\\n- \u52a0\u5165\u793e\u533a\u5fae\u4fe1\u7fa4\uff1a\u6dfb\u52a0\u7528\u6237 `openkruise` \u5e76\u8ba9\u673a\u5668\u4eba\u62c9\u4f60\u5165\u7fa4 (Chinese)"},{"id":"workloadspread","metadata":{"permalink":"/zh/blog/workloadspread","editUrl":"https://github.com/openkruise/openkruise.io/edit/master/blog/2021-09-22-workloadspread.md","source":"@site/i18n/zh/docusaurus-plugin-content-blog/2021-09-22-workloadspread.md","title":"OpenKruise v0.10.0 \u65b0\u7279\u6027WorkloadSpread\u89e3\u8bfb","description":"\u80cc\u666f","date":"2021-09-22T00:00:00.000Z","tags":[{"inline":true,"label":"workload","permalink":"/zh/blog/tags/workload"},{"inline":true,"label":"workloadspread","permalink":"/zh/blog/tags/workloadspread"},{"inline":true,"label":"multi-domain","permalink":"/zh/blog/tags/multi-domain"}],"readingTime":12.29,"hasTruncateMarker":false,"authors":[{"name":"GuangLei Cao","title":"Contributor of OpenKruise","url":"https://github.com/BoltsLei","imageURL":"https://github.com/BoltsLei.png","key":"BoltsLei","page":null}],"frontMatter":{"slug":"workloadspread","title":"OpenKruise v0.10.0 \u65b0\u7279\u6027WorkloadSpread\u89e3\u8bfb","authors":["BoltsLei"],"tags":["workload","workloadspread","multi-domain"]},"unlisted":false,"prevItem":{"title":"OpenKruise v1.0\uff1a\u4e91\u539f\u751f\u5e94\u7528\u81ea\u52a8\u5316\u8fbe\u5230\u65b0\u7684\u9ad8\u5cf0","permalink":"/zh/blog/openkruise-1.0"},"nextItem":{"title":"OpenKruise 0.10.0\uff1a\u65b0\u589e\u5e94\u7528\u5f39\u6027\u62d3\u6251\u7ba1\u7406\u3001\u5e94\u7528\u9632\u62a4\u7b49\u80fd\u529b","permalink":"/zh/blog/openkruise-0.10.0"}},"content":"## \u80cc\u666f\\n\\nWorkload\u5206\u5e03\u5728\u4e0d\u540czone\uff0c\u4e0d\u540c\u7684\u786c\u4ef6\u7c7b\u578b\uff0c\u751a\u81f3\u662f\u4e0d\u540c\u7684\u96c6\u7fa4\u548c\u4e91\u5382\u5546\u5df2\u7ecf\u662f\u4e00\u4e2a\u975e\u5e38\u666e\u904d\u7684\u9700\u6c42\u3002\u8fc7\u53bb\u4e00\u822c\u53ea\u80fd\u5c06\u4e00\u4e2a\u5e94\u7528\u62c6\u5206\u4e3a\u591a\u4e2a workload\uff08\u6bd4\u5982 Deployment\uff09\u6765\u90e8\u7f72\uff0c\u7531SRE\u56e2\u961f\u624b\u5de5\u7ba1\u7406\u6216\u8005\u5bf9PaaS \u5c42\u6df1\u5ea6\u5b9a\u5236\uff0c\u6765\u652f\u6301\u5bf9\u4e00\u4e2a\u5e94\u7528\u591a\u4e2a workload \u7684\u7cbe\u7ec6\u5316\u7ba1\u7406\u3002\\n\\n\u8fdb\u4e00\u6b65\u6765\u8bf4\uff0c\u5728\u5e94\u7528\u90e8\u7f72\u7684\u573a\u666f\u4e0b\u6709\u7740\u591a\u79cd\u591a\u6837\u7684\u62d3\u6251\u6253\u6563\u4ee5\u53ca\u5f39\u6027\u7684\u8bc9\u6c42\u3002\u5176\u4e2d\u6700\u5e38\u89c1\u5c31\u662f\u6309\u67d0\u79cd\u6216\u591a\u79cd\u62d3\u6251\u7ef4\u5ea6\u6253\u6563\uff0c\u6bd4\u5982\uff1a\\n- \u5e94\u7528\u90e8\u7f72\u9700\u8981\u6309 node \u7ef4\u5ea6\u6253\u6563\uff0c\u907f\u514d\u5806\u53e0\uff08\u63d0\u9ad8\u5bb9\u707e\u80fd\u529b\uff09\u3002\\n- \u5e94\u7528\u90e8\u7f72\u9700\u8981\u6309 AZ\uff08available zone\uff09\u7ef4\u5ea6\u6253\u6563\uff08\u63d0\u9ad8\u5bb9\u707e\u80fd\u529b\uff09\u3002\\n- \u6309 zone \u6253\u6563\u65f6\uff0c\u9700\u8981\u6307\u5b9a\u5728\u4e0d\u540c zone \u4e2d\u90e8\u7f72\u7684\u6bd4\u4f8b\u6570\u3002\\n\\n\u968f\u7740\u4e91\u539f\u751f\u5728\u56fd\u5185\u5916\u7684\u8fc5\u901f\u666e\u53ca\u843d\u5730\uff0c\u5e94\u7528\u5bf9\u4e8e\u5f39\u6027\u7684\u9700\u6c42\u4e5f\u8d8a\u6765\u8d8a\u591a\u3002\u5404\u516c\u6709\u4e91\u5382\u5546\u9646\u7eed\u63a8\u51fa\u4e86Serverless\u5bb9\u5668\u670d\u52a1\u6765\u652f\u6491\u5f39\u6027\u90e8\u7f72\u573a\u666f\uff0c\u5982\u963f\u91cc\u4e91\u7684\u5f39\u6027\u5bb9\u5668\u670d\u52a1ECI\uff0cAWS\u7684Fragate\u5bb9\u5668\u670d\u52a1\u7b49\u3002\u4ee5ECI\u4e3a\u4f8b\uff0cECI\u53ef\u4ee5\u901a\u8fc7Virtual Kubelet\u5bf9\u63a5Kubernetes\u7cfb\u7edf\uff0c\u7ed9\u4e88Pod\u4e00\u5b9a\u7684\u914d\u7f6e\u5c31\u53ef\u4ee5\u8c03\u5ea6\u5230virtual-node\u80cc\u540e\u7684ECI\u96c6\u7fa4\u3002\u603b\u7ed3\u4e00\u4e9b\u5e38\u89c1\u7684\u5f39\u6027\u8bc9\u6c42\uff0c\u6bd4\u5982\uff1a\\n- \u5e94\u7528\u4f18\u5148\u90e8\u7f72\u5230\u81ea\u6709\u96c6\u7fa4\uff0c\u8d44\u6e90\u4e0d\u8db3\u65f6\u518d\u90e8\u7f72\u5230\u5f39\u6027\u96c6\u7fa4\u3002\u7f29\u5bb9\u65f6\uff0c\u4f18\u5148\u4ece\u5f39\u6027\u8282\u70b9\u7f29\u5bb9\u4ee5\u8282\u7701\u6210\u672c\u3002\\n- \u7528\u6237\u81ea\u5df1\u89c4\u5212\u57fa\u7840\u8282\u70b9\u6c60\u548c\u5f39\u6027\u8282\u70b9\u6c60\u3002\u5e94\u7528\u90e8\u7f72\u65f6\u9700\u8981\u56fa\u5b9a\u6570\u91cf\u6216\u6bd4\u4f8b\u7684 Pod \u90e8\u7f72\u5728\u57fa\u7840\u8282\u70b9\u6c60\uff0c\u5176\u4f59\u7684\u90fd\u6269\u5230\u5f39\u6027\u8282\u70b9\u6c60\u3002\\n\\n\u9488\u5bf9\u8fd9\u4e9b\u9700\u6c42\uff0cOpenKruise\u5728 v0.10.0 \u7248\u672c\u4e2d\u65b0\u589e\u4e86 WorkloadSpread \u7279\u6027\u3002\u76ee\u524d\u5b83\u652f\u6301\u914d\u5408 Deployment\u3001ReplicaSet\u3001CloneSet \u8fd9\u4e9b workload \uff0c\u6765\u7ba1\u7406\u5b83\u4eec\u4e0b\u5c5e Pod \u7684\u5206\u533a\u90e8\u7f72\u4e0e\u5f39\u6027\u4f38\u7f29\u3002\u4e0b\u6587\u4f1a\u6df1\u5165\u4ecb\u7ecdWorkloadSpread\u7684\u5e94\u7528\u573a\u666f\u548c\u5b9e\u73b0\u539f\u7406\uff0c\u5e2e\u52a9\u7528\u6237\u66f4\u597d\u7684\u4e86\u89e3\u8be5\u7279\u6027\u3002\\n\\n---\\n\\n## WorkloadSpread \u4ecb\u7ecd\\n\\n\u8be6\u7ec6\u7ec6\u8282\u53ef\u4ee5\u53c2\u8003[\u5b98\u65b9\u6587\u6863](https://openkruise.io/docs/user-manuals/workloadspread)\u3002\\n\\n\u7b80\u800c\u8a00\u4e4b\uff0cWorkloadSpread\u80fd\u591f\u5c06workload\u6240\u5c5e\u7684Pod\u6309\u4e00\u5b9a\u89c4\u5219\u5206\u5e03\u5230\u4e0d\u540c\u7c7b\u578b\u7684Node\u8282\u70b9\u4e0a\uff0c\u80fd\u591f\u540c\u65f6\u6ee1\u8db3\u4e0a\u8ff0\u7684\u6253\u6563\u4e0e\u5f39\u6027\u573a\u666f\u3002\\n\\n--- \\n\\n## \u73b0\u6709\u65b9\u6848\u5bf9\u6bd4\\n\\n\u7b80\u5355\u5bf9\u6bd4\u4e00\u4e9b\u793e\u533a\u5df2\u6709\u7684\u65b9\u6848\u3002\\n\\n### Pod Topology Spread Constrains\\n[Pod topology spread constraints](https://kubernetes.io/docs/concepts/workloads/pods/pod-topology-spread-constraints/) \u662fKubernetes\u793e\u533a\u63d0\u4f9b\u7684\u65b9\u6848\uff0c\u53ef\u4ee5\u5b9a\u4e49\u6309 topology key \u7684\u6c34\u5e73\u6253\u6563\u3002\u7528\u6237\u5728\u5b9a\u4e49\u5b8c\u540e\uff0c\u8c03\u5ea6\u5668\u4f1a\u4f9d\u636e\u914d\u7f6e\u9009\u62e9\u7b26\u5408\u5206\u5e03\u6761\u4ef6\u7684node\u3002\\n\\n\u7531\u4e8ePodTopologySpread\u66f4\u591a\u7684\u662f\u5747\u5300\u6253\u6563\uff0c\u65e0\u6cd5\u652f\u6301\u81ea\u5b9a\u4e49\u7684\u5206\u533a\u6570\u91cf\u4ee5\u53ca\u6bd4\u4f8b\u914d\u7f6e\uff0c\u4e14\u7f29\u5bb9\u65f6\u4f1a\u7834\u574f\u5206\u5e03\u3002WorkloadSpread\u53ef\u4ee5\u81ea\u5b9a\u4e49\u5404\u4e2a\u5206\u533a\u7684\u6570\u91cf\uff0c\u5e76\u4e14\u7ba1\u7406\u7740\u7f29\u5bb9\u7684\u987a\u5e8f\u3002\u56e0\u6b64\u5728\u4e00\u4e9b\u573a\u666f\u4e0b\u53ef\u4ee5\u907f\u514dPodTopologySpread\u7684\u4e0d\u8db3\u3002\\n\\n#### UnitedDeployment\\n[UnitedDeployment](https://openkruise.io/docs/user-manuals/uniteddeployment) \u662fKruise\u793e\u533a\u63d0\u4f9b\u7684\u65b9\u6848\uff0c\u901a\u8fc7\u521b\u5efa\u548c\u7ba1\u7406\u591a\u4e2a workload \u7ba1\u7406\u591a\u4e2a\u533a\u57df\u4e0b\u7684 Pod\u3002\\n\\nUnitedDeployment\u975e\u5e38\u597d\u7684\u652f\u6301\u4e86\u6253\u6563\u4e0e\u5f39\u6027\u7684\u9700\u6c42\uff0c\u4e0d\u8fc7\u5b83\u662f\u4e00\u4e2a\u5168\u65b0\u7684workload\uff0c\u7528\u6237\u7684\u4f7f\u7528\u548c\u8fc1\u79fb\u6210\u672c\u4f1a\u6bd4\u8f83\u9ad8\u3002\u800cWorkloadSpread\u662f\u4e00\u79cd\u8f7b\u91cf\u5316\u7684\u65b9\u6848\uff0c\u53ea\u9700\u8981\u7b80\u5355\u7684\u914d\u7f6e\u5e76\u5173\u8054\u5230workload\u5373\u53ef\u3002\\n\\n--- \\n\\n## \u5e94\u7528\u573a\u666f\\n\u4e0b\u9762\u6211\u4f1a\u5217\u4e3e\u4e00\u4e9bWorkloadSpread\u7684\u5e94\u7528\u573a\u666f\uff0c\u7ed9\u51fa\u5bf9\u5e94\u7684\u914d\u7f6e\uff0c\u5e2e\u52a9\u5927\u5bb6\u5feb\u901f\u4e86\u89e3WorkloadSpread\u7684\u80fd\u529b\u3002\\n\\n### 1. \u57fa\u7840\u8282\u70b9\u6c60\u81f3\u591a\u90e8\u7f72100\u4e2a\u526f\u672c\uff0c\u5269\u4f59\u7684\u90e8\u7f72\u5230\u5f39\u6027\u8282\u70b9\u6c60\u3002\\n\\n![case-1](../../../static/img/blog/2021-09-22-workloadspread/case-1.jpg)\\n\\n```yaml\\nsubsets:\\n- name: subset-normal\\n  maxReplicas: 100\\n  requiredNodeSelectorTerm:\\n    matchExpressions:\\n    - key: app.deploy/zone\\n      operator: In\\n      values:\\n      - normal\\n- name: subset-elastic #\u526f\u672c\u6570\u91cf\u4e0d\u9650\\n  requiredNodeSelectorTerm:\\n    matchExpressions:\\n    - key: app.deploy/zone\\n      operator: In\\n      values:\\n      - elastic\\n```\\n\\n\u5f53workload\u5c11\u4e8e100\u526f\u672c\u65f6\uff0c\u5168\u90e8\u90e8\u7f72\u5230normal\u8282\u70b9\u6c60\uff0c\u8d85\u8fc7100\u4e2a\u90e8\u7f72\u5230elastic\u8282\u70b9\u6c60\u3002\u7f29\u5bb9\u65f6\u4f1a\u4f18\u5148\u5220\u9664elastic\u8282\u70b9\u4e0a\u7684Pod\u3002\\n\\n\u7531\u4e8eWorkloadSpread\u4e0d\u4fb5\u5165workload\uff0c\u53ea\u662f\u9650\u5236\u4f4f\u4e86workload\u7684\u5206\u5e03\uff0c\u6211\u4eec\u8fd8\u53ef\u4ee5\u901a\u8fc7\u7ed3\u5408HPA\u6839\u636e\u8d44\u6e90\u8d1f\u8f7d\u52a8\u6001\u8c03\u6574\u526f\u672c\u6570\uff0c\u8fd9\u6837\u5f53\u4e1a\u52a1\u9ad8\u5cf0\u65f6\u4f1a\u81ea\u52a8\u8c03\u5ea6\u5230elastic\u8282\u70b9\u4e0a\u53bb\uff0c\u4e1a\u52a1\u4f4e\u5cf0\u65f6\u4f1a\u4f18\u5148\u91ca\u653eelastic\u8282\u70b9\u6c60\u4e0a\u7684\u8d44\u6e90\u3002\\n\\n### 2. \u4f18\u5148\u90e8\u7f72\u5230\u57fa\u7840\u8282\u70b9\u6c60\uff0c\u8d44\u6e90\u4e0d\u8db3\u518d\u90e8\u7f72\u5230\u5f39\u6027\u8d44\u6e90\u6c60\u3002\\n\\n![case-2](../../../static/img/blog/2021-09-22-workloadspread/case-2.jpg)\\n\\n```yaml\\nscheduleStrategy:\\n  type: Adaptive\\n  adaptive:\\n    rescheduleCriticalSeconds: 30\\n    disableSimulationSchedule: false\\nsubsets:\\n- name: subset-normal #\u526f\u672c\u6570\u91cf\u4e0d\u9650\\n  requiredNodeSelectorTerm:\\n    matchExpressions:\\n    - key: app.deploy/zone\\n      operator: In\\n      values:\\n      - normal\\n- name: subset-elastic #\u526f\u672c\u6570\u91cf\u4e0d\u9650\\n  requiredNodeSelectorTerm:\\n    matchExpressions:\\n    - key: app.deploy/zone\\n      operator: In\\n      values:\\n      - elastic\\n```\\n\\n\u4e24\u4e2asubset\u90fd\u6ca1\u6709\u526f\u672c\u6570\u91cf\u9650\u5236\uff0c\u4e14\u542f\u7528Adptive\u8c03\u5ea6\u7b56\u7565\u7684\u6a21\u62df\u8c03\u5ea6\u548cReschedule\u80fd\u529b\u3002\u90e8\u7f72\u6548\u679c\u662f\u4f18\u5148\u90e8\u7f72\u5230normal\u8282\u70b9\u6c60\uff0cnormal\u8d44\u6e90\u4e0d\u8db3\u65f6\uff0cwebhook\u4f1a\u901a\u8fc7\u6a21\u62df\u8c03\u5ea6\u9009\u62e9elastic\u8282\u70b9\u3002\u5f53normal\u8282\u70b9\u6c60\u4e2d\u7684Pod\u5904\u4e8epending\u72b6\u6001\u8d85\u8fc730s\u9608\u503c, WorkloadSpread controller\u4f1a\u5220\u9664\u8be5Pod\u4ee5\u89e6\u53d1\u91cd\u5efa\uff0c\u65b0\u7684Pod\u4f1a\u88ab\u8c03\u5ea6\u5230elastic\u8282\u70b9\u6c60\u3002\u7f29\u5bb9\u65f6\u8fd8\u662f\u4f18\u5148\u7f29\u5bb9elastic\u8282\u70b9\u4e0a\u7684Pod\uff0c\u4e3a\u7528\u6237\u8282\u7701\u6210\u672c\u3002\\n\\n### 3. \u6253\u6563\u52303\u4e2azone\uff0c\u6bd4\u4f8b\u5206\u522b\u4e3a1:1:3\\n\\n![case-3](../../../static/img/blog/2021-09-22-workloadspread/case-3.jpg)\\n\\n```yaml\\nsubsets:\\n- name: subset-a\\n  maxReplicas: 20%\\n  requiredNodeSelectorTerm:\\n    matchExpressions:\\n    - key: topology.kubernetes.io/zone\\n      operator: In\\n      values:\\n      - zone-a\\n- name: subset-b\\n  maxReplicas: 20%\\n  requiredNodeSelectorTerm:\\n    matchExpressions:\\n    - key: topology.kubernetes.io/zone\\n      operator: In\\n      values:\\n      - zone-b\\n- name: subset-c\\n  maxReplicas: 60%\\n  requiredNodeSelectorTerm:\\n    matchExpressions:\\n    - key: topology.kubernetes.io/zone\\n      operator: In\\n      values:\\n      - zone-c      \\n```\\n\\n\u6309\u7167\u4e0d\u540czone\u7684\u5b9e\u9645\u60c5\u51b5\uff0c\u5c06workload\u6309\u71671:1:3\u7684\u6bd4\u4f8b\u6253\u6563\u3002WorkloadSpread\u4f1a\u786e\u4fddworkload\u6269\u7f29\u5bb9\u65f6\u6309\u7167\u5b9a\u4e49\u7684\u6bd4\u4f8b\u5206\u5e03\u3002\\n\\n### 4. workload\u5728\u4e0d\u540cCPU Arch\u4e0a\u914d\u7f6e\u4e0d\u540c\u7684\u8d44\u6e90\u914d\u989d\\nworkload\u5206\u5e03\u7684Node\u53ef\u80fd\u6709\u4e0d\u540c\u7684\u786c\u4ef6\u914d\u7f6e\uff0cCPU\u67b6\u6784\u7b49\uff0c\u8fd9\u5c31\u53ef\u80fd\u9700\u8981\u4e3a\u4e0d\u540c\u7684subset\u5206\u522b\u5236\u5b9aPod\u914d\u7f6e\u3002\u8fd9\u4e9b\u914d\u7f6e\u53ef\u4ee5\u662flabel\u548cannotation\u7b49\u5143\u6570\u636e\u4e5f\u53ef\u4ee5\u662fPod\u5185\u90e8\u5bb9\u5668\u7684\u8d44\u6e90\u914d\u989d\uff0c\u73af\u5883\u53d8\u91cf\u7b49\u3002\\n\\n![case-4](../../../static/img/blog/2021-09-22-workloadspread/case-4.jpg)\\n\\n```yaml\\nsubsets:\\n- name: subset-x86-arch\\n  # maxReplicas...\\n  # requiredNodeSelectorTerm...\\n  patch:\\n    metadata:\\n      labels:\\n        resource.cpu/arch: x86\\n    spec: \\n      containers:\\n      - name: main\\n        resources:\\n          limits:\\n            cpu: \\"500m\\"\\n            memory: \\"800Mi\\"\\n- name: subset-arm-arch\\n  # maxReplicas...\\n  # requiredNodeSelectorTerm...\\n  patch:\\n    metadata:\\n      labels:\\n        resource.cpu/arch: arm\\n    spec: \\n      containers:\\n      - name: main\\n        resources:\\n          limits:\\n            cpu: \\"300m\\"\\n            memory: \\"600Mi\\"\\n```\\n\\n\u4ece\u4e0a\u9762\u7684\u6837\u4f8b\u4e2d\u6211\u4eec\u4e3a\u4e24\u4e2asubset\u7684Pod\u5206\u522bpatch\u4e86\u4e0d\u540c\u7684label, container resources\uff0c\u65b9\u4fbf\u6211\u4eec\u5bf9Pod\u505a\u66f4\u7cbe\u7ec6\u5316\u7684\u7ba1\u7406\u3002\u5f53workload\u7684Pod\u5206\u5e03\u5728\u4e0d\u540c\u7684CPU\u67b6\u6784\u7684\u8282\u70b9\u4e0a\uff0c\u914d\u7f6e\u4e0d\u540c\u7684\u8d44\u6e90\u914d\u989d\u4ee5\u66f4\u597d\u7684\u5229\u7528\u786c\u4ef6\u8d44\u6e90\u3002\\n\\n---\\n\\n## \u5b9e\u73b0\u539f\u7406\\nWorkloadSpread\u662f\u4e00\u4e2a\u7eaf\u65c1\u8def\u7684\u5f39\u6027/\u62d3\u6251\u7ba1\u63a7\u65b9\u6848\u3002\u7528\u6237\u53ea\u9700\u8981\u9488\u5bf9\u81ea\u5df1\u7684 Deployment/CloneSet/Job \u5bf9\u8c61\u521b\u5efa\u5bf9\u5e94\u7684 WorkloadSpread \u5373\u53ef\uff0c\u65e0\u9700\u5bf9 workload \u505a\u6539\u52a8\uff0c\u4e5f\u4e0d\u4f1a\u5bf9\u7528\u6237\u4f7f\u7528 workload \u9020\u6210\u989d\u5916\u6210\u672c\u3002\\n\\n![arch](../../../static/img/blog/2021-09-22-workloadspread/arch.jpg)\\n\\n### 1. subset\u4f18\u5148\u7ea7\u4e0e\u526f\u672c\u6570\u91cf\u63a7\u5236\\nWorkloadSpread \u4e2d\u5b9a\u4e49\u4e86\u591a\u4e2a subset\uff0c\u6bcf\u4e2asubset\u4ee3\u8868\u4e00\u4e2a\u903b\u8f91\u57df\u3002\u7528\u6237\u53ef\u4ee5\u81ea\u7531\u7684\u6839\u636e\u8282\u70b9\u914d\u7f6e\uff0c\u786c\u4ef6\u7c7b\u578b\uff0czone\u7b49\u6765\u5212\u5206subset\u3002\u7279\u522b\u7684\uff0c\u6211\u4eec\u89c4\u5b9a\u4e86subset\u7684\u4f18\u5148\u7ea7\uff1a\\n1. \u6309\u5b9a\u4e49\u4ece\u524d\u5f80\u540e\u7684\u987a\u5e8f\uff0c\u4f18\u5148\u7ea7\u4ece\u9ad8\u5230\u4f4e\u3002\\n2. \u4f18\u5148\u7ea7\u8d8a\u9ad8\uff0c\u8d8a\u5148\u6269\u5bb9\uff1b\u4f18\u5148\u7ea7\u8d8a\u4f4e\uff0c\u8d8a\u5148\u7f29\u5bb9\u3002\\n\\n### 2. \u5982\u4f55\u63a7\u5236\u7f29\u5bb9\u4f18\u5148\u7ea7\uff1f\\n\u7406\u8bba\u4e0a\uff0cWorkloadSpread \u8fd9\u79cd\u65c1\u8def\u65b9\u6848\u662f\u65e0\u6cd5\u5e72\u6d89\u5230 workload \u63a7\u5236\u5668\u91cc\u7684\u7f29\u5bb9\u987a\u5e8f\u903b\u8f91\u7684\u3002\\n\\n\u4e0d\u8fc7\uff0c\u8fd9\u4e2a\u95ee\u9898\u5728\u8fd1\u671f\u5f97\u4ee5\u89e3\u51b3\u2014\u2014 \u7ecf\u8fc7\u4e00\u4ee3\u4ee3\u7528\u6237\u7684\u4e0d\u61c8\u52aa\u529b\uff08\u53cd\u9988\uff09\uff0ck8s \u4ece 1.21 \u7248\u672c\u5f00\u59cb\u4e3a ReplicaSet\uff08Deployment\uff09\u652f\u6301\u4e86\u901a\u8fc7\u8bbe\u7f6e controller.kubernetes.io/pod-deletion-cost \u8fd9\u4e2a annotation \u6765\u6307\u5b9a Pod \u7684 \u201c\u5220\u9664\u4ee3\u4ef7\u201d\uff1adeletion-cost \u8d8a\u9ad8\u7684 Pod\uff0c\u5220\u9664\u7684\u4f18\u5148\u7ea7\u8d8a\u4f4e\u3002\\n\\n\u800c Kruise \u4ece v0.9.0 \u7248\u672c\u5f00\u59cb\uff0c\u5c31\u5728 CloneSet \u4e2d\u652f\u6301\u4e86 deletion-cost \u7279\u6027\u3002\\n\\n\u56e0\u6b64\uff0cWorkloadSpread controller\u901a\u8fc7\u8c03\u6574\u5404\u4e2a subset \u4e0b\u5c5e Pod \u7684 deletion-cost\uff0c\u6765\u63a7\u5236workload\u7684\u7f29\u5bb9\u987a\u5e8f\u3002\\n\\n\u4e3e\u4e2a\u4f8b\u5b50\uff1a\u5bf9\u4e8e\u4ee5\u4e0b WorkloadSpread\uff0c\u4ee5\u53ca\u5b83\u5173\u8054\u7684 CloneSet \u6709 10 \u4e2a\u526f\u672c\uff1a\\n```yaml\\n  subsets:\\n  - name: subset-a\\n    maxReplicas: 8\\n  - name: subset-b # \u526f\u672c\u6570\u91cf\u4e0d\u9650\\n```\\n\\n\u5219 deletion-cost \u6570\u503c\u4ee5\u53ca\u5220\u9664\u987a\u5e8f\u4e3a\uff1a\\n- 2 \u4e2a\u5728 subset-b\u4e0a\u7684 Pod\uff0cdeletion-cost \u4e3a 100\uff08\u4f18\u5148\u7f29\u5bb9\uff09 \\n- 8 \u4e2a\u5728 subset-a\u4e0a\u7684 Pod\uff0cdeletion-cost \u4e3a 200\uff08\u6700\u540e\u7f29\u5bb9\uff09 \\n\\n\u7136\u540e\uff0c\u5982\u679c\u7528\u6237\u4fee\u6539\u4e86 WorkloadSpread \u4e3a\uff1a\\n```yaml\\n  subsets:\\n  - name: subset-a\\n    maxReplicas: 5 # 8-3, \\n  - name: subset-b\\n```\\n\\n\u5219 workloadspread controller \u4f1a\u5c06\u5176\u4e2d 3 \u4e2a\u5728 susbet-a \u4e0a Pod \u7684 deletion-cost\u503c\u7531 200 \u6539\u4e3a -100\uff0c\u5219:\\n- 3 \u4e2a\u5728 subset-a \u4e0a\u7684 Pod\uff0cdeletion-cost \u4e3a -100\uff08\u4f18\u5148\u7f29\u5bb9\uff09 \\n- 2 \u4e2a\u5728 subset-b \u4e0a\u7684 Pod\uff0cdeletion-cost \u4e3a 100\uff08\u5176\u6b21\u7f29\u5bb9\uff09 \\n- 5 \u4e2a\u5728 subset-a \u4e0a\u7684 Pod\uff0cdeletion-cost \u4e3a 200\uff08\u6700\u540e\u7f29\u5bb9\uff09 \\n\\n\u8fd9\u6837\u5c31\u80fd\u591f\u4f18\u5148\u7f29\u5bb9\u90a3\u4e9b\u8d85\u8fc7subset\u526f\u672c\u9650\u5236\u7684Pod\u4e86\uff0c\u5f53\u7136\u603b\u4f53\u8fd8\u662f\u6309\u7167subset\u5b9a\u4e49\u7684\u987a\u5e8f\u4ece\u540e\u5411\u524d\u7f29\u5bb9\u3002\\n\\n### 3. \u6570\u91cf\u63a7\u5236\\n\\n\u5982\u4f55\u786e\u4fdd webhook \u4e25\u683c\u6309\u7167 subset \u4f18\u5148\u7ea7\u987a\u5e8f\u3001maxReplicas \u6570\u91cf\u6765\u6ce8\u5165Pod \u89c4\u5219\u662f WorkloadSpread \u5b9e\u73b0\u5c42\u9762\u7684\u91cd\u70b9\u96be\u9898\u3002\\n\\n#### 3.1 \u89e3\u51b3\u5e76\u53d1\u4e00\u81f4\u6027\u95ee\u9898\\n\u5728 workloadspread\u7684status \u4e2d\u6709\u5bf9\u5e94\u6bcf\u4e2a subset \u7684 status\uff0c\u5176\u4e2d missingReplicas \u5b57\u6bb5\u8868\u793a\u4e86\u8fd9\u4e2a subset \u9700\u8981\u7684 Pod \u6570\u91cf\uff0c-1 \u8868\u793a\u6ca1\u6709\u6570\u91cf\u9650\u5236\uff08subset \u6ca1\u6709\u914d\u7f6e maxReplicas\uff09\u3002\\n```yaml\\nspec:\\n  subsets:\\n  - name: subset-a\\n    maxReplicas: 1\\n  - name: subset-b\\n  # ...\\nstatus:\\n  subsetStatuses:\\n  - name: subset-a\\n    missingReplicas: 1\\n  - name: subset-b\\n    missingReplicas: -1\\n  # ...\\n```\\n\\n\u5f53 webhook \u6536\u5230 Pod create\u8bf7\u6c42\u65f6\uff1a\\n1. \u6839\u636e subsetStatuses \u987a\u5e8f\u4f9d\u6b21\u627e missingReplicas \u5927\u4e8e 0 \u6216\u4e3a -1 \u7684 suitable subset\u3002\\n2. \u627e\u5230suitable subset\u540e\uff0c\u5982\u679c missingReplicas \u5927\u4e8e 0\uff0c\u5219\u5148\u51cf 1 \u5e76\u5c1d\u8bd5\u66f4\u65b0 workloadspread status\u3002\\n3. \u5982\u679c\u66f4\u65b0\u6210\u529f\uff0c\u5219\u5c06\u8be5 subset\u5b9a\u4e49\u7684\u89c4\u5219\u6ce8\u5165\u5230 pod \u4e2d\u3002\\n4. \u5982\u679c\u66f4\u65b0\u5931\u8d25\uff0c\u5219\u91cd\u65b0 get \u8fd9\u4e2a workloadspread\u4ee5\u83b7\u53d6\u6700\u65b0\u7684status\uff0c\u5e76\u56de\u5230\u6b65\u9aa4 1\uff08\u6709\u4e00\u5b9a\u91cd\u8bd5\u6b21\u6570\u9650\u5236\uff09\u3002\\n\\n\u540c\u6837\uff0c\u5f53 webhook \u6536\u5230 Pod delete/eviction \u8bf7\u6c42\u65f6\uff0c\u5219\u5c06 missingReplicas \u52a0 1 \u5e76\u66f4\u65b0\u3002\\n\\n\u6beb\u65e0\u7591\u95ee\uff0c\u6211\u4eec\u5728\u4f7f\u7528\u4e50\u89c2\u9501\u6765\u89e3\u51b3\u66f4\u65b0\u51b2\u7a81\u3002\u4f46\u662f\u4ec5\u4f7f\u7528\u4e50\u89c2\u9501\u662f\u4e0d\u5408\u9002\u7684\uff0c\u56e0\u4e3aworkload\u5728\u521b\u5efaPod\u65f6\u4f1a\u5e76\u884c\u521b\u5efa\u5927\u91cf\u7684Pod\uff0capiserver\u4f1a\u5728\u4e00\u77ac\u95f4\u53d1\u9001\u5f88\u591aPod create\u8bf7\u6c42\u5230webhook\uff0c\u5e76\u884c\u5904\u7406\u4f1a\u4ea7\u751f\u975e\u5e38\u591a\u7684\u51b2\u7a81\u3002\u5927\u5bb6\u90fd\u77e5\u9053\uff0c\u51b2\u7a81\u592a\u591a\u5c31\u4e0d\u9002\u5408\u4f7f\u7528\u4e50\u89c2\u9501\u4e86\uff0c\u56e0\u4e3a\u5b83\u89e3\u51b3\u51b2\u7a81\u7684\u91cd\u8bd5\u6210\u672c\u975e\u5e38\u9ad8\u3002\u4e3a\u6b64\u6211\u4eec\u8fd8\u52a0\u5165\u4e86workloadspread\u7ea7\u522b\u7684\u4e92\u65a5\u9501\uff0c\u5c06\u5e76\u884c\u5904\u7406\u9650\u5236\u4e3a\u4e32\u884c\u5904\u7406\u3002\u52a0\u5165\u4e92\u65a5\u9501\u8fd8\u6709\u65b0\u7684\u95ee\u9898\uff0c\u5373\u5f53\u524dgroutine\u83b7\u53d6\u9501\u540e\uff0c\u6781\u6709\u53ef\u80fd\u4eceinfromer\u4e2d\u62ff\u7684workloadspread\u4e0d\u662f\u6700\u65b0\u7684\uff0c\u8fd8\u662f\u4f1a\u51b2\u7a81\u3002\u6240\u4ee5groutine\u5728\u66f4\u65b0\u5b8cworkloadspread\u4e4b\u540e\uff0c\u5148\u5c06\u6700\u65b0\u7684workloadspread\u5bf9\u8c61\u7f13\u5b58\u8d77\u6765\u518d\u91ca\u653e\u9501\uff0c\u8fd9\u6837\u65b0\u7684groutine\u83b7\u53d6\u9501\u540e\u5c31\u53ef\u4ee5\u76f4\u63a5\u4ece\u7f13\u5b58\u4e2d\u62ff\u5230\u6700\u65b0\u7684workloadspread\u3002\u5f53\u7136\uff0c\u591a\u4e2awebhook\u7684\u60c5\u51b5\u4e0b\u8fd8\u662f\u9700\u8981\u7ed3\u5408\u4e50\u89c2\u9501\u673a\u5236\u6765\u89e3\u51b3\u51b2\u7a81\u3002\\n\\n#### 3.2 \u89e3\u51b3\u6570\u636e\u4e00\u81f4\u6027\u95ee\u9898\\n\u90a3\u4e48\uff0cmissingReplicas \u6570\u503c\u662f\u5426\u4ea4\u7531 webhook \u63a7\u5236\u5373\u53ef\u5462\uff1f\u7b54\u6848\u662f\u4e0d\u884c\uff0c\u56e0\u4e3a\uff1a\\n1. webhook \u6536\u5230\u7684 Pod create \u8bf7\u6c42\uff0c\u6700\u7ec8\u4e0d\u4e00\u5b9a\u771f\u7684\u80fd\u6210\u529f\uff08\u6bd4\u5982 Pod \u4e0d\u5408\u6cd5\uff0c\u6216\u5728\u540e\u7eed quota \u7b49\u6821\u9a8c\u73af\u8282\u5931\u8d25\u4e86\uff09\u3002\\n2. webhook \u6536\u5230\u7684 Pod delete/eviction \u8bf7\u6c42\uff0c\u6700\u7ec8\u4e5f\u4e0d\u4e00\u5b9a\u771f\u7684\u80fd\u6210\u529f\uff08\u6bd4\u5982\u540e\u7eed\u88ab PDB\u3001PUB \u7b49\u62e6\u622a\u4e86\uff09\u3002\\n3. K8s \u91cc\u603b\u6709\u79cd\u79cd\u7684\u53ef\u80fd\u6027\uff0c\u5bfc\u81f4 Pod \u6ca1\u6709\u7ecf\u8fc7 webhook \u5c31\u7ed3\u675f\u6216\u6ca1\u4e86\uff08\u6bd4\u5982 phase \u8fdb\u5165 Succeeded/Failed\uff0c\u6216\u662f etcd \u6570\u636e\u4e22\u4e86\u7b49\u7b49\uff09\u3002\\n4. \u540c\u65f6\uff0c\u8fd9\u4e5f\u4e0d\u7b26\u5408\u9762\u5411\u7ec8\u6001\u7684\u8bbe\u8ba1\u7406\u5ff5\u3002\\n\\n\u56e0\u6b64\uff0cworkloadspread status \u662f\u7531 webhook \u4e0e controller \u534f\u4f5c\u6765\u63a7\u5236\u7684\uff1a\\n- webhook \u5728 Pod create/delete/eviction \u8bf7\u6c42\u94fe\u8def\u62e6\u622a\uff0c\u4fee\u6539 missingReplicas \u6570\u503c\u3002\\n- \u540c\u65f6 controller \u7684 reconcile \u4e2d\u4e5f\u4f1a\u62ff\u5230\u5f53\u524d workload \u4e0b\u7684\u6240\u6709 Pod\uff0c\u6839\u636e subset \u5206\u7c7b\uff0c\u5e76\u5c06 missingReplicas \u66f4\u65b0\u4e3a\u5f53\u524d\u5b9e\u9645\u7f3a\u5c11\u7684\u6570\u91cf\u3002\\n- \u4ece\u4e0a\u9762\u7684\u5206\u6790\u4e2d\uff0ccontroller\u4eceinformer\u4e2d\u83b7\u53d6Pod\u5f88\u53ef\u80fd\u5b58\u5728\u5ef6\u65f6\uff0c\u6240\u4ee5\u6211\u4eec\u8fd8\u5728status\u4e2d\u589e\u52a0\u4e86creatingPods map, webook\u6ce8\u5165\u7684\u65f6\u5019\u4f1a\u8bb0\u5f55key\u4e3apod.name, value\u4e3a\u65f6\u95f4\u6233\u7684\u4e00\u6761entry\u5230map\uff0ccontroller\u518d\u7ed3\u5408map\u7ef4\u62a4\u771f\u5b9e\u7684missingReplicas\u3002\u540c\u7406\u8fd8\u6709\u4e00\u4e2adeletingPods map\u6765\u8bb0\u5f55Pod\u7684delete/eviction\u4e8b\u4ef6\u3002\\n\\n### 4. \u81ea\u9002\u5e94\u8c03\u5ea6\u80fd\u529b\\n\u5728 WorkloadSpread \u4e2d\u652f\u6301\u914d\u7f6e scheduleStrategy\u3002\u9ed8\u8ba4\u60c5\u51b5\u4e0b\uff0ctype \u4e3a Fixed\uff0c\u5373\u56fa\u5b9a\u6309\u7167\u5404\u4e2a subset \u7684\u524d\u540e\u987a\u5e8f\u3001maxReplicas \u9650\u5236\u6765\u5c06 Pod \u8c03\u5ea6\u5230\u5bf9\u5e94\u7684 subset \u4e2d\u3002\\n\u4f46\u771f\u5b9e\u7684\u573a\u666f\u4e0b\uff0c\u5f88\u591a\u65f6\u5019 subset \u5206\u533a\u6216\u62d3\u6251\u7684\u8d44\u6e90\uff0c\u4e0d\u4e00\u5b9a\u80fd\u5b8c\u5168\u6ee1\u8db3 maxReplicas \u6570\u91cf\u3002\u7528\u6237\u9700\u8981\u6309\u7167\u5b9e\u9645\u7684\u8d44\u6e90\u60c5\u51b5\uff0c\u6765\u4e3a Pod \u9009\u62e9\u6709\u8d44\u6e90\u7684\u5206\u533a\u6269\u5bb9\u3002\u8fd9\u5c31\u9700\u8981\u7528 Adaptive \u8fd9\u79cd\u81ea\u9002\u5e94\u7684\u8c03\u5ea6\u5206\u914d\u3002\\n\\nWorkloadSpread \u63d0\u4f9b\u7684 Adaptive \u80fd\u529b\uff0c\u903b\u8f91\u4e0a\u5206\u4e3a\u4e24\u79cd\uff1a\\n1. SimulationSchedule\uff1a\u5728 Kruise webhook \u4e2d\u6839\u636e informer \u91cc\u5df2\u6709\u7684 nodes/pods \u6570\u636e\uff0c\u7ec4\u88c5\u51fa\u8c03\u5ea6\u8d26\u672c\uff0c\u5bf9 Pod \u8fdb\u884c\u6a21\u62df\u8c03\u5ea6\u3002\u5373\u901a\u8fc7 nodeSelector/affinity\u3001tolerations\u3001\u4ee5\u53ca\u57fa\u672c\u7684 resources \u8d44\u6e90\uff0c\u505a\u4e00\u6b21\u7b80\u5355\u7684\u8fc7\u6ee4\u3002\uff08\u5bf9\u4e8e vk \u8fd9\u79cd\u8282\u70b9\u4e0d\u592a\u9002\u7528\uff09\\n2. Reschedule\uff1a\u5728\u5c06 Pod \u8c03\u5ea6\u5230\u4e00\u4e2a subset \u540e\uff0c\u5982\u679c\u8c03\u5ea6\u5931\u8d25\u8d85\u8fc7 rescheduleCriticalSeconds \u65f6\u95f4\uff0c\u5219\u5c06\u8be5 subset \u6682\u65f6\u6807\u8bb0\u4e3a unschedulable\uff0c\u5e76\u5220\u9664 Pod \u89e6\u53d1\u91cd\u5efa\u3002\u9ed8\u8ba4\u60c5\u51b5\u4e0b\uff0cunschedulable \u4f1a\u4fdd\u7559 5min\uff0c\u5373\u5728 5min \u5185\u7684 Pod \u521b\u5efa\u4f1a\u8df3\u8fc7\u8fd9\u4e2a subset\u3002\\n\\n--- \\n\\n## \u5c0f\u7ed3\\nWorkloadSpread\u901a\u8fc7\u7ed3\u5408\u4e00\u4e9bkubernetes\u73b0\u6709\u7684\u7279\u6027\u4ee5\u4e00\u79cd\u65c1\u8def\u7684\u5f62\u5f0f\u8d4b\u4e88workload\u5f39\u6027\u90e8\u7f72\u4e0e\u591a\u57df\u90e8\u7f72\u7684\u80fd\u529b\u3002\u6211\u4eec\u5e0c\u671b\u7528\u6237\u901a\u8fc7\u4f7f\u7528WorkloadSpread\u964d\u4f4eworkload\u90e8\u7f72\u590d\u6742\u5ea6\uff0c\u5229\u7528\u5176\u5f39\u6027\u4f38\u7f29\u80fd\u529b\u5207\u5b9e\u964d\u4f4e\u6210\u672c\u3002\\n\u76ee\u524d\u963f\u91cc\u4e91\u5185\u90e8\u6b63\u5728\u79ef\u6781\u7684\u843d\u5730\uff0c\u843d\u5730\u8fc7\u7a0b\u4e2d\u7684\u8c03\u6574\u4f1a\u53ca\u65f6\u53cd\u9988\u793e\u533a\u3002\u672a\u6765WorkloadSpread\u8fd8\u6709\u4e00\u4e9b\u65b0\u80fd\u529b\u8ba1\u5212\uff0c\u6bd4\u5982\u8ba9WorkloadSpread\u652f\u6301workload\u7684\u5b58\u91cfPod\u63a5\u7ba1\uff0c\u652f\u6301\u6279\u91cf\u7684workload\u7ea6\u675f\uff0c\u751a\u81f3\u662f\u8de8\u8fc7workload\u5c42\u7ea7\u4f7f\u7528label\u6765\u5339\u914dPod\u3002\u5176\u4e2d\u4e00\u4e9b\u80fd\u529b\u9700\u8981\u5b9e\u9645\u8003\u91cf\u793e\u533a\u7528\u6237\u7684\u9700\u6c42\u573a\u666f\u3002\u5e0c\u671b\u5927\u5bb6\u591a\u591a\u53c2\u4e0e\u5230Kruise\u793e\u533a\uff0c\u591a\u63d0issue\u548cpr\uff0c\u5e2e\u52a9\u7528\u6237\u89e3\u51b3\u66f4\u591a\u4e91\u539f\u751f\u90e8\u7f72\u65b9\u9762\u7684\u96be\u9898\uff0c\u6784\u5efa\u4e00\u4e2a\u66f4\u597d\u7684\u793e\u533a\u3002\\n\\n---\\n\\n## \u53c2\u8003\u6587\u732e\\n- WorkloadSpread: https://openkruise.io/docs/user-manuals/workloadspread\\n- Pod Topology Spread Constrains: https://kubernetes.io/docs/concepts/workloads/pods/pod-topology-spread-constraints/\\n- UnitedDeployment: https:/"},{"id":"openkruise-0.10.0","metadata":{"permalink":"/zh/blog/openkruise-0.10.0","editUrl":"https://github.com/openkruise/openkruise.io/edit/master/blog/2021-09-06-release-0.10.0.md","source":"@site/i18n/zh/docusaurus-plugin-content-blog/2021-09-06-release-0.10.0.md","title":"OpenKruise 0.10.0\uff1a\u65b0\u589e\u5e94\u7528\u5f39\u6027\u62d3\u6251\u7ba1\u7406\u3001\u5e94\u7528\u9632\u62a4\u7b49\u80fd\u529b","description":"\u672c\u6587\u5c06\u5e26\u4f60\u4e00\u89c8 v0.10.0 \u7684\u65b0\u53d8\u5316\uff0c\u5176\u4e2d\u65b0\u589e\u7684 WorkloadSpread\u3001PodUnavailableBudget \u7b49\u5927\u9897\u7c92\u7279\u6027\u540e\u7eed\u8fd8\u5c06\u6709\u4e13\u6587\u8be6\u7ec6\u4ecb\u7ecd\u5176\u8bbe\u8ba1\u5b9e\u73b0\u539f\u7406\u3002","date":"2021-09-06T00:00:00.000Z","tags":[{"inline":true,"label":"release","permalink":"/zh/blog/tags/release"}],"readingTime":6.41,"hasTruncateMarker":false,"authors":[{"name":"Siyu Wang","title":"Maintainer of OpenKruise","url":"https://github.com/FillZpp","imageURL":"https://github.com/FillZpp.png","key":"FillZpp","page":null}],"frontMatter":{"slug":"openkruise-0.10.0","title":"OpenKruise 0.10.0\uff1a\u65b0\u589e\u5e94\u7528\u5f39\u6027\u62d3\u6251\u7ba1\u7406\u3001\u5e94\u7528\u9632\u62a4\u7b49\u80fd\u529b","authors":["FillZpp"],"tags":["release"]},"unlisted":false,"prevItem":{"title":"OpenKruise v0.10.0 \u65b0\u7279\u6027WorkloadSpread\u89e3\u8bfb","permalink":"/zh/blog/workloadspread"},"nextItem":{"title":"OpenKruise 0.9.0, SidecarSet Helps Mesh Container Hot Upgrade","permalink":"/zh/blog/sidecarset-hotupdate"}},"content":"\u672c\u6587\u5c06\u5e26\u4f60\u4e00\u89c8 v0.10.0 \u7684\u65b0\u53d8\u5316\uff0c\u5176\u4e2d\u65b0\u589e\u7684 WorkloadSpread\u3001PodUnavailableBudget \u7b49\u5927\u9897\u7c92\u7279\u6027\u540e\u7eed\u8fd8\u5c06\u6709\u4e13\u6587\u8be6\u7ec6\u4ecb\u7ecd\u5176\u8bbe\u8ba1\u5b9e\u73b0\u539f\u7406\u3002\\n\\n## WorkloadSpread\uff1a\u65c1\u8def\u7684\u5e94\u7528\u5f39\u6027\u62d3\u6251\u7ba1\u7406\u80fd\u529b\\n\\n\u5728\u5e94\u7528\u90e8\u7f72\u8fd0\u7ef4\u7684\u573a\u666f\u4e0b\uff0c\u6709\u7740\u591a\u79cd\u591a\u6837\u7684\u62d3\u6251\u6253\u6563\u4ee5\u53ca\u5f39\u6027\u7684\u8bc9\u6c42\u3002\u5176\u4e2d\u6700\u5e38\u89c1\u3001\u6700\u57fa\u672c\u7684\uff0c\u5c31\u662f\u6309\u67d0\u79cd\u6216\u51e0\u79cd\u62d3\u6251\u6c34\u5e73\u6253\u6563\uff0c\u6bd4\u5982\uff1a\\n\\n- \u5e94\u7528\u90e8\u7f72\u9700\u8981\u6309 node \u7ef4\u5ea6\u6253\u6563\uff0c\u907f\u514d\u5806\u53e0\uff08\u63d0\u9ad8\u5bb9\u707e\u80fd\u529b\uff09\\n- \u5e94\u7528\u90e8\u7f72\u9700\u8981\u6309 AZ\uff08available zone\uff09\u7ef4\u5ea6\u6253\u6563\uff08\u63d0\u9ad8\u5bb9\u707e\u80fd\u529b\uff09\\n\\n\u8fd9\u4e9b\u57fa\u672c\u7684\u8bc9\u6c42\uff0c\u901a\u8fc7 Kubernetes \u539f\u751f\u63d0\u4f9b\u7684 pod affinity\u3001[topology spread constraints](https://kubernetes.io/docs/concepts/workloads/pods/pod-topology-spread-constraints/) \u7b49\u80fd\u529b\u76ee\u524d\u90fd\u80fd\u591f\u6ee1\u8db3\u4e86\u3002\u4f46\u5728\u5b9e\u9645\u7684\u751f\u4ea7\u573a\u666f\u4e0b\uff0c\u8fd8\u6709\u7740\u592a\u591a\u66f4\u52a0\u590d\u6742\u7684\u5206\u533a\u4e0e\u5f39\u6027\u9700\u6c42\uff0c\u4ee5\u4e0b\u4e3e\u4e00\u4e9b\u5b9e\u9645\u7684\u4f8b\u5b50\uff1a\\n\\n- \u6309 zone \u6253\u6563\u65f6\uff0c\u9700\u8981\u6307\u5b9a\u5728\u4e0d\u540c zone \u4e2d\u90e8\u7f72\u7684\u6bd4\u4f8b\u6570\uff0c\u6bd4\u5982\u67d0\u4e2a\u5e94\u7528\u5728 zone a\u3001b\u3001c \u4e2d\u90e8\u7f72\u7684 Pod \u6570\u91cf\u6bd4\u4f8b\u4e3a 1 : 1 : 2 \u7b49\uff08\u7531\u4e8e\u4e00\u4e9b\u73b0\u5b9e\u7684\u539f\u56e0\u6bd4\u5982\u8be5\u5e94\u7528\u5728\u591a\u4e2a zone \u4e2d\u7684\u6d41\u91cf\u4e0d\u5747\u8861\u7b49\uff09\\n- \u5b58\u5728\u591a\u4e2a zone \u6216\u4e0d\u540c\u673a\u578b\u7684\u62d3\u6251\uff0c\u5e94\u7528\u6269\u5bb9\u65f6\uff0c\u4f18\u5148\u90e8\u7f72\u5230\u67d0\u4e2a zone \u6216\u673a\u578b\u4e0a\uff0c\u5f53\u8d44\u6e90\u4e0d\u8db3\u65f6\u518d\u90e8\u7f72\u5230\u53e6\u4e00\u4e2a zone \u6216\u673a\u578b\u4e0a\uff08\u5f80\u540e\u4ee5\u6b64\u7c7b\u63a8\uff09\uff1b\u5e94\u7528\u7f29\u5bb9\u65f6\uff0c\u8981\u6309\u53cd\u5411\u987a\u5e8f\uff0c\u4f18\u5148\u7f29\u5bb9\u540e\u9762 zone \u6216\u673a\u578b\u4e0a\u7684 Pod\uff08\u5f80\u524d\u4ee5\u6b64\u7c7b\u63a8\uff09\\n- \u5b58\u5728\u591a\u4e2a\u57fa\u7840\u7684\u8282\u70b9\u6c60\u548c\u5f39\u6027\u7684\u8282\u70b9\u6c60\uff0c\u5e94\u7528\u90e8\u7f72\u65f6\u9700\u8981\u56fa\u5b9a\u6570\u91cf\u6216\u6bd4\u4f8b\u7684 Pod \u90e8\u7f72\u5728\u57fa\u7840\u8282\u70b9\u6c60\uff0c\u5176\u4f59\u7684\u90fd\u6269\u5230\u5f39\u6027\u8282\u70b9\u6c60\\n\\n\u5bf9\u4e8e\u8fd9\u4e9b\u4f8b\u5b50\uff0c\u8fc7\u53bb\u4e00\u822c\u53ea\u80fd\u5c06\u4e00\u4e2a\u5e94\u7528\u62c6\u5206\u4e3a\u591a\u4e2a Workload\uff08\u6bd4\u5982 Deployment\uff09\u6765\u90e8\u7f72\uff0c\u624d\u80fd\u89e3\u51b3\u5e94\u7528\u5728\u4e0d\u540c\u62d3\u6251\u4e0b\u91c7\u7528\u4e0d\u540c\u6bd4\u4f8b\u6570\u91cf\u3001\u6269\u7f29\u5bb9\u4f18\u5148\u7ea7\u3001\u8d44\u6e90\u611f\u77e5\u3001\u5f39\u6027\u9009\u62e9\u7b49\u573a\u666f\u7684\u57fa\u672c\u95ee\u9898\uff0c\u4f46\u8fd8\u662f\u9700\u8981 PaaS \u5c42\u6df1\u5ea6\u5b9a\u5236\u5316\uff0c\u6765\u652f\u6301\u5bf9\u4e00\u4e2a\u5e94\u7528\u591a\u4e2a Workload \u7684\u7cbe\u7ec6\u5316\u7ba1\u7406\u3002\\n\\n\u9488\u5bf9\u8fd9\u4e9b\u95ee\u9898\uff0c\u5728 Kruise v0.10.0 \u7248\u672c\u4e2d\u65b0\u589e\u4e86 WorkloadSpread \u8d44\u6e90\uff0c\u76ee\u524d\u5b83\u652f\u6301\u914d\u5408 Deployment\u3001ReplicaSet\u3001CloneSet \u8fd9\u4e9b Workload \u7c7b\u578b\uff0c\u6765\u7ba1\u7406\u5b83\u4eec\u4e0b\u5c5e Pod \u7684\u5206\u533a\u4e0e\u5f39\u6027\u62d3\u6251\u3002\\n\u4ee5\u4e0b\u662f\u4e00\u4e2a\u7b80\u5316\u7684\u4f8b\u5b50\uff1a\\n\\n```yaml\\napiVersion: apps.kruise.io/v1alpha1\\nkind: WorkloadSpread\\nmetadata:\\n  name: workloadspread-demo\\nspec:\\n  targetRef:\\n    apiVersion: apps/v1 | apps.kruise.io/v1alpha1\\n    kind: Deployment | CloneSet\\n    name: workload-xxx\\n  subsets:\\n  - name: subset-a\\n    requiredNodeSelectorTerm:\\n      matchExpressions:\\n      - key: topology.kubernetes.io/zone\\n        operator: In\\n        values:\\n        - zone-a\\n    maxReplicas: 10 | 30%\\n  - name: subset-b\\n    requiredNodeSelectorTerm:\\n      matchExpressions:\\n      - key: topology.kubernetes.io/zone\\n        operator: In\\n        values:\\n        - zone-b\\n```\\n\\n\u521b\u5efa\u8fd9\u4e2a WorkloadSpread \u53ef\u4ee5\u901a\u8fc7 targetRef \u5173\u8054\u5230\u4e00\u4e2a Workload \u5bf9\u8c61\u4e0a\uff0c\u7136\u540e\u8fd9\u4e2a Workload \u5728\u6269\u5bb9 pod \u7684\u8fc7\u7a0b\u4e2d\uff0cPod \u4f1a\u88ab Kruise \u6309\u4e0a\u8ff0\u7b56\u7565\u6ce8\u5165\u5bf9\u5e94\u7684\u62d3\u6251\u89c4\u5219\u3002\u8fd9\u662f\u4e00\u79cd\u65c1\u8def\u7684\u6ce8\u5165\u548c\u7ba1\u7406\u65b9\u5f0f\uff0c\u672c\u8eab\u4e0d\u4f1a\u5e72\u6d89 Workload \u5bf9 Pod \u7684\u6269\u7f29\u5bb9\u3001\u53d1\u5e03\u7ba1\u7406\u3002\\n\\n\u6ce8\u610f\uff1aWorkloadSpread \u5bf9 Pod \u7684\u7f29\u5bb9\u7684\u4f18\u5148\u7ea7\u63a7\u5236\u662f\u901a\u8fc7 [Pod Deletion Cost](https://kubernetes.io/docs/reference/labels-annotations-taints/#pod-deletion-cost) \u6765\u5b9e\u73b0\u7684\uff1a\\n\\n- \u5982\u679c Workload \u7c7b\u578b\u662f CloneSet\uff0c\u5219\u5df2\u7ecf\u652f\u6301\u4e86\u8fd9\u4e2a feature\uff0c\u53ef\u4ee5\u5b9e\u73b0\u7f29\u5bb9\u4f18\u5148\u7ea7\\n- \u5982\u679c Workload \u7c7b\u578b\u662f Deployment/ReplicaSet\uff0c\u5219\u8981\u6c42 Kubernetes version >= 1.21\uff0c\u4e14\u5728 1.21 \u4e2d\u8981\u5728 kube-controller-manager \u4e0a\u5f00\u542f `PodDeletionCost` \u8fd9\u4e2a feature-gate\\n\\n\u4f7f\u7528 WorkloadSpread \u529f\u80fd\uff0c\u9700\u8981\u5728 \u5b89\u88c5/\u5347\u7ea7 Kruise v0.10.0 \u7684\u65f6\u5019\u6253\u5f00 WorkloadSpread \u8fd9\u4e2a feature-gate\u3002\\n\\n## PodUnavailableBudget\uff1a\u5e94\u7528\u53ef\u7528\u6027\u9632\u62a4\\n\\n\u5728\u8bf8\u591a [Voluntary Disruption](https://kubernetes.io/docs/concepts/workloads/pods/disruptions/) \u573a\u666f\u4e2d Kubernetes \u539f\u751f\u63d0\u4f9b\u7684 [Pod Disruption Budget\uff08PDB\uff09](https://kubernetes.io/docs/tasks/run-application/configure-pdb/) \u901a\u8fc7\u9650\u5236\u540c\u65f6\u4e2d\u65ad\u7684 Pod \u6570\u91cf\uff0c\u6765\u4fdd\u8bc1\u5e94\u7528\u7684\u9ad8\u53ef\u7528\u6027\u3002\\n\\n\u4f46\u8fd8\u6709\u5f88\u591a\u573a\u666f\u4e2d\uff0c\u5373\u4fbf\u6709 PDB \u9632\u62a4\u4f9d\u7136\u5c06\u4f1a\u5bfc\u81f4\u4e1a\u52a1\u4e2d\u65ad\u3001\u670d\u52a1\u964d\u7ea7\uff0c\u6bd4\u5982\uff1a\\n\\n- \u5e94\u7528 owner \u901a\u8fc7 Deployment \u6b63\u5728\u8fdb\u884c\u7248\u672c\u5347\u7ea7\uff0c\u4e0e\u6b64\u540c\u65f6\u96c6\u7fa4\u7ba1\u7406\u5458\u7531\u4e8e\u673a\u5668\u8d44\u6e90\u5229\u7528\u7387\u8fc7\u4f4e\u6b63\u5728\u8fdb\u884c node \u7f29\u5bb9\\n- \u4e2d\u95f4\u4ef6\u56e2\u961f\u5229\u7528 SidecarSet \u6b63\u5728\u539f\u5730\u5347\u7ea7\u96c6\u7fa4\u4e2d\u7684sidecar\u7248\u672c\uff08\u4f8b\u5982\uff1aServiceMesh envoy\uff09\uff0c\u540c\u65f6HPA\u6b63\u5728\u5bf9\u540c\u4e00\u6279\u5e94\u7528\u8fdb\u884c\u7f29\u5bb9\\n- \u5e94\u7528 owner \u548c\u4e2d\u95f4\u4ef6\u56e2\u961f\u5229\u7528 CloneSet\u3001SidecarSet \u539f\u5730\u5347\u7ea7\u7684\u80fd\u529b\uff0c\u6b63\u5728\u5bf9\u540c\u4e00\u6279 Pod \u8fdb\u884c\u5347\u7ea7\\n\\n\u8fd9\u5176\u5b9e\u5f88\u597d\u7406\u89e3 -- PDB \u53ea\u80fd\u9632\u63a7\u901a\u8fc7 Eviction API \u6765\u89e6\u53d1\u7684 Pod \u9a71\u9010\uff08\u4f8b\u5982 kubectl drain\u9a71\u9010node\u4e0a\u9762\u7684\u6240\u6709Pod\uff09\uff0c\u4f46\u662f\u5bf9\u4e8e Pod \u5220\u9664\u3001\u539f\u5730\u5347\u7ea7 \u7b49\u5f88\u591a\u64cd\u4f5c\u662f\u65e0\u6cd5\u9632\u62a4\u7684\u3002\\n\\n\u5728 Kruise v0.10.0 \u7248\u672c\u4e2d\u65b0\u589e\u7684 PodUnavailableBudget\uff08PUB\uff09\u529f\u80fd\uff0c\u5219\u662f\u5bf9\u539f\u751f PDB \u7684\u5f3a\u5316\u6269\u5c55\u3002\u5b83\u5305\u542b\u4e86 PDB \u81ea\u8eab\u7684\u80fd\u529b\uff0c\u5e76\u5728\u6b64\u57fa\u7840\u4e0a\u589e\u52a0\u4e86\u5bf9\u66f4\u591a Voluntary Disruption \u64cd\u4f5c\u7684\u9632\u62a4\uff0c\u5305\u62ec\u4f46\u4e0d\u9650\u4e8e Pod \u5220\u9664\u3001\u539f\u5730\u5347\u7ea7 \u7b49\u3002\\n\\n```yaml\\napiVersion: apps.kruise.io/v1alpha1\\nkind: PodUnavailableBudget\\nmetadata:\\n  name: web-server-pub\\n  namespace: web\\nspec:\\n  targetRef:\\n    apiVersion: apps/v1 | apps.kruise.io/v1alpha1\\n    kind: Deployment | CloneSet | StatefulSet | ...\\n    name: web-server\\n  # selector \u4e0e targetRef \u4e8c\u9009\u4e00\u914d\u7f6e\\n# selector:\\n#   matchLabels:\\n#     app: web-server\\n  # \u4fdd\u8bc1\u7684\u6700\u5927\u4e0d\u53ef\u7528\u6570\u91cf\\n  maxUnavailable: 60%\\n  # \u4fdd\u8bc1\u7684\u6700\u5c0f\u53ef\u7528\u6570\u91cf\\n# minAvailable: 40%\\n```\\n\\n\u4f7f\u7528 PodUnavailableBudget \u529f\u80fd\uff0c\u9700\u8981\u5728 \u5b89\u88c5/\u5347\u7ea7 Kruise v0.10.0 \u7684\u65f6\u5019\u6253\u5f00feature-gate\uff08\u4e24\u4e2a\u53ef\u4ee5\u9009\u62e9\u6253\u5f00\u4e00\u4e2a\uff0c\u4e5f\u53ef\u4ee5\u90fd\u6253\u5f00\uff09\uff1a\\n\\n- PodUnavailableBudgetDeleteGate\uff1a\u62e6\u622a\u9632\u62a4 Pod \u5220\u9664\u3001\u9a71\u9010 \u7b49\u64cd\u4f5c\\n- PodUnavailableBudgetUpdateGate\uff1a\u62e6\u622a\u9632\u62a4 Pod \u539f\u5730\u5347\u7ea7 \u7b49\u66f4\u65b0\u64cd\u4f5c\\n\\n## CloneSet \u652f\u6301\u6309\u62d3\u6251\u89c4\u5219\u7f29\u5bb9\\n\\n\u5728 CloneSet \u7f29\u5bb9\uff08\u8c03\u5c0f replicas \u6570\u91cf\uff09\u7684\u65f6\u5019\uff0c\u9009\u62e9\u54ea\u4e9b Pod \u5220\u9664\u662f\u6709\u4e00\u5957\u56fa\u5b9a\u7b97\u6cd5\u6392\u5e8f\u7684\uff1a\\n\\n1. \u672a\u8c03\u5ea6 < \u5df2\u8c03\u5ea6\\n2. PodPending < PodUnknown < PodRunning\\n3. Not ready < ready\\n4. **\u8f83\u5c0f pod-deletion cost < \u8f83\u5927 pod-deletion cost**\\n5. **\u8f83\u5927\u6253\u6563\u6743\u91cd < \u8f83\u5c0f**\\n6. \u5904\u4e8e Ready \u65f6\u95f4\u8f83\u77ed < \u8f83\u957f\\n7. \u5bb9\u5668\u91cd\u542f\u6b21\u6570\u8f83\u591a < \u8f83\u5c11\\n8. \u521b\u5efa\u65f6\u95f4\u8f83\u77ed < \u8f83\u957f\\n\\n\u5176\u4e2d\uff0c\u201c4\u201d \u662f\u5728 Kruise v0.9.0 \u4e2d\u5f00\u59cb\u63d0\u4f9b\u7684\u7279\u6027\uff0c\u7528\u4e8e\u652f\u6301\u7528\u6237\u6307\u5b9a\u5220\u9664\u987a\u5e8f\uff08WorkloadSpread \u5c31\u662f\u5229\u7528\u8fd9\u4e2a\u529f\u80fd\u5b9e\u73b0\u7f29\u5bb9\u4f18\u5148\u7ea7\uff09\uff1b**\u800c \u201c5\u201d \u5219\u662f\u5f53\u524d v0.10.0 \u63d0\u4f9b\u7684\u7279\u6027\uff0c\u5373\u5728\u7f29\u5bb9\u7684\u65f6\u5019\u4f1a\u53c2\u8003\u5e94\u7528\u7684\u62d3\u6251\u6253\u6563\u6765\u6392\u5e8f**\u3002\\n\\n- \u5982\u679c\u5e94\u7528\u914d\u7f6e\u4e86 [topology spread constraints](https://kubernetes.io/docs/concepts/workloads/pods/pod-topology-spread-constraints/)\uff0c\u5219 CloneSet \u7f29\u5bb9\u65f6\u4f1a\u6309\u7167\u5176\u4e2d\u7684 topology \u7ef4\u5ea6\u6253\u6563\u6765\u9009\u62e9 Pod \u5220\u9664\uff08\u6bd4\u5982\u5c3d\u91cf\u6253\u5e73\u591a\u4e2a zone \u4e0a\u90e8\u7f72 Pod \u7684\u6570\u91cf\uff09\\n- \u5982\u679c\u5e94\u7528\u6ca1\u6709\u914d\u7f6e [topology spread constraints](https://kubernetes.io/docs/concepts/workloads/pods/pod-topology-spread-constraints/)\uff0c\u5219\u9ed8\u8ba4\u60c5\u51b5\u4e0b CloneSet \u7f29\u5bb9\u65f6\u4f1a\u6309\u7167 node \u8282\u70b9\u7ef4\u5ea6\u6253\u6563\u6765\u9009\u62e9 Pod \u5220\u9664\uff08\u5c3d\u91cf\u51cf\u5c11\u540c node \u4e0a\u7684\u5806\u53e0\u6570\u91cf\uff09\\n\\n## Advanced StatefulSet \u652f\u6301\u6d41\u5f0f\u6269\u5bb9\\n\\n\u4e3a\u4e86\u907f\u514d\u5728\u4e00\u4e2a\u65b0 Advanced StatefulSet \u521b\u5efa\u540e\u6709\u5927\u91cf\u5931\u8d25\u7684 pod \u88ab\u521b\u5efa\u51fa\u6765\uff0c\u4ece Kruise v0.10.0 \u7248\u672c\u5f00\u59cb\u5f15\u5165\u4e86\u5728 scale strategy \u4e2d\u7684 maxUnavailable \u7b56\u7565\uff1a\\n\\n```yaml\\napiVersion: apps.kruise.io/v1beta1\\nkind: StatefulSet\\nspec:\\n  # ...\\n  replicas: 100\\n  scaleStrategy:\\n    maxUnavailable: 10% # percentage or absolute number\\n```\\n\\n\u5f53\u8fd9\u4e2a\u5b57\u6bb5\u88ab\u8bbe\u7f6e\u4e4b\u540e\uff0cAdvanced StatefulSet \u4f1a\u4fdd\u8bc1\u521b\u5efa pod \u4e4b\u540e\u4e0d\u53ef\u7528 pod \u6570\u91cf\u4e0d\u8d85\u8fc7\u8fd9\u4e2a\u9650\u5236\u503c\u3002\\n\u6bd4\u5982\u8bf4\uff0c\u4e0a\u9762\u8fd9\u4e2a StatefulSet \u4e00\u5f00\u59cb\u53ea\u4f1a\u4e00\u6b21\u6027\u521b\u5efa 10 \u4e2a pod\u3002\u5728\u6b64\u4e4b\u540e\uff0c\u6bcf\u5f53\u4e00\u4e2a pod \u53d8\u4e3a running\u3001ready \u72b6\u6001\u540e\uff0c\u624d\u4f1a\u518d\u521b\u5efa\u4e00\u4e2a\u65b0 pod \u51fa\u6765\u3002\\n\\n\u6ce8\u610f\uff1a\u8fd9\u4e2a\u529f\u80fd\u53ea\u5141\u8bb8\u5728 podManagementPolicy \u662f `Parallel` \u7684 StatefulSet \u4e2d\u4f7f\u7528\u3002\\n\\n## More\\n\\n\u66f4\u591a\u7248\u672c\u53d8\u5316\uff0c\u8bf7\u53c2\u8003 [release page](https://github.com/openkruise/kruise/releases) \u6216 [ChangeLog](https://github.com/openkruise/kruise/blob/master/CHANGELOG.md)"},{"id":"sidecarset-hotupdate","metadata":{"permalink":"/zh/blog/sidecarset-hotupdate","editUrl":"https://github.com/openkruise/openkruise.io/edit/master/blog/2021-06-10-sidecarset-hot-update-0.9.0.md","source":"@site/i18n/zh/docusaurus-plugin-content-blog/2021-06-10-sidecarset-hot-update-0.9.0.md","title":"OpenKruise 0.9.0, SidecarSet Helps Mesh Container Hot Upgrade","description":"OpenKruise \u662f\u963f\u91cc\u4e91\u5f00\u6e90\u7684\u4e91\u539f\u751f\u5e94\u7528\u81ea\u52a8\u5316\u7ba1\u7406\u5957\u4ef6\uff0c\u4e5f\u662f\u5f53\u524d\u6258\u7ba1\u5728 Cloud Native Computing Foundation (CNCF) \u4e0b\u7684Sandbox\u9879\u76ee\u3002\u5b83\u6765\u81ea\u963f\u91cc\u5df4\u5df4\u591a\u5e74\u6765\u5bb9\u5668\u5316\u3001\u4e91\u539f\u751f\u7684\u6280\u672f\u6c89\u6dc0\uff0c\u662f\u963f\u91cc\u5185\u90e8\u751f\u4ea7\u73af\u5883\u5927\u89c4\u6a21\u5e94\u7528\u7684\u57fa\u4e8eKubernetes\u4e4b\u4e0a\u7684\u6807\u51c6\u6269\u5c55\u7ec4\u4ef6\uff0c\u4e5f\u662f\u7d27\u8d34\u4e0a\u6e38\u793e\u533a\u6807\u51c6\u3001\u9002\u5e94\u4e92\u8054\u7f51\u89c4\u6a21\u5316\u573a\u666f\u7684\u6280\u672f\u7406\u5ff5\u4e0e\u6700\u4f73\u5b9e\u8df5\u3002","date":"2021-06-10T00:00:00.000Z","tags":[{"inline":true,"label":"workload","permalink":"/zh/blog/tags/workload"},{"inline":true,"label":"sidecar","permalink":"/zh/blog/tags/sidecar"},{"inline":true,"label":"istio","permalink":"/zh/blog/tags/istio"},{"inline":true,"label":"mosn","permalink":"/zh/blog/tags/mosn"},{"inline":true,"label":"HotUpgrade","permalink":"/zh/blog/tags/hot-upgrade"}],"readingTime":7.55,"hasTruncateMarker":false,"authors":[{"name":"Mingshan Zhao","title":"Member of OpenKruise","url":"https://github.com/zmberg","imageURL":"https://github.com/zmberg.png","key":"zmberg","page":null}],"frontMatter":{"slug":"sidecarset-hotupdate","title":"OpenKruise 0.9.0, SidecarSet Helps Mesh Container Hot Upgrade","authors":["zmberg"],"tags":["workload","sidecar","istio","mosn","HotUpgrade"]},"unlisted":false,"prevItem":{"title":"OpenKruise 0.10.0\uff1a\u65b0\u589e\u5e94\u7528\u5f39\u6027\u62d3\u6251\u7ba1\u7406\u3001\u5e94\u7528\u9632\u62a4\u7b49\u80fd\u529b","permalink":"/zh/blog/openkruise-0.10.0"},"nextItem":{"title":"OpenKruise 0.9.0\uff1a\u65b0\u589ePod\u5bb9\u5668\u91cd\u542f\u3001\u8d44\u6e90\u5220\u9664\u9632\u62a4\u7b49\u529f\u80fd","permalink":"/zh/blog/openkruise-0.9.0"}},"content":"OpenKruise \u662f\u963f\u91cc\u4e91\u5f00\u6e90\u7684\u4e91\u539f\u751f\u5e94\u7528\u81ea\u52a8\u5316\u7ba1\u7406\u5957\u4ef6\uff0c\u4e5f\u662f\u5f53\u524d\u6258\u7ba1\u5728 Cloud Native Computing Foundation (CNCF) \u4e0b\u7684Sandbox\u9879\u76ee\u3002\u5b83\u6765\u81ea\u963f\u91cc\u5df4\u5df4\u591a\u5e74\u6765\u5bb9\u5668\u5316\u3001\u4e91\u539f\u751f\u7684\u6280\u672f\u6c89\u6dc0\uff0c\u662f\u963f\u91cc\u5185\u90e8\u751f\u4ea7\u73af\u5883\u5927\u89c4\u6a21\u5e94\u7528\u7684\u57fa\u4e8eKubernetes\u4e4b\u4e0a\u7684\u6807\u51c6\u6269\u5c55\u7ec4\u4ef6\uff0c\u4e5f\u662f\u7d27\u8d34\u4e0a\u6e38\u793e\u533a\u6807\u51c6\u3001\u9002\u5e94\u4e92\u8054\u7f51\u89c4\u6a21\u5316\u573a\u666f\u7684\u6280\u672f\u7406\u5ff5\u4e0e\u6700\u4f73\u5b9e\u8df5\u3002\\n\\nOpenKruise\u57282021.5.20\u53d1\u5e03\u4e86\u6700\u65b0\u7684v0.9.0\u7248\u672c\uff0c\u5176\u4e2dsidecarSet\u57fa\u4e8e\u4e0a\u4e00\u4e2a\u7248\u672c\u6269\u5c55\u4e86\u7279\u522b\u9488\u5bf9Service Mesh\u573a\u666f\u7684\u652f\u6301\u3002\\n\\n# \u80cc\u666f - \u5982\u4f55\u72ec\u7acb\u5347\u7ea7Mesh\u5bb9\u5668\\nSidecarSet \u662f Kruise \u63d0\u4f9b\u7684\u72ec\u7acb\u7ba1\u7406 sidecar \u5bb9\u5668\u7684 workload\u3002\u7528\u6237\u901a\u8fc7 SidecarSet \u80fd\u591f\u4fbf\u5229\u7684\u5b8c\u6210\u5bf9Sidecar\u5bb9\u5668\u7684\u81ea\u52a8\u6ce8\u5165\u548c\u72ec\u7acb\u5347\u7ea7\u3002\\n\\n\u9ed8\u8ba4\u60c5\u51b5\u4e0b\uff0csidecar \u7684\u72ec\u7acb\u5347\u7ea7\u987a\u5e8f\u662f\u5148\u505c\u6b62\u65e7\u7248\u672c\u7684\u5bb9\u5668\uff0c\u7136\u540e\u518d\u521b\u5efa\u65b0\u7248\u672c\u7684\u5bb9\u5668\u3002\u8fd9\u79cd\u65b9\u5f0f\u5c24\u5176\u9002\u5408\u4e0d\u5f71\u54cdPod\u670d\u52a1\u53ef\u7528\u6027\u7684sidecar\u5bb9\u5668\uff0c\u4f8b\u5982\u65e5\u5fd7\u6536\u96c6 agent\uff0c\u4f46\u662f\u5bf9\u4e8e\u5f88\u591a\u4ee3\u7406\u6216\u8fd0\u884c\u65f6\u7684 sidecar \u5bb9\u5668\uff0c\u5982 Istio Envoy\uff0c\u8fd9\u79cd\u5347\u7ea7\u65b9\u6cd5\u5c31\u6709\u95ee\u9898\u4e86\u3002Envoy \u4f5c\u4e3a Pod \u4e2d\u7684\u4e00\u4e2aProxy\u5bb9\u5668\u4ee3\u7406\u4e86\u6240\u6709\u7684\u6d41\u91cf\uff0c\u8fd9\u79cd\u573a\u666f\u4e0b\u5982\u679c\u76f4\u63a5\u91cd\u542f\u5347\u7ea7\uff0cPod\u670d\u52a1\u7684\u53ef\u7528\u6027\u5fc5\u7136\u4f1a\u53d7\u5230\u5f71\u54cd\uff0c\u56e0\u6b64\u9700\u8981\u8003\u8651\u5e94\u7528\u81ea\u8eab\u7684\u53d1\u5e03\u548c\u5bb9\u91cf\u60c5\u51b5\uff0c\u65e0\u6cd5\u5b8c\u5168\u72ec\u7acb\u4e8e\u5e94\u7528\u505asidecar\u7684\u53d1\u5e03\u3002\\n\\n![how update mesh sidecar](../../../static/img/blog/2021-06-10-sidecarset-hot-update/how_update_mesh.png)\\n\\n\u963f\u91cc\u5df4\u5df4\u96c6\u56e2\u5185\u90e8\u62e5\u6709\u4e0a\u4e07\u7684Pod\u90fd\u662f\u57fa\u4e8eService Mesh\u6765\u5b9e\u73b0\u76f8\u4e92\u95f4\u7684\u901a\u4fe1\uff0c\u7531\u4e8emesh\u5bb9\u5668\u5347\u7ea7\u4f1a\u5bfc\u81f4\u4e1a\u52a1pod\u7684\u4e0d\u53ef\u7528\uff0c\u56e0\u800cmesh\u5bb9\u5668\u7684\u5347\u7ea7\u5c06\u4f1a\u6781\u5927\u963b\u788dService Mesh\u7684\u8fed\u4ee3\u3002\u9488\u5bf9\u8fd9\u79cd\u573a\u666f\uff0c\u6211\u4eec\u540c\u96c6\u56e2\u5185\u90e8\u7684Service Mesh\u56e2\u961f\u4e00\u8d77\u5408\u4f5c\u5b9e\u73b0\u4e86mesh\u5bb9\u5668\u7684\u70ed\u5347\u7ea7\u80fd\u529b\u3002\u672c\u6587\u5c06\u91cd\u70b9\u4ecb\u7ecd\u5728\u5b9e\u73b0mesh\u5bb9\u5668\u70ed\u5347\u7ea7\u80fd\u529b\u7684\u8fc7\u7a0b\u4e2dSidecarSet\u662f\u626e\u6f14\u4e86\u600e\u6837\u7684\u91cd\u8981\u89d2\u8272\u3002\\n\\n# SidecarSet\u52a9\u529bMesh\u5bb9\u5668\u65e0\u635f\u70ed\u5347\u7ea7\\nMesh\u5bb9\u5668\u4e0d\u80fd\u50cf\u65e5\u5fd7\u91c7\u96c6\u7c7b\u5bb9\u5668\u76f4\u63a5\u539f\u5730\u5347\u7ea7\uff0c\u5176\u539f\u56e0\u5728\u4e8e\uff1amesh\u5bb9\u5668\u5fc5\u987b\u8981\u4e0d\u95f4\u65ad\u5730\u5bf9\u5916\u63d0\u4f9b\u670d\u52a1\uff0c\u800c\u72ec\u7acb\u5347\u7ea7\u65b9\u5f0f\u4f1a\u5bfc\u81f4mesh\u670d\u52a1\u5b58\u5728\u4e00\u6bb5\u4e0d\u53ef\u7528\u65f6\u95f4\u3002\u867d\u7136\u793e\u533a\u4e2d\u5df2\u6709\u4e00\u4e9b\u77e5\u540d\u7684mesh\u670d\u52a1\u5982Envoy\u3001Mosn\u7b49\u9ed8\u8ba4\u80fd\u591f\u63d0\u4f9b\u5e73\u6ed1\u5347\u7ea7\u7684\u80fd\u529b\uff0c\u4f46\u662f\u8fd9\u4e9b\u5347\u7ea7\u65b9\u5f0f\u65e0\u6cd5\u4e0e\u4e91\u539f\u751f\u8fdb\u884c\u6070\u5f53\u5730\u7ed3\u5408\uff0c\u4e14kubernetes\u672c\u8eab\u4e5f\u7f3a\u4e4f\u5bf9\u6b64\u7c7bsidecar\u5bb9\u5668\u7684\u5347\u7ea7\u65b9\u6848\u3002\\n\\nOpenKruise SidecarSet\u4e3a\u6b64\u7c7bmesh\u5bb9\u5668\u63d0\u4f9b\u4e86sidecar\u70ed\u5347\u7ea7\u673a\u5236\uff0c\u80fd\u591f\u901a\u8fc7\u4e91\u539f\u751f\u7684\u65b9\u5f0f\u52a9\u529bMesh\u5bb9\u5668\u5b9e\u73b0\u65e0\u635f\u70ed\u5347\u7ea7\u3002\\n```yaml\\napiVersion: apps.kruise.io/v1alpha1\\nkind: SidecarSet\\nmetadata:\\n  name: hotupgrade-sidecarset\\nspec:\\n  selector:\\n    matchLabels:\\n      app: hotupgrade\\n  containers:\\n  - name: sidecar\\n    image: openkruise/hotupgrade-sample:sidecarv1\\n    imagePullPolicy: Always\\n    lifecycle:\\n      postStart:\\n        exec:\\n          command:\\n          - /bin/sh\\n          - /migrate.sh\\n    upgradeStrategy:\\n      upgradeType: HotUpgrade\\n      hotUpgradeEmptyImage: openkruise/hotupgrade-sample:empty\\n```\\n- upgradeType: HotUpgrade\u4ee3\u8868\u8be5sidecar\u5bb9\u5668\u7684\u7c7b\u578b\u662fhot upgrade\uff0c\u5373\u70ed\u5347\u7ea7\u65b9\u6848\\n- hotUpgradeEmptyImage: \u5f53\u70ed\u5347\u7ea7sidecar\u5bb9\u5668\u65f6\uff0c\u4e1a\u52a1\u987b\u8981\u63d0\u4f9b\u4e00\u4e2aempty\u5bb9\u5668\u7528\u4e8e\u70ed\u5347\u7ea7\u8fc7\u7a0b\u4e2d\u7684\u5bb9\u5668\u5207\u6362\u3002Empty\u5bb9\u5668\u540csidecar\u5bb9\u5668\u5177\u6709\u76f8\u540c\u7684\u914d\u7f6e\uff08\u955c\u50cf\u5730\u5740\u9664\u5916\uff09\uff0c\u4f8b\u5982command, lifecycle, probe\u7b49\u3002\\n\\nSidecarSet\u70ed\u5347\u7ea7\u673a\u5236\u4e3b\u8981\u5305\u542b\u6ce8\u5165\u70ed\u5347\u7ea7Sidecar\u5bb9\u5668\u548cMesh\u5bb9\u5668\u5e73\u6ed1\u5347\u7ea7\u4e24\u4e2a\u8fc7\u7a0b\u3002\\n\\n## \u6ce8\u5165\u70ed\u5347\u7ea7Sidecar\u5bb9\u5668\\n\u9488\u5bf9\u70ed\u5347\u7ea7\u7c7b\u578b\u7684Sidecar\u5bb9\u5668\uff0c\u5728Pod\u521b\u5efa\u65f6SidecarSet Webhook\u5c06\u4f1a\u6ce8\u5165\u4e24\u4e2a\u5bb9\u5668\uff1a\\n- \\\\{sidecar.name\\\\}-1: \u5982\u4e0b\u56fe\u6240\u793a envoy-1\uff0c\u8fd9\u4e2a\u5bb9\u5668\u4ee3\u8868\u6b63\u5728\u5b9e\u9645\u5de5\u4f5c\u7684sidecar\u5bb9\u5668\uff0c\u4f8b\u5982\uff1aenvoy:1.16.0\\n- \\\\{sidecar.name\\\\}-2: \u5982\u4e0b\u56fe\u6240\u793a envoy-2\uff0c\u8fd9\u4e2a\u5bb9\u5668\u662f\u4e1a\u52a1\u63d0\u4f9b\u7684hotUpgradeEmptyImage\u5bb9\u5668\uff0c\u4f8b\u5982\uff1aempty:1.0\\n\\n![inject sidecar](../../../static/img/blog/2021-06-10-sidecarset-hot-update/inject_sidecar.png)\\n\\n\u4e0a\u8ff0Empty\u5bb9\u5668\u5728Mesh\u5bb9\u5668\u8fd0\u884c\u8fc7\u7a0b\u4e2d\uff0c\u5e76\u6ca1\u6709\u505a\u4efb\u4f55\u5b9e\u9645\u7684\u5de5\u4f5c\u3002\\n\\n## Mesh\u5bb9\u5668\u5e73\u6ed1\u5347\u7ea7\\n\u70ed\u5347\u7ea7\u6d41\u7a0b\u4e3b\u8981\u5206\u4e3a\u4e00\u4e0b\u4e09\u4e2a\u6b65\u9aa4\uff1a\\n1. Upgrade: \u5c06Empty\u5bb9\u5668\u66ff\u6362\u4e3a\u6700\u65b0\u7248\u672c\u7684sidecar\u5bb9\u5668\uff0c\u4f8b\u5982\uff1aenvoy-2.Image = envoy:1.17.0\\n2. Migration: \u6267\u884csidecar\u5bb9\u5668\u7684PostStartHook\u811a\u672c\uff0c\u5b8c\u6210mesh\u670d\u52a1\u7684\u5e73\u6ed1\u5347\u7ea7\\n3. Reset: mesh\u670d\u52a1\u5e73\u6ed1\u5347\u7ea7\u540e\uff0c\u5c06\u8001\u7248\u672csidecar\u5bb9\u5668\u66ff\u6362\u4e3aEmpty\u5bb9\u5668\uff0c\u4f8b\u5982\uff1aenvoy-1.Image = empty:1.0\\n\\n![update sidecar](../../../static/img/blog/2021-06-10-sidecarset-hot-update/update_sidecar.png)\\n\\n\u4ec5\u9700\u4e0a\u8ff0\u4e09\u4e2a\u6b65\u9aa4\u5373\u53ef\u5b8c\u6210\u70ed\u5347\u7ea7\u4e2d\u7684\u5168\u90e8\u6d41\u7a0b\uff0c\u82e5\u5bf9Pod\u6267\u884c\u591a\u6b21\u70ed\u5347\u7ea7\uff0c\u5219\u91cd\u590d\u6267\u884c\u4e0a\u8ff0\u4e09\u4e2a\u6b65\u9aa4\u5373\u53ef\u3002\\n\\n## Migration\u6838\u5fc3\u903b\u8f91\\nSidecarSet\u70ed\u5347\u7ea7\u673a\u5236\u4e0d\u4ec5\u5b8c\u6210\u4e86mesh\u5bb9\u5668\u7684\u5207\u6362\uff0c\u5e76\u4e14\u63d0\u4f9b\u4e86\u65b0\u8001\u7248\u672c\u7684\u534f\u8c03\u673a\u5236\uff08PostStartHook\uff09\uff0c\u4f46\u662f\u81f3\u6b64\u8fd8\u53ea\u662f\u4e07\u91cc\u957f\u5f81\u7684\u7b2c\u4e00\u6b65\uff0cMesh\u5bb9\u5668\u540c\u65f6\u8fd8\u9700\u8981\u63d0\u4f9bPostSartHook\u811a\u672c\u6765\u5b8c\u6210mesh\u670d\u52a1\u81ea\u8eab\u7684\u5e73\u6ed1\u5347\u7ea7\uff08\u4e0a\u8ff0Migration\u8fc7\u7a0b\uff09\uff0c\u5982\uff1aEnvoy\u70ed\u91cd\u542f\u3001Mosn\u65e0\u635f\u91cd\u542f\u3002\\n\\nmesh\u5bb9\u5668\u4e00\u822c\u90fd\u662f\u901a\u8fc7\u76d1\u542c\u56fa\u5b9a\u7aef\u53e3\u6765\u5bf9\u5916\u63d0\u4f9b\u670d\u52a1\uff0c\u6b64\u7c7bmesh\u5bb9\u5668\u7684migration\u8fc7\u7a0b\u53ef\u4ee5\u6982\u62ec\u4e3a\uff1a\u901a\u8fc7UDS\u4f20\u9012ListenFD\u548c\u505c\u6b62Accpet\u3001\u5f00\u59cb\u6392\u6c34\u3002\u9488\u5bf9\u4e0d\u652f\u6301\u70ed\u91cd\u542f\u7684mesh\u5bb9\u5668\u53ef\u4ee5\u53c2\u8003\u6b64\u8fc7\u7a0b\u5b8c\u6210\u6539\u9020\uff0c\u903b\u8f91\u56fe\u5982\u4e0b\uff1a\\n\\n![migration](../../../static/img/blog/2021-06-10-sidecarset-hot-update/migration.png)\\n\\n## Migration Demo\\n\u4e0d\u540cmesh\u5bb9\u5668\u5bf9\u5916\u63d0\u4f9b\u7684\u670d\u52a1\u4ee5\u53ca\u5185\u90e8\u5b9e\u73b0\u903b\u8f91\u5404\u6709\u5dee\u5f02\uff0c\u8fdb\u800c\u5177\u4f53\u7684Migration\u4e5f\u6709\u6240\u4e0d\u540c\uff0c\u4e0a\u8ff0\u903b\u8f91\u53ea\u662f\u5bf9\u5176\u4e2d\u4e00\u4e9b\u8981\u70b9\u505a\u4e86\u4e00\u4e9b\u603b\u7ed3\uff0c\u5e0c\u671b\u80fd\u5bf9\u6709\u9700\u8981\u7684\u5404\u4f4d\u6709\u6240\u88e8\u76ca\uff0c\u540c\u65f6\u5728github\u4e0a\u9762\u6211\u4eec\u4e5f\u63d0\u4f9b\u4e86\u4e00\u4e2a\u70ed\u5347\u7ea7Migration Demo\u4ee5\u4f9b\u53c2\u8003\uff0c\u4e0b\u9762\u5c06\u5bf9\u5176\u4e2d\u7684\u4e00\u4e9b\u5173\u952e\u4ee3\u7801\u8fdb\u884c\u4ecb\u7ecd\u3002\\n\\n1. \u534f\u5546\u673a\u5236\\nMesh\u5bb9\u5668\u542f\u52a8\u903b\u8f91\u9996\u5148\u5c31\u9700\u8981\u5224\u65ad\u7b2c\u4e00\u6b21\u542f\u52a8\u8fd8\u662f\u70ed\u5347\u7ea7\u5e73\u6ed1\u8fc1\u79fb\u8fc7\u7a0b\uff0c\u4e3a\u4e86\u51cf\u5c11mesh\u5bb9\u5668\u6c9f\u901a\u6210\u672c\uff0cKruise\u5728\u4e24\u4e2asidecar\u5bb9\u5668\u4e2d\u6ce8\u5165\u4e86\u4e24\u4e2a\u73af\u5883\u53d8\u91cfSIDECARSET_VERSION\u548cSIDECARSET_VERSION_ALT\uff0c\u901a\u8fc7\u5224\u65ad\u4e24\u4e2a\u73af\u5883\u53d8\u91cf\u7684\u503c\u6765\u5224\u65ad\u662f\u5426\u662f\u70ed\u5347\u7ea7\u8fc7\u7a0b\u4ee5\u53ca\u5f53\u524dsidecar\u5bb9\u5668\u662f\u65b0\u7248\u672c\u8fd8\u662f\u8001\u7248\u672c\u3002\\n```\\n// return two parameters:\\n// 1. (bool) indicates whether it is hot upgrade process\\n// 2. (bool ) when isHotUpgrading=true, the current sidecar is newer or older\\nfunc isHotUpgradeProcess() (bool, bool) {\\n  // Version of the current sidecar container\\n  version := os.Getenv(\\"SIDECARSET_VERSION\\")\\n  // Version of the peer sidecar container\\n  versionAlt := os.Getenv(\\"SIDECARSET_VERSION_ALT\\")\\n  // If the version of the peer sidecar container is \\"0\\", hot upgrade is not underway\\n  if versionAlt == \\"0\\" {\\n    return false, false\\n  }\\n  // Hot upgrade is underway\\n  versionInt, _ := strconv.Atoi(version)\\n  versionAltInt, _ := strconv.Atoi(versionAlt)\\n  // version is of int type and monotonically increases, which means the version value of the new-version container will be greater\\n  return true, versionInt > versionAltInt\\n}\\n```\\n\\n2. ListenFD\u8fc1\u79fb\\n\u901a\u8fc7Unix Domain Socket\u5b9e\u73b0ListenFD\u5728\u4e0d\u540c\u5bb9\u5668\u95f4\u7684\u8fc1\u79fb\uff0c\u6b64\u6b65\u540c\u6837\u4e5f\u662f\u70ed\u5347\u7ea7\u4e2d\u975e\u5e38\u5173\u952e\u7684\u4e00\u6b65\uff0c\u4ee3\u7801\u793a\u4f8b\u5982\u4e0b\uff1a\\n```\\n  // For code conciseness, all failures will not be captured\\n\\n  /* The old sidecar migrates ListenFD to the new sidecar through Unix Domain Socket */\\n  // tcpLn *net.TCPListener\\n  f, _ := tcpLn.File()\\n  fdnum := f.Fd()\\n  data := syscall.UnixRights(int(fdnum))\\n  // Establish a connection with the new sidecar container through Unix Domain Socket\\n  raddr, _ := net.ResolveUnixAddr(\\"unix\\", \\"/dev/shm/migrate.sock\\")\\n  uds, _ := net.DialUnix(\\"unix\\", nil, raddr)\\n  // Use UDS to send ListenFD to the new sidecar container\\n  uds.WriteMsgUnix(nil, data, nil)\\n  // Stop receiving new requests and start the drainage phase, for example, http2 GOAWAY\\n  tcpLn.Close()\\n\\n  /* The new sidecar receives ListenFD and starts to provide external services */\\n  // Listen to UDS\\n  addr, _ := net.ResolveUnixAddr(\\"unix\\", \\"/dev/shm/migrate.sock\\")\\n  unixLn, _ := net.ListenUnix(\\"unix\\", addr)\\n  conn, _ := unixLn.AcceptUnix()\\n  buf := make([]byte, 32)\\n  oob := make([]byte, 32)\\n  // Receive ListenFD\\n  _, oobn, _, _, _ := conn.ReadMsgUnix(buf, oob)\\n  scms, _ := syscall.ParseSocketControlMessage(oob[:oobn])\\n  if len(scms) > 0 {\\n    // Parse FD and convert to *net.TCPListener\\n    fds, _ := syscall.ParseUnixRights(&(scms[0]))\\n    f := os.NewFile(uintptr(fds[0]), \\"\\")\\n    ln, _ := net.FileListener(f)\\n    tcpLn, _ := ln.(*net.TCPListener)\\n    // Start to provide external services based on the received Listener. The http service is used as an example\\n    http.Serve(tcpLn, serveMux)\\n  }\\n\\n```\\n\\n# \u5df2\u77e5Mesh\u5bb9\u5668\u70ed\u5347\u7ea7\u6848\u4f8b\\n\u963f\u91cc\u4e91\u670d\u52a1\u7f51\u683c\uff08Alibaba Cloud Service Mesh\uff0c\u7b80\u79f0ASM\uff09\u63d0\u4f9b\u4e86\u4e00\u4e2a\u5168\u6258\u7ba1\u5f0f\u7684\u670d\u52a1\u7f51\u683c\u5e73\u53f0\uff0c\u517c\u5bb9\u793e\u533aIstio\u5f00\u6e90\u670d\u52a1\u7f51\u683c\u3002\u5f53\u524d\uff0c\u57fa\u4e8eOpenKruise SidecarSet\u7684\u70ed\u5347\u7ea7\u80fd\u529b\uff0cASM\u5b9e\u73b0\u4e86\u6570\u636e\u5e73\u9762Sidecar\u70ed\u5347\u7ea7\u80fd\u529b\uff08Beta\uff09\uff0c\u7528\u6237\u53ef\u4ee5\u5728\u5e94\u7528\u65e0\u611f\u7684\u60c5\u51b5\u4e0b\u5b8c\u6210\u670d\u52a1\u7f51\u683c\u7684\u6570\u636e\u5e73\u9762\u7248\u672c\u5347\u7ea7\uff0c\u6b63\u5f0f\u7248\u4e5f\u5c06\u4e8e\u8fd1\u671f\u4e0a\u7ebf\u3002\u9664\u70ed\u5347\u7ea7\u80fd\u529b\u5916\uff0cASM\u8fd8\u652f\u6301\u914d\u7f6e\u8bca\u65ad\u3001\u64cd\u4f5c\u5ba1\u8ba1\u3001\u8bbf\u95ee\u65e5\u5fd7\u3001\u76d1\u63a7\u3001\u670d\u52a1\u6ce8\u518c\u63a5\u5165\u7b49\u80fd\u529b\uff0c\u5168\u65b9\u4f4d\u63d0\u5347\u670d\u52a1\u7f51\u683c\u4f7f\u7528\u4f53\u9a8c\uff0c\u6b22\u8fce\u60a8\u524d\u5f80\u8bd5\u7528\u3002\\n\\n# \u603b\u7ed3\\n\u4e91\u539f\u751f\u4e2dmesh\u5bb9\u5668\u7684\u70ed\u5347\u7ea7\u4e00\u76f4\u90fd\u662f\u8feb\u5207\u5374\u53c8\u68d8\u624b\u7684\u95ee\u9898\uff0c\u672c\u6587\u4e2d\u7684\u65b9\u6848\u4e5f\u53ea\u662f\u963f\u91cc\u5df4\u5df4\u96c6\u56e2\u5728\u6b64\u95ee\u9898\u4e0a\u7684\u4e00\u6b21\u63a2\u7d22\uff0c\u5728\u53cd\u9988\u793e\u533a\u7684\u540c\u65f6\u4e5f\u5e0c\u671b\u80fd\u591f\u629b\u7816\u5f15\u7389\uff0c\u5f15\u53d1\u5404\u4f4d\u5bf9\u6b64\u4e2d\u573a\u666f\u7684\u601d\u8003\u3002\u540c\u65f6\uff0c\u6211\u4eec\u4e5f\u6b22\u8fce\u66f4\u591a\u7684\u540c\u5b66\u53c2\u4e0e\u5230 OpenKruise \u793e\u533a\u6765\uff0c\u5171\u540c\u5efa\u8bbe\u4e00\u4e2a\u573a\u666f\u66f4\u52a0\u4e30\u5bcc\u3001\u5b8c\u5584\u7684 K8s \u5e94\u7528\u7ba1\u7406\u3001\u4ea4\u4ed8\u6269\u5c55\u80fd\u529b\uff0c\u80fd\u591f\u9762\u5411\u66f4\u52a0\u89c4\u6a21\u5316\u3001\u590d\u6742\u5316\u3001\u6781\u81f4\u6027\u80fd\u7684\u573a\u666f\u3002"},{"id":"openkruise-0.9.0","metadata":{"permalink":"/zh/blog/openkruise-0.9.0","editUrl":"https://github.com/openkruise/openkruise.io/edit/master/blog/2021-05-20-release-0.9.0.md","source":"@site/i18n/zh/docusaurus-plugin-content-blog/2021-05-20-release-0.9.0.md","title":"OpenKruise 0.9.0\uff1a\u65b0\u589ePod\u5bb9\u5668\u91cd\u542f\u3001\u8d44\u6e90\u5220\u9664\u9632\u62a4\u7b49\u529f\u80fd","description":"OpenKruise \u5728 2021.5.20 \u53d1\u5e03\u4e86\u6700\u65b0\u7684 v0.9.0 \u7248\u672c\uff0c\u65b0\u589e\u4e86 Pod \u5bb9\u5668\u91cd\u542f\u3001\u8d44\u6e90\u7ea7\u8054\u5220\u9664\u9632\u62a4\u7b49\u91cd\u78c5\u529f\u80fd\uff0c\u672c\u6587\u4ee5\u4e0b\u5bf9\u65b0\u7248\u672c\u505a\u6574\u4f53\u7684\u6982\u89c8\u4ecb\u7ecd\u3002","date":"2021-05-20T00:00:00.000Z","tags":[{"inline":true,"label":"release","permalink":"/zh/blog/tags/release"}],"readingTime":11.97,"hasTruncateMarker":false,"authors":[{"name":"Siyu Wang","title":"Maintainer of OpenKruise","url":"https://github.com/FillZpp","imageURL":"https://github.com/FillZpp.png","key":"FillZpp","page":null}],"frontMatter":{"slug":"openkruise-0.9.0","title":"OpenKruise 0.9.0\uff1a\u65b0\u589ePod\u5bb9\u5668\u91cd\u542f\u3001\u8d44\u6e90\u5220\u9664\u9632\u62a4\u7b49\u529f\u80fd","authors":["FillZpp"],"tags":["release"]},"unlisted":false,"prevItem":{"title":"OpenKruise 0.9.0, SidecarSet Helps Mesh Container Hot Upgrade","permalink":"/zh/blog/sidecarset-hotupdate"},"nextItem":{"title":"OpenKruise 0.8.0, A Powerful Tool for Sidecar Container Management","permalink":"/zh/blog/sidecarset"}},"content":"OpenKruise \u5728 2021.5.20 \u53d1\u5e03\u4e86\u6700\u65b0\u7684 v0.9.0 \u7248\u672c\uff0c\u65b0\u589e\u4e86 Pod \u5bb9\u5668\u91cd\u542f\u3001\u8d44\u6e90\u7ea7\u8054\u5220\u9664\u9632\u62a4\u7b49\u91cd\u78c5\u529f\u80fd\uff0c\u672c\u6587\u4ee5\u4e0b\u5bf9\u65b0\u7248\u672c\u505a\u6574\u4f53\u7684\u6982\u89c8\u4ecb\u7ecd\u3002\\n\\n## Pod \u5bb9\u5668\u91cd\u542f/\u91cd\u5efa\\n\\n\u201c\u91cd\u542f\u201d \u662f\u4e00\u4e2a\u5f88\u6734\u7d20\u7684\u9700\u6c42\uff0c\u5373\u4f7f\u65e5\u5e38\u8fd0\u7ef4\u7684\u8bc9\u6c42\uff0c\u4e5f\u662f\u6280\u672f\u9886\u57df\u8f83\u4e3a\u5e38\u89c1\u7684 \u201c\u6062\u590d\u624b\u6bb5\u201d\u3002\u800c\u5728\u539f\u751f\u7684 Kubernetes \u4e2d\uff0c\u5e76\u6ca1\u6709\u63d0\u4f9b\u4efb\u4f55\u5bf9\u5bb9\u5668\u7c92\u5ea6\u7684\u64cd\u4f5c\u80fd\u529b\uff0cPod \u4f5c\u4e3a\u6700\u5c0f\u64cd\u4f5c\u5355\u5143\u4e5f\u53ea\u6709\u521b\u5efa\u3001\u5220\u9664\u4e24\u79cd\u64cd\u4f5c\u65b9\u5f0f\u3002\\n\\n\u6709\u7684\u540c\u5b66\u53ef\u80fd\u4f1a\u95ee\uff0c\u5728\u4e91\u539f\u751f\u65f6\u4ee3\uff0c\u4e3a\u4ec0\u4e48\u7528\u6237\u8fd8\u8981\u5173\u6ce8\u5bb9\u5668\u91cd\u542f\u8fd9\u79cd\u8fd0\u7ef4\u64cd\u4f5c\u5462\uff1f\u5728\u7406\u60f3\u7684 serverless \u6a21\u5f0f\u4e0b\uff0c\u4e1a\u52a1\u53ea\u9700\u8981\u5173\u5fc3\u670d\u52a1\u81ea\u8eab\u5c31\u597d\u5427\uff1f\\n\\n\u8fd9\u6765\u81ea\u4e8e\u4e91\u539f\u751f\u67b6\u6784\u548c\u8fc7\u53bb\u4f20\u7edf\u57fa\u7840\u57fa\u7840\u8bbe\u65bd\u7684\u5dee\u5f02\u6027\u3002\u5728\u4f20\u7edf\u7684\u7269\u7406\u673a\u3001\u865a\u62df\u673a\u65f6\u4ee3\uff0c\u4e00\u53f0\u673a\u5668\u4e0a\u5f80\u5f80\u4f1a\u90e8\u7f72\u548c\u8fd0\u884c\u591a\u4e2a\u5e94\u7528\u7684\u5b9e\u4f8b\uff0c\u5e76\u4e14\u673a\u5668\u548c\u5e94\u7528\u7684\u751f\u547d\u5468\u671f\u662f\u4e0d\u540c\u7684\uff1b\u5728\u8fd9\u79cd\u60c5\u51b5\u4e0b\uff0c\u5e94\u7528\u5b9e\u4f8b\u7684\u91cd\u542f\u53ef\u80fd\u4ec5\u4ec5\u662f\u4e00\u6761 systemctl \u6216 supervisor \u4e4b\u7c7b\u7684\u6307\u4ee4\uff0c\u800c\u65e0\u9700\u5c06\u6574\u4e2a\u673a\u5668\u91cd\u542f\u3002\u7136\u800c\uff0c\u5728\u5bb9\u5668\u4e0e\u4e91\u539f\u751f\u6a21\u5f0f\u4e0b\uff0c\u5e94\u7528\u7684\u751f\u547d\u5468\u671f\u662f\u548c Pod \u5bb9\u5668\u7ed1\u5b9a\u7684\uff1b\u5373\u5e38\u89c4\u60c5\u51b5\u4e0b\uff0c\u4e00\u4e2a\u5bb9\u5668\u53ea\u8fd0\u884c\u4e00\u4e2a\u5e94\u7528\u8fdb\u7a0b\uff0c\u4e00\u4e2a Pod \u4e5f\u53ea\u63d0\u4f9b\u4e00\u4e2a\u5e94\u7528\u5b9e\u4f8b\u7684\u670d\u52a1\u3002\\n\\n\u57fa\u4e8e\u4e0a\u8ff0\u7684\u9650\u5236\uff0c\u76ee\u524d\u539f\u751f Kubernetes \u4e4b\u4e0b\u662f\u6ca1\u6709 API \u6765\u4e3a\u4e0a\u5c42\u4e1a\u52a1\u63d0\u4f9b\u5bb9\u5668\uff08\u5e94\u7528\uff09\u91cd\u542f\u80fd\u529b\u7684\u3002\u800c Kruise v0.9.0 \u7248\u672c\u63d0\u4f9b\u4e86\u4e00\u79cd\u5355 Pod \u7ef4\u5ea6\u7684\u5bb9\u5668\u91cd\u542f\u80fd\u529b\uff0c\u517c\u5bb9 1.16 \u53ca\u4ee5\u4e0a\u7248\u672c\u7684\u6807\u51c6 Kubernetes \u96c6\u7fa4\u3002\u5728\u5b89\u88c5\u6216\u5347\u7ea7 Kruise \u4e4b\u540e\uff0c\u53ea\u9700\u8981\u521b\u5efa ContainerRecreateRequest\uff08\u7b80\u79f0 CRR\uff09 \u5bf9\u8c61\u6765\u6307\u5b9a\u91cd\u542f\uff0c\u6700\u7b80\u5355\u7684 YAML \u5982\u4e0b\uff1a\\n\\n```yaml\\napiVersion: apps.kruise.io/v1alpha1\\nkind: ContainerRecreateRequest\\nmetadata:\\n  namespace: pod-namespace\\n  name: xxx\\nspec:\\n  podName: pod-name\\n  containers:\\n  - name: app\\n  - name: sidecar\\n```\\n\\n\u5176\u4e2d\uff0cnamespace \u9700\u8981\u4e0e\u8981\u64cd\u4f5c\u7684 Pod \u5728\u540c\u4e00\u4e2a\u547d\u540d\u7a7a\u95f4\uff0cname \u53ef\u81ea\u9009\u3002spec \u4e2d podName \u662f Pod \u540d\u5b57\uff0ccontainers \u5217\u8868\u5219\u53ef\u4ee5\u6307\u5b9a Pod \u4e2d\u4e00\u4e2a\u6216\u591a\u4e2a\u5bb9\u5668\u540d\u6765\u6267\u884c\u91cd\u542f\u3002\\n\\n\u9664\u4e86\u4e0a\u8ff0\u5fc5\u9009\u5b57\u6bb5\u5916\uff0cCRR \u8fd8\u63d0\u4f9b\u4e86\u591a\u79cd\u53ef\u9009\u7684\u91cd\u542f\u7b56\u7565\uff1a\\n\\n```yaml\\nspec:\\n  # ...\\n  strategy:\\n    failurePolicy: Fail\\n    orderedRecreate: false\\n    terminationGracePeriodSeconds: 30\\n    unreadyGracePeriodSeconds: 3\\n    minStartedSeconds: 10\\n  activeDeadlineSeconds: 300\\n  ttlSecondsAfterFinished: 1800\\n```\\n\\n- `failurePolicy`: Fail \u6216 Ignore\uff0c\u9ed8\u8ba4 Fail\uff1b\u8868\u793a\u4e00\u65e6\u6709\u67d0\u4e2a\u5bb9\u5668\u505c\u6b62\u6216\u91cd\u5efa\u5931\u8d25\uff0cCRR \u7acb\u5373\u7ed3\u675f\\n- `orderedRecreate`: \u9ed8\u8ba4 false\uff1btrue \u8868\u793a\u5217\u8868\u6709\u591a\u4e2a\u5bb9\u5668\u65f6\uff0c\u7b49\u524d\u4e00\u4e2a\u5bb9\u5668\u91cd\u5efa\u5b8c\u6210\u4e86\uff0c\u518d\u5f00\u59cb\u91cd\u5efa\u4e0b\u4e00\u4e2a\\n- `terminationGracePeriodSeconds`: \u7b49\u5f85\u5bb9\u5668\u4f18\u96c5\u9000\u51fa\u7684\u65f6\u95f4\uff0c\u4e0d\u586b\u9ed8\u8ba4\u7528 Pod \u4e2d\u5b9a\u4e49\u7684\u65f6\u95f4\\n- `unreadyGracePeriodSeconds`: \u5728\u91cd\u5efa\u4e4b\u524d\u5148\u628a Pod \u8bbe\u4e3a not ready\uff0c\u5e76\u7b49\u5f85\u8fd9\u6bb5\u65f6\u95f4\u540e\u518d\u5f00\u59cb\u6267\u884c\u91cd\u5efa\\n  -   \u6ce8\uff1a\u8be5\u529f\u80fd\u4f9d\u8d56\u4e8e KruisePodReadinessGate \u8fd9\u4e2a feature-gate \u8981\u6253\u5f00\uff0c\u540e\u8005\u4f1a\u5728\u6bcf\u4e2a Pod \u521b\u5efa\u7684\u65f6\u5019\u6ce8\u5165\u4e00\u4e2a readinessGate\u3002 \u5426\u5219\uff0c\u9ed8\u8ba4\u53ea\u4f1a\u7ed9 Kruise workload \u521b\u5efa\u7684 Pod \u6ce8\u5165 readinessGate\uff0c\u4e5f\u5c31\u662f\u8bf4\u53ea\u6709\u8fd9\u4e9b Pod \u624d\u80fd\u5728 CRR \u91cd\u5efa\u65f6\u4f7f\u7528 unreadyGracePeriodSeconds\\n- `minStartedSeconds`: \u91cd\u5efa\u540e\u65b0\u5bb9\u5668\u81f3\u5c11\u4fdd\u6301\u8fd0\u884c\u8fd9\u6bb5\u65f6\u95f4\uff0c\u624d\u8ba4\u4e3a\u8be5\u5bb9\u5668\u91cd\u5efa\u6210\u529f\\n- `activeDeadlineSeconds`: \u5982\u679c CRR \u6267\u884c\u8d85\u8fc7\u8fd9\u4e2a\u65f6\u95f4\uff0c\u5219\u76f4\u63a5\u6807\u8bb0\u4e3a\u7ed3\u675f\uff08\u672a\u5b8c\u6210\u7684\u5bb9\u5668\u6807\u8bb0\u4e3a\u5931\u8d25\uff09\\n- `ttlSecondsAfterFinished`: CRR \u7ed3\u675f\u540e\uff0c\u8fc7\u4e86\u8fd9\u6bb5\u65f6\u95f4\u81ea\u52a8\u88ab\u5220\u9664\u6389\\n\\n\u5b9e\u73b0\u539f\u7406\uff1a\u5f53\u7528\u6237\u521b\u5efa\u4e86 CRR \u540e\uff0c\u7ecf\u8fc7\u4e86 kruise-manager \u4e2d\u5fc3\u7aef\u7684\u521d\u6b65\u5904\u7406\uff0c\u4f1a\u88ab Pod \u6240\u5728\u8282\u70b9\u4e0a\u7684 kruise-daemon \u6536\u5230\u5e76\u5f00\u59cb\u6267\u884c\u3002\u6267\u884c\u7684\u8fc7\u7a0b\u5982\u4e0b\uff1a\\n\\n1. \u5982\u679c Pod \u5bb9\u5668\u5b9a\u4e49\u4e86 preStop\uff0ckruise-daemon \u4f1a\u5148\u8d70 CRI \u8fd0\u884c\u65f6 exec \u5230\u5bb9\u5668\u4e2d\u6267\u884c preStop\\n2. \u5982\u679c\u6ca1\u6709 preStop \u6216\u6267\u884c\u5b8c\u6210\uff0ckruise-daemon \u8c03\u7528 CRI \u63a5\u53e3\u5c06\u5bb9\u5668\u505c\u6b62\\n3. kubelet \u611f\u77e5\u5230\u5bb9\u5668\u9000\u51fa\uff0c\u5219\u4f1a\u65b0\u5efa\u4e00\u4e2a \u201c\u5e8f\u53f7\u201d \u9012\u589e\u7684\u65b0\u5bb9\u5668\uff0c\u5e76\u5f00\u59cb\u542f\u52a8\uff08\u4ee5\u53ca\u6267\u884c postStart\uff09\\n4. kruise-daemon \u611f\u77e5\u5230\u65b0\u5bb9\u5668\u542f\u52a8\u6210\u529f\uff0c\u4e0a\u62a5 CRR \u91cd\u542f\u5b8c\u6210\\n\\n![ContainerRecreateRequest](/img/docs/user-manuals/containerrecreaterequest.png)\\n\\n\u4e0a\u8ff0\u7684\u5bb9\u5668 \u201c\u5e8f\u53f7\u201d \u5176\u5b9e\u5c31\u5bf9\u5e94\u4e86 Pod status \u4e2d kubelet \u4e0a\u62a5\u7684 restartCount\u3002\u56e0\u6b64\uff0c\u5728\u5bb9\u5668\u91cd\u542f\u540e\u4f1a\u770b\u5230 Pod \u7684 restartCount \u589e\u52a0\u3002\u53e6\u5916\uff0c\u56e0\u4e3a\u5bb9\u5668\u53d1\u751f\u4e86\u91cd\u5efa\uff0c\u4e4b\u524d\u4e34\u65f6\u5199\u5230\u65e7\u5bb9\u5668 rootfs \u4e2d\u7684\u6587\u4ef6\u4f1a\u4e22\u5931\uff0c\u4f46\u662f volume mount \u6302\u8f7d\u5377\u4e2d\u7684\u6570\u636e\u4ecd\u7136\u5b58\u5728\u3002\\n\\n## \u7ea7\u8054\u5220\u9664\u9632\u62a4\\n\\nKubernetes \u7684\u9762\u5411\u7ec8\u6001\u81ea\u52a8\u5316\u662f\u4e00\u628a \u201c\u53cc\u5203\u5251\u201d\uff0c\u5b83\u65e2\u4e3a\u5e94\u7528\u5e26\u6765\u4e86\u58f0\u660e\u5f0f\u7684\u90e8\u7f72\u80fd\u529b\uff0c\u540c\u65f6\u4e5f\u6f5c\u5728\u5730\u4f1a\u5c06\u4e00\u4e9b\u8bef\u64cd\u4f5c\u884c\u4e3a\u88ab\u7ec8\u6001\u5316\u653e\u5927\u3002\u4f8b\u5982\u5b83\u7684 \u201c\u7ea7\u8054\u5220\u9664\u201d \u673a\u5236\uff0c\u5373\u6b63\u5e38\u60c5\u51b5\uff08\u975e orphan \u5220\u9664\uff09\u4e0b\u4e00\u65e6\u7236\u7c7b\u8d44\u6e90\u88ab\u5220\u9664\uff0c\u5219\u6240\u6709\u5b50\u7c7b\u8d44\u6e90\u90fd\u4f1a\u88ab\u5173\u8054\u5220\u9664\uff1a\\n\\n1. \u5220\u9664\u4e00\u4e2a CRD\uff0c\u5176\u6240\u6709\u5bf9\u5e94\u7684 CR \u90fd\u88ab\u6e05\u7406\u6389\\n2. \u5220\u9664\u4e00\u4e2a namespace\uff0c\u8fd9\u4e2a\u547d\u540d\u7a7a\u95f4\u4e0b\u5305\u62ec Pod \u5728\u5185\u6240\u6709\u8d44\u6e90\u90fd\u88ab\u4e00\u8d77\u5220\u9664\\n3. \u5220\u9664\u4e00\u4e2a workload\uff08Deployment/StatefulSet/...\uff09\uff0c\u5219\u4e0b\u5c5e\u6240\u6709 Pod \u88ab\u5220\u9664\\n\\n\u7c7b\u4f3c\u8fd9\u79cd \u201c\u7ea7\u8054\u5220\u9664\u201d \u5e26\u6765\u7684\u6545\u969c\uff0c\u6211\u4eec\u5df2\u7ecf\u542c\u5230\u4e0d\u5c11\u793e\u533a K8s \u7528\u6237\u548c\u5f00\u53d1\u8005\u5e26\u6765\u7684\u62b1\u6028\u3002\u5bf9\u4e8e\u4efb\u4f55\u4e00\u5bb6\u4f01\u4e1a\u6765\u8bf4\uff0c\u5176\u751f\u4ea7\u73af\u5883\u53d1\u751f\u8fd9\u79cd\u89c4\u6a21\u8bef\u5220\u9664\u90fd\u662f\u4e0d\u53ef\u627f\u53d7\u4e4b\u75db\u3002\\n\\n\u56e0\u6b64\uff0c\u5728 Kruise v0.9.0 \u7248\u672c\u4e2d\uff0c\u6211\u4eec\u5efa\u7acb\u4e86\u9632\u7ea7\u8054\u5220\u9664\u80fd\u529b\uff0c\u671f\u671b\u80fd\u4e3a\u66f4\u591a\u7684\u7528\u6237\u5e26\u6765\u7a33\u5b9a\u6027\u4fdd\u969c\u3002\u5728\u5f53\u524d\u7248\u672c\u4e2d\u5982\u679c\u9700\u8981\u4f7f\u7528\u8be5\u529f\u80fd\uff0c\u5219\u5728\u5b89\u88c5\u6216\u5347\u7ea7 Kruise \u7684\u65f6\u5019\u9700\u8981\u663e\u5f0f\u6253\u5f00 `ResourcesDeletionProtection` \u8fd9\u4e2a feature-gate\u3002\\n\\n\u5bf9\u4e8e\u9700\u8981\u9632\u62a4\u5220\u9664\u7684\u8d44\u6e90\u5bf9\u8c61\uff0c\u7528\u6237\u53ef\u4ee5\u7ed9\u5176\u6253\u4e0a policy.kruise.io/delete-protection \u6807\u7b7e\uff0cvalue \u53ef\u4ee5\u6709\u4e24\u79cd\uff1a\\n\\n- Always: \u8868\u793a\u8fd9\u4e2a\u5bf9\u8c61\u7981\u6b62\u88ab\u5220\u9664\uff0c\u9664\u975e\u4e0a\u8ff0 label \u88ab\u53bb\u6389\\n- Cascading\uff1a\u8fd9\u4e2a\u5bf9\u8c61\u5982\u679c\u8fd8\u6709\u53ef\u7528\u7684\u4e0b\u5c5e\u8d44\u6e90\uff0c\u5219\u7981\u6b62\u88ab\u5220\u9664\\n\\n\u76ee\u524d\u652f\u6301\u7684\u8d44\u6e90\u7c7b\u578b\u3001\u4ee5\u53ca cascading \u7ea7\u8054\u5173\u7cfb\u5982\u4e0b\uff1a\\n\\n| Kind                        | Group                  | Version            | **Cascading** judgement                            |\\n| --------------------------- | ---------------------- | ------------------ | ----------------------------------------------------\\n| `Namespace`                 | core                   | v1                 | whether there is active Pods in this namespace     |\\n| `CustomResourceDefinition`  | apiextensions.k8s.io   | v1beta1, v1        | whether there is existing CRs of this CRD          |\\n| `Deployment`                | apps                   | v1                 | whether the replicas is 0                          |\\n| `StatefulSet`               | apps                   | v1                 | whether the replicas is 0                          |\\n| `ReplicaSet`                | apps                   | v1                 | whether the replicas is 0                          |\\n| `CloneSet`                  | apps.kruise.io         | v1alpha1           | whether the replicas is 0                          |\\n| `StatefulSet`               | apps.kruise.io         | v1alpha1, v1beta1  | whether the replicas is 0                          |\\n| `UnitedDeployment`          | apps.kruise.io         | v1alpha1           | whether the replicas is 0                          |\\n\\n## CloneSet \u65b0\u589e\u529f\u80fd\\n\\n### \u5220\u9664\u4f18\u5148\u7ea7\\n\\n`controller.kubernetes.io/pod-deletion-cost` \u662f\u4ece Kubernetes 1.21 \u7248\u672c\u540e\u52a0\u5165\u7684 annotation\uff0cReplicaSet \u5728\u7f29\u5bb9\u65f6\u4f1a\u53c2\u8003\u8fd9\u4e2a cost \u6570\u503c\u6765\u6392\u5e8f\u3002 CloneSet \u4ece Kruise v0.9.0 \u7248\u672c\u540e\u4e5f\u540c\u6837\u652f\u6301\u4e86\u8fd9\u4e2a\u529f\u80fd\u3002\\n\\n\u7528\u6237\u53ef\u4ee5\u628a\u8fd9\u4e2a annotation \u914d\u7f6e\u5230 pod \u4e0a\uff0c\u5b83\u7684 value \u6570\u503c\u662f int \u7c7b\u578b\uff0c\u8868\u793a\u8fd9\u4e2a pod \u76f8\u8f83\u4e8e\u540c\u4e2a CloneSet \u4e0b\u5176\u4ed6 pod \u7684 \\"\u5220\u9664\u4ee3\u4ef7\\"\uff0c\u4ee3\u4ef7\u8d8a\u5c0f\u7684 pod \u5220\u9664\u4f18\u5148\u7ea7\u76f8\u5bf9\u8d8a\u9ad8\u3002 \u6ca1\u6709\u8bbe\u7f6e\u8fd9\u4e2a annotation \u7684 pod \u9ed8\u8ba4 deletion cost \u662f 0\u3002\\n\\n\u6ce8\u610f\u8fd9\u4e2a\u5220\u9664\u987a\u5e8f\u5e76\u4e0d\u662f\u5f3a\u5236\u4fdd\u8bc1\u7684\uff0c\u56e0\u4e3a\u771f\u5b9e\u7684 pod \u7684\u5220\u9664\u7c7b\u4f3c\u4e8e\u4e0b\u8ff0\u987a\u5e8f\uff1a\\n\\n1. \u672a\u8c03\u5ea6 < \u5df2\u8c03\u5ea6\\n2. PodPending < PodUnknown < PodRunning\\n3. Not ready < ready\\n4. **\u8f83\u5c0f pod-deletion cost < \u8f83\u5927 pod-deletion cost**\\n5. \u5904\u4e8e Ready \u65f6\u95f4\u8f83\u77ed < \u8f83\u957f\\n6. \u5bb9\u5668\u91cd\u542f\u6b21\u6570\u8f83\u591a < \u8f83\u5c11\\n7. \u521b\u5efa\u65f6\u95f4\u8f83\u77ed < \u8f83\u957f\\n\\n### \u914d\u5408\u539f\u5730\u5347\u7ea7\u7684\u955c\u50cf\u9884\u70ed\\n\\n\u5f53\u4f7f\u7528 CloneSet \u505a\u5e94\u7528\u539f\u5730\u5347\u7ea7\u65f6\uff0c\u53ea\u4f1a\u5347\u7ea7\u5bb9\u5668\u955c\u50cf\u3001\u800c Pod \u4e0d\u4f1a\u53d1\u751f\u91cd\u5efa\u3002\u8fd9\u5c31\u4fdd\u8bc1\u4e86 Pod \u5347\u7ea7\u524d\u540e\u6240\u5728 node \u4e0d\u4f1a\u53d1\u751f\u53d8\u5316\uff0c\u4ece\u800c\u5728\u539f\u5730\u5347\u7ea7\u7684\u8fc7\u7a0b\u4e2d\uff0c\u5982\u679c CloneSet \u63d0\u524d\u5728\u6240\u6709 Pod \u8282\u70b9\u4e0a\u5148\u628a\u65b0\u7248\u672c\u955c\u50cf\u62c9\u53d6\u597d\uff0c\u5219\u5728\u540e\u7eed\u7684\u53d1\u5e03\u6279\u6b21\u4e2d Pod \u539f\u5730\u5347\u7ea7\u901f\u5ea6\u4f1a\u5f97\u5230\u5927\u5e45\u5ea6\u63d0\u9ad8\u3002\\n\\n\u5728\u5f53\u524d\u7248\u672c\u4e2d\u5982\u679c\u9700\u8981\u4f7f\u7528\u8be5\u529f\u80fd\uff0c\u5219\u5728\u5b89\u88c5\u6216\u5347\u7ea7 Kruise \u7684\u65f6\u5019\u9700\u8981\u663e\u5f0f\u6253\u5f00 `PreDownloadImageForInPlaceUpdate` \u8fd9\u4e2a feature-gate\u3002\u6253\u5f00\u540e\uff0c\u5f53\u7528\u6237\u66f4\u65b0\u4e86 CloneSet template \u4e2d\u7684\u955c\u50cf\u3001\u4e14\u53d1\u5e03\u7b56\u7565\u652f\u6301\u539f\u5730\u5347\u7ea7\uff0c\u5219 CloneSet \u4f1a\u81ea\u52a8\u4e3a\u8fd9\u4e2a\u65b0\u955c\u50cf\u521b\u5efa ImagePullJob \u5bf9\u8c61\uff08OpenKruise \u63d0\u4f9b\u7684\u6279\u91cf\u955c\u50cf\u9884\u70ed\u529f\u80fd\uff09\uff0c\u6765\u63d0\u524d\u5728 Pod \u6240\u5728\u8282\u70b9\u4e0a\u9884\u70ed\u65b0\u955c\u50cf\u3002\\n\\n\u9ed8\u8ba4\u60c5\u51b5\u4e0b CloneSet \u7ed9 ImagePullJob \u914d\u7f6e\u7684\u5e76\u53d1\u5ea6\u662f 1\uff0c\u4e5f\u5c31\u662f\u4e00\u4e2a\u4e2a\u8282\u70b9\u62c9\u955c\u50cf\u3002 \u5982\u679c\u9700\u8981\u8c03\u6574\uff0c\u4f60\u53ef\u4ee5\u5728 CloneSet annotation \u4e0a\u8bbe\u7f6e\u5176\u955c\u50cf\u9884\u70ed\u65f6\u7684\u5e76\u53d1\u5ea6\uff1a\\n\\n```yaml\\napiVersion: apps.kruise.io/v1alpha1\\nkind: CloneSet\\nmetadata:\\n  annotations:\\n    apps.kruise.io/image-predownload-parallelism: \\"5\\"\\n```\\n\\n### \u5148\u6269\u518d\u7f29\u7684 Pod \u7f6e\u6362\u65b9\u5f0f\\n\\n\u5728\u8fc7\u53bb\u7248\u672c\u4e2d\uff0cCloneSet \u7684 `maxUnavailable`\u3001`maxSurge` \u7b56\u7565\u53ea\u5bf9\u5e94\u7528\u53d1\u5e03\u8fc7\u7a0b\u751f\u6548\u3002\u800c\u4ece Kruise v0.9.0 \u7248\u672c\u5f00\u59cb\uff0c\u8fd9\u4e24\u4e2a\u7b56\u7565\u540c\u6837\u4f1a\u5bf9 Pod \u6307\u5b9a\u5220\u9664\u751f\u6548\u3002\\n\\n\u4e5f\u5c31\u662f\u8bf4\uff0c\u5f53\u7528\u6237\u901a\u8fc7 `podsToDelete` \u6216 `apps.kruise.io/specified-delete: true` \u65b9\u5f0f\uff08\u5177\u4f53\u89c1\u5b98\u7f51\u6587\u6863\uff09\u6765\u6307\u5b9a\u4e00\u4e2a\u6216\u591a\u4e2a Pod \u671f\u671b\u5220\u9664\u65f6\uff0cCloneSet \u53ea\u4f1a\u5728\u5f53\u524d\u4e0d\u53ef\u7528 Pod \u6570\u91cf\uff08\u76f8\u5bf9\u4e8e replicas \u603b\u6570\uff09\u5c0f\u4e8e maxUnavailable \u7684\u65f6\u5019\u624d\u6267\u884c\u5220\u9664\u3002\u540c\u65f6\uff0c\u5982\u679c\u7528\u6237\u914d\u7f6e\u4e86 maxSurge \u7b56\u7565\uff0c\u5219 CloneSet \u6709\u53ef\u80fd\u4f1a\u5148\u521b\u5efa\u4e00\u4e2a\u65b0 Pod\u3001\u7b49\u5f85\u65b0 Pod ready\u3001\u518d\u5220\u9664\u6307\u5b9a\u7684\u65e7 Pod\u3002\\n\\n\u5177\u4f53\u91c7\u7528\u4ec0\u4e48\u6837\u7684\u7f6e\u6362\u65b9\u5f0f\uff0c\u53d6\u51b3\u4e8e\u5f53\u65f6\u7684 maxUnavailable \u548c\u5b9e\u9645\u4e0d\u53ef\u7528 Pod \u6570\u91cf\u3002\u6bd4\u5982\uff1a\\n\\n- \u5bf9\u4e8e\u4e00\u4e2a CloneSet `maxUnavailable=2, maxSurge=1` \u4e14\u6709\u4e00\u4e2a `pod-a` \u5904\u4e8e\u4e0d\u53ef\u7528\u72b6\u6001\uff0c \u5982\u679c\u4f60\u5bf9\u53e6\u4e00\u4e2a `pod-b` \u6307\u5b9a\u5220\u9664\uff0c \u90a3\u4e48 CloneSet \u4f1a\u7acb\u5373\u5220\u9664\u5b83\uff0c\u7136\u540e\u521b\u5efa\u4e00\u4e2a\u65b0 Pod\u3002\\n- \u5bf9\u4e8e\u4e00\u4e2a CloneSet `maxUnavailable=1, maxSurge=1` \u4e14\u6709\u4e00\u4e2a `pod-a` \u5904\u4e8e\u4e0d\u53ef\u7528\u72b6\u6001\uff0c \u5982\u679c\u4f60\u5bf9\u53e6\u4e00\u4e2a `pod-b` \u6307\u5b9a\u5220\u9664\uff0c \u90a3\u4e48 CloneSet \u4f1a\u5148\u65b0\u5efa\u4e00\u4e2a Pod\u3001\u7b49\u5f85\u5b83 ready\uff0c\u6700\u540e\u518d\u5220\u9664 pod-b\u3002\\n- \u5bf9\u4e8e\u4e00\u4e2a CloneSet `maxUnavailable=1, maxSurge=1` \u4e14\u6709\u4e00\u4e2a `pod-a` \u5904\u4e8e\u4e0d\u53ef\u7528\u72b6\u6001\uff0c \u5982\u679c\u4f60\u5bf9\u8fd9\u4e2a `pod-a` \u6307\u5b9a\u5220\u9664\uff0c \u90a3\u4e48 CloneSet \u4f1a\u7acb\u5373\u5220\u9664\u5b83\uff0c\u7136\u540e\u521b\u5efa\u4e00\u4e2a\u65b0 Pod\u3002\\n- ...\\n\\n### \u57fa\u4e8e partition \u7ec8\u6001\u7684\u9ad8\u6548\u56de\u6eda\\n\\n\u5728\u539f\u751f\u7684 workload \u4e2d\uff0cDeployment \u81ea\u8eab\u53d1\u5e03\u4e0d\u652f\u6301\u7070\u5ea6\u53d1\u5e03\uff0cStatefulSet \u6709 partition \u8bed\u4e49\u6765\u5141\u8bb8\u7528\u6237\u63a7\u5236\u7070\u5ea6\u5347\u7ea7\u7684\u6570\u91cf\uff1b\u800c Kruise workload \u5982 CloneSet\u3001Advanced StatefulSet\uff0c\u4e5f\u90fd\u63d0\u4f9b\u4e86 partition \u6765\u652f\u6301\u7070\u5ea6\u5206\u6279\u3002\\n\\n\u5bf9\u4e8e CloneSet\uff0cPartition \u7684\u8bed\u4e49\u662f **\u4fdd\u7559\u65e7\u7248\u672c Pod \u7684\u6570\u91cf\u6216\u767e\u5206\u6bd4**\u3002\u6bd4\u5982\u8bf4\u4e00\u4e2a 100 \u4e2a\u526f\u672c\u7684 CloneSet\uff0c\u5728\u5347\u7ea7\u955c\u50cf\u65f6\u5c06 partition \u6570\u503c\u9636\u6bb5\u6027\u6539\u4e3a 80 -> 60 -> 40 -> 20 -> 0\uff0c\u5219\u5b8c\u6210\u4e86\u5206 5 \u6279\u6b21\u53d1\u5e03\u3002\\n\\n\u4f46\u8fc7\u53bb\uff0c\u4e0d\u7ba1\u662f Deployment\u3001StatefulSet \u8fd8\u662f CloneSet\uff0c\u5728\u53d1\u5e03\u7684\u8fc7\u7a0b\u4e2d\u5982\u679c\u60f3\u8981\u56de\u6eda\uff0c\u90fd\u5fc5\u987b\u5c06 template \u4fe1\u606f\uff08\u955c\u50cf\uff09\u91cd\u65b0\u6539\u56de\u8001\u7248\u672c\u3002\u540e\u4e24\u8005\u5728\u7070\u5ea6\u7684\u8fc7\u7a0b\u4e2d\uff0c\u5c06 partition \u8c03\u5c0f\u4f1a\u89e6\u53d1\u65e7\u7248\u672c\u5347\u7ea7\u4e3a\u65b0\u7248\u672c\uff0c\u4f46\u518d\u6b21 partition \u8c03\u5927\u5219\u4e0d\u4f1a\u5904\u7406\u3002\\n\\n\u4ece v0.9.0 \u7248\u672c\u5f00\u59cb\uff0cCloneSet \u7684 partition \u652f\u6301\u4e86 \u201c\u7ec8\u6001\u56de\u6eda\u201d \u529f\u80fd\u3002\u5982\u679c\u5728\u5b89\u88c5\u6216\u5347\u7ea7 Kruise \u7684\u65f6\u5019\u6253\u5f00\u4e86 `CloneSetPartitionRollback` \u8fd9\u4e2a feature-gate\uff0c\u5219\u5f53\u7528\u6237\u5c06 partition \u8c03\u5927\u65f6\uff0cCloneSet \u4f1a\u5c06\u5bf9\u5e94\u6570\u91cf\u7684\u65b0\u7248\u672c Pod \u91cd\u65b0\u56de\u6eda\u5230\u8001\u7248\u672c\u3002\\n\\n\u8fd9\u6837\u5e26\u6765\u7684\u597d\u5904\u662f\u663e\u800c\u6613\u89c1\u7684\uff1a\u5728\u7070\u5ea6\u53d1\u5e03\u7684\u8fc7\u7a0b\u4e2d\uff0c\u53ea\u9700\u8981\u524d\u540e\u8c03\u8282 partition \u6570\u503c\uff0c\u5c31\u80fd\u7075\u6d3b\u5f97\u63a7\u5236\u65b0\u65e7\u7248\u672c\u7684\u6bd4\u4f8b\u6570\u91cf\u3002\u4f46\u9700\u8981\u6ce8\u610f\u7684\u662f\uff0cCloneSet \u6240\u4f9d\u636e\u7684 \u201c\u65b0\u65e7\u7248\u672c\u201d \u5bf9\u5e94\u7684\u662f\u5176 status \u4e2d\u7684 updateRevision \u548c currentRevision\uff1a\\n\\n- updateRevision\uff1a\u5bf9\u5e94\u5f53\u524d CloneSet \u6240\u5b9a\u4e49\u7684 template \u7248\u672c\\n- currentRevision\uff1a\u8be5 CloneSet \u524d\u4e00\u6b21\u5168\u91cf\u53d1\u5e03\u6210\u529f\u7684 template \u7248\u672c\\n\\n### \u77ed hash\\n\\n\u9ed8\u8ba4\u60c5\u51b5\u4e0b\uff0cCloneSet \u5728 Pod label \u4e2d\u8bbe\u7f6e\u7684 `controller-revision-hash` \u503c\u4e3a `ControllerRevision` \u7684\u5b8c\u6574\u540d\u5b57\uff0c\u6bd4\u5982\uff1a\\n\\n```yaml\\napiVersion: v1\\nkind: Pod\\nmetadata:\\n  labels:\\n    controller-revision-hash: demo-cloneset-956df7994\\n```\\n\\n\u5b83\u662f\u901a\u8fc7 CloneSet \u540d\u5b57\u548c ControllerRevision hash \u503c\u62fc\u63a5\u800c\u6210\u3002 \u901a\u5e38 hash \u503c\u957f\u5ea6\u4e3a 8~10 \u4e2a\u5b57\u7b26\uff0c\u800c Kubernetes \u4e2d\u7684 label \u503c\u4e0d\u80fd\u8d85\u8fc7 63 \u4e2a\u5b57\u7b26\u3002 \u56e0\u6b64 CloneSet \u7684\u540d\u5b57\u4e00\u822c\u662f\u4e0d\u80fd\u8d85\u8fc7 52 \u4e2a\u5b57\u7b26\u7684\uff0c\u5982\u679c\u8d85\u8fc7\u4e86\uff0c\u5219\u65e0\u6cd5\u6210\u529f\u521b\u5efa\u51fa Pod\u3002\\n\\n\u5728 v0.9.0 \u7248\u672c\u5f15\u5165\u4e86 `CloneSetShortHash` \u65b0\u7684 feature-gate\u3002 \u5982\u679c\u5b83\u88ab\u6253\u5f00\uff0cCloneSet \u53ea\u4f1a\u5c06 Pod \u4e2d\u7684 `controller-revision-hash` \u7684\u503c\u53ea\u8bbe\u7f6e\u4e3a hash \u503c\uff0c\u6bd4\u5982 956df7994\uff0c\u56e0\u6b64 CloneSet \u540d\u5b57\u7684\u957f\u5ea6\u4e0d\u4f1a\u6709\u4efb\u4f55\u9650\u5236\u4e86\u3002\uff08\u5373\u4f7f\u542f\u7528\u8be5\u529f\u80fd\uff0cCloneSet \u4ecd\u7136\u4f1a\u8bc6\u522b\u548c\u7ba1\u7406\u8fc7\u53bb\u5b58\u91cf\u7684 revision label \u4e3a\u5b8c\u6574\u683c\u5f0f\u7684 Pod\u3002\uff09\\n\\n## SidecarSet \u65b0\u589e\u529f\u80fd\\n\\n### Sidecar \u70ed\u5347\u7ea7\\n\\nSidecarSet \u662f Kruise \u63d0\u4f9b\u7684\u72ec\u7acb\u7ba1\u7406 sidecar \u5bb9\u5668\u7684 workload\u3002\u7528\u6237\u53ef\u4ee5\u901a\u8fc7 SidecarSet\uff0c\u6765\u5728\u4e00\u5b9a\u8303\u56f4\u7684 Pod \u4e2d\u6ce8\u5165\u548c\u5347\u7ea7\u6307\u5b9a\u7684 sidecar \u5bb9\u5668\u3002\\n\\n\u9ed8\u8ba4\u60c5\u51b5\u4e0b\uff0csidecar \u7684\u72ec\u7acb\u539f\u5730\u5347\u7ea7\u662f\u5148\u505c\u6b62\u65e7\u7248\u672c\u7684\u5bb9\u5668\uff0c\u7136\u540e\u521b\u5efa\u65b0\u7248\u672c\u7684\u5bb9\u5668\u3002\u8fd9\u79cd\u65b9\u5f0f\u66f4\u52a0\u9002\u5408\u4e0d\u5f71\u54cdPod\u670d\u52a1\u53ef\u7528\u6027\u7684sidecar\u5bb9\u5668\uff0c\u6bd4\u5982\u8bf4\u65e5\u5fd7\u6536\u96c6 agent\uff0c\u4f46\u662f\u5bf9\u4e8e\u5f88\u591a\u4ee3\u7406\u6216\u8fd0\u884c\u65f6\u7684 sidecar \u5bb9\u5668\uff0c\u4f8b\u5982 Istio Envoy\uff0c\u8fd9\u79cd\u5347\u7ea7\u65b9\u6cd5\u5c31\u6709\u95ee\u9898\u4e86\u3002Envoy \u4f5c\u4e3a Pod \u4e2d\u7684\u4e00\u4e2a\u4ee3\u7406\u5bb9\u5668\uff0c\u4ee3\u7406\u4e86\u6240\u6709\u7684\u6d41\u91cf\uff0c\u5982\u679c\u76f4\u63a5\u91cd\u542f\u5347\u7ea7\uff0cPod \u670d\u52a1\u7684\u53ef\u7528\u6027\u4f1a\u53d7\u5230\u5f71\u54cd\u3002\u5982\u679c\u9700\u8981\u5355\u72ec\u5347\u7ea7 envoy sidecar\uff0c\u5c31\u9700\u8981\u590d\u6742\u7684 grace \u7ec8\u6b62\u548c\u534f\u8c03\u673a\u5236\u3002\u6240\u4ee5\u6211\u4eec\u4e3a\u8fd9\u79cd sidecar \u5bb9\u5668\u7684\u5347\u7ea7\u63d0\u4f9b\u4e86\u4e00\u79cd\u65b0\u7684\u89e3\u51b3\u65b9\u6848\uff0c\u5373\u70ed\u5347\u7ea7\uff08hot upgrade\uff09\u3002\\n\\n```yaml\\napiVersion: apps.kruise.io/v1alpha1\\nkind: SidecarSet\\nspec:\\n  # ...\\n  containers:\\n  - name: nginx-sidecar\\n    image: nginx:1.18\\n    lifecycle:\\n      postStart:\\n        exec:\\n          command:\\n          - /bin/bash\\n          - -c\\n          - /usr/local/bin/nginx-agent migrate\\n    upgradeStrategy:\\n      upgradeType: HotUpgrade\\n      hotUpgradeEmptyImage: empty:1.0.0\\n```\\n\\n- `upgradeType`: HotUpgrade\u4ee3\u8868\u8be5sidecar\u5bb9\u5668\u7684\u7c7b\u578b\u662fhot upgrade\uff0c\u5c06\u6267\u884c\u70ed\u5347\u7ea7\u65b9\u6848hotUpgradeEmptyImage: \u5f53\u70ed\u5347\u7ea7sidecar\u5bb9\u5668\u65f6\uff0c\u4e1a\u52a1\u5fc5\u987b\u8981\u63d0\u4f9b\u4e00\u4e2aempty\u5bb9\u5668\u7528\u4e8e\u70ed\u5347\u7ea7\u8fc7\u7a0b\u4e2d\u7684\u5bb9\u5668\u5207\u6362\u3002empty\u5bb9\u5668\u540csidecar\u5bb9\u5668\u5177\u6709\u76f8\u540c\u7684\u914d\u7f6e\uff08\u9664\u4e86\u955c\u50cf\u5730\u5740\uff09\uff0c\u4f8b\u5982\uff1acommand, lifecycle, probe\u7b49\uff0c\u4f46\u662f\u5b83\u4e0d\u505a\u4efb\u4f55\u5de5\u4f5c\u3002\\n- `lifecycle.postStart`: \u72b6\u6001\u8fc1\u79fb\uff0c\u8be5\u8fc7\u7a0b\u5b8c\u6210\u70ed\u5347\u7ea7\u8fc7\u7a0b\u4e2d\u7684\u72b6\u6001\u8fc1\u79fb\uff0c\u8be5\u811a\u672c\u9700\u8981\u7531\u4e1a\u52a1\u6839\u636e\u81ea\u8eab\u7684\u7279\u70b9\u81ea\u884c\u5b9e\u73b0\uff0c\u4f8b\u5982\uff1anginx\u70ed\u5347\u7ea7\u9700\u8981\u5b8c\u6210Listen FD\u5171\u4eab\u4ee5\u53ca\u6d41\u91cf\u6392\u6c34\uff08reload\uff09\\n\\n\\n## \u66f4\u591a\\n\\n\u66f4\u591a\u7248\u672c\u53d8\u5316\uff0c\u8bf7\u53c2\u8003 [release page](https://github.com/openkruise/kruise/releases) \u6216 [ChangeLog](https://github.com/openkruise/kruise/blob/master/CHANGELOG.md)"},{"id":"sidecarset","metadata":{"permalink":"/zh/blog/sidecarset","editUrl":"https://github.com/openkruise/openkruise.io/edit/master/blog/2021-03-15-sidecarSet-0.8.0.md","source":"@site/i18n/zh/docusaurus-plugin-content-blog/2021-03-15-sidecarSet-0.8.0.md","title":"OpenKruise 0.8.0, A Powerful Tool for Sidecar Container Management","description":"OpenKruise \u662f\u963f\u91cc\u4e91\u5f00\u6e90\u7684\u4e91\u539f\u751f\u5e94\u7528\u81ea\u52a8\u5316\u7ba1\u7406\u5957\u4ef6\uff0c\u4e5f\u662f\u5f53\u524d\u6258\u7ba1\u5728 Cloud Native Computing Foundation (CNCF) \u4e0b\u7684Sandbox\u9879\u76ee\u3002\u5b83\u6765\u81ea\u963f\u91cc\u5df4\u5df4\u591a\u5e74\u6765\u5bb9\u5668\u5316\u3001\u4e91\u539f\u751f\u7684\u6280\u672f\u6c89\u6dc0\uff0c\u662f\u963f\u91cc\u5185\u90e8\u751f\u4ea7\u73af\u5883\u5927\u89c4\u6a21\u5e94\u7528\u7684\u57fa\u4e8eKubernetes\u4e4b\u4e0a\u7684\u6807\u51c6\u6269\u5c55\u7ec4\u4ef6\uff0c\u4e5f\u662f\u7d27\u8d34\u4e0a\u6e38\u793e\u533a\u6807\u51c6\u3001\u9002\u5e94\u4e92\u8054\u7f51\u89c4\u6a21\u5316\u573a\u666f\u7684\u6280\u672f\u7406\u5ff5\u4e0e\u6700\u4f73\u5b9e\u8df5\u3002","date":"2021-03-15T00:00:00.000Z","tags":[{"inline":true,"label":"workload","permalink":"/zh/blog/tags/workload"},{"inline":true,"label":"sidecar","permalink":"/zh/blog/tags/sidecar"}],"readingTime":10.76,"hasTruncateMarker":false,"authors":[{"name":"Mingshan Zhao","title":"Member of OpenKruise","url":"https://github.com/zmberg","imageURL":"https://github.com/zmberg.png","key":"zmberg","page":null}],"frontMatter":{"slug":"sidecarset","title":"OpenKruise 0.8.0, A Powerful Tool for Sidecar Container Management","authors":["zmberg"],"tags":["workload","sidecar"]},"unlisted":false,"prevItem":{"title":"OpenKruise 0.9.0\uff1a\u65b0\u589ePod\u5bb9\u5668\u91cd\u542f\u3001\u8d44\u6e90\u5220\u9664\u9632\u62a4\u7b49\u529f\u80fd","permalink":"/zh/blog/openkruise-0.9.0"},"nextItem":{"title":"UnitedDeploymemt - Supporting Multi-domain Workload Management","permalink":"/zh/blog/uniteddeployment"}},"content":"OpenKruise \u662f\u963f\u91cc\u4e91\u5f00\u6e90\u7684\u4e91\u539f\u751f\u5e94\u7528\u81ea\u52a8\u5316\u7ba1\u7406\u5957\u4ef6\uff0c\u4e5f\u662f\u5f53\u524d\u6258\u7ba1\u5728 Cloud Native Computing Foundation (CNCF) \u4e0b\u7684Sandbox\u9879\u76ee\u3002\u5b83\u6765\u81ea\u963f\u91cc\u5df4\u5df4\u591a\u5e74\u6765\u5bb9\u5668\u5316\u3001\u4e91\u539f\u751f\u7684\u6280\u672f\u6c89\u6dc0\uff0c\u662f\u963f\u91cc\u5185\u90e8\u751f\u4ea7\u73af\u5883\u5927\u89c4\u6a21\u5e94\u7528\u7684\u57fa\u4e8eKubernetes\u4e4b\u4e0a\u7684\u6807\u51c6\u6269\u5c55\u7ec4\u4ef6\uff0c\u4e5f\u662f\u7d27\u8d34\u4e0a\u6e38\u793e\u533a\u6807\u51c6\u3001\u9002\u5e94\u4e92\u8054\u7f51\u89c4\u6a21\u5316\u573a\u666f\u7684\u6280\u672f\u7406\u5ff5\u4e0e\u6700\u4f73\u5b9e\u8df5\u3002\\n\\nOpenKruise\u57282021.3.4\u53d1\u5e03\u4e86\u6700\u65b0\u7684v0.8.0\u7248\u672c\uff0c\u5176\u4e2d\u589e\u5f3a\u4e86SidecarSet\u7684\u80fd\u529b\uff0c\u7279\u522b\u662f\u5bf9\u65e5\u5fd7\u7ba1\u7406\u7c7bSidecar\u6709\u4e86\u66f4\u52a0\u5b8c\u5584\u7684\u652f\u6301\u3002\\n\\n# \u80cc\u666f\\nSidecar\u662f\u4e91\u539f\u751f\u4e2d\u4e00\u79cd\u975e\u5e38\u91cd\u8981\u7684\u5bb9\u5668\u8bbe\u8ba1\u6a21\u5f0f\uff0c\u5b83\u5c06\u8f85\u52a9\u80fd\u529b\u4ece\u4e3b\u5bb9\u5668\u4e2d\u5265\u79bb\u51fa\u6765\u6210\u4e3a\u5355\u72ec\u7684sidecar\u5bb9\u5668\u3002\u5728\u5fae\u670d\u52a1\u67b6\u6784\u4e2d\uff0c\u901a\u5e38\u4e5f\u4f7f\u7528sidecar\u6a21\u5f0f\u5c06\u5fae\u670d\u52a1\u4e2d\u7684\u914d\u7f6e\u7ba1\u7406\u3001\u670d\u52a1\u53d1\u73b0\u3001\u8def\u7531\u3001\u7194\u65ad\u7b49\u901a\u7528\u80fd\u529b\u4ece\u4e3b\u7a0b\u5e8f\u4e2d\u5265\u79bb\u51fa\u6765\uff0c\u4ece\u800c\u6781\u5927\u964d\u4f4e\u4e86\u5fae\u670d\u52a1\u67b6\u6784\u4e2d\u7684\u590d\u6742\u6027\u3002\u968f\u7740Service Mesh\u7684\u9010\u6b65\u98ce\u9761\uff0csidecar\u6a21\u5f0f\u4e5f\u65e5\u76ca\u6df1\u5165\u4eba\u5fc3\uff0c\u5728\u963f\u91cc\u5df4\u5df4\u96c6\u56e2\u5185\u90e8\u4e5f\u5927\u91cf\u4f7f\u7528sidecar\u6a21\u5f0f\u6765\u7ba1\u7406\u8bf8\u5982\u8fd0\u7ef4\u3001\u5b89\u5168\u3001\u6d88\u606f\u4e2d\u95f4\u4ef6\u7b49\u901a\u7528\u7ec4\u4ef6\u3002\\n\\n\u5728Kubernetes\u96c6\u7fa4\u4e2d\uff0cPod\u4e0d\u4ec5\u53ef\u4ee5\u5b9e\u73b0\u4e3b\u5bb9\u5668\u4e0esidecar\u5bb9\u5668\u7684\u6784\u5efa\uff0c\u540c\u65f6\u63d0\u4f9b\u4e86\u8bb8\u591a\u529f\u80fd\u5f3a\u5927\u7684workload\uff08\u4f8b\u5982\uff1adeployment\u3001statefulset\uff09\u6765\u5bf9Pod\u8fdb\u884c\u7ba1\u7406\u3001\u5347\u7ea7\u3002\u4f46\u662f\u968f\u7740kubernetes\u96c6\u7fa4\u4e0a\u7684\u4e1a\u52a1\u65e5\u76ca\u589e\u591a\uff0csidecar\u5bb9\u5668\u7684\u79cd\u7c7b\u4e0e\u89c4\u6a21\u4e5f\u968f\u4e4b\u65e5\u76ca\u5e9e\u5927\uff0c\u5bf9\u7ebf\u4e0asidecar\u5bb9\u5668\u7684\u7ba1\u7406\u548c\u5347\u7ea7\u6210\u4e3a\u4e86\u6108\u53d1\u7e41\u6742\u7684\u5de5\u4f5c\uff1a\\n\\n1. \u4e1a\u52a1Pod\u91cc\u9762\u5305\u542b\u4e86\u8fd0\u7ef4\u3001\u5b89\u5168\u3001\u4ee3\u7406\u7b49\u591a\u4e2asidecar\u5bb9\u5668\uff0c\u4e1a\u52a1\u7ebf\u540c\u5b66\u4e0d\u4ec5\u8981\u5b8c\u6210\u81ea\u8eab\u4e3b\u5bb9\u5668\u7684\u914d\u7f6e\uff0c\u800c\u4e14\u8fd8\u9700\u8981\u719f\u6089\u8fd9\u4e9bsidecar\u5bb9\u5668\u7684\u914d\u7f6e\uff0c\u8fd9\u4e0d\u4ec5\u589e\u52a0\u4e86\u4e1a\u52a1\u540c\u5b66\u7684\u5de5\u4f5c\u91cf\uff0c\u540c\u65f6\u4e5f\u65e0\u5f62\u589e\u52a0\u4e86sidecar\u5bb9\u5668\u914d\u7f6e\u7684\u98ce\u9669\u3002\\n2. sidecar\u5bb9\u5668\u7684\u5347\u7ea7\u9700\u8981\u8fde\u540c\u4e1a\u52a1\u4e3b\u5bb9\u5668\u4e00\u8d77\u91cd\u542f\uff08deployment\u3001statefulset\u7b49workload\u57fa\u4e8ePod\u9500\u6bc1\u3001\u91cd\u5efa\u7684\u6a21\u5f0f\uff0c\u6765\u5b9e\u73b0Pod\u7684\u6eda\u52a8\u5347\u7ea7\uff09\uff0c\u63a8\u52a8\u548c\u5347\u7ea7\u652f\u6491\u7740\u7ebf\u4e0a\u6570\u767e\u6b3e\u4e1a\u52a1\u7684sidecar\u5bb9\u5668\uff0c\u5fc5\u7136\u5b58\u5728\u7740\u6781\u5927\u7684\u4e1a\u52a1\u963b\u529b\u3002\\n3. \u4f5c\u4e3asidecar\u5bb9\u5668\u7684\u63d0\u4f9b\u8005\u5bf9\u7ebf\u4e0a\u8bf8\u591a\u5404\u79cd\u914d\u7f6e\u4ee5\u53ca\u7248\u672c\u7684sidecar\u5bb9\u5668\u6ca1\u6709\u76f4\u63a5\u6709\u6548\u7684\u5347\u7ea7\u624b\u6bb5\uff0c\u8fd9\u5bf9sidecar\u5bb9\u5668\u7684\u7ba1\u7406\u610f\u5473\u7740\u6781\u5927\u7684\u6f5c\u5728\u98ce\u9669\u3002\\n\\n\u963f\u91cc\u5df4\u5df4\u96c6\u56e2\u5185\u90e8\u62e5\u6709\u7740\u767e\u4e07\u7ea7\u7684\u5bb9\u5668\u6570\u91cf\u8fde\u540c\u4e0a\u9762\u627f\u8f7d\u7684\u4e0a\u5343\u4e2a\u4e1a\u52a1\uff0c\u56e0\u6b64\uff0csidecar\u5bb9\u5668\u7684\u7ba1\u7406\u4e0e\u5347\u7ea7\u4e5f\u5c31\u6210\u4e3a\u4e86\u4e9f\u5f85\u5b8c\u5584\u7684\u4e3b\u9898\u3002\u56e0\u6b64\uff0c\u6211\u4eec\u603b\u7ed3\u4e86\u5185\u90e8\u8bb8\u591asidecar\u5bb9\u5668\u7684\u901a\u7528\u5316\u9700\u6c42\uff0c\u5e76\u5c06\u5176\u6c89\u6dc0\u5230OpenKruise\u4e0a\u9762\uff0c\u6700\u7ec8\u62bd\u8c61\u4e3aSidecarSet\u4f5c\u4e3a\u7ba1\u7406\u548c\u5347\u7ea7\u79cd\u7c7b\u7e41\u591asidecar\u5bb9\u5668\u7684\u5229\u5668\u3002\\n\\n# OpenKruise SidecarSet\\nSidecarSet\u662fOpenKruise\u4e2d\u9488\u5bf9sidecar\u62bd\u8c61\u51fa\u6765\u7684\u6982\u5ff5\uff0c\u8d1f\u8d23\u6ce8\u5165\u548c\u5347\u7ea7kubernetes\u96c6\u7fa4\u4e2d\u7684sidecar\u5bb9\u5668\uff0c\u662fOpenKruise\u7684\u6838\u5fc3workload\u4e4b\u4e00\u3002\u5b83\u63d0\u4f9b\u4e86\u975e\u5e38\u4e30\u5bcc\u7684\u529f\u80fd\uff0c\u7528\u6237\u4f7f\u7528SidecarSet\u53ef\u4ee5\u975e\u5e38\u65b9\u4fbf\u5b9e\u73b0sidecar\u5bb9\u5668\u7684\u7ba1\u7406\u3002\u4e3b\u8981\u7279\u6027\u5982\u4e0b\uff1a\\n\\n1. \u914d\u7f6e\u5355\u72ec\u7ba1\u7406\uff1a\u4e3a\u6bcf\u4e00\u4e2asidecar\u5bb9\u5668\u914d\u7f6e\u5355\u72ec\u7684SidecarSet\u914d\u7f6e\uff0c\u65b9\u4fbf\u7ba1\u7406\\n2. \u81ea\u52a8\u6ce8\u5165\uff1a\u5728\u65b0\u5efa\u3001\u6269\u5bb9\u3001\u91cd\u5efapod\u7684\u573a\u666f\u4e2d\uff0c\u5b9e\u73b0sidecar\u5bb9\u5668\u7684\u81ea\u52a8\u6ce8\u5165\\n3. \u539f\u5730\u5347\u7ea7\uff1a\u652f\u6301\u4e0d\u91cd\u5efapod\u7684\u65b9\u5f0f\u5b8c\u6210sidecar\u5bb9\u5668\u7684\u539f\u5730\u5347\u7ea7\uff0c\u4e0d\u5f71\u54cd\u4e1a\u52a1\u4e3b\u5bb9\u5668\uff0c\u5e76\u5305\u542b\u4e30\u5bcc\u7684\u7070\u5ea6\u53d1\u5e03\u7b56\u7565\\n\\n\u6ce8\u610f\uff1a\u9488\u5bf9Pod\u4e2d\u5305\u542b\u591a\u4e2a\u5bb9\u5668\u7684\u6a21\u5f0f\uff0c\u5176\u4e2d\u5bf9\u5916\u63d0\u4f9b\u4e3b\u8981\u4e1a\u52a1\u903b\u8f91\u80fd\u529b\u7684\u5bb9\u5668\u79f0\u4e4b\u4e3a \u4e3b\u5bb9\u5668\uff0c\u5176\u5b83\u4e00\u4e9b\u5982\u65e5\u5fd7\u91c7\u96c6\u3001\u5b89\u5168\u3001\u4ee3\u7406\u7b49\u8f85\u52a9\u80fd\u529b\u7684\u5bb9\u5668\u79f0\u4e4b\u4e3a Sidecar\u5bb9\u5668\u3002\u4f8b\u5982\uff1a\u4e00\u4e2a\u5bf9\u5916\u63d0\u4f9bweb\u80fd\u529b\u7684pod\uff0cnginx\u5bb9\u5668\u63d0\u4f9b\u4e3b\u8981\u7684web server\u80fd\u529b\u5373\u4e3a \u4e3b\u5bb9\u5668\uff0clogtail\u5bb9\u5668\u8d1f\u8d23\u91c7\u96c6\u3001\u4e0a\u62a5nginx\u65e5\u5fd7\u5373\u4e3a Sidecar\u5bb9\u5668\u3002\u672c\u6587\u4e2d\u7684SidecarSet\u8d44\u6e90\u62bd\u8c61\u4e5f\u662f\u4e3a\u89e3\u51b3 Sidecar\u5bb9\u5668 \u7684\u4e00\u4e9b\u95ee\u9898\u3002\\n\\n## Sidecar logging architectures\\n\u5e94\u7528\u65e5\u5fd7\u53ef\u4ee5\u8ba9\u4f60\u4e86\u89e3\u5e94\u7528\u5185\u90e8\u7684\u8fd0\u884c\u72b6\u51b5\uff0c\u65e5\u5fd7\u5bf9\u8c03\u8bd5\u95ee\u9898\u548c\u76d1\u63a7\u96c6\u7fa4\u6d3b\u52a8\u975e\u5e38\u6709\u7528\u3002\u5e94\u7528\u5bb9\u5668\u5316\u540e\uff0c\u6700\u7b80\u5355\u4e14\u6700\u5e7f\u6cdb\u91c7\u7528\u7684\u65e5\u5fd7\u8bb0\u5f55\u65b9\u5f0f\u5c31\u662f\u5199\u5165\u6807\u51c6\u8f93\u51fa\u548c\u6807\u51c6\u9519\u8bef\u3002\\n\\n\u4f46\u662f\uff0c\u5728\u5f53\u524d\u5206\u5e03\u5f0f\u7cfb\u7edf\u3001\u5927\u89c4\u6a21\u96c6\u7fa4\u7684\u65f6\u4ee3\u4e0b\uff0c\u4e0a\u8ff0\u65b9\u6848\u8fd8\u4e0d\u8db3\u4ee5\u8fbe\u5230\u751f\u4ea7\u73af\u5883\u7684\u6807\u51c6\u3002\u9996\u5148\uff0c\u5bf9\u4e8e\u5206\u5e03\u5f0f\u7cfb\u7edf\u800c\u8a00\uff0c\u65e5\u5fd7\u90fd\u662f\u5206\u6563\u5728\u5355\u4e2a\u5bb9\u5668\u91cc\u9762\uff0c\u6ca1\u6709\u4e00\u4e2a\u7edf\u4e00\u6c47\u603b\u7684\u5730\u65b9\u3002\u5176\u6b21\uff0c\u5982\u679c\u53d1\u751f\u5bb9\u5668\u5d29\u6e83\u3001Pod\u88ab\u9a71\u9010\u7b49\u573a\u666f\uff0c\u4f1a\u51fa\u73b0\u65e5\u5fd7\u4e22\u5931\u7684\u60c5\u51b5\u3002\u56e0\u6b64\uff0c\u9700\u8981\u4e00\u79cd\u66f4\u52a0\u53ef\u9760\uff0c\u72ec\u7acb\u4e8e\u5bb9\u5668\u751f\u547d\u5468\u671f\u7684\u65e5\u5fd7\u89e3\u51b3\u65b9\u6848\u3002\\n\\nSidecar logging architectures \u662f\u5c06logging agent\u653e\u5230\u4e00\u4e2a\u72ec\u7acb\u7684sidecar\u5bb9\u5668\u4e2d\uff0c\u901a\u8fc7\u5171\u4eab\u65e5\u5fd7\u76ee\u5f55\u7684\u65b9\u5f0f\uff0c\u5b9e\u73b0\u5bb9\u5668\u65e5\u5fd7\u7684\u91c7\u96c6\uff0c\u7136\u540e\u5b58\u50a8\u5230\u65e5\u5fd7\u5e73\u53f0\u7684\u540e\u7aef\u5b58\u50a8\u3002\\n\\n![logsidecar](../../../static/img/blog/2021-03-15-sidecarset/logsidecar.png)\\n\\n\u963f\u91cc\u5df4\u5df4\u4ee5\u53ca\u8682\u8681\u96c6\u56e2\u5185\u90e8\u540c\u6837\u4e5f\u662f\u57fa\u4e8e\u8fd9\u79cd\u67b6\u6784\u5b9e\u73b0\u4e86\u5bb9\u5668\u7684\u65e5\u5fd7\u91c7\u96c6\uff0c\u4e0b\u9762\u6211\u5c06\u4ecb\u7ecdOpenKruise SidecarSet\u5982\u4f55\u52a9\u529b Sidecar\u65e5\u5fd7\u67b6\u6784\u5728kubernetes\u96c6\u7fa4\u4e2d\u7684\u5927\u89c4\u6a21\u843d\u5730\u5b9e\u8df5\u3002\\n\\n## \u81ea\u52a8\u6ce8\u5165\\nOpenKruise SidecarSet\u57fa\u4e8ekubernetes AdmissionWebhook\u673a\u5236\u5b9e\u73b0\u4e86sidecar\u5bb9\u5668\u7684\u81ea\u52a8\u6ce8\u5165\uff0c\u56e0\u6b64\u53ea\u8981\u5c06sidecar\u914d\u7f6e\u5230SidecarSet\u4e2d\uff0c\u4e0d\u7ba1\u7528\u6237\u7528 CloneSet\u3001Deployment\u3001StatefulSet \u7b49\u4efb\u4f55\u65b9\u5f0f\u90e8\u7f72\uff0c\u6269\u51fa\u6765\u7684 Pod \u4e2d\u90fd\u4f1a\u6ce8\u5165\u5b9a\u4e49\u597d\u7684 sidecar \u5bb9\u5668\u3002\\n\\n![inject sidecar](../../../static/img/blog/2021-03-15-sidecarset/inject_sidecar.png)\\n\\nSidecar\u5bb9\u5668\u7684\u6240\u6709\u8005\u53ea\u9700\u8981\u914d\u7f6e\u81ea\u8eab\u7684SidecarSet\uff0c\u5c31\u53ef\u4ee5\u5728\u4e1a\u52a1\u65e0\u611f\u77e5\u7684\u60c5\u51b5\u4e0b\u5b8c\u6210sidecar\u5bb9\u5668\u7684\u6ce8\u5165\uff0c\u8fd9\u79cd\u65b9\u5f0f\u6781\u5927\u7684\u964d\u4f4e\u4e86sidecar\u5bb9\u5668\u4f7f\u7528\u7684\u95e8\u69db\uff0c\u4e5f\u65b9\u4fbf\u4e86sidecar\u6240\u6709\u8005\u7684\u7ba1\u7406\u5de5\u4f5c\u3002\u4e3a\u4e86\u6ee1\u8db3sidecar\u6ce8\u5165\u7684\u591a\u79cd\u573a\u666f\uff0cSidecarSet\u9664containers\u4e4b\u5916\u8fd8\u6269\u5c55\u4e86\u5982\u4e0b\u5b57\u6bb5\uff1a\\n```\\n# sidecarset.yaml\\napiVersion: apps.kruise.io/v1alpha1\\nkind: SidecarSet\\nmetadata:\\n  name: test-sidecarset\\nspec:\\n  # \u901a\u8fc7selector\u9009\u62e9pod\\n  selector:\\n    matchLabels:\\n      app: web-server\\n  # \u6307\u5b9a namespace \u751f\u6548\\n  namespace: ns-1\\n  # container definition\\n  containers:\\n  - name: logtail\\n    image: logtail:1.0.0\\n    # \u5171\u4eab\u6307\u5b9a\u5377\\n    volumeMounts:\\n    - name: web-log\\n      mountPath: /var/log/web\\n    # \u5171\u4eab\u6240\u6709\u5377\\n    shareVolumePolicy:\\n      type: disabled\\n    # \u73af\u5883\u53d8\u91cf\u5171\u4eab\\n    transferEnv:\\n    - sourceContainerName: web-server\\n    # TZ\u4ee3\u8868\u65f6\u533a\uff0c\u4f8b\u5982\uff1aweb-server\u5bb9\u5668\u4e2d\u5b58\u5728\u73af\u5883\u53d8\u91cf TZ=Asia/Shanghai\\n      envName: TZ\\n  volumes:\\n    - name: web-log\\n      emptyDir: {}\\n```\\n\\n- Pod\u9009\u62e9\u5668\\n  - \u652f\u6301selector\u6765\u9009\u62e9\u8981\u6ce8\u5165\u7684Pod\uff0c\u5982\u793a\u4f8b\u4e2d\u5c06\u9009\u62e9labels[app] = web-server\u7684pod\uff0c\u5c06logtail\u5bb9\u5668\u6ce8\u5165\u8fdb\u53bb\uff0c\u4e5f\u53ef\u4ee5\u5728\u6240\u6709\u7684pod\u4e2d\u6dfb\u52a0\u4e00\u4e2alabels[inject/logtail] = true\u7684\u65b9\u5f0f\uff0c\u6765\u5b9e\u73b0\u5168\u5c40\u6027\u7684sidecar\u6ce8\u5165\u3002\\n  - namespace\uff1asidecarSet\u9ed8\u8ba4\u662f\u5168\u5c40\u751f\u6548\u7684\uff0c\u5982\u679c\u53ea\u60f3\u5bf9\u67d0\u4e00\u4e2anamespace\u751f\u6548\uff0c\u5219\u914d\u7f6e\u8be5\u53c2\u6570\\n- \u6570\u636e\u5377\u5171\u4eab\uff1a\\n  - \u5171\u4eab\u6307\u5b9a\u5377\uff1a\u901a\u8fc7volumeMounts\u548cvolumes\u53ef\u4ee5\u5b8c\u6210\u4e0e\u4e3b\u5bb9\u5668\u7684\u7279\u5b9a\u5377\u7684\u5171\u4eab\uff0c\u5982\u793a\u4f8b\u4e2d\u901a\u8fc7\u5171\u4eabweb-log volume\u6765\u8fbe\u5230\u65e5\u5fd7\u91c7\u96c6\u7684\u6548\u679c\\n  - \u5171\u4eab\u6240\u6709\u5377\uff1a\u901a\u8fc7 shareVolumePolicy = enabled | disabled \u6765\u63a7\u5236\u662f\u5426\u6302\u8f7dpod\u4e3b\u5bb9\u5668\u7684\u6240\u6709\u5377\u5377\uff0c\u5e38\u7528\u4e8e\u65e5\u5fd7\u6536\u96c6\u7b49 sidecar\uff0c\u914d\u7f6e\u4e3a enabled \u540e\u4f1a\u628a\u5e94\u7528\u5bb9\u5668\u4e2d\u6240\u6709\u6302\u8f7d\u70b9\u6ce8\u5165 sidecar \u540c\u4e00\u8def\u7ecf\u4e0b(sidecar\u4e2d\u672c\u8eab\u5c31\u6709\u58f0\u660e\u7684\u6570\u636e\u5377\u548c\u6302\u8f7d\u70b9\u9664\u5916\uff09\\n- \u73af\u5883\u53d8\u91cf\u5171\u4eab \u53ef\u4ee5\u901a\u8fc7 transferEnv \u4ece\u5176\u5b83\u5bb9\u5668\u4e2d\u83b7\u53d6\u73af\u5883\u53d8\u91cf\uff0c\u4f1a\u628a\u540d\u4e3a sourceContainerName \u5bb9\u5668\u4e2d\u540d\u4e3a envName \u7684\u73af\u5883\u53d8\u91cf\u62f7\u8d1d\u5230\u672csidecar\u5bb9\u5668\uff0c\u5982\u793a\u4f8b\u4e2d \u65e5\u5fd7sidecar\u5bb9\u5668\u5171\u4eab\u4e86\u4e3b\u5bb9\u5668\u7684\u65f6\u533aTZ\uff0c\u8fd9\u5728\u6d77\u5916\u73af\u5883\u4e2d\u5c24\u5176\u5e38\u89c1\\n\\n\u6ce8\u610f\uff1akubernetes\u793e\u533a\u5bf9\u4e8e\u5df2\u7ecf\u521b\u5efa\u7684Pod\u4e0d\u5141\u8bb8\u4fee\u6539container\u6570\u91cf\uff0c\u6240\u4ee5\u4e0a\u8ff0\u6ce8\u5165\u80fd\u529b\u53ea\u80fd\u53d1\u751f\u5728Pod\u521b\u5efa\u9636\u6bb5\uff0c\u5bf9\u4e8e\u5df2\u7ecf\u521b\u5efa\u7684Pod\u9700\u8981\u901a\u8fc7\u91cd\u5efa\u7684\u65b9\u5f0f\u6765\u6ce8\u5165\u3002\\n\\n## \u539f\u5730\u5347\u7ea7\\nSidecarSet\u4e0d\u4ec5\u5b9e\u73b0sidecar\u5bb9\u5668\u7684\u6ce8\u5165\uff0c\u800c\u4e14\u590d\u7528\u4e86OpenKruise\u4e2d\u539f\u5730\u5347\u7ea7\u7684\u7279\u6027\uff0c\u5b9e\u73b0\u4e86\u5728\u4e0d\u91cd\u542fPod\u548c\u4e3b\u5bb9\u5668\u7684\u524d\u63d0\u4e0b\u5355\u72ec\u5347\u7ea7sidecar\u5bb9\u5668\u7684\u80fd\u529b\u3002\u7531\u4e8e\u8fd9\u79cd\u5347\u7ea7\u65b9\u5f0f\u57fa\u672c\u4e0a\u80fd\u505a\u5230\u4e1a\u52a1\u65b9\u65e0\u611f\u77e5\u7684\u7a0b\u5ea6\uff0c\u6240\u4ee5sidecar\u5bb9\u5668\u7684\u5347\u7ea7\u5df2\u4e0d\u518d\u662f\u4e0a\u4e0b\u4ea4\u56f0\u7684\u96be\u9898\uff0c\u4ece\u800c\u6781\u5927\u89e3\u653e\u4e86sidecar\u7684\u6240\u6709\u8005\uff0c\u63d0\u5347\u4e86sidecar\u7248\u672c\u8fed\u4ee3\u7684\u901f\u5ea6\u3002\\n\\n![inplace sidecar](../../../static/img/blog/2021-03-15-sidecarset/inplace_sidecar.png)\\n\\n\u6ce8\u610f\uff1akubernetes\u793e\u533a\u5bf9\u4e8e\u5df2\u7ecf\u521b\u5efa\u7684Pod\u53ea\u5141\u8bb8\u4fee\u6539 container.image \u5b57\u6bb5\uff0c\u56e0\u6b64\u5bf9\u4e8esidecar\u5bb9\u5668\u7684\u4fee\u6539\u5305\u542b\u9664 container.image \u7684\u5176\u5b83\u5b57\u6bb5\uff0c\u5219\u9700\u8981\u901a\u8fc7Pod\u91cd\u5efa\u7684\u65b9\u5f0f\uff0c\u4e0d\u80fd\u76f4\u63a5\u539f\u5730\u5347\u7ea7\u3002\\n\\n\u4e3a\u4e86\u6ee1\u8db3\u4e00\u4e9b\u590d\u6742\u7684sidecar\u5347\u7ea7\u573a\u666f\uff0cSidecarSet\u9664\u4e86\u539f\u5730\u5347\u7ea7\u4ee5\u5916\uff0c\u8fd8\u63d0\u4f9b\u4e86\u975e\u5e38\u4e30\u5bcc\u7684\u7070\u5ea6\u53d1\u5e03\u7b56\u7565\u3002\\n\\n## \u7070\u5ea6\u53d1\u5e03\\n\u7070\u5ea6\u53d1\u5e03\u5e94\u8be5\u7b97\u662f\u65e5\u5e38\u53d1\u5e03\u4e2d\u6700\u5e38\u89c1\u7684\u4e00\u79cd\u624b\u6bb5\uff0c\u5b83\u80fd\u591f\u6bd4\u8f83\u5e73\u6ed1\u7684\u5b8c\u6210sidecar\u5bb9\u5668\u7684\u53d1\u5e03\uff0c\u5c24\u5176\u662f\u5728\u5927\u89c4\u6a21\u96c6\u7fa4\u7684\u573a\u666f\u4e0b\uff0c\u5f3a\u70c8\u5efa\u8bae\u4f7f\u7528\u8fd9\u79cd\u65b9\u5f0f\u3002\u4e0b\u9762\u662f \u9996\u6279\u6682\u505c\uff0c\u540e\u7eed\u57fa\u4e8e \u6700\u5927\u4e0d\u53ef\u7528 \u6eda\u52a8\u53d1\u5e03 \u7684\u4f8b\u5b50\uff0c\u5047\u8bbe\u4e00\u4e2a\u67091000\u4e2apod\u9700\u8981\u53d1\u5e03\uff1a\\n```yaml\\napiVersion: apps.kruise.io/v1alpha1\\nkind: SidecarSet\\nmetadata:\\n  name: sidecarset\\nspec:\\n  # ...\\n  updateStrategy:\\n    type: RollingUpdate\\n    partition: 980\\n    maxUnavailable: 10%\\n```\\n\\n\u4e0a\u8ff0\u914d\u7f6e\u9996\u5148\u53d1\u5e03\uff081000 - 980\uff09= 20 \u4e2apod\u4e4b\u540e\u5c31\u4f1a\u6682\u505c\u53d1\u5e03\uff0c\u4e1a\u52a1\u53ef\u4ee5\u89c2\u5bdf\u4e00\u6bb5\u65f6\u95f4\u53d1\u73b0 sidecar \u5bb9\u5668\u6b63\u5e38\u540e\uff0c\u8c03\u6574\u91cd\u65b0 update SidecarSet \u914d\u7f6e\uff1a\\n```yaml\\napiVersion: apps.kruise.io/v1alpha1\\nkind: SidecarSet\\nmetadata:\\n  name: sidecarset\\nspec:\\n  # ...\\n  updateStrategy:\\n    type: RollingUpdate\\n    maxUnavailable: 10%\\n```\\n\\n\u8fd9\u6837\u8c03\u6574\u540e\uff0c\u5bf9\u4e8e\u4f59\u4e0b\u7684 980 \u4e2apod\uff0c\u5c06\u4f1a\u6309\u7167\u6700\u5927\u4e0d\u53ef\u7528\u7684\u6570\u91cf\uff0810% * 1000 = 100\uff09\u7684\u987a\u5e8f\u8fdb\u884c\u53d1\u5e03\uff0c\u76f4\u5230\u6240\u6709\u7684pod\u90fd\u53d1\u5e03\u5b8c\u6210\u3002\\n\\nPartition \u7684\u8bed\u4e49\u662f \u4fdd\u7559\u65e7\u7248\u672c Pod \u7684\u6570\u91cf\u6216\u767e\u5206\u6bd4\uff0c\u9ed8\u8ba4\u4e3a 0\u3002\u8fd9\u91cc\u7684 partition \u4e0d\u8868\u793a\u4efb\u4f55 order \u5e8f\u53f7\u3002\u5982\u679c\u5728\u53d1\u5e03\u8fc7\u7a0b\u4e2d\u8bbe\u7f6e\u4e86 partition:\\n- \u5982\u679c\u662f\u6570\u5b57\uff0c\u63a7\u5236\u5668\u4f1a\u5c06 (replicas - partition) \u6570\u91cf\u7684 Pod \u66f4\u65b0\u5230\u6700\u65b0\u7248\u672c\u3002\\n- \u5982\u679c\u662f\u767e\u5206\u6bd4\uff0c\u63a7\u5236\u5668\u4f1a\u5c06 (replicas * (100% - partition)) \u6570\u91cf\u7684 Pod \u66f4\u65b0\u5230\u6700\u65b0\u7248\u672c\u3002\\n\\nMaxUnavailable \u662f\u53d1\u5e03\u8fc7\u7a0b\u4e2d\u4fdd\u8bc1\u7684\uff0c\u540c\u4e00\u65f6\u95f4\u4e0b\u6700\u5927\u4e0d\u53ef\u7528\u7684 Pod \u6570\u91cf\uff0c\u9ed8\u8ba4\u503c\u4e3a 1\u3002\u7528\u6237\u53ef\u4ee5\u5c06\u5176\u8bbe\u7f6e\u4e3a\u7edd\u5bf9\u503c\u6216\u767e\u5206\u6bd4\uff08\u767e\u5206\u6bd4\u4f1a\u88ab\u63a7\u5236\u5668\u6309\u7167selected pod\u505a\u57fa\u6570\u6765\u8ba1\u7b97\u51fa\u4e00\u4e2a\u80cc\u540e\u7684\u7edd\u5bf9\u503c\uff09\u3002\\n\\n\u6ce8\u610f\uff1amaxUnavailable \u548c partition \u4e24\u4e2a\u503c\u662f\u6ca1\u6709\u5fc5\u7136\u5173\u8054\u3002\u4e3e\u4f8b\uff1a\\n- \u5f53 \\\\{matched pod\\\\}=100,partition=50,maxUnavailable=10\uff0c\u63a7\u5236\u5668\u4f1a\u53d1\u5e03 50 \u4e2a Pod \u5230\u65b0\u7248\u672c\uff0c\u4f46\u662f\u53d1\u5e03\u7a97\u53e3\u4e3a 10\uff0c\u5373\u540c\u4e00\u65f6\u95f4\u53ea\u4f1a\u53d1\u5e03 10 \u4e2a Pod\uff0c\u6bcf\u53d1\u5e03\u597d\u4e00\u4e2a Pod \u624d\u4f1a\u518d\u627e\u4e00\u4e2a\u53d1\u5e03\uff0c\u76f4\u5230 50 \u4e2a\u53d1\u5e03\u5b8c\u6210\u3002\\n- \u5f53 \\\\{matched pod\\\\}=100,partition=80,maxUnavailable=30\uff0c\u63a7\u5236\u5668\u4f1a\u53d1\u5e03 20 \u4e2a Pod \u5230\u65b0\u7248\u672c\uff0c\u56e0\u4e3a\u6ee1\u8db3 maxUnavailable \u6570\u91cf\uff0c\u6240\u4ee5\u8fd9 20 \u4e2a Pod \u4f1a\u540c\u65f6\u53d1\u5e03\u3002\\n\\n## \u91d1\u4e1d\u96c0\u53d1\u5e03\\n\u5bf9\u4e8e\u6709\u91d1\u4e1d\u96c0\u53d1\u5e03\u9700\u6c42\u7684\u4e1a\u52a1\uff0c\u53ef\u4ee5\u901a\u8fc7strategy.selector\u6765\u5b9e\u73b0\u3002\u65b9\u5f0f\uff1a\u5bf9\u4e8e\u9700\u8981\u7387\u5148\u91d1\u4e1d\u96c0\u7070\u5ea6\u7684pod\u6253\u4e0a\u56fa\u5b9a\u7684labels[canary.release] = true\uff0c\u518d\u901a\u8fc7strategy.selector.matchLabels\u6765\u9009\u4e2d\u8be5pod\\n```yaml\\napiVersion: apps.kruise.io/v1alpha1\\nkind: SidecarSet\\nmetadata:\\n  name: sidecarset\\nspec:\\n  # ...\\n  updateStrategy:\\n    type: RollingUpdate\\n    selector:\\n      matchLabels:\\n        canary.release: \\"true\\"\\n    maxUnavailable: 10%\\n```\\n\\n\u4e0a\u8ff0\u914d\u7f6e\u53ea\u4f1a\u53d1\u5e03\u6253\u4e0a\u91d1\u4e1d\u96c0labels\u7684\u5bb9\u5668\uff0c\u5728\u5b8c\u6210\u91d1\u4e1d\u96c0\u9a8c\u8bc1\u4e4b\u540e\uff0c\u901a\u8fc7\u5c06 updateStrategy.selector \u914d\u7f6e\u53bb\u6389\uff0c\u5c31\u4f1a\u7ee7\u7eed\u901a\u8fc7 \u6700\u5927\u4e0d\u53ef\u7528 \u6765\u6eda\u52a8\u53d1\u5e03\u3002\\n\\n## \u6253\u6563\u53d1\u5e03\\nSidecarSet\u5bf9\u4e8epod\u7684\u5347\u7ea7\u987a\u5e8f\uff0c\u9ed8\u8ba4\u6309\u7167\u5982\u4e0b\u89c4\u5219\uff1a\\n- \u5bf9\u5347\u7ea7\u7684pod\u96c6\u5408\uff0c\u4fdd\u8bc1\u591a\u6b21\u5347\u7ea7\u7684\u987a\u5e8f\u4e00\u81f4\\n- \u9009\u62e9\u4f18\u5148\u987a\u5e8f\u662f\uff08\u8d8a\u5c0f\u4f18\u5148\u7ea7\u8d8a\u9ad8\uff09\uff1a unscheduled < scheduled, pending < unknown < running, not-ready < ready, newer pods < older pods\\n\\n\u9664\u4e86\u4e0a\u8ff0\u9ed8\u8ba4\u53d1\u5e03\u987a\u5e8f\u4e4b\u5916\uff0cscatter\u6253\u6563\u7b56\u7565\u5141\u8bb8\u7528\u6237 \u81ea\u5b9a\u4e49\u5c06\u7b26\u5408\u67d0\u4e9b\u6807\u7b7e\u7684 Pod \u6253\u6563 \u5230\u6574\u4e2a\u53d1\u5e03\u8fc7\u7a0b\u4e2d\u3002\u6bd4\u5982\uff0c\u5bf9\u4e8e\u50cf logtail \u8fd9\u79cd\u5168\u5c40\u6027\u7684 sidecar container\uff0c\u4e00\u4e2a\u96c6\u7fa4\u5f53\u4e2d\u5f88\u53ef\u80fd\u6ce8\u5165\u4e86\u51e0\u5341\u4e2a\u4e1a\u52a1pod\uff0c\u56e0\u6b64\u53ef\u4ee5\u4f7f\u7528\u57fa\u4e8e \u5e94\u7528\u540d \u7684\u65b9\u5f0f\u6765\u6253\u6563logtail\u7684\u65b9\u5f0f\u8fdb\u884c\u53d1\u5e03\uff0c\u5b9e\u73b0 \u4e0d\u540c\u5e94\u7528\u95f4\u6253\u6563\u7070\u5ea6\u53d1\u5e03 \u7684\u6548\u679c\uff0c\u5e76\u4e14\u8fd9\u79cd\u65b9\u5f0f\u53ef\u4ee5\u540c \u6700\u5927\u4e0d\u53ef\u7528 \u4e00\u8d77\u4f7f\u7528\u3002\\n```yaml\\napiVersion: apps.kruise.io/v1alpha1\\nkind: SidecarSet\\nmetadata:\\n  name: sidecarset\\nspec:\\n# ...\\n  updateStrategy:\\n    type: RollingUpdate\\n    # \u914d\u7f6epod labels\uff0c\u5047\u8bbe\u6240\u6709\u7684pod\u90fd\u5305\u542blabels[app_name]\\n    scatterStrategy:\\n    - key: app_name\\n      value: nginx\\n    - key: app_name\\n      value: web-server\\n    - key: app_name\\n      value: api-gateway\\n    maxUnavailable: 10%\\n```\\n\\n\u6ce8\u610f\uff1a\u5f53\u524d\u7248\u672c\u5fc5\u987b\u8981\u5217\u4e3e\u6240\u6709\u7684\u5e94\u7528\u540d\u79f0\uff0c\u6211\u4eec\u5c06\u5728\u4e0b\u4e2a\u7248\u672c\u652f\u6301 \u53ea\u914d\u7f6elabel key \u7684\u667a\u80fd\u6253\u6563\u65b9\u5f0f\u3002\\n\\n# \u603b\u7ed3\\n\u672c\u6b21 OpenKruise v0.8.0 \u7248\u672c\u7684\u5347\u7ea7\uff0cSidecarSet\u7279\u6027\u4e3b\u8981\u662f\u5b8c\u5584\u4e86 \u65e5\u5fd7\u7ba1\u7406\u7c7bSidecar \u573a\u666f\u7684\u80fd\u529b\uff0c\u540e\u7eed\u6211\u4eec\u5728\u6301\u7eed\u6df1\u8015SidecarSet\u7a33\u5b9a\u6027\u3001\u6027\u80fd\u7684\u540c\u65f6\uff0c\u4e5f\u5c06\u8986\u76d6\u66f4\u591a\u7684\u573a\u666f\uff0c\u6bd4\u5982\u4e0b\u4e00\u4e2a\u7248\u672c\u5c06\u4f1a\u589e\u52a0\u9488\u5bf9 Service Mesh\u573a\u666f \u7684\u652f\u6301\u3002\u540c\u65f6\uff0c\u6211\u4eec\u4e5f\u6b22\u8fce\u66f4\u591a\u7684\u540c\u5b66\u53c2\u4e0e\u5230 OpenKruise \u793e\u533a\u6765\uff0c\u5171\u540c\u5efa\u8bbe\u4e00\u4e2a\u573a\u666f\u66f4\u52a0\u4e30\u5bcc\u3001\u5b8c\u5584\u7684 K8s \u5e94\u7528\u7ba1\u7406\u3001\u4ea4\u4ed8\u6269\u5c55\u80fd\u529b\uff0c\u80fd\u591f\u9762\u5411\u66f4\u52a0\u89c4\u6a21\u5316\u3001\u590d\u6742\u5316\u3001\u6781\u81f4\u6027\u80fd\u7684\u573a\u666f\u3002"},{"id":"uniteddeployment","metadata":{"permalink":"/zh/blog/uniteddeployment","editUrl":"https://github.com/openkruise/openkruise.io/edit/master/blog/2019-11-20-uniteddeployment.md","source":"@site/blog/2019-11-20-uniteddeployment.md","title":"UnitedDeploymemt - Supporting Multi-domain Workload Management","description":"Ironically, probably every cloud user knew (or should realized that) failures in Cloud resources","date":"2019-11-20T00:00:00.000Z","tags":[{"inline":true,"label":"workload","permalink":"/zh/blog/tags/workload"},{"inline":true,"label":"uniteddeployment","permalink":"/zh/blog/tags/uniteddeployment"}],"readingTime":6.04,"hasTruncateMarker":false,"authors":[{"name":"Fei Guo","title":"Maintainer of OpenKruise","url":"https://github.com/Fei-Guo","imageURL":"https://github.com/Fei-Guo.png","key":"Fei-Guo","page":null}],"frontMatter":{"slug":"uniteddeployment","title":"UnitedDeploymemt - Supporting Multi-domain Workload Management","authors":["Fei-Guo"],"tags":["workload","uniteddeployment"]},"unlisted":false,"prevItem":{"title":"OpenKruise 0.8.0, A Powerful Tool for Sidecar Container Management","permalink":"/zh/blog/sidecarset"},"nextItem":{"title":"Learning Concurrent Reconciling","permalink":"/zh/blog/learning-concurrent-reconciling"}},"content":"Ironically, probably every cloud user knew (or should realized that) failures in Cloud resources\\nare inevitable. Hence, high availability is probably one of the most desirable features that\\nCloud Provider offers for cloud users. For example, in AWS, each geographic region has \\nmultiple isolated locations known as Availability Zones (AZs). \\nAWS provides various AZ-aware solutions to allow the compute or storage resources of the user\\napplications to be distributed across multiple AZs in order to tolerate AZ failure, which indeed\\nhappened in the past. \\n\\nIn Kubernetes, the concept of AZ is not realized by an API object. Instead,\\nan AZ is usually represented by a group of hosts that have the same location label.\\nAlthough hosts within the same AZ can be identified by labels, the capability of distributing Pods across\\nAZs was missing in Kubernetes default scheduler. Hence it was difficult to use single \\n`StatefulSet` or `Deployment` to perform  AZ-aware Pods deployment. Fortunately, \\nin Kubernetes 1.16, a new feature called [\\"Pod Topology Spread Constraints\\"](https://kubernetes.io/docs/concepts/workloads/pods/pod-topology-spread-constraints/)\\nwas introduced. Users now can add new constraints in the Pod Spec, and scheduler\\nwill enforce the constraints so that Pods can be distributed across failure \\ndomains such as AZs, regions or nodes, in a uniform fashion.\\n\\nIn Kruise, **UnitedDeploymemt** provides an alternative to achieve high availability in\\na cluster that consists of multiple fault domains - that is, managing multiple homogeneous \\nworkloads, and each workload is dedicated to a single `Subset`. Pod distribution across AZs is\\ndetermined by the replica number of each workload.\\nSince each `Subset` is associated with a workload, UnitedDeployment can support\\nfiner-grained rollout and deployment strategies. \\nIn addition, UnitedDeploymemt can be further extended to support\\nmultiple clusters! Let us reveal how UnitedDeployment is designed.\\n\\n\\n## Using `Subsets` to describe domain topology\\n\\nUnitedDeploymemt uses `Subset` to represent a failure domain. `Subset` API\\nprimarily specifies the nodes that forms the domain and the number of replicas, or\\nthe percentage of total replicas, run in this domain. UnitedDeployment manages\\nsubset workloads against a specific domain topology, described by a `Subset` array.\\n\\n```\\ntype Topology struct {\\n\\t// Contains the details of each subset.\\n\\tSubsets []Subset\\n}\\n\\ntype Subset struct {\\n\\t// Indicates the name of this subset, which will be used to generate\\n\\t// subset workload name prefix in the format \'<deployment-name>-<subset-name>-\'.\\n\\tName string\\n\\n\\t// Indicates the node select strategy to form the subset.\\n\\tNodeSelector corev1.NodeSelector\\n\\n\\t// Indicates the number of the subset replicas or percentage of it on the\\n\\t// UnitedDeployment replicas.\\n\\tReplicas *intstr.IntOrString\\n}\\n```\\n\\nThe specification of the subset workload is saved in `Spec.Template`. UnitedDeployment\\nonly supports `StatefulSet` subset workload as of now. An interesting part of `Subset`\\ndesign is that now user can specify **customized Pod distribution** across AZs, which is not\\nnecessarily a uniform distribution in some cases. For example, if the AZ\\nutilization or capacity are not homogeneous, evenly distributing Pods may lead to Pod deployment\\nfailure due to lack of resources. If users have prior knowledge about AZ resource capacity/usage,\\nUnitedDeployment can help to apply an optimal Pod distribution to ensure overall\\ncluster utilization remains balanced. Of course, if not specified, a uniform Pod distribution\\nwill be applied to maximize availability.\\n\\n## Customized subset rollout `Partitions`\\n\\nUser can update all the UnitedDeployment subset workloads by providing a\\nnew version of subset workload template.\\nNote that UnitedDeployment does not control\\nthe entire rollout process of all subset workloads, which is typically done by another rollout\\ncontroller built on top of it. Since the replica number in each `Subset` can be different,\\nit will be much more convenient to allow user to specify the individual rollout `Partition` of each\\nsubset workload instead of using one `Partition` to rule all, so that they can be upgraded in the same pace.\\nUnitedDeployment provides `ManualUpdate` strategy to customize per subset rollout `Partition`.\\n\\n```\\ntype UnitedDeploymentUpdateStrategy struct {\\n\\t// Type of UnitedDeployment update.\\n\\tType UpdateStrategyType\\n\\t// Indicates the partition of each subset.\\n\\tManualUpdate *ManualUpdate\\n}\\n\\ntype ManualUpdate struct {\\n\\t// Indicates number of subset partition.\\n\\tPartitions map[string]int32\\n}\\n```\\n\\n![multi-cluster controller](/img/blog/2019-11-20-uniteddeployment/uniteddeployment-1.png)\\n\\nThis makes it fairly easy to coordinate multiple subsets rollout. For example,\\nas illustrated in Figure 1, assuming UnitedDeployment manages three subsets and\\ntheir replica numbers are 4, 2, 2 respectively, a rollout \\ncontroller can realize a canary release plan of upgrading 50% of Pods in each\\nsubset at a time by setting subset partitions to 2, 1, 1 respectively. \\nThe same cannot be easily achieved by using a single workload controller like `StatefulSet`\\nor `Deployment`.\\n\\n## Multi-Cluster application management (In future)\\n\\nUnitedDeployment can be extended to support multi-cluster workload\\nmanagement. The idea is that `Subsets` may not only\\nreside in one cluster, but also spread over multiple clusters. \\nMore specifically, domain topology specification will associate\\na `ClusterRegistryQuerySpec`, which describes the clusters that UnitedDeployment\\nmay distribute Pods to. Each cluster is represented by a custom resource managed by a\\nClusterRegistry controller using Kubernetes [cluster registry APIs](https://github.com/kubernetes/cluster-registry).\\n\\n```\\ntype Topology struct {\\n  // ClusterRegistryQuerySpec is used to find the all the clusters that\\n  // the workload may be deployed to. \\n  ClusterRegistry *ClusterRegistryQuerySpec\\n  // Contains the details of each subset including the target cluster name and\\n  // the node selector in target cluster.\\n  Subsets []Subset\\n}\\n\\ntype ClusterRegistryQuerySpec struct {\\n  // Namespaces that the cluster objects reside.\\n  // If not specified, default namespace is used.\\n  Namespaces []string\\n  // Selector is the label matcher to find all qualified clusters.\\n  Selector   map[string]string\\n  // Describe the kind and APIversion of the cluster object.\\n  ClusterType metav1.TypeMeta\\n}\\n\\ntype Subset struct {\\n  Name string\\n\\n  // The name of target cluster. The controller will validate that\\n  // the TargetCluster exits based on Topology.ClusterRegistry.\\n  TargetCluster *TargetCluster\\n\\n  // Indicate the node select strategy in the Subset.TargetCluster.\\n  // If Subset.TargetCluster is not set, node selector strategy refers to\\n  // current cluster.\\n  NodeSelector corev1.NodeSelector\\n\\n  Replicas *intstr.IntOrString \\n}\\n\\ntype TargetCluster struct {\\n  // Namespace of the target cluster CRD\\n  Namespace string\\n  // Target cluster name\\n  Name string\\n}\\n```\\n\\nA new `TargetCluster` field is added to the `Subset` API. If it presents, the\\n`NodeSelector` indicates the node selection logic in the target cluster. Now\\nUnitedDeployment controller can distribute application Pods to multiple clusters by\\ninstantiating a `StatefulSet` workload in each target cluster with a specific\\nreplica number (or a percentage of total replica), as illustrated in Figure 2.\\n\\n![multi-cluster\\tcontroller](/img/blog/2019-11-20-uniteddeployment/uniteddeployment-2.png)\\n\\nAt a first glance, UnitedDeployment looks more like a federation\\ncontroller following the design pattern of [Kubefed](https://github.com/kubernetes-sigs/kubefed),\\nbut it isn\'t. The fundamental difference is that Kubefed focuses on propagating arbitrary\\nobject types to remote clusters instead of managing an application across clusters. \\nIn this example, had a Kubefed style controller been used, each `StatefulSet` workload in\\nindividual cluster would have a replica of 100. UnitedDeployment focuses more on\\nproviding the ability of managing multiple workloads in multiple clusters on behalf\\nof one application, which is absent in Kubernetes community to the best of our\\nknowledge.\\n\\n## Summary\\n\\nThis blog post introduces UnitedDeployment, a new controller which helps managing \\napplication spread over multiple domains (in arbitrary clusters). \\nIt not only allows evenly distributing Pods over AZs, \\nwhich arguably can be more efficiently done using the new Pod Topology Spread\\nConstraint APIs though, but also enables flexible workload deployment/rollout and\\nsupports multi-cluster use cases in the future."},{"id":"learning-concurrent-reconciling","metadata":{"permalink":"/zh/blog/learning-concurrent-reconciling","editUrl":"https://github.com/openkruise/openkruise.io/edit/master/blog/2019-11-10-learning-concurrent-reconciling.md","source":"@site/blog/2019-11-10-learning-concurrent-reconciling.md","title":"Learning Concurrent Reconciling","description":"The concept of controller in Kubernete is one of the most important reasons that make it successful.","date":"2019-11-10T00:00:00.000Z","tags":[{"inline":true,"label":"workload","permalink":"/zh/blog/tags/workload"},{"inline":true,"label":"reconcile","permalink":"/zh/blog/tags/reconcile"},{"inline":true,"label":"controller","permalink":"/zh/blog/tags/controller"}],"readingTime":4.18,"hasTruncateMarker":false,"authors":[{"name":"Fei Guo","title":"Maintainer of OpenKruise","url":"https://github.com/Fei-Guo","imageURL":"https://github.com/Fei-Guo.png","key":"Fei-Guo","page":null}],"frontMatter":{"slug":"learning-concurrent-reconciling","title":"Learning Concurrent Reconciling","authors":["Fei-Guo"],"tags":["workload","reconcile","controller"]},"unlisted":false,"prevItem":{"title":"UnitedDeploymemt - Supporting Multi-domain Workload Management","permalink":"/zh/blog/uniteddeployment"},"nextItem":{"title":"Kruise Workload Classification Guidance","permalink":"/zh/blog/workload-classification-guidance"}},"content":"The concept of controller in Kubernete is one of the most important reasons that make it successful.\\nController is the core mechanism that supports Kubernetes APIs to ensure the system reaches \\nthe desired state. By leveraging CRDs/controllers and operators, it is fairly easy for \\nother systems to integrate with Kubernetes. \\n\\nController runtime library and the corresponding controller tool [KubeBuilder](https://book.kubebuilder.io/introduction.html)\\nare widely used by many developers to build their customized Kubernetes controllers. In Kruise project,\\nwe also use Kubebuilder to generate scaffolding codes that implement the \\"reconciling\\" logic. \\nIn this blog post, I will share some learnings from\\nKruise controller development, particularly, about concurrent reconciling. \\n\\nSome people may already notice that controller runtime supports concurrent reconciling.\\nCheck for the options ([source](https://github.com/kubernetes-sigs/controller-runtime/blob/81842d0e78f7111f0566156189806e2801e3adf1/pkg/controller/controller.go#L32))\\nused to create new controller:  \\n\\n```\\ntype Options struct {\\n\\t// MaxConcurrentReconciles is the maximum number of concurrent Reconciles which can be run. Defaults to 1.\\n\\tMaxConcurrentReconciles int\\n\\n\\t// Reconciler reconciles an object\\n\\tReconciler reconcile.Reconciler\\n}\\n```\\n\\nConcurrent reconciling is quite useful when the states of the controller\'s watched objects change so\\nfrequently that a large amount of reconcile requests are sent to and queued in the reconcile queue.\\nMultiple reconcile loops do help drain the reconcile queue much more quickly compared to the default single\\nreconcile loop case. Although this is a great feature for performance, without digging into the code,\\nan immediate concern that a developer may raise is that will this introduce consistency issue? \\ni.e., is it possible that two reconcile loops handle the same object at the same time?\\n\\nThe answer is NO, as you may expect. The \\"magic\\" is enforced by the workqueue\\nimplementation in Kubernetes `client-go`, which is used by controller runtime reconcile queue. \\nThe workqueue algorithm ([source](https://github.com/kubernetes/client-go/blob/a57d0056dbf1d48baaf3cee876c123bea745591f/util/workqueue/queue.go#L65))\\nis demonstrated in Figure 1.\\n\\n![workqueue](/img/blog/2019-11-10-learning-concurrent-reconciling/workqueue.png)\\n\\nBasically, the workqueue uses a `queue` and two `sets` to coordinate the process of handling multiple reconciling \\nrequests against the same object. Figure 1(a) presents the initial state of handling four reconcile requests,\\ntwo of which target the same object A. When a request arrives, the target object is first added to the `dirty set`\\nor dropped if it presents in `dirty set`,  and then pushed to the `queue` only if it is not presented in\\n`processing set`. Figure 1(b) shows the case of adding three requests consecutively. \\nWhen a reconciling loop is ready to serve a request, it gets the target object from the `front` of the queue. The\\nobject is also added to the `processing set` and removed from the `dirty set` (Figure 1(c)).\\nNow if a request of the processing object arrives, the object is only added to the `dirty set`, not\\nto the `queue` (Figure 1(d)). This guarantees that an object is only handled by one reconciling\\nloop. When reconciling is done, the object is removed from the `processing set`. If the object is also\\nshown in the `dirty set`, it is added back to the `back` of the `queue` (Figure 1(e)).\\n\\nThe above algorithm has following implications:\\n* It avoids concurrent reconciling for the same object.\\n* The object processing order can be different from arriving order even if there is only one reconciling thread.\\nThis usually would not be a problem since the controller still reconciles to the final cluster state. However,\\nthe out of order reconciling may cause a significant delay for a request. \\n![workqueue-starve](/img/blog/2019-11-10-learning-concurrent-reconciling/workqueue-starve.png).... For example, as illustrated in \\nFigure 2, assuming there is only one reconciling thread and two requests targeting the same object A arrive, one of\\nthem will be processed and object A will be added to the `dirty set` (Figure 2(b)). \\nIf the reconciling takes a long time and during which a large number of new reconciling requests arrive,\\nthe queue will be filled up by the new requests (Figure 2(c)). When reconciling is done, object A will be\\nadded to the `back` of the `queue` (Figure 2(d)). It would not be handled until all the requests coming after had been\\nhandled, which can cause a noticeable long delay. The workaround is actually simple - **USE CONCURRENT RECONCILES**.\\nSince the cost of an idle go routine is fairly small, the overhead of having multiple reconcile threads is\\nlow even if the controller is idle. It seems that the `MaxConcurrentReconciles` value should\\nbe overwritten to a value larger than the default 1 (CloneSet uses 10 for example).\\n* Last but not the least, reconcile requests can be dropped (if the target exists in `dirty set`). This means\\nthat we cannot assume that the controller can track all the object state change events. Recalling a presentation\\ngiven by [Tim Hockin](https://speakerdeck.com/thockin/edge-vs-level-triggered-logic), Kubernetes controller\\nis level triggered, not edge triggered. It reconciles for state, not for events. \\n\\nThanks for reading the post, hope it helps."},{"id":"workload-classification-guidance","metadata":{"permalink":"/zh/blog/workload-classification-guidance","editUrl":"https://github.com/openkruise/openkruise.io/edit/master/blog/2019-10-10-workload-classification-guidance.md","source":"@site/i18n/zh/docusaurus-plugin-content-blog/2019-10-10-workload-classification-guidance.md","title":"Kruise Workload Classification Guidance","description":"Kubernetes \u76ee\u524d\u5e76\u6ca1\u6709\u4e3a\u4e00\u4e2a\u5e94\u7528\u5e94\u8be5\u4f7f\u7528\u54ea\u4e2a\u63a7\u5236\u5668\u63d0\u4f9b\u660e\u786e\u7684\u6307\u5f15\uff0c\u8fd9\u5c24\u5176\u4e0d\u5229\u4e8e\u7528\u6237\u7406\u89e3\u5e94\u7528\u548c workload \u7684\u5173\u7cfb\u3002","date":"2019-10-10T00:00:00.000Z","tags":[{"inline":true,"label":"workload","permalink":"/zh/blog/tags/workload"}],"readingTime":4.43,"hasTruncateMarker":false,"authors":[{"name":"Fei Guo","title":"Maintainer of OpenKruise","url":"https://github.com/Fei-Guo","imageURL":"https://github.com/Fei-Guo.png","key":"Fei-Guo","page":null},{"name":"Siyu Wang","title":"Maintainer of OpenKruise","url":"https://github.com/FillZpp","imageURL":"https://github.com/FillZpp.png","key":"FillZpp","page":null}],"frontMatter":{"slug":"workload-classification-guidance","title":"Kruise Workload Classification Guidance","authors":["Fei-Guo","FillZpp"],"tags":["workload"]},"unlisted":false,"prevItem":{"title":"Learning Concurrent Reconciling","permalink":"/zh/blog/learning-concurrent-reconciling"}},"content":"Kubernetes \u76ee\u524d\u5e76\u6ca1\u6709\u4e3a\u4e00\u4e2a\u5e94\u7528\u5e94\u8be5\u4f7f\u7528\u54ea\u4e2a\u63a7\u5236\u5668\u63d0\u4f9b\u660e\u786e\u7684\u6307\u5f15\uff0c\u8fd9\u5c24\u5176\u4e0d\u5229\u4e8e\u7528\u6237\u7406\u89e3\u5e94\u7528\u548c workload \u7684\u5173\u7cfb\u3002\\n\u6bd4\u5982\u8bf4\uff0c\u7528\u6237\u901a\u5e38\u77e5\u9053\u4ec0\u4e48\u65f6\u5019\u5e94\u8be5\u7528 `Job/CronJob` \u6216\u8005 `DaemonSet`\uff0c\u8fd9\u4e9b workload \u7684\u6982\u5ff5\u662f\u975e\u5e38\u660e\u786e\u7684 -- \u524d\u8005\u662f\u4e3a\u4e86\u4efb\u52a1\u7c7b\u578b\u7684\u5e94\u7528\u90e8\u7f72\u3001\u540e\u8005\u5219\u662f\u9762\u5411\u9700\u8981\u5206\u53d1\u5230\u6bcf\u4e2a node \u4e0a\u7684\u957f\u671f\u8fd0\u884c Pod\u3002\\n\\n\u4f46\u662f\u53e6\u4e00\u4e9b workload \u6bd4\u5982 `Deployment` \u548c `StatefulSet` \u4e4b\u95f4\u7684\u754c\u9650\u662f\u6bd4\u8f83\u6a21\u7cca\u7684\u3002\u4e00\u4e2a\u901a\u8fc7 `Deployment` \u90e8\u7f72\u7684\u5e94\u7528\u4e5f\u53ef\u4ee5\u901a\u8fc7 `StatefulSet` \u90e8\u7f72\uff0c`StatefulSet` \u5bf9 Pod \u7684 `OrderedReady` \u7b56\u7565\u5e76\u975e\u662f\u5f3a\u5236\u7684\u3002\u800c\u4e14\uff0c\u968f\u7740 Kubernetes \u793e\u533a\u4e2d\u8d8a\u6765\u8d8a\u591a\u7684\u81ea\u5b9a\u4e49 controllers/operators \u53d8\u7684\u6210\u719f\uff0c\u7528\u6237\u5c31\u8d8a\u96be\u4ee5\u4e3a\u81ea\u5df1\u7684\u5e94\u7528\u627e\u5230\u4e00\u4e2a\u6700\u5408\u9002\u7684 workload \u6765\u7ba1\u7406\uff0c\u5c24\u5176\u662f\u4e00\u4e9b\u63a7\u5236\u5668\u7684\u529f\u80fd\u4e0a\u90fd\u5b58\u5728\u91cd\u5408\u90e8\u5206\u3002\\n\\nKruise \u5c1d\u8bd5\u5728\u4e24\u4e2a\u65b9\u9762\u6765\u7f13\u89e3\u8fd9\u4e2a\u95ee\u9898\uff1a\\n\\n- \u5728 Kruise \u4e2d\u8c28\u614e\u8bbe\u8ba1\u65b0\u7684\u63a7\u5236\u5668\uff0c\u907f\u514d\u4e0d\u5fc5\u8981\u7684\u529f\u80fd\u91cd\u590d\u7ed9\u7528\u6237\u6765\u5e26\u56f0\u6270\\n- \u4e3a\u6240\u6709\u63d0\u4f9b\u51fa\u6765\u7684 workload \u63a7\u5236\u5668\u521b\u5efa\u4e00\u4e2a\u5206\u7c7b\u673a\u5236\uff0c\u65b9\u4fbf\u7528\u6237\u66f4\u5bb9\u6613\u7406\u89e3\u5b83\u4eec\u7684\u4f7f\u7528\u573a\u666f\u3002\u6211\u4eec\u4e0b\u9762\u4f1a\u8be6\u7ec6\u63cf\u8ff0\u4e00\u4e0b\uff0c\u9996\u5148\u662f controller \u547d\u540d\u4e0a\u7684\u89c4\u8303\uff1a\\n\\n### Controller \u547d\u540d\u60ef\u4f8b\\n\\n\u4e00\u4e2a\u6613\u4e8e\u7406\u89e3\u7684 controller \u540d\u5b57\u5bf9\u4e8e\u7528\u6237\u9009\u7528\u662f\u975e\u5e38\u6709\u5e2e\u52a9\u7684\u3002\u7ecf\u8fc7\u5bf9\u5185\u5916\u90e8\u4e0d\u5c11 Kubernetes \u7528\u6237\u7684\u54a8\u8be2\uff0c\u6211\u4eec\u51b3\u5b9a\u5728 Kruise \u4e2d\u5b9e\u884c\u4ee5\u4e0b\u7684\u547d\u540d\u60ef\u4f8b\uff08\u8fd9\u4e9b\u60ef\u4f8b\u4e0e\u76ee\u524d\u4e0a\u6e38\u7684 controller \u547d\u540d\u5e76\u4e0d\u51b2\u7a81\uff09\uff1a\\n\\n- **Set** \u540e\u7f00\uff1a\u8fd9\u7c7b controller \u4f1a\u76f4\u63a5\u64cd\u4f5c\u548c\u7ba1\u7406 Pod\uff0c\u6bd4\u5982 `CloneSet`, `ReplicaSet`, `SidecarSet` \u7b49\u3002\u5b83\u4eec\u63d0\u4f9b\u4e86 Pod \u7ef4\u5ea6\u7684\u591a\u79cd\u90e8\u7f72\u3001\u53d1\u5e03\u7b56\u7565\u3002\\n- **Deployment** \u540e\u7f00\uff1a\u8fd9\u7c7b controller \u4e0d\u4f1a\u76f4\u63a5\u5730\u64cd\u4f5c Pod\uff0c\u5b83\u4eec\u901a\u8fc7\u64cd\u4f5c\u4e00\u4e2a\u6216\u591a\u4e2a **Set** \u7c7b\u578b\u7684 workload \u6765\u95f4\u63a5\u7ba1\u7406 Pod\uff0c\u6bd4\u5982 `Deployment` \u7ba1\u7406 `ReplicaSet` \u6765\u63d0\u4f9b\u4e00\u4e9b\u989d\u5916\u7684\u6eda\u52a8\u7b56\u7565\uff0c\u4ee5\u53ca `UnitedDeployment` \u652f\u6301\u7ba1\u7406\u591a\u4e2a `StatefulSet`/`AdvancedStatefulSet` \u6765\u5c06\u5e94\u7528\u90e8\u7f72\u5230\u4e0d\u540c\u7684\u53ef\u7528\u533a\u3002\\n- **Job** \u540e\u7f00\uff1a\u8fd9\u7c7b controller \u4e3b\u8981\u7ba1\u7406\u77ed\u671f\u6267\u884c\u7684\u4efb\u52a1\uff0c\u6bd4\u5982 `BroadcastJob` \u652f\u6301\u5c06\u4efb\u52a1\u7c7b\u578b\u7684 Pod \u5206\u53d1\u5230\u96c6\u7fa4\u4e2d\u6240\u6709 Node \u4e0a\u3002\\n\\n**Set**, **Deployment** \u548c **Job** \u90fd\u662f\u88ab Kubernetes \u793e\u533a\u5e7f\u6cdb\u63a5\u53d7\u7684\u6982\u5ff5\uff0c\u5728 Kruise \u4e2d\u7ed9\u4ed6\u4eec\u5b9a\u4e49\u4e86\u660e\u786e\u7684\u6269\u5c55\u89c4\u8303\u3002\\n\\n\u6211\u4eec\u80fd\u5426\u5bf9\u6709\u76f8\u540c\u540e\u7f00\u7684 controller \u505a\u8fdb\u4e00\u6b65\u533a\u5206\u5462\uff1f\u901a\u5e38\u6765\u8bf4\u524d\u7f00\u524d\u9762\u7684\u540d\u5b57\u5e94\u8be5\u662f\u8ba9\u4eba\u80fd\u4e00\u76ee\u4e86\u7136\u7684\uff0c\u4e0d\u8fc7\u4e5f\u6709\u4e00\u4e9b\u60c5\u51b5\u4e0b\u5f88\u96be\u4e00\u8bed\u63cf\u8ff0 controller \u81ea\u8eab\u7684\u884c\u4e3a\u3002\u53ef\u4ee5\u770b\u4e00\u4e0b `StatefulSet` \u6765\u6e90\u7684\u8fd9\u4e2a [issue](https://github.com/kubernetes/kubernetes/issues/27430)\uff0c\u793e\u533a\u7528\u4e86\u56db\u4e2a\u6708\u7684\u65f6\u95f4\u624d\u51b3\u5b9a\u7528 `StatefulSet` \u8fd9\u4e2a\u540d\u5b57\u4ee3\u66ff\u8fc7\u53bb\u7684 `PetSet`\uff0c\u5c3d\u7ba1\u65b0\u540d\u5b57\u4e5f\u8ba9\u4eba\u770b\u8d77\u6765\u6bd4\u8f83\u56f0\u60d1\u3002\\n\\n\u8fd9\u4e2a\u4f8b\u5b50\u8bf4\u660e\u4e86\u6709\u65f6\u5019\u4e00\u4e2a\u7cbe\u5fc3\u8ba1\u5212\u7684\u540d\u5b57\u4e5f\u4e0d\u4e00\u5b9a\u6709\u52a9\u4e8e\u6807\u8bc6\u8fd9\u4e2a controller\u3002\u56e0\u6b64\uff0cKruise \u5e76\u4e0d\u6253\u7b97\u89e3\u51b3\u8fd9\u4e2a\u95ee\u9898\uff0c\u800c\u662f\u901a\u8fc7\u4ee5\u4e0b\u7684\u6807\u51c6\u6765\u5e2e\u52a9\u5bf9 **Set** \u7c7b\u578b\u7684 controller \u5206\u7c7b\u3002\\n\\n### \u56fa\u5b9a Pod \u540d\u5b57\\n\\n`StatefulSet` \u7684\u4e00\u4e2a\u72ec\u6709\u7684\u7279\u6027\u662f\u652f\u6301\u4e00\u81f4\u7684 Pod \u7f51\u7edc\u548c\u5b58\u50a8\u6807\u8bc6\uff0c\u8fd9\u5728\u672c\u8d28\u4e0a\u662f\u901a\u8fc7\u56fa\u5b9a Pod \u540d\u5b57\u6765\u5b9e\u73b0\u7684\u3002Pod \u540d\u5b57\u53ef\u4ee5\u7528\u4e8e\u6807\u8bc6\u7f51\u7edc\u548c\u5b58\u50a8\uff0c\u56e0\u4e3a\u5b83\u662f DNS record \u7684\u4e00\u90e8\u5206\uff0c\u5e76\u4e14\u53ef\u4ee5\u4f5c\u4e3a PVC \u7684\u540d\u5b57\u3002\u65e2\u7136 `StatefulSet` \u4e0b\u7684 Pod \u90fd\u662f\u901a\u8fc7\u540c\u4e00\u4e2a\u6a21\u677f\u521b\u5efa\u51fa\u6765\u7684\uff0c\u4e3a\u4ec0\u4e48\u9700\u8981\u8fd9\u4e2a\u7279\u6027\u5462\uff1f\u4e00\u4e2a\u5e38\u89c1\u7684\u4f8b\u5b50\u5c31\u662f\u7528\u4e8e\u7ba1\u7406\u5206\u5e03\u5f0f\u4e00\u81f4\u6027\u670d\u52a1\uff0c\u6bd4\u5982 etcd \u6216 Zookeeper\u3002\u8fd9\u7c7b\u5e94\u7528\u9700\u8981\u77e5\u9053\u96c6\u7fa4\u6784\u6210\u7684\u6240\u6709\u6210\u5458\uff0c\u5e76\u4e14\u5728\u91cd\u5efa\u3001\u53d1\u5e03\u540e\u90fd\u9700\u8981\u4fdd\u6301\u539f\u6709\u7684\u7f51\u7edc\u6807\u8bc6\u548c\u78c1\u76d8\u6570\u636e\u3002\u800c\u50cf `ReplicaSet`, `DaemonSet` \u8fd9\u7c7b\u7684\u63a7\u5236\u5668\u662f\u9762\u5411\u65e0\u72b6\u6001\u7684\uff0c\u5b83\u4eec\u5728\u65b0\u5efa Pod \u65f6\u5e76\u4e0d\u4f1a\u590d\u7528\u8fc7\u53bb\u7684 Pod \u540d\u5b57\u3002\\n\\n\u4e3a\u4e86\u652f\u6301\u6709\u72b6\u6001\uff0c\u63a7\u5236\u5668\u7684\u5b9e\u73b0\u4e0a\u4f1a\u6bd4\u8f83\u56fa\u5b9a\u3002`StatefulSet` \u4f9d\u8d56\u4e8e\u7ed9\u6bcf\u4e2a Pod \u540d\u5b57\u4e2d\u52a0\u5165\u4e00\u4e2a\u5e8f\u53f7\uff0c\u5728\u6269\u7f29\u5bb9\u548c\u6eda\u52a8\u5347\u7ea7\u7684\u65f6\u5019\u90fd\u9700\u8981\u6309\u7167\u8fd9\u4e2a\u5e8f\u53f7\u7684\u987a\u5e8f\u6765\u6267\u884c\u3002\u4f46\u8fd9\u6837\u4e00\u6765\uff0c`StatefulSet` \u4e5f\u5c31\u65e0\u6cd5\u505a\u5230\u53e6\u4e00\u4e9b\u589e\u5f3a\u529f\u80fd\uff0c\u6bd4\u5982\uff1a\\n\\n- \u5f53\u7f29\u5c0f replicas \u65f6\u9009\u62e9\u7279\u5b9a\u7684 Pod \u6765\u5220\u9664\uff0c\u8fd9\u4e2a\u529f\u80fd\u5728\u8de8\u591a\u4e2a\u53ef\u7528\u533a\u90e8\u7f72\u7684\u65f6\u5019\u4f1a\u7528\u5230\u3002\\n- \u628a\u4e00\u4e2a\u5b58\u91cf\u7684 Pod \u63a5\u7ba1\u5230\u53e6\u4e00\u4e2a workload \u4e0b\u9762\uff08\u6bd4\u5982 `StatefulSet`\uff09\\n\\n\u6211\u4eec\u53d1\u73b0\u5f88\u591a\u4e91\u539f\u751f\u5e94\u7528\u5e76\u4e0d\u9700\u8981\u8fd9\u4e2a\u6709\u72b6\u6001\u7684\u7279\u6027\u6765\u56fa\u5b9a Pod \u540d\u5b57\uff0c\u800c `StatefulSet` \u53c8\u5f88\u96be\u5728\u5176\u4ed6\u65b9\u9762\u505a\u6269\u5c55\u3002\u4e3a\u4e86\u89e3\u51b3\u8fd9\u4e2a\u95ee\u9898\uff0cKruise \u53d1\u5e03\u4e86\u4e00\u4e2a\u65b0\u7684\u63a7\u5236\u5668 `CloneSet` \u6765\u7ba1\u7406\u65e0\u72b6\u6001\u5e94\u7528\uff0c`CloneSet` \u63d0\u4f9b\u4e86\u5bf9 PVC \u6a21\u677f\u7684\u652f\u6301\uff0c\u5e76\u4e14\u4e3a\u5e94\u7528\u90e8\u7f72\u63d0\u4f9b\u4e86\u4e30\u5bcc\u7684\u53ef\u9009\u7b56\u7565\u3002\u4ee5\u4e0b\u8868\u4e2d\u6bd4\u8f83\u4e86 Advanced StatefulSet \u548c CloneSet \u4e00\u4e9b\u65b9\u9762\u7684\u80fd\u529b\uff1a\\n\\n| Features   |     Advanced StatefulSet      |  CloneSet |\\n|----------|:-------------:|:------:|\\n| PVC | Yes | Yes |\\n| Pod name | Ordered | Random |\\n| Inplace upgrade | Yes | Yes |\\n| Max unavailable | Yes | Yes |\\n| Selective deletion | No | Yes |\\n| Selective upgrade | No | Yes |\\n| Change Pod ownership | No | Yes |\\n\\n\u76ee\u524d\u5bf9\u4e8e Kruise \u7528\u6237\u7684\u5efa\u8bae\u662f\uff0c\u5982\u679c\u4f60\u7684\u5e94\u7528\u9700\u8981\u56fa\u5b9a\u7684 Pod \u540d\u5b57\uff08\u7f51\u7edc\u548c\u5b58\u50a8\u6807\u8bc6\uff09\uff0c\u4f60\u53ef\u4ee5\u4f7f\u7528 `Advanced StatefulSet`\uff0c\u5426\u5219 `CloneSet` \u5e94\u8be5\u662f **Set** \u7c7b\u578b\u63a7\u5236\u5668\u7684\u9996\u9009\u3002\\n\\n### \u603b\u7ed3\\n\\nKruise \u4f1a\u4e3a\u5404\u79cd workload \u9009\u62e9\u660e\u786e\u7684\u540d\u5b57\uff0c\u672c\u6587\u76ee\u6807\u662f\u80fd\u4e3a Kruise \u7528\u6237\u63d0\u4f9b\u9009\u62e9\u6b63\u786e controller \u90e8\u7f72\u5e94\u7528\u7684\u6307\u5f15\u3002\\n\u5e0c\u671b\u5bf9\u4f60\u6709\u5e2e\u52a9\uff01"}]}}')}}]);