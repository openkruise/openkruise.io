"use strict";(self.webpackChunkopenkruise_io=self.webpackChunkopenkruise_io||[]).push([[8153],{28453:(e,n,s)=>{s.d(n,{R:()=>t,x:()=>d});var a=s(96540);const i={},r=a.createContext(i);function t(e){const n=a.useContext(r);return a.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function d(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:t(e.components),a.createElement(r.Provider,{value:n},e.children)}},33348:(e,n,s)=>{s.r(n),s.d(n,{assets:()=>c,contentTitle:()=>d,default:()=>p,frontMatter:()=>t,metadata:()=>a,toc:()=>l});const a=JSON.parse('{"id":"user-manuals/sidecarset","title":"SidecarSet","description":"\u8fd9\u4e2a\u63a7\u5236\u5668\u652f\u6301\u901a\u8fc7 admission webhook \u6765\u81ea\u52a8\u4e3a\u96c6\u7fa4\u4e2d\u521b\u5efa\u7684\u7b26\u5408\u6761\u4ef6\u7684 Pod \u6ce8\u5165 sidecar \u5bb9\u5668\u3002","source":"@site/i18n/zh/docusaurus-plugin-content-docs/version-v1.6/user-manuals/sidecarset.md","sourceDirName":"user-manuals","slug":"/user-manuals/sidecarset","permalink":"/zh/docs/v1.6/user-manuals/sidecarset","draft":false,"unlisted":false,"editUrl":"https://github.com/openkruise/openkruise.io/edit/master/docs/user-manuals/sidecarset.md","tags":[],"version":"v1.6","lastUpdatedBy":"ChrisLiu","lastUpdatedAt":1742896773000,"frontMatter":{"title":"SidecarSet"},"sidebar":"docs","previous":{"title":"AdvancedCronJob","permalink":"/zh/docs/v1.6/user-manuals/advancedcronjob"},"next":{"title":"Job Sidecar Terminator","permalink":"/zh/docs/v1.6/user-manuals/jobsidecarterminator"}}');var i=s(74848),r=s(28453);const t={title:"SidecarSet"},d=void 0,c={},l=[{value:"\u8303\u4f8b",id:"\u8303\u4f8b",level:2},{value:"\u521b\u5efa SidecarSet",id:"\u521b\u5efa-sidecarset",level:3},{value:"\u521b\u5efa Pod",id:"\u521b\u5efa-pod",level:3},{value:"\u66f4\u65b0sidecar container Image",id:"\u66f4\u65b0sidecar-container-image",level:3},{value:"SidecarSet\u529f\u80fd\u8bf4\u660e",id:"sidecarset\u529f\u80fd\u8bf4\u660e",level:2},{value:"namespace selector",id:"namespace-selector",level:4},{value:"sidecar container\u6ce8\u5165",id:"sidecar-container\u6ce8\u5165",level:3},{value:"\u6ce8\u5165\u6682\u505c",id:"\u6ce8\u5165\u6682\u505c",level:4},{value:"imagePullSecrets",id:"imagepullsecrets",level:4},{value:"sidecar\u6ce8\u5165\u65f6\u7248\u672c\u63a7\u5236",id:"sidecar\u6ce8\u5165\u65f6\u7248\u672c\u63a7\u5236",level:3},{value:"\u901a\u8fc7 ControllerRevision \u540d\u79f0\u6307\u5b9a\u6ce8\u5165\u7684 Sidecar \u7248\u672c",id:"\u901a\u8fc7-controllerrevision-\u540d\u79f0\u6307\u5b9a\u6ce8\u5165\u7684-sidecar-\u7248\u672c",level:4},{value:"\u901a\u8fc7\u81ea\u5b9a\u4e49\u7248\u672c\u6807\u8bc6\u6307\u5b9a\u6ce8\u5165\u7684 Sidecar \u7248\u672c",id:"\u901a\u8fc7\u81ea\u5b9a\u4e49\u7248\u672c\u6807\u8bc6\u6307\u5b9a\u6ce8\u5165\u7684-sidecar-\u7248\u672c",level:4},{value:"sidecar\u66f4\u65b0\u7b56\u7565",id:"sidecar\u66f4\u65b0\u7b56\u7565",level:3},{value:"\u5206\u6279\u53d1\u5e03",id:"\u5206\u6279\u53d1\u5e03",level:4},{value:"\u6700\u5927\u4e0d\u53ef\u7528\u6570\u91cf",id:"\u6700\u5927\u4e0d\u53ef\u7528\u6570\u91cf",level:4},{value:"\u66f4\u65b0\u6682\u505c",id:"\u66f4\u65b0\u6682\u505c",level:4},{value:"\u91d1\u4e1d\u96c0\u53d1\u5e03",id:"\u91d1\u4e1d\u96c0\u53d1\u5e03",level:4},{value:"\u53d1\u5e03\u987a\u5e8f\u63a7\u5236",id:"\u53d1\u5e03\u987a\u5e8f\u63a7\u5236",level:3},{value:"\u4f18\u5148\u7ea7\u7b56\u7565",id:"\u4f18\u5148\u7ea7\u7b56\u7565",level:4},{value:"scatter\u6253\u6563\u987a\u5e8f",id:"scatter\u6253\u6563\u987a\u5e8f",level:4},{value:"Sidecar\u70ed\u5347\u7ea7\u7279\u6027",id:"sidecar\u70ed\u5347\u7ea7\u7279\u6027",level:3},{value:"\u6ce8\u5165\u70ed\u5347\u7ea7\u5bb9\u5668",id:"\u6ce8\u5165\u70ed\u5347\u7ea7\u5bb9\u5668",level:4},{value:"\u70ed\u5347\u7ea7\u6d41\u7a0b",id:"\u70ed\u5347\u7ea7\u6d41\u7a0b",level:4},{value:"Migration Demo",id:"migration-demo",level:4},{value:"Inject Pod Metadata",id:"inject-pod-metadata",level:3},{value:"Metadata \u767d\u540d\u5355",id:"metadata-\u767d\u540d\u5355",level:4},{value:"Feature-gate",id:"feature-gate",level:4},{value:"SidecarSet\u72b6\u6001\u8bf4\u660e",id:"sidecarset\u72b6\u6001\u8bf4\u660e",level:3},{value:"\u5982\u4f55\u6392\u67e5 SidecarSet \u72ec\u7acb\u5347\u7ea7 Sidecar \u5bb9\u5668\u5361\u4f4f\uff1f",id:"\u5982\u4f55\u6392\u67e5-sidecarset-\u72ec\u7acb\u5347\u7ea7-sidecar-\u5bb9\u5668\u5361\u4f4f",level:2}];function o(e){const n={a:"a",code:"code",h2:"h2",h3:"h3",h4:"h4",img:"img",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,r.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsxs)(n.p,{children:["\u8fd9\u4e2a\u63a7\u5236\u5668\u652f\u6301\u901a\u8fc7 admission webhook \u6765\u81ea\u52a8\u4e3a\u96c6\u7fa4\u4e2d\u521b\u5efa\u7684\u7b26\u5408\u6761\u4ef6\u7684 Pod \u6ce8\u5165 sidecar \u5bb9\u5668\u3002\n\u8fd9\u4e2a\u6ce8\u5165\u8fc7\u7a0b\u548c ",(0,i.jsx)(n.a,{href:"https://istio.io/docs/setup/kubernetes/additional-setup/sidecar-injection/",children:"istio"}),"\n\u7684\u81ea\u52a8\u6ce8\u5165\u65b9\u5f0f\u5f88\u7c7b\u4f3c\u3002\n\u9664\u4e86\u5728 Pod \u521b\u5efa\u65f6\u5019\u6ce8\u5165\u5916\uff0cSidecarSet \u8fd8\u63d0\u4f9b\u4e86\u4e3a\u8fd0\u884c\u65f6 Pod \u539f\u5730\u5347\u7ea7\u5176\u4e2d\u5df2\u7ecf\u6ce8\u5165\u7684 sidecar \u5bb9\u5668\u955c\u50cf\u7684\u80fd\u529b\u3002"]}),"\n",(0,i.jsx)(n.p,{children:"\u7b80\u5355\u6765\u8bf4\uff0cSidecarSet \u5c06 sidecar \u5bb9\u5668\u7684\u5b9a\u4e49\u548c\u751f\u547d\u5468\u671f\u4e0e\u4e1a\u52a1\u5bb9\u5668\u89e3\u8026\u3002\n\u5b83\u4e3b\u8981\u7528\u4e8e\u7ba1\u7406\u65e0\u72b6\u6001\u7684 sidecar \u5bb9\u5668\uff0c\u6bd4\u5982\u76d1\u63a7\u3001\u65e5\u5fd7\u7b49 agent\u3002"}),"\n",(0,i.jsx)(n.h2,{id:"\u8303\u4f8b",children:"\u8303\u4f8b"}),"\n",(0,i.jsx)(n.h3,{id:"\u521b\u5efa-sidecarset",children:"\u521b\u5efa SidecarSet"}),"\n",(0,i.jsx)(n.p,{children:"\u5982\u4e0b\u7684 sidecarset.yaml \u5b9a\u4e49\u4e86\u4e00\u4e2a SidecarSet\uff0c\u5176\u4e2d\u5305\u62ec\u4e86\u4e00\u4e2a\u540d\u4e3a sidecar1 \u7684 sidecar \u5bb9\u5668\uff1a"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-yaml",children:'# sidecarset.yaml\napiVersion: apps.kruise.io/v1alpha1\nkind: SidecarSet\nmetadata:\n  name: test-sidecarset\nspec:\n  selector:\n    matchLabels:\n      app: nginx\n  updateStrategy:\n    type: RollingUpdate\n    maxUnavailable: 1\n  containers:\n  - name: sidecar1\n    image: centos:6.7\n    command: ["sleep", "999d"] # do nothing at all\n    volumeMounts:\n    - name: log-volume\n      mountPath: /var/log\n  volumes: # this field will be merged into pod.spec.volumes\n  - name: log-volume\n    emptyDir: {}\n'})}),"\n",(0,i.jsx)(n.p,{children:"\u521b\u5efa\u8fd9\u4e2a YAML:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"kubectl apply -f sidecarset.yaml\n"})}),"\n",(0,i.jsx)(n.h3,{id:"\u521b\u5efa-pod",children:"\u521b\u5efa Pod"}),"\n",(0,i.jsx)(n.p,{children:"\u5b9a\u4e49\u4e00\u4e2a\u5339\u914d SidecarSet selector \u7684 Pod\uff1a"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-yaml",children:"apiVersion: v1\nkind: Pod\nmetadata:\n  labels:\n    app: nginx # matches the SidecarSet's selector\n  name: test-pod\nspec:\n  containers:\n  - name: app\n    image: nginx:1.15.1\n"})}),"\n",(0,i.jsx)(n.p,{children:"\u521b\u5efa\u8fd9\u4e2a Pod\uff0c\u4f60\u4f1a\u53d1\u73b0\u5176\u4e2d\u88ab\u6ce8\u5165\u4e86 sidecar1 \u5bb9\u5668\uff1a"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"$ kubectl get pod\nNAME       READY   STATUS    RESTARTS   AGE\ntest-pod   2/2     Running   0          118s\n"})}),"\n",(0,i.jsx)(n.p,{children:"\u6b64\u65f6\uff0cSidecarSet status \u88ab\u66f4\u65b0\u4e3a\uff1a"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"$ kubectl get sidecarset test-sidecarset -o yaml | grep -A4 status\nstatus:\n  matchedPods: 1\n  observedGeneration: 1\n  readyPods: 1\n  updatedPods: 1\n"})}),"\n",(0,i.jsx)(n.h3,{id:"\u66f4\u65b0sidecar-container-image",children:"\u66f4\u65b0sidecar container Image"}),"\n",(0,i.jsx)(n.p,{children:"\u66f4\u65b0sidecarSet\u4e2dsidecar container\u7684image=centos:7"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"$ kubectl edit sidecarsets test-sidecarset\n\n# sidecarset.yaml\napiVersion: apps.kruise.io/v1alpha1\nkind: SidecarSet\nmetadata:\n  name: test-sidecarset\nspec:\n  containers:\n    - name: sidecar1\n      image: centos:7\n"})}),"\n",(0,i.jsx)(n.p,{children:"\u6b64\u65f6\uff0c\u53d1\u73b0pod\u4e2d\u7684sidecar\u5bb9\u5668\u5df2\u7ecf\u88ab\u66f4\u65b0\u4e3a\u4e86centos:7\uff0c\u5e76\u4e14pod\u4ee5\u53ca\u5176\u5b83\u7684\u5bb9\u5668\u6ca1\u6709\u91cd\u542f\u3002"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:'$ kubectl get pods | grep test-pod\ntest-pod                            2/2     Running   1          7m34s\n\n$ kubectl get pods test-pod -o yaml | grep \'image: centos\'\n    image: centos:7\n\n$ kubectl describe pods test-pod\nEvents:\n  Type    Reason     Age                 From               Message\n  ----    ------     ----                ----               -------\n  Normal  Killing    5m47s               kubelet            Container sidecar1 definition changed, will be restarted\n  Normal  Pulling    5m17s               kubelet            Pulling image "centos:7"\n  Normal  Created    5m5s (x2 over 12m)  kubelet            Created container sidecar1\n  Normal  Started    5m5s (x2 over 12m)  kubelet            Started container sidecar1\n  Normal  Pulled     5m5s                kubelet            Successfully pulled image "centos:7"\n'})}),"\n",(0,i.jsx)(n.h2,{id:"sidecarset\u529f\u80fd\u8bf4\u660e",children:"SidecarSet\u529f\u80fd\u8bf4\u660e"}),"\n",(0,i.jsx)(n.p,{children:"\u4e00\u4e2a\u7b80\u5355\u7684 SidecarSet yaml \u6587\u4ef6\u5982\u4e0b\uff1a"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-yaml",children:'apiVersion: apps.kruise.io/v1alpha1\nkind: SidecarSet\nmetadata:\n  name: sidecarset\nspec:\n  selector:\n    matchLabels:\n      app: sample\n  containers:\n  - name: nginx\n    image: nginx:alpine\n  initContainers:\n  - name: init-container\n    image: busybox:latest\n    command: [ "/bin/sh", "-c", "sleep 5 && echo \'init container success\'" ]\n  updateStrategy:\n    type: RollingUpdate\n  namespace: ns-1\n'})}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["spec.selector \u901a\u8fc7label\u7684\u65b9\u5f0f\u9009\u62e9\u9700\u8981\u6ce8\u5165\u3001\u66f4\u65b0\u7684pod\uff0c\u652f\u6301matchLabels\u3001MatchExpressions\u4e24\u79cd\u65b9\u5f0f\uff0c\u8be6\u60c5\u8bf7\u53c2\u8003\uff1a",(0,i.jsx)(n.a,{href:"https://kubernetes.io/docs/concepts/overview/working-with-objects/labels/",children:"https://kubernetes.io/docs/concepts/overview/working-with-objects/labels/"})]}),"\n",(0,i.jsxs)(n.li,{children:["spec.containers \u5b9a\u4e49\u9700\u8981\u6ce8\u5165\u3001\u66f4\u65b0\u7684pod.spec.containers\u5bb9\u5668\uff0c\u652f\u6301\u5b8c\u6574\u7684k8s container\u5b57\u6bb5\uff0c\u8be6\u60c5\u8bf7\u53c2\u8003\uff1a",(0,i.jsx)(n.a,{href:"https://kubernetes.io/docs/concepts/containers/",children:"https://kubernetes.io/docs/concepts/containers/"})]}),"\n",(0,i.jsxs)(n.li,{children:["spec.initContainers \u5b9a\u4e49\u9700\u8981\u6ce8\u5165\u7684pod.spec.initContainers\u5bb9\u5668\uff0c\u652f\u6301\u5b8c\u6574\u7684k8s initContainer\u5b57\u6bb5\uff0c\u8be6\u60c5\u8bf7\u53c2\u8003\uff1a",(0,i.jsx)(n.a,{href:"https://kubernetes.io/docs/concepts/workloads/pods/init-containers/",children:"https://kubernetes.io/docs/concepts/workloads/pods/init-containers/"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"\u6ce8\u5165initContainers\u5bb9\u5668\u9ed8\u8ba4\u57fa\u4e8econtainer name\u5347\u7ea7\u6392\u5e8f"}),"\n",(0,i.jsx)(n.li,{children:"initContainers\u53ea\u652f\u6301\u6ce8\u5165\uff0c\u4e0d\u652f\u6301pod\u539f\u5730\u5347\u7ea7"}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["spec.updateStrategy sidecarSet\u66f4\u65b0\u7b56\u7565\uff0ctype\u8868\u660e\u5347\u7ea7\u65b9\u5f0f\uff1a","\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"NotUpdate \u4e0d\u66f4\u65b0\uff0c\u6b64\u6a21\u5f0f\u4e0b\u53ea\u4f1a\u5305\u542b\u6ce8\u5165\u80fd\u529b"}),"\n",(0,i.jsx)(n.li,{children:"RollingUpdate \u6ce8\u5165+\u6eda\u52a8\u66f4\u65b0\uff0c\u5305\u542b\u4e86\u4e30\u5bcc\u7684\u6eda\u52a8\u66f4\u65b0\u7b56\u7565\uff0c\u540e\u9762\u4f1a\u8be6\u7ec6\u4ecb\u7ecd"}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(n.li,{children:"spec.namespace sidecarset\u9ed8\u8ba4\u5728k8s\u6574\u4e2a\u96c6\u7fa4\u8303\u56f4\u5185\u751f\u6548\uff0c\u5373\u5bf9\u6240\u6709\u7684\u547d\u540d\u7a7a\u95f4\u751f\u6548\uff08\u9664\u4e86kube-system, kube-public\uff09\uff0c\u5f53\u8bbe\u7f6e\u8be5\u5b57\u6bb5\u65f6\uff0c\u53ea\u5bf9\u8be5namespace\u7684pod\u751f\u6548"}),"\n"]}),"\n",(0,i.jsxs)(n.p,{children:["**\u6ce8\u610f\uff1a**\u4ece Kruise v1.3.0 \u7248\u672c\u5f00\u59cb\uff0cSidecarSet \u4e0d\u518d\u9ed8\u8ba4\u6392\u9664 Namespace ",(0,i.jsx)(n.strong,{children:"kube-system, kube-public"}),"\u3002\u5982\u679c\u4f60\u6709\u6392\u9664\u7279\u5b9a Namespace \u7684\u9700\u6c42\uff0c\u8bf7\u4f7f\u7528\u5982\u4e0b namespace selector \u7684\u65b9\u5f0f\u3002"]}),"\n",(0,i.jsx)(n.h4,{id:"namespace-selector",children:"namespace selector"}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"FEATURE STATE:"})," Kruise v1.4.0"]}),"\n",(0,i.jsxs)(n.p,{children:["spec.namespace \u5b57\u6bb5\u53ea\u80fd\u6307\u5b9a\u4e00\u4e2aNamespace\uff0c\u5e76\u4e14\u4e0d\u80fd\u6392\u9664\u7684\u4e00\u4e9b\u7279\u5b9a\u7684Namespace\u3002\u5982\u679c\u9762\u5bf9\u4e00\u4e9b\u590d\u6742\u7684 namespace selector \u573a\u666f\uff0c\u63a8\u8350\u4f7f\u7528 ",(0,i.jsx)(n.strong,{children:"namespaceSelector"})," \u5b57\u6bb5\uff1a"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-yaml",children:"apiVersion: apps.kruise.io/v1alpha1\nkind: SidecarSet\nmetadata:\n  name: sidecarset\nspec:\n  ...\n  namespaceSelector:\n    matchLabels:\n      environment: production\n  # matchExpressions:\n  # - {key: tier, operator: In, values: [frontend, middleware]}\n"})}),"\n",(0,i.jsx)(n.h3,{id:"sidecar-container\u6ce8\u5165",children:"sidecar container\u6ce8\u5165"}),"\n",(0,i.jsx)(n.p,{children:"sidecar \u7684\u6ce8\u5165\u53ea\u4f1a\u53d1\u751f\u5728 Pod \u521b\u5efa\u9636\u6bb5\uff0c\u5e76\u4e14\u53ea\u6709 Pod spec \u4f1a\u88ab\u66f4\u65b0\uff0c\u4e0d\u4f1a\u5f71\u54cd Pod \u6240\u5c5e\u7684 workload template \u6a21\u677f\u3002\nspec.containers\u9664\u4e86\u9ed8\u8ba4\u7684k8s container\u5b57\u6bb5\uff0c\u8fd8\u6269\u5c55\u4e86\u5982\u4e0b\u4e00\u4e9b\u5b57\u6bb5\uff0c\u6765\u65b9\u4fbf\u6ce8\u5165\uff1a"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-yaml",children:'apiVersion: apps.kruise.io/v1alpha1\nkind: SidecarSet\nmetadata:\n  name: sidecarset\nspec:\n  selector:\n    matchLabels:\n      app: sample\n  containers:\n    # default K8s Container fields\n  - name: nginx\n    image: nginx:alpine\n    volumeMounts:\n    - mountPath: /nginx/conf\n      name: nginx.conf\n    # extended sidecar container fields\n    podInjectPolicy: BeforeAppContainer\n    shareVolumePolicy:\n      type: disabled | enabled\n    transferEnv:\n    - sourceContainerName: main\n      envName: PROXY_IP\n    - sourceContainerNameFrom:\n        fieldRef:\n          apiVersion: "v1"\n          fieldPath: "metadata.labels[\'cName\']"\n        # fieldPath: "metadata.annotations[\'cName\']"\n      envName: TC\n  volumes:\n  - name: nginx.conf\n    hostPath:\n      path: /data/nginx/conf\n'})}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["podInjectPolicy \u5b9a\u4e49container\u6ce8\u5165\u5230pod.spec.containers\u4e2d\u7684\u4f4d\u7f6e","\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"BeforeAppContainer(\u9ed8\u8ba4) \u6ce8\u5165\u5230pod\u539fcontainers\u7684\u524d\u9762"}),"\n",(0,i.jsx)(n.li,{children:"AfterAppContainer \u6ce8\u5165\u5230pod\u539fcontainers\u7684\u540e\u9762"}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\u6570\u636e\u5377\u5171\u4eab","\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["\u5171\u4eab\u6307\u5b9a\u5377\uff1a\u901a\u8fc7 spec.volumes \u6765\u5b9a\u4e49 sidecar \u81ea\u8eab\u9700\u8981\u7684 volume\uff0c\u8be6\u60c5\u8bf7\u53c2\u8003\uff1a",(0,i.jsx)(n.a,{href:"https://kubernetes.io/docs/concepts/storage/volumes/",children:"https://kubernetes.io/docs/concepts/storage/volumes/"})]}),"\n",(0,i.jsx)(n.li,{children:"\u5171\u4eab\u6240\u6709\u5377\uff1a\u901a\u8fc7 spec.containers[i].shareVolumePolicy.type = enabled | disabled \u6765\u63a7\u5236\u662f\u5426\u6302\u8f7dpod\u5e94\u7528\u5bb9\u5668\u7684\u5377\uff0c\u5e38\u7528\u4e8e\u65e5\u5fd7\u6536\u96c6\u7b49 sidecar\uff0c\u914d\u7f6e\u4e3a enabled \u540e\u4f1a\u628a\u5e94\u7528\u5bb9\u5668\u4e2d\u6240\u6709\u6302\u8f7d\u70b9\u6ce8\u5165 sidecar \u540c\u4e00\u8def\u7ecf\u4e0b(sidecar\u4e2d\u672c\u8eab\u5c31\u6709\u58f0\u660e\u7684\u6570\u636e\u5377\u548c\u6302\u8f7d\u70b9\u9664\u5916\uff09"}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\u73af\u5883\u53d8\u91cf\u5171\u4eab","\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"\u53ef\u4ee5\u901a\u8fc7 spec.containers[i].transferEnv \u6765\u4ece\u522b\u7684\u5bb9\u5668\u83b7\u53d6\u73af\u5883\u53d8\u91cf\uff0c\u4f1a\u628a\u540d\u4e3a sourceContainerName \u5bb9\u5668\u4e2d\u540d\u4e3a envName \u7684\u73af\u5883\u53d8\u91cf\u62f7\u8d1d\u5230\u672c\u5bb9\u5668"}),"\n",(0,i.jsxs)(n.li,{children:["sourceContainerNameFrom \u652f\u6301 downwardAPI \u6765\u83b7\u53d6\u5bb9\u5668name\uff0c\u6bd4\u5982\uff1a",(0,i.jsx)(n.code,{children:"metadata.labels['<KEY>']"}),", ",(0,i.jsx)(n.code,{children:"metadata.annotations['<KEY>']"})]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(n.h4,{id:"\u6ce8\u5165\u6682\u505c",children:"\u6ce8\u5165\u6682\u505c"}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"FEATURE STATE:"})," Kruise v0.10.0"]}),"\n",(0,i.jsxs)(n.p,{children:["\u5bf9\u4e8e\u5df2\u7ecf\u521b\u5efa\u7684 SidecarSet\uff0c\u53ef\u901a\u8fc7\u8bbe\u7f6e ",(0,i.jsx)(n.code,{children:"spec.injectionStrategy.paused=true"})," \u5b9e\u73b0sidecar container\u7684\u6682\u505c\u6ce8\u5165\uff1a"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-yaml",children:"apiVersion: apps.kruise.io/v1alpha1\nkind: SidecarSet\nmetadata:\n  name: sidecarset\nspec:\n  ... ...\n  injectionStrategy:\n    paused: true\n"})}),"\n",(0,i.jsx)(n.p,{children:"\u4e0a\u8ff0\u65b9\u6cd5\u53ea\u4f5c\u7528\u4e8e\u65b0\u521b\u5efa\u7684 Pod\uff0c\u5bf9\u4e8e\u5df2\u6ce8\u5165 Pod \u7684\u5b58\u91cf sidecar container \u4e0d\u4ea7\u751f\u4efb\u4f55\u5f71\u54cd\u3002"}),"\n",(0,i.jsx)(n.h4,{id:"imagepullsecrets",children:"imagePullSecrets"}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"FEATURE STATE:"})," Kruise v0.10.0"]}),"\n",(0,i.jsxs)(n.p,{children:["SidecarSet \u53ef\u4ee5\u901a\u8fc7\u914d\u7f6e spec.imagePullSecrets\uff0c\u6765\u914d\u5408 ",(0,i.jsx)(n.a,{href:"https://kubernetes.io/zh/docs/concepts/configuration/secret/",children:"Secret"})," \u62c9\u53d6\u79c1\u6709 sidecar \u955c\u50cf\u3002\u5176\u5b9e\u73b0\u539f\u7406\u4e3a: \u5f53sidecar\u6ce8\u5165\u65f6\uff0cSidecarSet \u4f1a\u5c06\u5176 spec.imagePullSecrets \u6ce8\u5165\u5230",(0,i.jsx)(n.a,{href:"https://kubernetes.io/zh/docs/tasks/configure-pod-container/pull-image-private-registry/",children:" Pod \u7684 spec.imagePullSecrets"}),"\u3002"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-yaml",children:"apiVersion: apps.kruise.io/v1alpha1\nkind: SidecarSet\nmetadata:\n  name: sidecarset\nspec:\n  ... ....\n  imagePullSecrets:\n  - name: my-secret\n"})}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"\u7279\u522b\u6ce8\u610f"}),": \u5bf9\u4e8e\u9700\u8981\u62c9\u53d6\u79c1\u6709 sidecar \u955c\u50cf\u7684 Pod\uff0c\u7528\u6237\u5fc5\u9700\u786e\u4fdd\u8fd9\u4e9b Pod \u6240\u5728\u7684\u547d\u540d\u7a7a\u95f4\u4e2d\u5df2\u5b58\u5728\u5bf9\u5e94\u7684 Secret\uff0c\u5426\u5219\u4f1a\u5bfc\u81f4\u62c9\u53d6\u79c1\u6709\u955c\u50cf\u5931\u8d25\u3002"]}),"\n",(0,i.jsx)(n.h3,{id:"sidecar\u6ce8\u5165\u65f6\u7248\u672c\u63a7\u5236",children:"sidecar\u6ce8\u5165\u65f6\u7248\u672c\u63a7\u5236"}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"FEATURE STATE:"})," Kruise v1.3.0"]}),"\n",(0,i.jsxs)(n.p,{children:["SidecarSet \u901a\u8fc7 ControllerRevision \u8bb0\u5f55\u4e86\u5173\u4e8e ",(0,i.jsx)(n.code,{children:"containers"}),"\u3001",(0,i.jsx)(n.code,{children:"volumes"}),"\u3001",(0,i.jsx)(n.code,{children:"initContainers"}),"\u3001",(0,i.jsx)(n.code,{children:"imagePullSecrets"})," \u548c ",(0,i.jsx)(n.code,{children:"patchPodMetadata"})," \u7b49\u5b57\u6bb5\u7684\u5386\u53f2\u7248\u672c\uff0c\u5e76\u5141\u8bb8\u7528\u6237\u5728 Pod \u521b\u5efa\u65f6\u9009\u62e9\u7279\u5b9a\u7684\u5386\u53f2\u7248\u672c\u8fdb\u884c\u6ce8\u5165\u3002\n\u57fa\u4e8e\u8fd9\u4e00\u7279\u6027\uff0c\u7528\u6237\u53ef\u4ee5\u89c4\u907f\u5728 SidecarSet \u7070\u5ea6\u53d1\u5e03\u65f6\uff0c\u56e0Deployment \u7b49 Workload \u6269\u5bb9\u3001\u5347\u7ea7\u7b49\u64cd\u4f5c\u5e26\u6765\u7684 SidecarSet \u53d1\u5e03\u98ce\u9669\u3002\u5982\u679c\u4e0d\u9009\u62e9\u6ce8\u5165\u7248\u672c\uff0cSidecarSet \u5c06\u5bf9\u91cd\u5efa Pod \u9ed8\u8ba4\u5168\u90fd\u6ce8\u5165\u6700\u65b0\u7248\u672c Sidecar\u3002"]}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsxs)(n.strong,{children:["\u6ce8\uff1aSidecarSet \u76f8\u5173 ControllerRevision \u8d44\u6e90\u88ab\u653e\u7f6e\u5728\u4e86\u4e0e Kruise-Manager \u76f8\u540c\u7684\u547d\u540d\u7a7a\u95f4\u4e2d\uff0c\u7528\u6237\u53ef\u4ee5\u4f7f\u7528 ",(0,i.jsx)(n.code,{children:"kubectl get controllerrevisions -n kruise-system -l kruise.io/sidecarset-name=<your-sidecarset-name>"})," \u6765\u67e5\u770b\u3002\u6b64\u5916\uff0c\u7528\u6237\u8fd8\u53ef\u4ee5\u901a\u8fc7 SidecarSet \u7684 ",(0,i.jsx)(n.code,{children:"status.latestRevision"})," \u5b57\u6bb5\u770b\u5230\u5f53\u524d\u7248\u672c\u5bf9\u5e94\u7684 ControllerRevision \u540d\u79f0\uff0c\u4ee5\u65b9\u4fbf\u81ea\u884c\u8bb0\u5f55\u3002"]})}),"\n",(0,i.jsx)(n.h4,{id:"\u901a\u8fc7-controllerrevision-\u540d\u79f0\u6307\u5b9a\u6ce8\u5165\u7684-sidecar-\u7248\u672c",children:"\u901a\u8fc7 ControllerRevision \u540d\u79f0\u6307\u5b9a\u6ce8\u5165\u7684 Sidecar \u7248\u672c"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-yaml",children:"apiVersion: apps.kruise.io/v1alpha1\nkind: SidecarSet\nmetadata:\n  name: sidecarset\nspec:\n  ...\n  injectionStrategy:\n    revision:\n      revisionName: <specific-controllerRevision-name>\n"})}),"\n",(0,i.jsx)(n.h4,{id:"\u901a\u8fc7\u81ea\u5b9a\u4e49\u7248\u672c\u6807\u8bc6\u6307\u5b9a\u6ce8\u5165\u7684-sidecar-\u7248\u672c",children:"\u901a\u8fc7\u81ea\u5b9a\u4e49\u7248\u672c\u6807\u8bc6\u6307\u5b9a\u6ce8\u5165\u7684 Sidecar \u7248\u672c"}),"\n",(0,i.jsxs)(n.p,{children:["\u7528\u6237\u53ef\u4ee5\u901a\u8fc7\u5728\u53d1\u7248\u65f6\uff0c\u540c\u65f6\u7ed9 SidecarSet \u6253\u4e0a ",(0,i.jsx)(n.code,{children:"apps.kruise.io/sidecarset-custom-version=<your-version-id>"})," \u6765\u6807\u8bb0\u6bcf\u4e00\u4e2a\u5386\u53f2\u7248\u672c\uff0cSidecarSet \u4f1a\u5c06\u8fd9\u4e2a label \u5411\u4e0b\u5e26\u5165\u5230\u5bf9\u5e94\u7684 ControllerRevision \u5bf9\u8c61\uff0c\u4ee5\u4fbf\u7528\u6237\u8fdb\u884c\u7b5b\u9009\uff0c\u5e76\u4e14\u5141\u8bb8\u7528\u6237\u5728\u9009\u62e9\u6ce8\u5165\u5386\u53f2\u7248\u672c\u65f6\uff0c\u4f7f\u7528\u8be5 ",(0,i.jsx)(n.code,{children:"<your-version-id>"})," \u6765\u8fdb\u884c\u63cf\u8ff0\u3002"]}),"\n",(0,i.jsxs)(n.p,{children:["\u5047\u8bbe\u7528\u6237\u53ea\u60f3\u7070\u5ea6 ",(0,i.jsx)(n.code,{children:"10%"})," \u7684 Pods \u5230 ",(0,i.jsx)(n.code,{children:"version-2"}),"\uff0c\u5e76\u4e14\u5bf9\u4e8e\u65b0\u521b\u5efa\u7684 Pod \u5e0c\u671b\u90fd\u6ce8\u5165\u66f4\u52a0\u7a33\u5b9a\u7684 ",(0,i.jsx)(n.code,{children:"version-1"})," \u7248\u672c\u6765\u63a7\u5236\u7070\u5ea6\u98ce\u9669\uff1a"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-yaml",children:"apiVersion: apps.kruise.io/v1alpha1\nkind: SidecarSet\nmetadata:\n  name: sidecarset\n  labels:\n    apps.kruise.io/sidecarset-custom-version: version-2\nspec:\n  ...\n  updateStrategy:\n    partition: 90%\n  injectionStrategy:\n    revision:\n      customVersion: version-1\n"})}),"\n",(0,i.jsx)(n.p,{children:"\u4ee5\u4e0a\u4e24\u79cd\u7248\u672c\u9009\u62e9\u65b9\u5f0f\uff0c\u4efb\u9009\u5176\u4e00\u5373\u53ef\u3002"}),"\n",(0,i.jsx)(n.h3,{id:"sidecar\u66f4\u65b0\u7b56\u7565",children:"sidecar\u66f4\u65b0\u7b56\u7565"}),"\n",(0,i.jsx)(n.p,{children:"SidecarSet\u4e0d\u4ec5\u652f\u6301sidecar\u5bb9\u5668\u7684\u539f\u5730\u5347\u7ea7\uff0c\u800c\u4e14\u63d0\u4f9b\u4e86\u975e\u5e38\u4e30\u5bcc\u7684\u5347\u7ea7\u3001\u7070\u5ea6\u7b56\u7565\u3002"}),"\n",(0,i.jsx)(n.h4,{id:"\u5206\u6279\u53d1\u5e03",children:"\u5206\u6279\u53d1\u5e03"}),"\n",(0,i.jsxs)(n.p,{children:["Partition \u7684\u8bed\u4e49\u662f ",(0,i.jsx)(n.strong,{children:"\u4fdd\u7559\u65e7\u7248\u672c Pod \u7684\u6570\u91cf\u6216\u767e\u5206\u6bd4"}),"\uff0c\u9ed8\u8ba4\u4e3a ",(0,i.jsx)(n.code,{children:"0"}),"\u3002\u8fd9\u91cc\u7684 ",(0,i.jsx)(n.code,{children:"partition"})," ",(0,i.jsx)(n.strong,{children:"\u4e0d\u8868\u793a"}),"\u4efb\u4f55 ",(0,i.jsx)(n.code,{children:"order"})," \u5e8f\u53f7\u3002"]}),"\n",(0,i.jsxs)(n.p,{children:["\u5982\u679c\u5728\u53d1\u5e03\u8fc7\u7a0b\u4e2d\u8bbe\u7f6e\u4e86 ",(0,i.jsx)(n.code,{children:"partition"}),":"]}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["\u5982\u679c\u662f\u6570\u5b57\uff0c\u63a7\u5236\u5668\u4f1a\u5c06 ",(0,i.jsx)(n.code,{children:"(replicas - partition)"})," \u6570\u91cf\u7684 Pod \u66f4\u65b0\u5230\u6700\u65b0\u7248\u672c\u3002"]}),"\n",(0,i.jsxs)(n.li,{children:["\u5982\u679c\u662f\u767e\u5206\u6bd4\uff0c\u63a7\u5236\u5668\u4f1a\u5c06 ",(0,i.jsx)(n.code,{children:"(replicas * (100% - partition))"})," \u6570\u91cf\u7684 Pod \u66f4\u65b0\u5230\u6700\u65b0\u7248\u672c\u3002"]}),"\n"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-yaml",children:"apiVersion: apps.kruise.io/v1alpha1\nkind: SidecarSet\nmetadata:\n  name: sidecarset\nspec:\n  # ...\n  updateStrategy:\n    type: RollingUpdate\n    partition: 90\n"})}),"\n",(0,i.jsx)(n.p,{children:"\u5047\u8bbe\u8be5SidecarSet\u5173\u8054\u7684pod\u6570\u91cf\u662f100\u4e2a\uff0c\u5219\u672c\u6b21\u5347\u7ea7\u53ea\u4f1a\u5347\u7ea710\u4e2a\uff0c\u4fdd\u755990\u4e2a\u3002"}),"\n",(0,i.jsx)(n.h4,{id:"\u6700\u5927\u4e0d\u53ef\u7528\u6570\u91cf",children:"\u6700\u5927\u4e0d\u53ef\u7528\u6570\u91cf"}),"\n",(0,i.jsx)(n.p,{children:"MaxUnavailable \u662f\u53d1\u5e03\u8fc7\u7a0b\u4e2d\u4fdd\u8bc1\u7684\uff0c\u540c\u4e00\u65f6\u95f4\u4e0b\u6700\u5927\u4e0d\u53ef\u7528\u7684 Pod \u6570\u91cf\uff0c\u9ed8\u8ba4\u503c\u4e3a 1\u3002\u7528\u6237\u53ef\u4ee5\u5c06\u5176\u8bbe\u7f6e\u4e3a\u7edd\u5bf9\u503c\u6216\u767e\u5206\u6bd4\uff08\u767e\u5206\u6bd4\u4f1a\u88ab\u63a7\u5236\u5668\u6309\u7167selected pod\u505a\u57fa\u6570\u6765\u8ba1\u7b97\u51fa\u4e00\u4e2a\u80cc\u540e\u7684\u7edd\u5bf9\u503c\uff09\u3002"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-yaml",children:"apiVersion: apps.kruise.io/v1alpha1\nkind: SidecarSet\nmetadata:\n  name: sidecarset\nspec:\n  # ...\n  updateStrategy:\n    type: RollingUpdate\n    maxUnavailable: 20%\n"})}),"\n",(0,i.jsx)(n.p,{children:"\u6ce8\u610f\uff0cmaxUnavailable \u548c partition \u4e24\u4e2a\u503c\u662f\u6ca1\u6709\u5fc5\u7136\u5173\u8054\u3002\u4e3e\u4f8b\uff1a"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["\u5f53 ",(0,i.jsx)(n.code,{children:"{matched pod}=100,partition=50,maxUnavailable=10"}),"\uff0c\u63a7\u5236\u5668\u4f1a\u53d1\u5e03 50 \u4e2a Pod \u5230\u65b0\u7248\u672c\uff0c\u4f46\u662f\u53d1\u5e03\u7a97\u53e3\u4e3a 10\uff0c\u5373\u540c\u4e00\u65f6\u95f4\u53ea\u4f1a\u53d1\u5e03 10 \u4e2a Pod\uff0c\u6bcf\u53d1\u5e03\u597d\u4e00\u4e2a Pod \u624d\u4f1a\u518d\u627e\u4e00\u4e2a\u53d1\u5e03\uff0c\u76f4\u5230 50 \u4e2a\u53d1\u5e03\u5b8c\u6210\u3002"]}),"\n",(0,i.jsxs)(n.li,{children:["\u5f53 ",(0,i.jsx)(n.code,{children:"{matched pod}=100,partition=80,maxUnavailable=30"}),"\uff0c\u63a7\u5236\u5668\u4f1a\u53d1\u5e03 20 \u4e2a Pod \u5230\u65b0\u7248\u672c\uff0c\u56e0\u4e3a\u6ee1\u8db3 maxUnavailable \u6570\u91cf\uff0c\u6240\u4ee5\u8fd9 20 \u4e2a Pod \u4f1a\u540c\u65f6\u53d1\u5e03\u3002"]}),"\n"]}),"\n",(0,i.jsx)(n.h4,{id:"\u66f4\u65b0\u6682\u505c",children:"\u66f4\u65b0\u6682\u505c"}),"\n",(0,i.jsx)(n.p,{children:"\u7528\u6237\u53ef\u4ee5\u901a\u8fc7\u8bbe\u7f6e paused \u4e3a true \u6682\u505c\u53d1\u5e03\uff0c\u6b64\u65f6\u5bf9\u4e8e\u65b0\u521b\u5efa\u7684\u3001\u6269\u5bb9\u7684pod\u4f9d\u65e7\u4f1a\u5b9e\u73b0\u6ce8\u5165\u80fd\u529b\uff0c\u5df2\u7ecf\u66f4\u65b0\u7684pod\u4f1a\u4fdd\u6301\u66f4\u65b0\u540e\u7684\u7248\u672c\u4e0d\u52a8\uff0c\u8fd8\u6ca1\u6709\u66f4\u65b0\u7684pod\u4f1a\u6682\u505c\u66f4\u65b0\u3002"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-yaml",children:"apiVersion: apps.kruise.io/v1alpha1\nkind: SidecarSet\nmetadata:\n  name: sidecarset\nspec:\n  # ...\n  updateStrategy:\n    type: RollingUpdate\n    paused: true\n"})}),"\n",(0,i.jsx)(n.h4,{id:"\u91d1\u4e1d\u96c0\u53d1\u5e03",children:"\u91d1\u4e1d\u96c0\u53d1\u5e03"}),"\n",(0,i.jsx)(n.p,{children:"\u5bf9\u4e8e\u6709\u91d1\u4e1d\u96c0\u53d1\u5e03\u9700\u6c42\u7684\u4e1a\u52a1\uff0c\u53ef\u4ee5\u901a\u8fc7strategy.selector\u6765\u5b9e\u73b0\u3002\u65b9\u5f0f\uff1a\u5bf9\u4e8e\u9700\u8981\u7387\u5148\u91d1\u4e1d\u96c0\u7070\u5ea6\u7684pod\u6253\u4e0a\u56fa\u5b9a\u7684labels[canary.release] = true\uff0c\u518d\u901a\u8fc7strategy.selector.matchLabels\u6765\u9009\u4e2d\u8be5pod"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-yaml",children:'apiVersion: apps.kruise.io/v1alpha1\nkind: SidecarSet\nmetadata:\n  name: sidecarset\nspec:\n  # ...\n  updateStrategy:\n    type: RollingUpdate\n    selector:\n      matchLabels:\n        canary.release: "true"\n'})}),"\n",(0,i.jsx)(n.h3,{id:"\u53d1\u5e03\u987a\u5e8f\u63a7\u5236",children:"\u53d1\u5e03\u987a\u5e8f\u63a7\u5236"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"\u9ed8\u8ba4\u5bf9\u5347\u7ea7\u7684pod\u6392\u5e8f\uff0c\u4fdd\u8bc1\u591a\u6b21\u5347\u7ea7\u7684\u987a\u5e8f\u4e00\u81f4"}),"\n",(0,i.jsx)(n.li,{children:"\u9ed8\u8ba4\u9009\u62e9\u4f18\u5148\u987a\u5e8f\u662f\uff08\u8d8a\u5c0f\u4f18\u5148\u7ea7\u8d8a\u9ad8\uff09\uff1a unscheduled < scheduled, pending < unknown < running, not-ready < ready, newer pods < older pods"}),"\n",(0,i.jsxs)(n.li,{children:["\u589e\u5f3a\u7684 ",(0,i.jsx)(n.code,{children:"priority"}),"(\u4f18\u5148\u7ea7) \u548c ",(0,i.jsx)(n.code,{children:"scatter"}),"(\u6253\u6563) \u7b56\u7565\u6765\u5141\u8bb8\u7528\u6237\u81ea\u5b9a\u4e49\u53d1\u5e03\u987a\u5e8f\u3002"]}),"\n"]}),"\n",(0,i.jsx)(n.h4,{id:"\u4f18\u5148\u7ea7\u7b56\u7565",children:"\u4f18\u5148\u7ea7\u7b56\u7565"}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"FEATURE STATE:"})," Kruise v1.5.0"]}),"\n",(0,i.jsxs)(n.p,{children:["\u8fd9\u4e2a\u7b56\u7565\u5b9a\u4e49\u4e86\u63a7\u5236\u5668\u8ba1\u7b97 Pod \u53d1\u5e03\u4f18\u5148\u7ea7\u7684\u89c4\u5219\uff0c\u6240\u6709\u9700\u8981\u66f4\u65b0\u7684 Pod \u90fd\u4f1a\u901a\u8fc7\u8fd9\u4e2a\u4f18\u5148\u7ea7\u89c4\u5219\u8ba1\u7b97\u540e\u6392\u5e8f\u3002\n\u76ee\u524d ",(0,i.jsx)(n.code,{children:"priority"})," \u53ef\u4ee5\u901a\u8fc7 weight(\u6743\u91cd) \u548c order(\u5e8f\u53f7) \u4e24\u79cd\u65b9\u5f0f\u6765\u6307\u5b9a\u3002"]}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"weight"}),": Pod \u4f18\u5148\u7ea7\u662f\u7531\u6240\u6709 weights \u5217\u8868\u4e2d\u7684 term \u6765\u8ba1\u7b97 match selector \u5f97\u51fa\u3002\u5982\u4e0b\uff1a"]}),"\n"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-yaml",children:"apiVersion: apps.kruise.io/v1alpha1\nkind: SidecarSet\nspec:\n  # ...\n  updateStrategy:\n    priorityStrategy:\n      weightPriority:\n      - weight: 50\n        matchSelector:\n          matchLabels:\n            test-key: foo\n      - weight: 30\n        matchSelector:\n          matchLabels:\n            test-key: bar\n"})}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"order"}),': Pod \u4f18\u5148\u7ea7\u662f\u7531 orderKey \u7684 value \u51b3\u5b9a\uff0c\u8fd9\u91cc\u8981\u6c42\u5bf9\u5e94\u7684 value \u7684\u7ed3\u5c3e\u80fd\u89e3\u6790\u4e3a int \u503c\u3002\u6bd4\u5982 value "5" \u7684\u4f18\u5148\u7ea7\u662f 5\uff0cvalue "sts-10" \u7684\u4f18\u5148\u7ea7\u662f 10\u3002']}),"\n"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-yaml",children:"apiVersion: apps.kruise.io/v1alpha1\nkind: SidecarSet\nspec:\n  # ...\n  updateStrategy:\n    priorityStrategy:\n      orderPriority:\n      - orderedKey: some-label-key\n"})}),"\n",(0,i.jsx)(n.h4,{id:"scatter\u6253\u6563\u987a\u5e8f",children:"scatter\u6253\u6563\u987a\u5e8f"}),"\n",(0,i.jsx)(n.p,{children:"\u6253\u6563\u7b56\u7565\u5141\u8bb8\u7528\u6237\u5b9a\u4e49\u5c06\u7b26\u5408\u67d0\u4e9b\u6807\u7b7e\u7684 Pod \u6253\u6563\u5230\u6574\u4e2a\u53d1\u5e03\u8fc7\u7a0b\u4e2d\u3002\u6bd4\u5982\uff0c\u4e00\u4e2a SidecarSet\u6240\u7ba1\u7406\u7684pod\u4e3a10\uff0c\u5982\u679c\u4e0b\u9762\u6709 3 \u4e2a Pod \u5e26\u6709 foo=bar \u6807\u7b7e\uff0c\u4e14\u7528\u6237\u5728\u6253\u6563\u7b56\u7565\u4e2d\u8bbe\u7f6e\u4e86\u8fd9\u4e2a\u6807\u7b7e\uff0c\u90a3\u4e48\u8fd9 3 \u4e2a Pod \u4f1a\u88ab\u653e\u5728\u7b2c 1\u30016\u300110 \u4e2a\u4f4d\u7f6e\u53d1\u5e03\u3002"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-yaml",children:"apiVersion: apps.kruise.io/v1alpha1\nkind: SidecarSet\nmetadata:\n  name: sidecarset\nspec:\n  # ...\n  updateStrategy:\n    type: RollingUpdate\n    scatterStrategy:\n    - key: foo\n      value: bar\n"})}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.strong,{children:"\u6ce8\u610f\uff1a\u5982\u679c\u4f7f\u7528 scatter \u7b56\u7565\uff0c\u5efa\u8bae\u53ea\u8bbe\u7f6e\u4e00\u5bf9 key-value \u505a\u6253\u6563\uff0c\u4f1a\u6bd4\u8f83\u597d\u7406\u89e3\u3002"})}),"\n",(0,i.jsx)(n.h3,{id:"sidecar\u70ed\u5347\u7ea7\u7279\u6027",children:"Sidecar\u70ed\u5347\u7ea7\u7279\u6027"}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"FEATURE STATE:"})," Kruise v0.9.0"]}),"\n",(0,i.jsx)(n.p,{children:"SidecarSet\u539f\u5730\u5347\u7ea7\u4f1a\u5148\u505c\u6b62\u65e7\u7248\u672c\u7684\u5bb9\u5668\uff0c\u7136\u540e\u521b\u5efa\u65b0\u7248\u672c\u7684\u5bb9\u5668\u3002\u8fd9\u79cd\u65b9\u5f0f\u66f4\u52a0\u9002\u5408\u4e0d\u5f71\u54cdPod\u670d\u52a1\u53ef\u7528\u6027\u7684sidecar\u5bb9\u5668\uff0c\u6bd4\u5982\u8bf4\uff1a\u65e5\u5fd7\u6536\u96c6Agent\u3002"}),"\n",(0,i.jsx)(n.p,{children:"\u4f46\u662f\u5bf9\u4e8e\u5f88\u591a\u4ee3\u7406\u6216\u8fd0\u884c\u65f6\u7684sidecar\u5bb9\u5668\uff0c\u4f8b\u5982Istio Envoy\uff0c\u8fd9\u79cd\u5347\u7ea7\u65b9\u6cd5\u5c31\u6709\u95ee\u9898\u4e86\u3002Envoy\u4f5c\u4e3aPod\u4e2d\u7684\u4e00\u4e2a\u4ee3\u7406\u5bb9\u5668\uff0c\u4ee3\u7406\u4e86\u6240\u6709\u7684\u6d41\u91cf\uff0c\u5982\u679c\u76f4\u63a5\u91cd\u542f\uff0cPod\u670d\u52a1\u7684\u53ef\u7528\u6027\u4f1a\u53d7\u5230\u5f71\u54cd\u3002\u5982\u679c\u9700\u8981\u5355\u72ec\u5347\u7ea7envoy sidecar\uff0c\u5c31\u9700\u8981\u590d\u6742\u7684grace\u7ec8\u6b62\u548c\u534f\u8c03\u673a\u5236\u3002\u6240\u4ee5\u6211\u4eec\u4e3a\u8fd9\u79cdsidecar\u5bb9\u5668\u7684\u5347\u7ea7\u63d0\u4f9b\u4e86\u4e00\u79cd\u65b0\u7684\u89e3\u51b3\u65b9\u6848\u3002"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-yaml",children:"apiVersion: apps.kruise.io/v1alpha1\nkind: SidecarSet\nmetadata:\n  name: hotupgrade-sidecarset\nspec:\n  selector:\n    matchLabels:\n      app: hotupgrade\n  containers:\n  - name: sidecar\n    image: openkruise/hotupgrade-sample:sidecarv1\n    imagePullPolicy: Always\n    lifecycle:\n      postStart:\n        exec:\n          command:\n          - /bin/sh\n          - /migrate.sh\n    upgradeStrategy:\n      upgradeType: HotUpgrade\n      hotUpgradeEmptyImage: openkruise/hotupgrade-sample:empty\n"})}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"upgradeType: HotUpgrade\u4ee3\u8868\u8be5sidecar\u5bb9\u5668\u7684\u7c7b\u578b\u662fhot upgrade\uff0c\u5c06\u6267\u884c\u70ed\u5347\u7ea7\u65b9\u6848"}),"\n",(0,i.jsx)(n.li,{children:"hotUpgradeEmptyImage: \u5f53\u70ed\u5347\u7ea7sidecar\u5bb9\u5668\u65f6\uff0c\u4e1a\u52a1\u5fc5\u987b\u8981\u63d0\u4f9b\u4e00\u4e2aempty\u5bb9\u5668\u7528\u4e8e\u70ed\u5347\u7ea7\u8fc7\u7a0b\u4e2d\u7684\u5bb9\u5668\u5207\u6362\u3002empty\u5bb9\u5668\u540csidecar\u5bb9\u5668\u5177\u6709\u76f8\u540c\u7684\u914d\u7f6e\uff08\u9664\u4e86\u955c\u50cf\u5730\u5740\uff09\uff0c\u4f8b\u5982\uff1acommand, lifecycle, probe\u7b49\uff0c\u4f46\u662f\u5b83\u4e0d\u505a\u4efb\u4f55\u5de5\u4f5c\u3002"}),"\n",(0,i.jsx)(n.li,{children:"lifecycle.postStart: \u72b6\u6001\u8fc1\u79fb\uff0c\u8be5\u8fc7\u7a0b\u5b8c\u6210\u70ed\u5347\u7ea7\u8fc7\u7a0b\u4e2d\u7684\u72b6\u6001\u8fc1\u79fb\uff0c\u8be5\u811a\u672c\u9700\u8981\u7531\u4e1a\u52a1\u6839\u636e\u81ea\u8eab\u7684\u7279\u70b9\u81ea\u884c\u5b9e\u73b0\uff0c\u4f8b\u5982\uff1anginx\u70ed\u5347\u7ea7\u9700\u8981\u5b8c\u6210Listen FD\u5171\u4eab\u4ee5\u53ca\u6d41\u91cf\u6392\u6c34\uff08reload\uff09"}),"\n"]}),"\n",(0,i.jsx)(n.p,{children:"\u70ed\u5347\u7ea7\u7279\u6027\u603b\u5171\u5305\u542b\u4ee5\u4e0b\u4e24\u4e2a\u8fc7\u7a0b\uff1a"}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsx)(n.li,{children:"Pod\u521b\u5efa\u65f6\uff0c\u6ce8\u5165\u70ed\u5347\u7ea7\u5bb9\u5668"}),"\n",(0,i.jsx)(n.li,{children:"\u539f\u5730\u5347\u7ea7\u65f6\uff0c\u5b8c\u6210\u70ed\u5347\u7ea7\u6d41\u7a0b"}),"\n"]}),"\n",(0,i.jsx)(n.h4,{id:"\u6ce8\u5165\u70ed\u5347\u7ea7\u5bb9\u5668",children:"\u6ce8\u5165\u70ed\u5347\u7ea7\u5bb9\u5668"}),"\n",(0,i.jsx)(n.p,{children:"Pod\u521b\u5efa\u65f6\uff0cSidecarSet Webhook\u5c06\u4f1a\u6ce8\u5165\u4e24\u4e2a\u5bb9\u5668\uff1a"}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"{sidecarContainer.name}-1"}),": \u5982\u4e0b\u56fe\u6240\u793a envoy-1\uff0c\u8fd9\u4e2a\u5bb9\u5668\u4ee3\u8868\u6b63\u5728\u5b9e\u9645\u5de5\u4f5c\u7684sidecar\u5bb9\u5668\uff0c\u4f8b\u5982\uff1aenvoy:1.16.0"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"{sidecarContainer.name}-2"}),": \u5982\u4e0b\u56fe\u6240\u793a envoy-2\uff0c\u8fd9\u4e2a\u5bb9\u5668\u662f\u4e1a\u52a1\u914d\u7f6e\u7684hotUpgradeEmptyImage\u5bb9\u5668\uff0c\u4f8b\u5982\uff1aempty:1.0\uff0c\u7528\u4e8e\u540e\u9762\u7684\u70ed\u5347\u7ea7\u673a\u5236"]}),"\n"]}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.img,{alt:"sidecarset hotupgrade_injection",src:s(44012).A+"",width:"677",height:"405"})}),"\n",(0,i.jsx)(n.h4,{id:"\u70ed\u5347\u7ea7\u6d41\u7a0b",children:"\u70ed\u5347\u7ea7\u6d41\u7a0b"}),"\n",(0,i.jsx)(n.p,{children:"\u70ed\u5347\u7ea7\u6d41\u7a0b\u4e3b\u8981\u5206\u4e3a\u4e00\u4e0b\u4e09\u4e2a\u6b65\u9aa4\uff1a"}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsx)(n.li,{children:"Upgrade: \u5c06empty\u5bb9\u5668\u5347\u7ea7\u4e3a\u5f53\u524d\u6700\u65b0\u7684sidecar\u5bb9\u5668\uff0c\u4f8b\u5982\uff1aenvoy-2.Image = envoy:1.17.0"}),"\n",(0,i.jsxs)(n.li,{children:["Migration: lifecycle.postStart\u5b8c\u6210\u70ed\u5347\u7ea7\u6d41\u7a0b\u4e2d\u7684\u72b6\u6001\u8fc1\u79fb\uff0c\u5f53\u8fc1\u79fb\u5b8c\u6210\u540e\u9000\u51fa\u3002(",(0,i.jsxs)(n.strong,{children:["\u6ce8\u610f",":PostStartHook","\u5728\u8fc1\u79fb\u8fc7\u7a0b\u4e2d\u5fc5\u987b\u963b\u585e\uff0c\u8fc1\u79fb\u5b8c\u6210\u540e\u9000\u51fa\u3002"]}),")"]}),"\n",(0,i.jsx)(n.li,{children:"Reset: \u72b6\u6001\u8fc1\u79fb\u5b8c\u6210\u540e\uff0c\u70ed\u5347\u7ea7\u6d41\u7a0b\u5c06\u8bbe\u7f6eenvoy-1\u5bb9\u5668\u4e3aempty\u955c\u50cf\uff0c\u4f8b\u5982\uff1aenvoy-1.Image = empty:1.0"}),"\n"]}),"\n",(0,i.jsx)(n.p,{children:"\u4e0a\u8ff0\u4e09\u4e2a\u6b65\u9aa4\u5b8c\u6210\u4e86\u70ed\u5347\u7ea7\u4e2d\u7684\u5168\u90e8\u6d41\u7a0b\uff0c\u5f53\u5bf9Pod\u6267\u884c\u591a\u6b21\u70ed\u5347\u7ea7\u65f6\uff0c\u5c06\u91cd\u590d\u6027\u7684\u6267\u884c\u4e0a\u8ff0\u4e09\u4e2a\u6b65\u9aa4\u3002"}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.img,{alt:"sidecarset hotupgrade",src:s(74330).A+"",width:"653",height:"432"})}),"\n",(0,i.jsx)(n.h4,{id:"migration-demo",children:"Migration Demo"}),"\n",(0,i.jsxs)(n.p,{children:["SidecarSet\u70ed\u5347\u7ea7\u673a\u5236\u4e0d\u4ec5\u5b8c\u6210\u4e86mesh\u5bb9\u5668\u7684\u5207\u6362\uff0c\u5e76\u4e14\u63d0\u4f9b\u4e86\u65b0\u8001\u7248\u672c\u7684\u534f\u8c03\u673a\u5236\uff08PostStartHook\uff09\uff0c\u4f46\u662f\u81f3\u6b64\u8fd8\u53ea\u662f\u4e07\u91cc\u957f\u5f81\u7684\u7b2c\u4e00\u6b65\uff0cMesh\u5bb9\u5668\u540c\u65f6\u8fd8\u9700\u8981\u63d0\u4f9b PostStartHook \u811a\u672c\u6765\u5b8c\u6210mesh\u670d\u52a1\u81ea\u8eab\u7684\u5e73\u6ed1\u5347\u7ea7\uff08\u4e0a\u8ff0Migration\u8fc7\u7a0b\uff09\uff0c\u5982\uff1aEnvoy\u70ed\u91cd\u542f\u3001Mosn\u65e0\u635f\u91cd\u542f\u3002\n\u4e3a\u4e86\u65b9\u4fbf\u5927\u5bb6\u80fd\u66f4\u597d\u7684\u7406\u89e3Migration\u8fc7\u7a0b\uff0c\u5728kruise\u4ed3\u5e93\u4e0b\u9762\u63d0\u4f9b\u4e86\u4e00\u4e2a\u5305\u542b\u4ee3\u7801\u548c\u955c\u50cf\u7684demo\uff0c\u4f9b\u5927\u5bb6\u53c2\u8003\uff1a",(0,i.jsx)(n.a,{href:"https://github.com/openkruise/samples/tree/master/hotupgrade",children:"Migration Demo"})]}),"\n",(0,i.jsxs)(n.p,{children:["\u8bbe\u8ba1\u6587\u6863\u8bf7\u53c2\u8003: ",(0,i.jsx)(n.a,{href:"https://github.com/openkruise/kruise/blob/master/docs/proposals/20210305-sidecarset-hotupgrade.md",children:"proposals sidecarset hot upgrade"})]}),"\n",(0,i.jsx)(n.p,{children:"\u5f53\u524d\u5df2\u77e5\u7684\u5229\u7528SidecarSet\u70ed\u5347\u7ea7\u673a\u5236\u7684\u6848\u4f8b\uff1a"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.a,{href:"https://help.aliyun.com/document_detail/193804.html",children:"ALIYUN ASM"})," \u5b9e\u73b0\u4e86Service Mesh\u4e2d\u6570\u636e\u9762\u7684\u65e0\u635f\u5347\u7ea7"]}),"\n"]}),"\n",(0,i.jsx)(n.h3,{id:"inject-pod-metadata",children:"Inject Pod Metadata"}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"FEATURE STATE:"})," Kruise v1.3.0"]}),"\n",(0,i.jsx)(n.p,{children:"SidecarSet\u652f\u6301\u6ce8\u5165Pod Annotations\uff0c\u5982\u4e0b\uff1a"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-yaml",children:'apiVersion: apps.kruise.io/v1alpha1\nkind: SidecarSet\nspec:\n  containers:\n    ...\n  patchPodMetadata:\n  - annotations:\n      oom-score: \'{"log-agent": 1}\'\n      custom.example.com/sidecar-configuration: \'{"command": "/home/admin/bin/start.sh", "log-level": "3"}\'\n    patchPolicy: MergePatchJson\n  - annotations:\n      apps.kruise.io/container-launch-priority: Ordered\n    patchPolicy: Overwrite | Retain\n'})}),"\n",(0,i.jsx)(n.p,{children:"patchPolicy\u4e3a\u6ce8\u5165\u7684\u7b56\u7565\uff0c\u5982\u4e0b\uff1a"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Retain\uff1a"})," \u9ed8\u8ba4\u7b56\u7565\uff0c\u5982\u679cPod\u4e2d\u5b58\u5728 annotation[key]=value \uff0c\u5219\u4fdd\u7559Pod\u539f\u6709\u7684value\u3002\u53ea\u6709\u5f53 Pod\u4e2d\u4e0d\u5b58\u5728 annotation[key] \u65f6\uff0c\u624d\u6ce8\u5165 annotations[key]=value\u3002"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Overwrite\uff1a"})," \u4e0e Retain \u5bf9\u5e94\uff0c\u5f53 Pod \u4e2d\u5b58\u5728 annotation[key]=value\uff0c\u5c06\u88ab\u5f3a\u5236\u8986\u76d6\u4e3a value2\u3002"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"MergePatchJson\uff1a"})," \u4e0e Overwrite \u5bf9\u5e94\uff0cannotations value\u4e3a json \u5b57\u7b26\u4e32\u3002\u5982\u679c Pod \u4e0d\u5b58\u5728\u8be5 annotations[key]\uff0c\u5219\u76f4\u63a5\u6ce8\u5165\u3002\u5982\u679c\u5b58\u5728\uff0c\u5219\u8fdb\u884c json value\u5408\u5e76\u3002\n\u4f8b\u5982\uff1aPod\u4e2d\u5b58\u5728 ",(0,i.jsx)(n.code,{children:"annotations[oom-score]='{\"main\": 2}'"}),"\uff0c\u6ce8\u5165\u540e\u5c06 value json\u5408\u5e76\u4e3a ",(0,i.jsx)(n.code,{children:'annotations[oom-score]=\'{"log-agent": 1, "main": 2}\''}),"\u3002"]}),"\n"]}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"\u6ce8\u610f\uff1a"})," patchPolicy\u4e3aOverwrite\u548cMergePatchJson\u65f6\uff0cSidecarSet\u539f\u5730\u5347\u7ea7 Sidecar Container\u65f6\uff0c\u80fd\u591f\u540c\u6b65\u66f4\u65b0\u8be5 annotations\u3002\u4f46\u662f\uff0c\u5982\u679c\u53ea\u4fee\u6539annotations\u5219\u4e0d\u80fd\u751f\u6548\uff0c\u53ea\u80fd\u642d\u914dSidecar\u5bb9\u5668\u955c\u50cf\u4e00\u8d77\u539f\u5730\u5347\u7ea7\u3002\npatchPolicy\u4e3aRetain\u65f6\uff0cSidecarSet\u539f\u5730\u5347\u7ea7 Sidecar Container\u65f6\uff0c\u5c06\u4e0d\u4f1a\u540c\u6b65\u66f4\u65b0\u8be5 annotations\u3002"]}),"\n",(0,i.jsx)(n.p,{children:"\u4e0a\u8ff0\u914d\u7f6e\u540e\uff0csidecarSet\u5728\u6ce8\u5165sidecar container\u65f6\uff0c\u4f1a\u6ce8\u5165Pod annotations\uff0c\u5982\u4e0b\uff1a"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-yaml",children:'apiVersion: v1\nkind: Pod\nmetadata:\n  annotations:\n    apps.kruise.io/container-launch-priority: Ordered\n    oom-score: \'{"log-agent": 1, "main": 2}\'\n    custom.example.com/sidecar-configuration: \'{"command": "/home/admin/bin/start.sh", "log-level": "3"}\'\n  name: test-pod\nspec:\n  containers:\n    ...\n'})}),"\n",(0,i.jsx)(n.h4,{id:"metadata-\u767d\u540d\u5355",children:"Metadata \u767d\u540d\u5355"}),"\n",(0,i.jsx)(n.p,{children:"SidecarSet\u4ece\u5b89\u5168\u7684\u8003\u8651\u4e0d\u5e94\u8be5\u4fee\u6539\u9664sidecar container\u4e4b\u5916\u7684\u4efb\u4f55Pod\u5b57\u6bb5\u3002\u4f46\u662f\u76ee\u524d\u5f88\u591a\u7684sidecar container\u7684\u4e00\u4e9b\u914d\u7f6e\uff0c\u9700\u8981\u4ecePod Annotations\u4e0a\u6765\u83b7\u53d6\u3002\n\u6240\u4ee5\u5982\u679c\u60f3\u8981\u4f7f\u7528\u8be5\u80fd\u529b\uff0c\u9996\u5148\u9700\u8981\u914d\u7f6e SidecarSet_PatchPodMetadata_WhiteList \u767d\u540d\u5355\uff0c\u5982\u4e0b\uff1a"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-yaml",children:'apiVersion: v1\nkind: ConfigMap\nmetadata:\n  name: kruise-configuration\n  namespace: kruise-system\ndata:\n  "SidecarSet_PatchPodMetadata_WhiteList": |\n    {\n      "rules": [\n        {\n          "selector":{\n            "matchLabels":{\n              "sidecar":"log-agent"\n            }\n          },\n          "allowedAnnotationKeyExprs": [\n            "^apps.kruise.io/container-launch-priority$",\n            "^oom-score$",\n            "^custom.example.com/sidecar-configuration$"\n          ]\n        }\n      ]\n    }\n'})}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"selector:"})," \u6839\u636eLabel\u9009\u62e9\u751f\u6548\u7684SidecarSet\uff0cMatchLabels\u548cMatchExpressions\u90fd\u652f\u6301\u3002\u5982\u679c\u4e0d\u914d\u7f6e\uff0c\u5219\u5bf9\u8be5\u96c6\u7fa4\u6240\u6709\u7684SidecarSet\u751f\u6548\u3002"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"allowedAnnotationKeyExprs:"})," \u5141\u8bb8\u4fee\u6539\u7684Pod annotation key\u767d\u540d\u5355\uff0c\u5fc5\u987b\u4e3a\u6b63\u5219\u8868\u8fbe\u5f0f\u3002"]}),"\n"]}),"\n",(0,i.jsx)(n.h4,{id:"feature-gate",children:"Feature-gate"}),"\n",(0,i.jsx)(n.p,{children:"SidecarSet_PatchPodMetadata_WhiteList \u4e3b\u8981\u662f\u8003\u8651\u5230\u5b89\u5168\uff0c\u5982\u679c\u7528\u6237\u7684\u96c6\u7fa4\u4f7f\u7528\u573a\u666f\u6bd4\u8f83\u53ef\u63a7\uff0c\u53ef\u4ee5\u901a\u8fc7 Feature-gate \u7684\u65b9\u5f0f\u6765\u5173\u95ed\u767d\u540d\u5355\u7684\u6821\u9a8c\uff0c\u5982\u4e0b\uff1a"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-shell",children:'$ helm install kruise https://... --set featureGates="SidecarSetPatchPodMetadataDefaultsAllowed=true"\n'})}),"\n",(0,i.jsx)(n.h3,{id:"sidecarset\u72b6\u6001\u8bf4\u660e",children:"SidecarSet\u72b6\u6001\u8bf4\u660e"}),"\n",(0,i.jsx)(n.p,{children:"\u901a\u8fc7sidecarset\u539f\u5730\u5347\u7ea7sidecar\u5bb9\u5668\u65f6\uff0c\u53ef\u4ee5\u901a\u8fc7SidecarSet.Status\u6765\u89c2\u5bdf\u5347\u7ea7\u7684\u8fc7\u7a0b"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-yaml",children:"# kubectl describe sidecarsets sidecarset-example\nName:         sidecarset-example\nKind:         SidecarSet\nStatus:\n  Matched Pods:         10  # The number of PODs injected and managed by the Sidecarset\n  Updated Pods:         5   # 5 PODs have been updated to the container version in the latest SidecarSet\n  Ready Pods:           8   # Matched Pods pod.status.condition.Ready = true number\n  Updated Ready Pods:   3   # Updated Pods && Ready Pods number\n"})}),"\n",(0,i.jsx)(n.h2,{id:"\u5982\u4f55\u6392\u67e5-sidecarset-\u72ec\u7acb\u5347\u7ea7-sidecar-\u5bb9\u5668\u5361\u4f4f",children:"\u5982\u4f55\u6392\u67e5 SidecarSet \u72ec\u7acb\u5347\u7ea7 Sidecar \u5bb9\u5668\u5361\u4f4f\uff1f"}),"\n",(0,i.jsxs)(n.p,{children:["kubernetes\u793e\u533a\u53ea\u5141\u8bb8 patch pod.spec \u4e2d ",(0,i.jsx)(n.strong,{children:"image \u5b57\u6bb5"}),"\uff0c\u8fdb\u800c SidecarSet \u72ec\u7acb\u5347\u7ea7 Sidecar \u5bb9\u5668\u4e5f\u53ea\u80fd\u652f\u6301 image \u5b57\u6bb5\u3002\n\u5982\u679c SidecarSet \u4e2d\u4fee\u6539\u4e86\u9664 image \u7684\u5176\u5b83\u5b57\u6bb5\uff0c\u6bd4\u5982\uff1aEnv\u3001Resources\uff0c\u5c06\u4f1a\u5bfc\u81f4\u72ec\u7acb\u5347\u7ea7 Sidecar \u5bb9\u5668\u5361\u4f4f\u3002"]}),"\n",(0,i.jsxs)(n.p,{children:["\u793e\u533a\u5f53\u4e2d\u7ecf\u5e38\u4f1a\u6709\u540c\u5b66\u6709\u6b64\u7591\u95ee\uff0c\u4e3a\u4e86\u65b9\u4fbf\u5927\u5bb6\u6392\u67e5\u7c7b\u4f3c\u7684\u95ee\u9898\uff0c",(0,i.jsx)(n.strong,{children:"\u4ece kruise v1.5.0 \u7248\u672c\u5f00\u59cb"}),"\uff0ckruise\u5c06\u4f1a\u4e0a\u62a5\u76f8\u5173\u7684\u4fe1\u606f\u5230 ",(0,i.jsx)(n.strong,{children:"Pod Condition"})," \u548c ",(0,i.jsx)(n.strong,{children:"SidecarSet Event"}),"\uff0c\u5982\u4e0b\uff1a"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:'# kubectl describe sidecarsets test-sidecarset\nStatus:\n  Collision Count:      0\n  Latest Revision:      test-sidecarset-5f6d95f777\n  Matched Pods:         1\n  Observed Generation:  2\n  Ready Pods:           1\n  Updated Pods:         0\nEvents:\n  Type    Reason             Age   From                   Message\n----    ------             ----  ----                   -------\nNormal  NotUpgradablePods  63s   sidecarset-controller  SidecarSet in-place update detected 1 not upgradable pod(s) in this round, will skip them\n\n# kubectl get pods test-pod -oyaml\nstatus:\n  conditions:\n  - lastProbeTime: null\n    lastTransitionTime: "2023-09-09T11:10:17Z"\n    message: \'{"test-sidecarset":false}\'\n    reason: UpdateImmutableField\n    status: "False"\n    type: SidecarSetUpgradable\n'})})]})}function p(e={}){const{wrapper:n}={...(0,r.R)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(o,{...e})}):o(e)}},44012:(e,n,s)=>{s.d(n,{A:()=>a});const a=s.p+"assets/images/sidecarset_hotupgrade_injection-bc68babcd84165fd3561dd2d4f5f8d9d.png"},74330:(e,n,s)=>{s.d(n,{A:()=>a});const a=s.p+"assets/images/sidecarset_hotupgrade-8f7325ba1f999667c60bea6d6aec32f9.png"}}]);